<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://img.heliar.top/file/1766204913128_Image_1759748044606.jpg">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>X-Evol</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- FullCalendar CSS for the new Calendar App -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css' rel='stylesheet' />
    <!-- Cropper.js CSS for Avatar Cropping -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <style id="global-theme-style"></style> <!-- 全局自定义主题注入点 -->
    <style id="dynamic-font-style"></style> <!-- 动态字体注入点 -->
    <style id="player-css-style"></style> <!-- 播放器CSS注入点 -->
    <style>
        :root {
            /* 屏幕尺寸 */
            --phone-width: 380px;
            --phone-height: 820px;

            /* 主题颜色变量 */
            --wechat-bg: #EDEDED;
            --wechat-nav-bg: #F6F6F6;
            --wechat-border-color: #D8D8D8;
            --wechat-text-primary: #000000;
            --wechat-text-secondary: #888888;
            --wechat-green: #07C160;
            --wechat-blue: #576B95;
            --wechat-red: #FA5151;
            --special-orange-bg: #FCAE3D;

            /* 美化变量 */
            --user-avatar-frame: none;
            --char-avatar-frame: none;
            --avatar-shape: 6px;
            --chat-background-image: none;
            --home-screen-background-image: url('https://source.unsplash.com/random/380x820?gradient');
            --home-screen-font-color: #FFFFFF;
            --global-font-color: var(--wechat-text-primary);
            --player-image: url('https://img.heliar.top/file/1764067235404_Screenshot_2025_1125_183413.png');
            --player-background: url('https://img.heliar.top/file/1764067231296_Screenshot_2025_1125_183056.png');
            --user-custom-font: 'UserCustomFont', -apple-system, BlinkMacSystemFont, "Helvetica Neue", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif;
            --font-size-base: 15px;
            --global-font-weight: normal;
            --global-font-style: normal;


            /* 手机边框变量 */
            --phone-border-color: #111;
            --phone-border-width: 10px;
            --phone-shadow: 0 15px 50px rgba(0,0,0,0.3);
            --phone-edge-highlight: transparent;
            --phone-backdrop-filter: none;
            
            /* 暗黑主题背景变量 */
            --page-bg-general: none;
            --page-bg-special: none;

            /* 主屏幕APP图标变量 */
            --app-icon-size: 60px;
            --app-icon-gap: 20px;
            --app-icon-radius: 15px;

            /* 电池图标变量 */
            --battery-icon-image: none;
            --battery-percent-display-outside: block;
            --battery-percent-display-inside: none;
            --battery-percent-color: var(--global-font-color);

            /* ★★★ 优化：线下剧情美化变量 ★★★ */
            --offline-plot-bubble-bg: var(--wechat-nav-bg);
            --offline-plot-bubble-padding: 15px;
            --offline-plot-bubble-radius: 12px;
            --offline-plot-bubble-shadow: 0 2px 5px rgba(0,0,0,0.05);
            --offline-plot-font-family: var(--user-custom-font);
            --offline-plot-font-size: 16px;
            --offline-plot-line-height: 1.8;
            --offline-plot-char-narration-color: var(--global-font-color);
            --offline-plot-char-narration-style: normal;
            --offline-plot-char-narration-weight: normal;
            --offline-plot-user-narration-color: var(--global-font-color);
            --offline-plot-user-narration-style: normal;
            --offline-plot-user-narration-weight: normal;
            --offline-plot-char-quote-color: var(--global-font-color);
            --offline-plot-char-quote-style: normal;
            --offline-plot-char-quote-weight: bold;
            --offline-plot-user-quote-color: var(--global-font-color);
            --offline-plot-user-quote-style: normal;
            --offline-plot-user-quote-weight: bold;
            
            /* ★★★ 新增：群头衔颜色变量 ★★★ */
            --group-title-owner-color: #FFA500; /* 橙黄色 */
            --group-title-admin-color: #07C160; /* 绿色 */
            --group-title-special-color: #8A2BE2; /* 紫色 */
            --group-title-normal-color: #888888; /* 灰色 */

            /* UI图标变量 */
            --ui-icon-back: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z'/%3e%3c/svg%3e");
            --ui-icon-plus-circle: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z'/%3e%3c/svg%3e");
            --ui-icon-tab-chat: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z'/%3e%3c/svg%3e");
            --ui-icon-tab-contacts: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M16.5 12c1.38 0 2.5-1.12 2.5-2.5S17.88 7 16.5 7C15.12 7 14 8.12 14 9.5s1.12 2.5 2.5 2.5zM9 11c1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3 1.34 3 3 3zm7.5 3c-1.83 0-5.5.92-5.5 2.75V18h11v-1.25c0-1.83-3.67-2.75-5.5-2.75zM9 13c-2.33 0-7 1.17-7 3.5V18h7v-1.5c0-.92.32-2.14 1.9-2.83A5.47 5.47 0 0 1 9 13z'/%3e%3c/svg%3e");
            --ui-icon-tab-me: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3e%3c/svg%3e");
            --ui-icon-chat-resend: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M2.01 21L23 12 2.01 3 2 10l15 2-15 2z'/%3e%3c/svg%3e");
            --ui-icon-chat-voice: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z'/%3e%3c/svg%3e");
            --ui-icon-chat-sticker: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z'/%3e%3c/svg%3e");
            --ui-icon-chat-plus: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z'/%3e%3c/svg%3e");
            --ui-icon-plus-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z'/%3e%3c/svg%3e");
            --ui-icon-plus-camera: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M12 12c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm-2 4h4c1.1 0 2-.9 2-2v-1.17l2.17 2.17c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L17.17 13H7v2c0 1.1.9 2 2 2zm10-7.17V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7.17l-2.17-2.17 2.17-2.17zM12 4c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3z'/%3e%3c/svg%3e");
            --ui-icon-plus-phone: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.02.74-.25 1.02l-2.2 2.2z'/%3e%3c/svg%3e");
            --ui-icon-plus-location: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z'/%3e%3c/svg%3e");
            --ui-icon-plus-redpacket: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4.5c-1.38 0-2.5-1.12-2.5-2.5S18.62 3.5 20 3.5V4.5zM4 8.5c1.38 0 2.5-1.12 2.5-2.5S5.38 3.5 4 3.5V8.5zm8 10c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z'/%3e%3ccircle cx='12' cy='13.5' r='2.5'/%3e%3c/svg%3e");
            --ui-icon-plus-transfer: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M17 16.59V14h-4v-4h4V7.41L21.59 12 17 16.59zM7 7.41V10h4v4H7v2.59L2.41 12 7 7.41z'/%3e%3c/svg%3e");
            --ui-icon-plus-kinship: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3e%3c/svg%3e");
            --ui-icon-plus-diary: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z'/%3e%3c/svg%3e");
            --ui-icon-plus-file: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z'/%3e%3c/svg%3e");
            --ui-icon-plus-heartbeat: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3e%3c/svg%3e"); /* ★★★ 新增心声图标 ★★★ */
            --ui-icon-me-settings: url('https://img.js.design/assets/img/66547a8286955562f5597929.png');
            --ui-icon-me-wallet: url('https://img.js.design/assets/img/667d7195d37637e76118f1a1.png');
            --ui-icon-me-moments: url('https://img.js.design/assets/img/667d719515a119e755255403.png');
            --ui-icon-me-persona: url('https://img.js.design/assets/img/667d7195d37637e76118f1a2.png');
            --ui-icon-me-address: url('https://img.js.design/assets/img/667d719515a119e755255404.png');
            --ui-icon-me-status: url('https://img.js.design/assets/img/667d7195d37637e76118f1a3.png');
        }

        /* --- 主题 --- */
        /* 夜间模式 */
        body.dark-mode {
            --wechat-bg: #121212;
            --wechat-nav-bg: #1E1E1E;
            --wechat-border-color: #3A3A3C;
            --wechat-text-primary: #EAEAEA;
            --wechat-text-secondary: #8E8E93;
            --global-font-color: #EAEAEA;
            --battery-percent-color: #EAEAEA;
            --offline-plot-char-narration-color: #EAEAEA;
            --offline-plot-user-narration-color: #EAEAEA;
            --offline-plot-char-quote-color: #EAEAEA;
            --offline-plot-user-quote-color: #EAEAEA;
        }
        body.dark-mode .list-item, body.dark-mode .me-profile-card, body.dark-mode .me-menu-item, body.dark-mode .chat-input-bar, body.dark-mode .modal-content, body.dark-mode .form-group input, body.dark-mode .form-group textarea, body.dark-mode .form-group select, body.dark-mode .moment-post, body.dark-mode .bank-card { background-color: var(--wechat-nav-bg); color: var(--global-font-color); }
        body.dark-mode .message-row.received .message-bubble.text-bubble { background-color: var(--wechat-nav-bg); }
        body.dark-mode .message-row.received .message-bubble.text-bubble::after { background: var(--wechat-nav-bg); }
        body.dark-mode .message-recalled, body.dark-mode .message-system { background: #333; color: var(--wechat-text-secondary); }
        body.dark-mode .list-item:active, body.dark-mode .me-menu-item:active { background-color: #2c2c2c; }
        body.dark-mode .chat-input-bar input { background: #333; color: var(--global-font-color); }
        body.dark-mode .chat-plus-menu { background: #252525; }
        body.dark-mode .plus-menu-item .icon { background: #333; border-color: #444; }
        body.dark-mode .header-back-btn, body.dark-mode .header-title, body.dark-mode .header-right { color: var(--global-font-color); }
        body.dark-mode .tab-item { color: var(--wechat-text-secondary); }
        body.dark-mode .tab-item.active { color: var(--wechat-green); }
        body.dark-mode .message-bubble.camera-sim-bubble, body.dark-mode .message-bubble.location-bubble { background: #2c2c2e; border-color: #3a3a3c; }
        body.dark-mode .message-bubble.location-bubble .map-placeholder { background-color: #3a3a3c; }
        
        /* 可爱樱花粉主题 */
        body.sakura-pink-mode { --wechat-bg: #FFF0F5; --wechat-nav-bg: #FFC0CB; --wechat-border-color: #FFB6C1; --wechat-text-primary: #333333; --wechat-text-secondary: #8B4513; --wechat-green: #FF69B4; --wechat-blue: #DB7093; --global-font-color: #333333; --battery-percent-color: #333333; --offline-plot-char-narration-color: #333; --offline-plot-user-narration-color: #333; --offline-plot-char-quote-color: #333; --offline-plot-user-quote-color: #333; }
        body.sakura-pink-mode .list-item, body.sakura-pink-mode .me-profile-card, body.sakura-pink-mode .me-menu-item, body.sakura-pink-mode .chat-input-bar, body.sakura-pink-mode .modal-content, body.sakura-pink-mode .form-group input, body.sakura-pink-mode .form-group textarea, body.sakura-pink-mode .form-group select, body.sakura-pink-mode .moment-post, body.sakura-pink-mode .bank-card { background-color: #FFFFFF; color: var(--global-font-color); }
        body.sakura-pink-mode .message-row.sent .message-bubble.text-bubble { background-color: #FFDFE5; }
        body.sakura-pink-mode .message-row.sent .message-bubble.text-bubble::after { background: #FFDFE5; }
        body.sakura-pink-mode .message-row.received .message-bubble.text-bubble { background-color: #FFFFFF; }
        body.sakura-pink-mode .message-row.received .message-bubble.text-bubble::after { background: #FFFFFF; }

        /* 透明主题 */
        body.transparent-mode { --wechat-bg: transparent; --wechat-nav-bg: transparent; --wechat-border-color: rgba(255, 255, 255, 0.2); --wechat-text-primary: #FFFFFF; --wechat-text-secondary: #CCCCCC; --global-font-color: #FFFFFF; --battery-percent-color: #FFFFFF; --offline-plot-char-narration-color: #FFF; --offline-plot-user-narration-color: #FFF; --offline-plot-char-quote-color: #FFF; --offline-plot-user-quote-color: #FFF; }
        body.transparent-mode .wallet-header { background-color: transparent; }

        /* 拟态主题 */
        body.neumorphic-mode { --wechat-bg: #e0e5ec; --wechat-nav-bg: #e0e5ec; --wechat-border-color: transparent; --wechat-text-primary: #555; --wechat-text-secondary: #999; --global-font-color: #555; --battery-percent-color: #555; --offline-plot-char-narration-color: #555; --offline-plot-user-narration-color: #555; --offline-plot-char-quote-color: #555; --offline-plot-user-quote-color: #555; }
        body.neumorphic-mode .list-item, body.neumorphic-mode .me-profile-card, body.neumorphic-mode .me-menu-item, body.neumorphic-mode .chat-input-bar, body.neumorphic-mode .modal-content, body.neumorphic-mode .form-group input, body.neumorphic-mode .form-group textarea, body.neumorphic-mode .form-group select, body.neumorphic-mode .moment-post, body.neumorphic-mode .message-bubble, body.neumorphic-mode .wechat-header, body.neumorphic-mode .wechat-tabbar, body.neumorphic-mode .bank-card { background: #e0e5ec; box-shadow: 7px 7px 15px #a3b1c6, -7px -7px 15px #ffffff; border: none; }
        body.neumorphic-mode .message-row.sent .message-bubble { box-shadow: inset 5px 5px 10px #a3b1c6, inset -5px -5px 10px #ffffff; }

        /* ^•͈༝•^ฅ 主题 */
        body.clear-sky-blue-mode { --wechat-bg: #E1F5FE; --wechat-nav-bg: #B3E5FC; --wechat-border-color: #81D4FA; --wechat-text-primary: #01579B; --wechat-text-secondary: #4FC3F7; --wechat-green: #0288D1; --wechat-blue: #03A9F4; --global-font-color: #01579B; --battery-percent-color: #01579B; --offline-plot-char-narration-color: #01579B; --offline-plot-user-narration-color: #01579B; --offline-plot-char-quote-color: #01579B; --offline-plot-user-quote-color: #01579B; }
        body.clear-sky-blue-mode .list-item, body.clear-sky-blue-mode .me-profile-card, body.clear-sky-blue-mode .me-menu-item, body.clear-sky-blue-mode .chat-input-bar, body.clear-sky-blue-mode .modal-content, body.clear-sky-blue-mode .form-group input, body.clear-sky-blue-mode .form-group textarea, body.clear-sky-blue-mode .form-group select, body.clear-sky-blue-mode .moment-post, body.clear-sky-blue-mode .bank-card { background-color: #FFFFFF; }
        body.clear-sky-blue-mode .message-row.sent .message-bubble.text-bubble { background-color: #81D4FA; }
        body.clear-sky-blue-mode .message-row.sent .message-bubble.text-bubble::after { background: #81D4FA; }
        body.clear-sky-blue-mode .message-row.received .message-bubble.text-bubble { background-color: #FFFFFF; }
        body.clear-sky-blue-mode .message-row.received .message-bubble.text-bubble::after { background: #FFFFFF; }

        /* 毛玻璃主题 */
        body.glassmorphism-mode {
            --wechat-bg: transparent;
            --wechat-nav-bg: rgba(200, 225, 255, 0.5);
            --wechat-border-color: rgba(255, 255, 255, 0.2);
            --wechat-text-primary: #002D62;
            --wechat-text-secondary: #005A9C;
            --wechat-green: #007BFF;
            --wechat-blue: #0056b3;
            --global-font-color: #002D62;
            --battery-percent-color: #002D62;
            --page-bg-general: url('https://source.unsplash.com/random/380x820?abstract,blue,light');
            --offline-plot-char-narration-color: #002D62;
            --offline-plot-user-narration-color: #002D62;
            --offline-plot-char-quote-color: #002D62;
            --offline-plot-user-quote-color: #002D62;
        }
        body.glassmorphism-mode .screen { background-image: var(--page-bg-general); background-size: cover; background-position: center; }
        body.glassmorphism-mode .page { background-color: transparent; }
        body.glassmorphism-mode .list-item, body.glassmorphism-mode .me-profile-card, body.glassmorphism-mode .me-menu-item, body.glassmorphism-mode .chat-input-bar, body.glassmorphism-mode .modal-content, body.glassmorphism-mode .wechat-header, body.glassmorphism-mode .wechat-tabbar, body.glassmorphism-mode .chat-plus-menu, body.glassmorphism-mode .bank-card, body.glassmorphism-mode .moment-post {
            background-color: var(--wechat-nav-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        body.glassmorphism-mode .message-row.received .message-bubble.text-bubble { background-color: rgba(255, 255, 255, 0.7); }
        body.glassmorphism-mode .message-row.received .message-bubble.text-bubble::after { background: rgba(255, 255, 255, 0.7); }
        body.glassmorphism-mode .message-row.sent .message-bubble.text-bubble { background-color: rgba(128, 191, 255, 0.8); }
        body.glassmorphism-mode .message-row.sent .message-bubble.text-bubble::after { background: rgba(128, 191, 255, 0.8); }
        body.glassmorphism-mode .app-icon .icon-bg { background-color: #007BFF !important; }

        /* 仿QQ主题 */
        body.qq-style-mode {
            --wechat-bg: #F5F5F5;
            --wechat-nav-bg: #FFFFFF;
            --wechat-border-color: #E0E0E0;
            --wechat-text-primary: #000000;
            --wechat-text-secondary: #777777;
            --wechat-green: #0099FF; /* QQ Blue */
            --wechat-blue: #0099FF;
            --global-font-color: #000000;
            --battery-percent-color: #000000;
            --qq-icon-color: #27455A; /* RGB(39, 69, 90) */
            --offline-plot-char-narration-color: #000;
            --offline-plot-user-narration-color: #000;
            --offline-plot-char-quote-color: #000;
            --offline-plot-user-quote-color: #000;
        }
        body.qq-style-mode .wechat-header { background-color: var(--wechat-green); color: white; }
        body.qq-style-mode .header-back-btn, body.qq-style-mode .header-title, body.qq-style-mode .header-right { color: white; }
        body.qq-style-mode .tab-item.active { color: var(--wechat-green); }
        body.qq-style-mode .message-row.sent .message-bubble.text-bubble { background-color: var(--wechat-green); color: white; }
        body.qq-style-mode .message-row.sent .message-bubble.text-bubble::after { background: var(--wechat-green); }
        body.qq-style-mode .message-row.received .message-bubble.text-bubble { background-color: #FFFFFF; }
        body.qq-style-mode .message-row.received .message-bubble.text-bubble::after { background: #FFFFFF; }
        body.qq-style-mode .plus-menu-item .icon { background: #FFFFFF; border: 1px solid #E0E0E0; }
        body.qq-style-mode .plus-menu-item .icon .ui-icon { filter: none; -webkit-filter: none; background-color: var(--qq-icon-color); }
        body.qq-style-mode .form-btn { background-color: var(--wechat-green); }
        body.qq-style-mode .wallet-header { background-color: var(--wechat-green); }
        body.qq-style-mode .tab-item .ui-icon { background-color: var(--qq-icon-color); }
        body.qq-style-mode .tab-item.active .ui-icon { background-color: var(--wechat-green); }
        body.qq-style-mode .me-menu-item .ui-icon { background-color: var(--qq-icon-color); }

        /* ★★★ 新增：ins拟态白主题 ★★★ */
        body.ins-neumorphic-white-mode {
            --wechat-bg: #F0F2F5;
            --wechat-nav-bg: #F0F2F5;
            --wechat-border-color: transparent;
            --wechat-text-primary: #555;
            --wechat-text-secondary: #999;
            --wechat-green: #0095F6;
            --wechat-blue: #0095F6;
            --global-font-color: #555;
            --battery-percent-color: #555;
            --offline-plot-char-narration-color: #555;
            --offline-plot-user-narration-color: #555;
            --offline-plot-char-quote-color: #555;
            --offline-plot-user-quote-color: #555;
            --ins-shadow-light: #FFFFFF;
            --ins-shadow-dark: #D1D9E6;
        }
        body.ins-neumorphic-white-mode .list-item, 
        body.ins-neumorphic-white-mode .me-profile-card, 
        body.ins-neumorphic-white-mode .me-menu-item, 
        body.ins-neumorphic-white-mode .chat-input-bar, 
        body.ins-neumorphic-white-mode .modal-content, 
        body.ins-neumorphic-white-mode .form-group input, 
        body.ins-neumorphic-white-mode .form-group textarea, 
        body.ins-neumorphic-white-mode .form-group select, 
        body.ins-neumorphic-white-mode .moment-post, 
        body.ins-neumorphic-white-mode .wechat-header, 
        body.ins-neumorphic-white-mode .wechat-tabbar, 
        body.ins-neumorphic-white-mode .bank-card,
        body.ins-neumorphic-white-mode .plus-menu-item .icon {
            background: var(--wechat-bg);
            box-shadow: 5px 5px 10px var(--ins-shadow-dark), -5px -5px 10px var(--ins-shadow-light);
            border: none;
        }
        body.ins-neumorphic-white-mode .message-bubble.text-bubble {
            background: var(--wechat-bg);
            border-radius: 15px;
            box-shadow: 5px 5px 10px var(--ins-shadow-dark), -5px -5px 10px var(--ins-shadow-light);
        }
        body.ins-neumorphic-white-mode .message-row.sent .message-bubble.text-bubble {
            box-shadow: inset 3px 3px 6px var(--ins-shadow-dark), inset -3px -3px 6px var(--ins-shadow-light);
            background: linear-gradient(145deg, #e6e9ec, #ffffff);
        }
        body.ins-neumorphic-white-mode .message-bubble::after { display: none; }
        body.ins-neumorphic-white-mode .ui-icon {
            background-color: var(--wechat-text-secondary);
        }
        body.ins-neumorphic-white-mode .tab-item.active .ui-icon,
        body.ins-neumorphic-white-mode .form-btn,
        body.ins-neumorphic-white-mode .modal-btn.primary {
            background-color: var(--wechat-green);
        }
        body.ins-neumorphic-white-mode .form-btn,
        body.ins-neumorphic-white-mode .modal-btn.primary {
            color: white;
            box-shadow: 3px 3px 6px var(--ins-shadow-dark), -3px -3px 6px var(--ins-shadow-light);
        }

        @font-face { font-family: 'UserCustomFont'; src: var(--user-custom-font-src); }
        @font-face { font-family: 'DiaryFont'; src: url('https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756988857890_qdqqd_enpyrq.ttf'); }

        body { display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #333; margin: 0; font-family: var(--user-custom-font); font-size: var(--font-size-base); font-weight: var(--global-font-weight); font-style: var(--global-font-style); overflow: hidden; }

        /* ★★★ 优化：激活与加载弹窗 ★★★ */
        .popup-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.3s ease;
        }
        .popup-content {
            background: #FFFFFF;
            border-radius: 20px;
            width: 320px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            text-align: center;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            animation: popup-fade-in 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        @keyframes popup-fade-in {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        #activation-modal .popup-icon {
            width: 60px;
            height: 60px;
            margin-bottom: 20px;
            background-color: #0099FF;
            -webkit-mask-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z'/%3e%3c/svg%3e");
            mask-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z'/%3e%3c/svg%3e");
            display: inline-block;
        }
        #activation-modal h3 {
            margin: 0 0 15px;
            color: #333;
            font-size: 20px;
            font-weight: 600;
        }
        #activation-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #E0E0E0;
            border-radius: 10px;
            text-align: center;
            font-size: 16px;
            box-sizing: border-box;
            margin-bottom: 20px;
        }
        #activation-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: #0099FF;
            color: white;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        #activation-btn:hover { background: #0088e6; }
        #loading-screen .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 153, 255, 0.2);
            border-top-color: #0099FF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        #loading-screen .loading-text {
            font-size: 18px;
            font-weight: 500;
            color: #333;
        }
        #loading-screen .progress-bar-container {
            width: 100%;
            height: 6px;
            background-color: rgba(0, 153, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 20px;
        }
        #loading-screen .progress-bar {
            width: 0%;
            height: 100%;
            background-color: #0099FF;
            border-radius: 3px;
            transition: width 0.2s ease-out;
        }
        #loading-screen .loading-subtext {
            font-size: 12px;
            color: #999;
            margin-top: 15px;
        }

        /* --- 手机外壳 --- */
        .phone-container { width: var(--phone-width); height: var(--phone-height); background: var(--phone-border-color); border-radius: 44px; box-shadow: var(--phone-shadow), 0 0 0 1px var(--phone-edge-highlight); display: flex; flex-direction: column; overflow: hidden; position: relative; border: var(--phone-border-width) solid var(--phone-border-color); transition: all 0.3s ease; backdrop-filter: var(--phone-backdrop-filter, none); }
        .phone-container.fullscreen { width: 100vw; height: 100vh; border-radius: 0; border: none; }
        .screen { width: 100%; height: 100%; display: flex; flex-direction: column; position: relative; background-color: var(--wechat-bg); border-radius: 34px; overflow: hidden; }
        .phone-container.fullscreen .screen { border-radius: 0; }
        
        /* --- iPhone6 模式 --- */
        body.iphone6-mode .phone-container {
            padding: 80px 15px;
            border-radius: 40px;
            background: var(--phone-border-color);
            position: relative;
        }
        body.iphone6-mode .screen {
            border-radius: 5px;
            height: 100%;
            width: 100%;
        }
        body.iphone6-mode .phone-container::before { /* 听筒 */
            content: '';
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 4px;
            background: #444;
            border-radius: 2px;
        }
        .iphone6-home-button {
            display: none;
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #666;
            background: #333;
            cursor: pointer;
            z-index: 10;
        }
        body.iphone6-mode .iphone6-home-button {
            display: block;
        }

        /* ★★★ iOS风格手机边框 (优化) ★★★ */
        body.ios-style-frame-mode .phone-container {
            width: var(--phone-width); /* 宽度跟随系统 */
            height: var(--phone-height); /* 高度跟随系统 */
            border-radius: 50px;
            background: transparent;
            border: none;
            padding: 0;
            box-shadow: none;
        }
        body.ios-style-frame-mode .phone-container .screen {
            position: absolute;
            top: 14px;
            left: 14px;
            width: calc(100% - 28px);
            height: calc(100% - 28px);
            border-radius: 36px;
            z-index: 4;
        }
        .ios-frame-elements { display: none; }
        body.ios-style-frame-mode .ios-frame-elements {
            display: block;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
        }
        .ios-outer-frame {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 50px; border: 12px solid white; box-sizing: border-box;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1), inset 0 0 20px rgba(0, 0, 0, 0.05);
            z-index: 1;
        }
        .ios-outer-frame::before {
            content: ''; position: absolute; top: -6px; left: -6px; right: -6px; height: 30px;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0));
            border-radius: 50px 50px 0 0; z-index: 2;
        }
        .ios-outer-frame::after {
            content: ''; position: absolute; top: -6px; left: -6px; bottom: -6px; width: 30px;
            background: linear-gradient(to right, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0));
            border-radius: 50px 0 0 50px; z-index: 2;
        }
        .ios-inner-frame {
            position: absolute; top: 12px; left: 12px; width: calc(100% - 24px); height: calc(100% - 24px);
            border-radius: 38px; border: 2px solid #000; box-sizing: border-box; z-index: 3;
        }
        body.ios-style-frame-mode .screen::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            border-radius: 36px; box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.2); z-index: 5;
        }
        .ios-bottom-shadow {
            position: absolute; bottom: -15px; left: 20px; right: 20px; height: 30px;
            background: radial-gradient(ellipse at center, rgba(0,0,0,0.15) 0%, rgba(0,0,0,0) 70%);
            z-index: 0;
        }

        /* ★★★ 薄荷奶绿手机边框 (优化) ★★★ */
        body.mint-green-frame-mode .phone-container {
            width: var(--phone-width); /* 宽度跟随系统 */
            height: var(--phone-height); /* 高度跟随系统 */
            border: none; background: transparent; padding: 0;
        }
        body.mint-green-frame-mode .screen {
            position: absolute;
            top: 20px; left: 20px;
            width: calc(100% - 40px); height: calc(100% - 40px);
            border-radius: 30px; z-index: 1;
        }
        .mint-green-frame-elements { display: none; }
        body.mint-green-frame-mode .mint-green-frame-elements {
            display: block; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
        }
        .mint-inner-border {
            position: absolute; top: 20px; left: 20px; width: calc(100% - 40px); height: calc(100% - 40px);
            border: 2px solid #000;
            border-radius: 30px; box-sizing: border-box; z-index: 2;
        }
        .mint-middle-border {
            position: absolute; top: 12px; left: 12px; width: calc(100% - 24px); height: calc(100% - 24px);
            border: 8px solid white; border-radius: 38px; box-sizing: border-box; z-index: 3;
            box-shadow: inset -2px -2px 4px rgba(0, 0, 0, 0.1), inset 2px 2px 4px rgba(255, 255, 255, 0.8);
        }
        .mint-outer-border {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border: 12px solid #a0e0a0; border-radius: 50px; box-sizing: border-box; z-index: 4;
        }

        /* --- 状态栏 & 通知栏 & 刘海屏/灵动岛 --- */
        .status-bar { height: 30px; display: flex; justify-content: space-between; align-items: center; padding: 0 10px; color: var(--global-font-color); font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif; font-weight: 500; position: absolute; top: 0; left: 0; right: 0; z-index: 100; cursor: pointer; }
        body.dark-mode .status-bar, body.transparent-mode .status-bar, body.glassmorphism-mode .status-bar { color: white; }
        .status-bar-left { display: flex; align-items: center; gap: 8px; }
        .status-bar-right { display: flex; align-items: center; gap: 6px; }
        .status-bar .time { font-size: 13.5px; font-weight: 600; }
        .status-bar .network-icon i, .status-bar .network-icon span { font-size: 13px; }
        .status-bar .dnd-icon i { font-size: 12px; }
        .battery-container { position: relative; display: flex; align-items: center; gap: 4px; }
        .custom-battery-icon { width: 24px; height: 11px; background-image: var(--battery-icon-image); background-size: contain; background-repeat: no-repeat; background-position: center; }
        
        .battery-icon {
            width: 24px;
            height: 11.5px;
            border: 1.2px solid var(--global-font-color, black);
            border-radius: 4px;
            position: relative;
            display: flex;
            align-items: center;
            padding: 1.5px;
            box-sizing: border-box;
        }
        .battery-icon::after {
            content: '';
            width: 1.5px;
            height: 4.5px;
            background-color: var(--global-font-color, black);
            border-radius: 0 1.5px 1.5px 0;
            position: absolute;
            right: -4px;
            top: 50%;
            transform: translateY(-50%);
        }
        .battery-fill {
            height: 100%;
            background-color: var(--global-font-color, black);
            border-radius: 2.5px;
        }
        .battery-fill.charging, .battery-fill.low { background-color: var(--wechat-green); }
        .battery-fill.low { background-color: #FA5151; }
        .battery-percent-inside {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 9px;
            font-weight: 600;
            color: white;
            mix-blend-mode: difference;
            display: var(--battery-percent-display-inside);
        }
        .battery-percent-outside { font-size: 12px; display: var(--battery-percent-display-outside); color: var(--battery-percent-color); }

        /* ★★★ 优化：通知栏 ★★★ */
        .notification-center {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            z-index: 1005;
            transform: translateY(-100%);
            transition: transform 0.3s ease-out;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            cursor: pointer;
        }
        .notification-center.visible { transform: translateY(0); }
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 40px 20px 10px;
            flex-shrink: 0;
        }
        .notification-header h3 { color: white; margin: 0; font-size: 18px; }
        .notification-header .back-btn {
            background: none;
            border: none;
            color: white;
            font-size: 17px;
            cursor: pointer;
        }
        #notification-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0 10px;
        }
        .notification-item { background: rgba(255,255,255,0.15); border-radius: 12px; padding: 10px; margin-bottom: 10px; color: white; display: flex; align-items: center; gap: 10px; }
        .notification-item .app-icon { width: 24px; height: 24px; border-radius: 6px; }
        .notification-item .content .title { font-weight: bold; font-size: 14px; }
        .notification-item .content .text { font-size: 13px; margin-top: 4px; }
        .notification-footer {
            padding: 15px;
            text-align: center;
            flex-shrink: 0;
        }
        .clear-all-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 20px;
        }

        .notch-container { display: none; position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 190px; height: 28px; background: #000; border-bottom-left-radius: 14px; border-bottom-right-radius: 14px; z-index: 101; }
        body.notch-mode .notch-container { display: block; }
        
        /* ★★★ 优化：灵动岛交互 ★★★ */
        #dynamic-island {
            display: none;
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            background: #000;
            border-radius: 20px;
            z-index: 101;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            color: white;
            overflow: hidden;
            cursor: pointer;
        }
        body.island-mode #dynamic-island {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 120px;
            height: 36px;
        }
        #dynamic-island.music-mode {
            width: 220px;
            height: 60px;
            padding: 0 15px;
        }
        .island-content {
            display: none;
            align-items: center;
            gap: 10px;
            height: 100%;
            box-sizing: border-box;
            padding: 8px 15px;
            opacity: 0;
            transform: scale(0.8);
            transition: opacity 0.3s ease-out 0.2s, transform 0.3s ease-out 0.2s;
        }
        #dynamic-island.music-mode .island-content.music {
            display: flex;
            opacity: 1;
            transform: scale(1);
            width: 100%;
            justify-content: space-between;
        }
        .island-content .app-icon { width: 40px; height: 40px; border-radius: 8px; flex-shrink: 0; }
        .island-content .text-content { overflow: hidden; }
        .island-content .title { font-weight: bold; font-size: 14px; white-space: nowrap; }
        .island-content .text { font-size: 13px; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
        .island-content.music .cover { width: 40px; height: 40px; border-radius: 8px; flex-shrink: 0; background-size: cover; background-position: center; }
        .island-content.music .info { flex: 1; margin: 0 10px; overflow: hidden; }
        .island-content.music .info .title { font-size: 15px; font-weight: 600; }
        .island-content.music .info .artist { font-size: 12px; color: rgba(255,255,255,0.7); margin-top: 2px; }
        .island-content.music .controls { display: flex; align-items: center; gap: 15px; }
        .island-content.music .controls .control-btn { background: none; border: none; color: white; cursor: pointer; opacity: 0.9; transition: opacity 0.2s; padding: 5px; }
        .island-content.music .controls .control-btn:hover { opacity: 1; }
        .island-content.music .controls .control-btn svg { width: 16px; height: 16px; fill: currentColor; }
        .island-content.music .controls .play-pause-btn { background: rgba(255, 255, 255, 0.15); border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; }
        @keyframes island-pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        #dynamic-island.playing { animation: island-pulse 2s infinite; }

        /* ★★★ iOS灵动岛 (优化) ★★★ */
        #ios-dynamic-island {
            display: none;
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 130px;
            height: 38px;
            background: #000;
            border-radius: 45px;
            align-items: center;
            justify-content: center; /* 确保内容居中 */
            padding: 0 15px;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            z-index: 1000;
            cursor: pointer;
        }
        body.island-v2-mode #ios-dynamic-island { display: flex; }
        #ios-dynamic-island.island-expanded { width: 220px; height: 60px; }
        #ios-dynamic-island .music-controls { display: none; align-items: center; width: 100%; justify-content: space-between; }
        #ios-dynamic-island.playing .music-controls { display: flex; }
        #ios-dynamic-island .album-art { width: 32px; height: 32px; border-radius: 4px; background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0; }
        #ios-dynamic-island.expanded .album-art { width: 40px; height: 40px; }
        #ios-dynamic-island .album-art .music-icon { color: white; font-size: 18px; }
        #ios-dynamic-island .music-info { flex: 1; margin-left: 12px; color: white; overflow: hidden; }
        #ios-dynamic-island.expanded .music-info { margin-left: 15px; }
        #ios-dynamic-island .song-title { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #ios-dynamic-island.expanded .song-title { font-size: 15px; }
        #ios-dynamic-island .artist-name { font-size: 11px; color: rgba(255, 255, 255, 0.7); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #ios-dynamic-island.expanded .artist-name { font-size: 12px; }
        #ios-dynamic-island .controls { display: flex; align-items: center; gap: 12px; }
        #ios-dynamic-island.expanded .controls { gap: 15px; }
        #ios-dynamic-island .control-btn { background: none; border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0.9; transition: opacity 0.2s; padding: 5px; }
        #ios-dynamic-island .control-btn:hover { opacity: 1; }
        #ios-dynamic-island .control-btn svg { width: 14px; height: 14px; fill: currentColor; }
        #ios-dynamic-island.expanded .control-btn svg { width: 16px; height: 16px; }
        #ios-dynamic-island .play-pause-btn { background: rgba(255, 255, 255, 0.15); border-radius: 50%; width: 26px; height: 26px; }
        #ios-dynamic-island.expanded .play-pause-btn { width: 30px; height: 30px; }
        #ios-dynamic-island .wave-animation { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 45px; background: rgba(255, 255, 255, 0.05); opacity: 0; transition: opacity 0.3s; }
        #ios-dynamic-island.playing .wave-animation { opacity: 1; }
        #ios-dynamic-island .wave-bar { position: absolute; bottom: 0; left: 0; height: 2px; background: linear-gradient(90deg, #64d2ff, #5e5ce6); width: 0%; transition: width 2s linear; }
        #ios-dynamic-island .status-indicator { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 14px; font-weight: 600; opacity: 0; transition: opacity 0.3s; white-space: nowrap; }
        #ios-dynamic-island .status-visible { opacity: 1; }
        @keyframes ios-pulse { 0% { transform: translateX(-50%) scale(1); } 50% { transform: translateX(-50%) scale(1.02); } 100% { transform: translateX(-50%) scale(1); } }
        #ios-dynamic-island.pulse { animation: ios-pulse 2s infinite; }
        @keyframes ios-wave { 0% { transform: scaleY(1); } 50% { transform: scaleY(1.5); } 100% { transform: scaleY(1); } }
        #ios-dynamic-island .wave { display: inline-block; width: 2px; height: 12px; background: #64d2ff; margin: 0 1px; animation: ios-wave 1.2s infinite ease-in-out; }
        #ios-dynamic-island .wave:nth-child(2) { animation-delay: 0.1s; }
        #ios-dynamic-island .wave:nth-child(3) { animation-delay: 0.2s; }
        #ios-dynamic-island .wave:nth-child(4) { animation-delay: 0.3s; }

        /* ★★★ 新增：Evol灵动岛 ★★★ */
        #evol-dynamic-island {
            display: none;
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 37px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 30px;
            backdrop-filter: blur(20px);
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
            z-index: 1000;
        }
        body.evol-island-mode #evol-dynamic-island { display: flex; }
        #evol-dynamic-island.expanded {
            width: 280px;
            height: 110px;
        }
        #evol-dynamic-island .music-controls {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            padding: 18px 15px 15px;
            box-sizing: border-box;
        }
        #evol-dynamic-island.expanded .music-controls { display: flex; }
        #evol-dynamic-island .song-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 15px;
            width: 100%;
        }
        #evol-dynamic-island .song-name {
            font-weight: 600;
            font-size: 15px;
            color: white;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 90%;
        }
        #evol-dynamic-island .artist-name {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 90%;
        }
        #evol-dynamic-island .controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 22px;
        }
        #evol-dynamic-island .control-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }
        #evol-dynamic-island .play-pause {
            background-color: white;
            width: 34px;
            height: 34px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #evol-dynamic-island .play-pause i {
            color: black;
            font-size: 15px;
        }
        #evol-dynamic-island .wave-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
        }
        #evol-dynamic-island .wave-bar {
            width: 2.5px;
            background-color: white;
            border-radius: 2px;
            animation: evol-wave 0.8s infinite ease-in-out;
        }
        @keyframes evol-wave {
            0%, 100% { height: 4px; }
            50% { height: 12px; }
        }
        #evol-dynamic-island .wave-bar:nth-child(1) { animation-delay: 0.1s; }
        #evol-dynamic-island .wave-bar:nth-child(2) { animation-delay: 0.2s; }
        #evol-dynamic-island .wave-bar:nth-child(3) { animation-delay: 0.3s; }
        #evol-dynamic-island .wave-bar:nth-child(4) { animation-delay: 0.4s; }
        #evol-dynamic-island .wave-bar:nth-child(5) { animation-delay: 0.5s; }
        #evol-dynamic-island .wave-bar:nth-child(6) { animation-delay: 0.6s; }
        #evol-dynamic-island .wave-bar:nth-child(7) { animation-delay: 0.7s; }
        #evol-dynamic-island .wave-bar:nth-child(8) { animation-delay: 0.8s; }

        /* ★★★ 新增：ins灵动岛样式 ★★★ */
        #ins-dynamic-island {
            display: none;
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 126px;
            height: 37px;
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 40px;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            overflow: hidden;
            z-index: 1000;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif;
        }
        body.ins-island-mode #ins-dynamic-island { display: flex; }
        #ins-dynamic-island.expanded {
            width: 320px;
            height: 160px;
            border-radius: 30px;
            overflow: visible;
        }
        #ins-dynamic-island .island-default {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            font-size: 13px;
            font-weight: 500;
        }
        #ins-dynamic-island .island-default .album-cover {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            overflow: hidden;
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.8);
            background-size: cover;
            background-position: center;
        }
        #ins-dynamic-island .island-default .album-cover i { font-size: 20px; }
        #ins-dynamic-island .music-player {
            width: 100%;
            height: 100%;
            padding: 18px 20px;
            display: none;
            flex-direction: column;
            justify-content: space-between;
        }
        #ins-dynamic-island.expanded .music-player { display: flex; }
        #ins-dynamic-island .song-info { color: white; }
        #ins-dynamic-island .song-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #ins-dynamic-island .artist {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
        }
        #ins-dynamic-island .wave-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            height: 20px;
            margin-top: 5px;
        }
        #ins-dynamic-island .wave-bar {
            width: 2px;
            background-color: white;
            border-radius: 1px;
            animation: ins-wave 1s ease-in-out infinite alternate;
        }
        #ins-dynamic-island .wave-bar:nth-child(2) { animation-delay: 0.1s; }
        #ins-dynamic-island .wave-bar:nth-child(3) { animation-delay: 0.2s; }
        #ins-dynamic-island .wave-bar:nth-child(4) { animation-delay: 0.3s; }
        #ins-dynamic-island .wave-bar:nth-child(5) { animation-delay: 0.4s; }
        #ins-dynamic-island .wave-bar:nth-child(6) { animation-delay: 0.5s; }
        #ins-dynamic-island .wave-bar:nth-child(7) { animation-delay: 0.4s; }
        #ins-dynamic-island .wave-bar:nth-child(8) { animation-delay: 0.3s; }
        #ins-dynamic-island .wave-bar:nth-child(9) { animation-delay: 0.2s; }
        #ins-dynamic-island .wave-bar:nth-child(10) { animation-delay: 0.1s; }
        @keyframes ins-wave { 0% { height: 4px; } 100% { height: 16px; } }
        #ins-dynamic-island .wave-container.paused .wave-bar {
            animation-play-state: paused;
            height: 4px;
        }
        #ins-dynamic-island .progress-container {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }
        #ins-dynamic-island .time-display {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.8);
            min-width: 35px;
        }
        #ins-dynamic-island .progress-bar {
            flex: 1;
            height: 3px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 1.5px;
            overflow: hidden;
        }
        #ins-dynamic-island .progress {
            height: 100%;
            width: 0%;
            background-color: white;
            border-radius: 1.5px;
        }
        #ins-dynamic-island .music-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }
        #ins-dynamic-island .control-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        #ins-dynamic-island .control-btn:hover { background-color: rgba(255, 255, 255, 0.1); }
        #ins-dynamic-island .control-btn i { color: white; font-size: 16px; }
        #ins-dynamic-island .play-btn {
            width: 44px;
            height: 44px;
            background-color: white;
        }
        #ins-dynamic-island .play-btn i { color: black; font-size: 18px; }


        /* --- 页面 & 导航 --- */
        .page { position: absolute; inset: 0; background-color: var(--wechat-bg); display: none; flex-direction: column; z-index: 10; transform: translateX(100%); transition: transform 0.3s ease-in-out; padding-top: 30px; }
        .page.active { display: flex; transform: translateX(0); }
        .page.no-transition { transition: none; }
        .page.sub-page { z-index: 20; }
        .wechat-header { height: 44px; background-color: var(--wechat-nav-bg); display: flex; align-items: center; justify-content: space-between; padding: 0 10px; border-bottom: 0.5px solid var(--wechat-border-color); flex-shrink: 0; position: sticky; top: 0; z-index: 10; color: var(--global-font-color); }
        .header-title { font-size: 17px; font-weight: 600; position: absolute; left: 50%; transform: translateX(-50%); display: flex; align-items: center; gap: 5px; }
        .header-left, .header-right { display: flex; align-items: center; gap: 15px; font-size: 22px; cursor: pointer; color: var(--global-font-color); }
        .header-back-btn { font-size: 17px; color: var(--global-font-color); display: flex; align-items: center; gap: 2px; }
        .header-back-btn .ui-icon { width: 24px; height: 24px; }
        .content-area { flex: 1; overflow-y: auto; }
        .content-area::-webkit-scrollbar { width: 4px; }
        .content-area::-webkit-scrollbar-thumb { background: #ccc; border-radius: 2px; }
        .wechat-tabbar { display: flex; height: 50px; background-color: var(--wechat-nav-bg); border-top: 0.5px solid var(--wechat-border-color); flex-shrink: 0; }
        .tab-item { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 2px; color: var(--wechat-text-secondary); cursor: pointer; }
        .tab-item.active { color: var(--wechat-green); }
        .tab-item .ui-icon { width: 22px; height: 22px; }
        .tab-item span { font-size: 10px; }

        /* --- 底部导航指示条 --- */
        .home-indicator {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 134px;
            height: 5px;
            background-color: var(--global-font-color);
            border-radius: 100px;
            opacity: 0.4;
            cursor: pointer;
            z-index: 100;
            display: none;
        }
        body.fullscreen-mode .home-indicator,
        body.default-display-mode .home-indicator {
            display: block;
        }
        body.iphone6-mode .home-indicator {
            display: none;
        }


        /* --- 主屏幕 --- */
        #home-screen-page { background-image: var(--home-screen-background-image); background-size: cover; background-position: center; padding: 0; }
        #home-screen-page .content-area { padding: 0; overflow: hidden; position: relative; }
        .home-screen-pager-wrapper { display: flex; width: 100%; height: 100%; overflow-x: scroll; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .home-screen-pager-wrapper::-webkit-scrollbar { display: none; }
        .home-screen-page-content { width: 100%; height: 100%; flex-shrink: 0; scroll-snap-align: start; display: flex; flex-direction: column; justify-content: space-between; align-items: center; padding: 20px; box-sizing: border-box; }
        .home-screen-page-indicators { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; z-index: 5; }
        .home-screen-page-indicators .dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(255,255,255,0.4); transition: background 0.3s; }
        .home-screen-page-indicators .dot.active { background: white; }
        
        .home-screen-time-container { 
            text-align: center; 
            color: var(--home-screen-font-color); 
            text-shadow: 0 1px 5px rgba(0,0,0,0.3); 
            margin-top: 40px;
            margin-bottom: 10px; 
        }
        .home-screen-time-container .time { font-size: 50px; font-weight: 300; }
        .home-screen-time-container .date { font-size: 18px; font-weight: 400; margin-top: 2px; }
        .home-screen-widgets-container { display: grid; grid-template-columns: 2fr 1fr; grid-template-rows: auto auto; gap: 10px; width: 100%; margin-bottom: 20px; }
        .widget-card { background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); border-radius: 15px; padding: 10px; color: #333; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #home-screen-music-player-widget { grid-column: 1 / 2; grid-row: 1 / 2; display: flex; align-items: center; gap: 10px; }
        #home-screen-music-player-widget .cover { width: 50px; height: 50px; border-radius: 8px; flex-shrink: 0; }
        #home-screen-music-player-widget .info { flex: 1; overflow: hidden; }
        #home-screen-music-player-widget .info .title { font-weight: bold; font-size: 14px; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
        #home-screen-music-player-widget .info .artist { font-size: 12px; }
        #home-screen-music-player-widget .controls i { cursor: pointer; margin-left: 5px; }
        #home-screen-custom-text-widget { grid-column: 2 / 3; grid-row: 1 / 2; font-size: 12px; line-height: 1.4; }
        #home-screen-anniversary-widget { grid-column: 1 / 3; grid-row: 2 / 3; }
        #home-screen-countdown-widget { grid-column: 1 / 3; grid-row: 3 / 4; }
        .anniversary-widget-content { display: flex; align-items: center; gap: 10px; }
        .anniversary-widget-content .bg-image { width: 50px; height: 50px; border-radius: 8px; background-size: cover; background-position: center; flex-shrink: 0; }
        .anniversary-widget-content .text { font-size: 13px; }
        .app-grid { display: grid; grid-template-columns: repeat(4, 1fr); grid-auto-rows: min-content; gap: var(--app-icon-gap); padding: 20px; width: 100%; }
        .app-icon { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; text-align: center; }
        .app-icon .icon-bg { width: var(--app-icon-size); height: var(--app-icon-size); border-radius: var(--app-icon-radius); background-size: cover; background-position: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .app-icon .app-name { font-size: 12px; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        
        /* --- 第二、三页屏小组件 --- */
        #home-screen-widgets-container-p2, #home-screen-widgets-container-p3 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 100%; margin-bottom: 20px; }
        .widget-calendar { grid-column: 1 / 5; height: 260px; background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); border-radius: 15px; padding: 15px; color: #333; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .widget-calendar .header { display: flex; justify-content: space-between; align-items: center; font-weight: bold; margin-bottom: 10px; }
        .widget-calendar table { width: 100%; border-collapse: collapse; text-align: center; font-size: 12px; }
        .widget-calendar th { padding-bottom: 8px; color: #888; }
        .widget-calendar td { padding: 4px 0; }
        .widget-calendar .today { background: var(--wechat-green); color: white; border-radius: 50%; }
        .widget-calendar .other-month { color: #ccc; }
        .widget-image-changer { grid-column: 1 / 3; height: 150px; background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); cursor: pointer; background-size: cover; background-position: center; }
        .widget-location { grid-column: 3 / 5; height: 150px; background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; cursor: pointer; background-size: cover; background-position: center; }
        .widget-location i { font-size: 32px; color: var(--wechat-blue); text-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .widget-location span { font-size: 14px; font-weight: 500; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5); background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 5px; }


        /* --- 聊天气泡分离样式 --- */
        .message-bubble { position: relative; padding: 10px 14px; font-size: var(--font-size-base); line-height: 1.4; max-width: calc(var(--phone-width) - 120px); word-break: break-word; border-radius: 6px; user-select: none; color: var(--global-font-color); }
        .message-row.sent .message-bubble.text-bubble { background: #96d35f; color: #000; }
        .message-row.received .message-bubble.text-bubble { background: #ffffff; color: #000; }
        .message-row.sent .message-bubble.text-bubble::after { content: ""; position: absolute; right: -6px; top: 12px; width: 8px; height: 12px; background: #96d35f; clip-path: polygon(0 0, 100% 50%, 0 100%); }
        .message-row.received .message-bubble.text-bubble::after { content: ""; position: absolute; left: -6px; top: 12px; width: 8px; height: 12px; background: #ffffff; clip-path: polygon(100% 0, 0 50%, 100% 100%); }
        .message-bubble.image-bubble, .message-bubble.sticker-bubble { padding: 0; background: transparent !important; border-radius: 8px; overflow: hidden; }
        .message-bubble.image-bubble img, .message-bubble.sticker-bubble img { max-width: 150px; border-radius: 6px; display: block; }
        .message-bubble.sticker-bubble img { max-width: 120px; }
        .message-bubble.image-bubble::after, .message-bubble.sticker-bubble::after { display: none; }
        
        .message-bubble.voice-bubble { display: flex; align-items: center; gap: 8px; min-width: 80px; cursor: pointer; }
        .voice-bubble-content { display: flex; align-items: center; gap: 10px; }
        .voice-bubble-content .waveform { display: flex; align-items: center; height: 20px; overflow: hidden; }
        .voice-bubble-content .bar { 
            width: 3px; 
            height: 4px; 
            margin: 0 1.5px; 
            border-radius: 2px; 
            animation: wave 1.2s ease-in-out infinite alternate;
        }
        .message-row.sent .voice-bubble-content .bar { background-color: #000; }
        .message-row.received .voice-bubble-content .bar { background-color: var(--global-font-color); }
        @keyframes wave { 0% { transform: scaleY(0.2); } 50% { transform: scaleY(1); } 100% { transform: scaleY(0.2); } }
        .voice-bubble-content .bar:nth-child(1) { animation-delay: 0.2s; }
        .voice-bubble-content .bar:nth-child(2) { animation-delay: 0s; }
        .voice-bubble-content .bar:nth-child(3) { animation-delay: 0.3s; }
        .voice-bubble-content .bar:nth-child(4) { animation-delay: 0.1s; }
        .voice-bubble-content .bar:nth-child(5) { animation-delay: 0.4s; }
        .voice-bubble-content .bar:nth-child(6) { animation-delay: 0.2s; }
        .voice-bubble-content .bar:nth-child(7) { animation-delay: 0.5s; }
        .voice-bubble-content .bar:nth-child(8) { animation-delay: 0.3s; }
        .voice-bubble-content .bar:nth-child(9) { animation-delay: 0.1s; }
        .voice-bubble-content .bar:nth-child(10) { animation-delay: 0.4s; }
        .voice-bubble-content .duration { font-size: 14px; }
        .message-row.sent .voice-bubble-content .duration { color: #000; }
        .message-row.received .voice-bubble-content .duration { color: var(--wechat-text-secondary); }
        .message-row.sent .voice-bubble-content { flex-direction: row-reverse; }

        /* 文件气泡优化 */
        .file-bubble {
            background-color: #fff;
            color: var(--global-font-color);
            border: 1px solid #eee;
            width: 240px;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }
        body.dark-mode .file-bubble {
            background-color: var(--wechat-nav-bg);
            border-color: var(--wechat-border-color);
        }
        .file-bubble .file-icon {
            font-size: 36px;
            color: #999;
            width: 40px;
            text-align: center;
        }
        .file-bubble .file-details {
            flex: 1;
            overflow: hidden;
        }
        .file-bubble .file-name {
            font-size: 15px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .file-bubble .file-size {
            font-size: 12px;
            color: var(--wechat-text-secondary);
            margin-top: 4px;
        }

        .transfer-bubble, .redpacket-bubble { background-color: var(--special-orange-bg); color: white; width: 230px; border-radius: 8px; padding: 12px; display: flex; flex-direction: column; cursor: pointer; }
        .transfer-bubble .main, .redpacket-bubble .main { display: flex; align-items: center; gap: 10px; }
        .transfer-bubble .icon, .redpacket-bubble .icon { font-size: 36px; color: white; }
        .transfer-bubble .details, .redpacket-bubble .details { display: flex; flex-direction: column; flex: 1; }
        .transfer-bubble .amount, .redpacket-bubble .amount { font-size: 18px; font-weight: 500; color: white; }
        .transfer-bubble .remark, .redpacket-bubble .remark { font-size: 14px; color: white; margin-top: 2px; }
        .transfer-bubble .footer, .redpacket-bubble .footer { font-size: 12px; color: white; padding-top: 8px; margin-top: 8px; border-top: 1px solid rgba(255, 255, 255, 0.3); }
        
        .kinship-card-bubble {
            background-color: var(--special-orange-bg);
            color: white;
            width: 230px;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            cursor: pointer;
        }
        .kinship-card-bubble .main {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .kinship-card-bubble .icon {
            font-size: 36px;
            color: white;
        }
        .kinship-card-bubble .details {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        .kinship-card-bubble .title {
            font-size: 16px;
            font-weight: 500;
        }
        .kinship-card-bubble .subtext {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 4px;
        }
        .kinship-card-bubble .footer {
            font-size: 12px;
            color: white;
            padding-top: 8px;
            margin-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
        }

        .gift-bubble { background-color: #fff; border: 1px solid #f0f0f0; width: 240px; border-radius: 8px; padding: 12px; display: flex; align-items: center; gap: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .gift-bubble .icon { font-size: 40px; color: #FFB347; }
        .gift-bubble .details { flex: 1; }
        .gift-bubble .details .name { font-size: 16px; font-weight: 500; color: var(--global-font-color); }
        .gift-bubble .details .desc { font-size: 13px; color: var(--wechat-text-secondary); margin-top: 4px; }
        body.dark-mode .gift-bubble { background-color: #2c2c2e; border-color: #3a3a3c; }
        .forwarded-message-bubble { background: #fff; color: var(--global-font-color); padding: 10px 14px; border-radius: 6px; border: 0.5px solid var(--wechat-border-color); max-width: calc(var(--phone-width) - 120px); word-break: break-word; cursor: pointer; display: flex; flex-direction: column; align-items: flex-start; gap: 4px; }
        .forwarded-message-bubble .forward-title { font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 4px; margin-bottom: 4px; width: 100%; }
        .forwarded-message-bubble .forward-content-preview { font-size: 13px; color: var(--wechat-text-secondary); }
        body.dark-mode .forwarded-message-bubble { background: var(--wechat-nav-bg); border-color: var(--wechat-border-color); }
        body.dark-mode .forwarded-message-bubble .forward-title { border-bottom-color: var(--wechat-border-color); }
        .receipt-bubble { background-color: #fff; border: 1px solid #f0f0f0; width: 260px; border-radius: 8px; padding: 0; overflow: hidden; font-family: monospace; }
        .receipt-bubble .header { background: #333; color: white; padding: 8px 12px; font-weight: bold; display: flex; justify-content: space-between; }
        .receipt-bubble .items { padding: 12px; font-size: 13px; line-height: 1.6; border-bottom: 1px dashed #ccc; }
        .receipt-bubble .item-row { display: flex; justify-content: space-between; }
        .receipt-bubble .total { padding: 10px 12px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .receipt-bubble .footer { font-size: 12px; color: #999; text-align: center; padding: 8px; background: #fafafa; }
        body.dark-mode .receipt-bubble { background-color: #2c2c2e; border-color: #3a3a3c; }
        body.dark-mode .receipt-bubble .header { background: #111; }
        body.dark-mode .receipt-bubble .footer { background: #222; }
        .netease-share-bubble {
            background-color: #fff;
            color: #000;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #eee;
            width: 250px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .netease-share-bubble .share-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #555;
        }
        .netease-share-bubble .share-header img {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        .netease-share-bubble .share-content {
            font-size: 14px;
            line-height: 1.4;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        body.dark-mode .netease-share-bubble {
            background-color: var(--wechat-nav-bg);
            color: var(--global-font-color);
            border-color: var(--wechat-border-color);
        }
        body.dark-mode .netease-share-bubble .share-header {
            color: var(--wechat-text-secondary);
        }

        .offline-plot-container {
            padding: var(--offline-plot-bubble-padding);
            background-color: var(--offline-plot-bubble-bg);
            border-radius: var(--offline-plot-bubble-radius);
            box-shadow: var(--offline-plot-bubble-shadow);
            height: 100%;
            overflow-y: auto;
            font-family: var(--offline-plot-font-family);
            font-size: var(--offline-plot-font-size);
            line-height: var(--offline-plot-line-height);
            white-space: pre-wrap;
            word-break: break-word;
        }
        .offline-plot-container .char-narration {
            color: var(--offline-plot-char-narration-color);
            font-style: var(--offline-plot-char-narration-style);
            font-weight: var(--offline-plot-char-narration-weight);
        }
        .offline-plot-container .user-narration {
            color: var(--offline-plot-user-narration-color);
            font-style: var(--offline-plot-user-narration-style);
            font-weight: var(--offline-plot-user-narration-weight);
        }
        .offline-plot-container .char-quote {
            color: var(--offline-plot-char-quote-color);
            font-style: var(--offline-plot-char-quote-style);
            font-weight: var(--offline-plot-char-quote-weight);
        }
        .offline-plot-container .user-quote {
            color: var(--offline-plot-user-quote-color);
            font-style: var(--offline-plot-user-quote-style);
            font-weight: var(--offline-plot-user-quote-weight);
        }

        /* 其他通用样式 */
        .list-item { display: flex; align-items: center; padding: 10px 15px; gap: 12px; border-bottom: 0.5px solid var(--wechat-border-color); cursor: pointer; position: relative; background-color: var(--wechat-nav-bg); }
        .list-item:active { background-color: var(--wechat-bg); }
        .list-item .avatar { width: 48px; height: 48px; border-radius: var(--avatar-shape); object-fit: cover; }
        .list-item .details { flex: 1; overflow: hidden; }
        .list-item .details .name { font-size: var(--font-size-base); color: var(--global-font-color); display: flex; align-items: center; gap: 5px; }
        .list-item .details .name .fa-star { color: #FFC300; font-size: 12px; }
        .list-item .details .subtext { font-size: calc(var(--font-size-base) - 2px); color: var(--wechat-text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .list-item .info { text-align: right; font-size: calc(var(--font-size-base) - 3px); color: var(--wechat-text-secondary); }
        .list-divider { height: 8px; background-color: var(--wechat-bg); }
        .list-item .chevron { position: absolute; right: 15px; color: var(--wechat-text-secondary); }
        .list-item.pinned { background-color: #F5F5F5; }
        body.dark-mode .list-item.pinned { background-color: #2A2A2A; }
        #me-page .content-area { padding-top: 20px; }
        .me-profile-card { display: flex; align-items: center; gap: 20px; padding: 40px 20px 30px; background-color: var(--wechat-nav-bg); cursor: pointer; }
        .me-profile-card .avatar { width: 64px; height: 64px; border-radius: var(--avatar-shape); }
        .me-profile-card .details { flex: 1; }
        .me-profile-card .details .name { font-size: calc(var(--font-size-base) + 7px); font-weight: 600; margin-bottom: 5px; color: var(--global-font-color); }
        .me-profile-card .details .wxid { color: var(--wechat-text-secondary); font-size: var(--font-size-base); }
        .me-profile-card .details .signature { font-size: calc(var(--font-size-base) - 1px); color: var(--wechat-text-secondary); margin-top: 5px; }
        .me-profile-card .qr-code { font-size: 20px; color: var(--wechat-text-secondary); }
        .me-menu-item { padding: 15px 20px; display: flex; align-items: center; gap: 20px; background-color: var(--wechat-nav-bg); cursor: pointer; }
        .me-menu-item:active { background-color: var(--wechat-bg); }
        .me-menu-item .ui-icon { width: 24px; height: 24px; background-size: contain; background-repeat: no-repeat; background-position: center; }
        .me-menu-item span { flex: 1; font-size: var(--font-size-base); color: var(--global-font-color); }
        #conversation-page .content-area { background-color: var(--wechat-bg); padding: 10px; display: flex; flex-direction: column; background-image: var(--chat-background-image); background-size: cover; background-position: center; position: relative; }
        .message-row { display: flex; flex-direction: column; margin-bottom: 5px; max-width: 100%; }
        .message-timestamp { text-align: center; color: var(--wechat-text-secondary); font-size: calc(var(--font-size-base) - 3px); margin: 10px 0; }
        .message-recalled, .message-system { text-align: center; color: var(--wechat-text-secondary); font-size: calc(var(--font-size-base) - 3px); margin: 10px 0; background: rgba(0,0,0,0.1); padding: 4px 8px; border-radius: 4px; display: inline-block; align-self: center; }
        .message-body { display: flex; align-items: flex-start; gap: 10px; }
        .message-row.sent { align-items: flex-end; }
        .message-row.sent .message-body { flex-direction: row-reverse; }
        .message-avatar-wrapper { position: relative; flex-shrink: 0; }
        .message-avatar { width: 40px; height: 40px; border-radius: var(--avatar-shape); cursor: pointer; }
        .avatar-frame { position: absolute; top: -5px; left: -5px; width: 50px; height: 50px; background-size: contain; background-repeat: no-repeat; pointer-events: none; }
        .message-row.sent .avatar-frame { background-image: var(--user-avatar-frame); }
        .message-row.received .avatar-frame { background-image: var(--char-avatar-frame); }
        .message-content-wrapper { display: flex; flex-direction: column; position: relative; }
        .message-row.sent .message-content-wrapper { align-items: flex-end; }
        .message-row.received .message-content-wrapper { align-items: flex-start; }
        /* ★★★ 新增：群聊头衔样式 ★★★ */
        .message-sender-name {
            font-size: 12px;
            color: var(--wechat-text-secondary);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .group-title-badge {
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 4px;
            color: white;
        }
        .group-title-badge.owner { background-color: var(--group-title-owner-color); }
        .group-title-badge.admin { background-color: var(--group-title-admin-color); }
        .group-title-badge.special { background-color: var(--group-title-special-color); }
        .group-title-badge.normal { background-color: var(--group-title-normal-color); }
        .message-bubble .quoted-message { background: rgba(0,0,0,0.05); padding: 5px 8px; border-radius: 4px; margin-bottom: 5px; border-left: 2px solid #ccc; font-size: calc(var(--font-size-base) - 2px); color: var(--wechat-text-secondary); }
        body.dark-mode .message-bubble .quoted-message { background: rgba(255,255,255,0.1); border-left-color: #555; }
        .message-bubble .quoted-message p { margin: 0; }
        .message-bubble.camera-sim-bubble { background: transparent; padding: 0; cursor: pointer; }
        .camera-sim-bubble img { width: 150px; display: block; }
        .message-bubble.location-bubble { background: #fff; padding: 0; display: flex; flex-direction: column; border: 0.5px solid #eee; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); width: 250px; overflow: hidden; }
        .location-bubble .location-text-wrapper { padding: 10px; }
        .location-bubble .location-text { font-size: var(--font-size-base); color: var(--global-font-color); word-break: break-all; }
        .location-bubble .map-placeholder { height: 100px; width: 100%; background-color: #f0f0f0; display: flex; justify-content: center; align-items: center; color: #aaa; font-size: 40px; }
        .translated-text-bubble, .voice-transcribed-bubble { background: var(--wechat-nav-bg); color: var(--global-font-color); padding: 10px 14px; border-radius: 6px; margin-top: 5px; font-size: calc(var(--font-size-base) - 1px); border: 0.5px solid var(--wechat-border-color); max-width: calc(var(--phone-width) - 120px); word-break: break-word; position: relative; cursor: pointer; }
        .translated-text-bubble::before { content: '[译文]'; font-weight: bold; color: var(--wechat-blue); margin-right: 5px; }
        .music-bubble { background: #fff; color: var(--global-font-color); padding: 10px 14px; border-radius: 6px; border: 0.5px solid var(--wechat-border-color); max-width: calc(var(--phone-width) - 120px); word-break: break-word; cursor: pointer; }
        body.dark-mode .music-bubble { background: var(--wechat-nav-bg); border-color: var(--wechat-border-color); }
        .music-bubble { display: flex; align-items: center; gap: 10px; }
        .music-bubble img { width: 40px; height: 40px; border-radius: 4px; }
        .music-bubble .details { flex: 1; }
        .music-bubble .details .title { font-weight: 500; }
        .music-bubble .details .artist { font-size: 12px; color: var(--wechat-text-secondary); }
        .html-content-bubble { padding: 5px; background: #fff; }
        .html-content-iframe { width: 260px; height: 560px; border: none; resize: both; overflow: auto; }
        .message-timestamp-under { font-size: calc(var(--font-size-base) - 3px); color: var(--wechat-text-secondary); margin-top: 4px; }
        .message-timestamp-inside { font-size: 10px; opacity: 0.7; margin-top: 5px; color: inherit; }
        .message-row.sent .message-bubble .message-timestamp-inside { color: #000; }
        .chat-input-bar { display: flex; align-items: center; padding: 8px 10px; gap: 10px; background: var(--wechat-nav-bg); border-top: 0.5px solid var(--wechat-border-color); position: relative; }
        .chat-input-bar input { flex: 1; padding: 8px 12px; border: none; background: var(--wechat-bg); border-radius: 6px; font-size: var(--font-size-base); color: var(--global-font-color); }
        .chat-input-bar .ui-icon { width: 28px; height: 28px; cursor: pointer; filter: grayscale(1) brightness(1.5); -webkit-filter: grayscale(1) brightness(1.5); }
        .chat-plus-menu { position: absolute; bottom: 50px; left: 0; right: 0; background: var(--wechat-bg); display: none; grid-template-columns: repeat(4, 1fr); padding: 20px; gap: 20px; z-index: 10; border-top: 0.5px solid var(--wechat-border-color); }
        .plus-menu-item { display: flex; flex-direction: column; align-items: center; gap: 8px; font-size: calc(var(--font-size-base) - 3px); color: var(--wechat-text-secondary); cursor: pointer; }
        .plus-menu-item .icon { width: 56px; height: 56px; background: var(--wechat-nav-bg); border-radius: 12px; display: flex; justify-content: center; align-items: center; border: 0.5px solid var(--wechat-border-color); }
        .plus-menu-item .icon .ui-icon { width: 28px; height: 28px; filter: none; -webkit-filter: none; }
        .message-context-menu { position: fixed; background: #4c4c4c; color: white; border-radius: 8px; padding: 5px; display: none; z-index: 1100; }
        .context-menu-item { padding: 8px 15px; cursor: pointer; white-space: nowrap; position: relative; font-size: var(--font-size-base); }
        .context-menu-item:hover { background: #666; }
        .context-submenu { display: none; position: absolute; left: 100%; top: 0; background: #4c4c4c; border-radius: 8px; padding: 5px; }
        .context-menu-item:hover .context-submenu { display: block; }
        .multi-select-toolbar { position: fixed; bottom: 0; left: 0; right: 0; height: 50px; background: var(--wechat-nav-bg); border-top: 0.5px solid var(--wechat-border-color); display: none; justify-content: space-around; align-items: center; z-index: 1002; }
        .multi-select-toolbar.active { display: flex; }
        .multi-select-toolbar button { background: none; border: none; font-size: 16px; color: var(--global-font-color); cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .multi-select-toolbar button i { font-size: 18px; }
        .multi-select-toolbar button:disabled { color: var(--wechat-text-secondary); cursor: not-allowed; }
        .message-row.multi-select-mode .message-body::before { content: ''; display: block; width: 20px; height: 20px; border: 1px solid #ccc; border-radius: 50%; margin-right: 10px; align-self: center; flex-shrink: 0; }
        .message-row.multi-select-mode.selected .message-body::before { background-color: var(--wechat-green); border-color: var(--wechat-green); background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='white' d='M12.207 4.793a1 1 0 0 1 0 1.414l-5 5a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L6.5 9.086l4.293-4.293a1 1 0 0 1 1.414 0z'/%3e%3c/svg%3e"); background-position: center; background-repeat: no-repeat; }
        .message-row.sent.multi-select-mode .message-body { flex-direction: row; }
        .message-row.sent.multi-select-mode .message-body::before { margin-left: 10px; margin-right: 0; order: 2; }
        .message-row.sent.multi-select-mode .message-body .message-avatar-wrapper { order: 3; }
        .message-row.sent.multi-select-mode .message-body .message-content-wrapper { order: 1; }
        .form-page .content-area { padding: 15px; background-color: var(--wechat-bg); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-size: calc(var(--font-size-base) - 1px); color: var(--wechat-text-secondary); }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid var(--wechat-border-color); border-radius: 8px; font-size: var(--font-size-base); box-sizing: border-box; background: var(--wechat-nav-bg); color: var(--global-font-color); }
        .form-group textarea { min-height: 200px; resize: vertical; }
        .form-btn { display: block; width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 17px; font-weight: 500; cursor: pointer; background-color: var(--wechat-green); color: white; text-align: center; margin-top: 20px; }
        .file-input { display: none; }
        .avatar-upload-preview { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; cursor: pointer; display: block; margin: 0 auto 20px; border: 1px solid var(--wechat-border-color); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--wechat-nav-bg); padding: 20px; border-radius: 12px; width: 85%; max-width: 320px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color: var(--global-font-color); }
        .modal-title { font-size: 18px; font-weight: bold; text-align: center; margin-bottom: 20px; }
        .modal-input-group { margin-bottom: 15px; }
        .modal-input-group label { font-size: calc(var(--font-size-base) - 1px); color: var(--wechat-text-secondary); }
        .modal-input { width: 100%; padding: 10px; border: 1px solid var(--wechat-border-color); border-radius: 6px; box-sizing: border-box; font-size: var(--font-size-base); background: var(--wechat-bg); color: var(--global-font-color); }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .modal-btn { flex: 1; padding: 10px; border-radius: 6px; border: 1px solid var(--wechat-border-color); background: var(--wechat-bg); cursor: pointer; font-size: var(--font-size-base); color: var(--global-font-color); }
        .modal-btn.primary { background: var(--wechat-green); color: #fff; border-color: var(--wechat-green); }
        #wallet-page .content-area { background-color: var(--wechat-bg); padding: 0; }
        .wallet-header { background-color: #63B466; color: white; padding: 30px 20px; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; }
        body.dark-mode .wallet-header { background-color: #2E7D32; }
        .wallet-balance-title { font-size: calc(var(--font-size-base) - 1px); opacity: 0.8; display: flex; align-items: center; gap: 10px; }
        .wallet-balance-title .currency-switcher { cursor: pointer; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; }
        .wallet-balance { font-size: calc(var(--font-size-base) + 25px); font-weight: bold; margin: 10px 0; word-break: break-all; }
        .wallet-services-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background-color: var(--wechat-border-color); margin: 20px; border-radius: 8px; overflow: hidden; }
        .wallet-service-item { background-color: var(--wechat-nav-bg); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px 0; cursor: pointer; gap: 8px; }
        .wallet-service-item:active { background-color: var(--wechat-bg); }
        .wallet-service-item i { font-size: 28px; color: var(--wechat-green); }
        .wallet-service-item p { margin: 0; font-size: calc(var(--font-size-base) - 1px); color: var(--global-font-color); }
        #sticker-page .content-area { padding: 10px; }
        .sticker-pack { margin-bottom: 15px; }
        .sticker-pack-title { font-weight: bold; margin-bottom: 10px; padding: 0 5px; color: var(--global-font-color); }
        .sticker-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; }
        .sticker-item { background: var(--wechat-nav-bg); border-radius: 8px; padding: 5px; cursor: pointer; display: flex; justify-content: center; align-items: center; aspect-ratio: 1 / 1; position: relative; }
        .sticker-item img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .sticker-item .delete-checkbox { position: absolute; top: 5px; right: 5px; width: 20px; height: 20px; display: none; }
        #sticker-page.selection-mode .sticker-item .delete-checkbox { display: block; }
        #sticker-page.selection-mode .sticker-item { border: 2px solid transparent; }
        #sticker-page.selection-mode .sticker-item.selected { border-color: var(--wechat-green); }
        #moments-page .content-area { background-color: var(--wechat-bg); padding-top: 0; }
        .moments-header-bg { height: 300px; background-size: cover; background-position: center; position: relative; cursor: pointer; }
        .moments-user-info { position: absolute; bottom: -20px; right: 20px; display: flex; align-items: center; gap: 15px; }
        .moments-user-info .name { color: white; font-size: 18px; font-weight: bold; text-shadow: 1px 1px 2px #000; }
        .moments-user-info .avatar { width: 70px; height: 70px; border-radius: var(--avatar-shape); border: 2px solid white; }
        .moments-signature { position: absolute; bottom: -45px; right: 105px; color: #ccc; font-size: 14px; text-shadow: 1px 1px 2px #000; max-width: 200px; text-align: right; }
        .moment-post { padding: 15px; border-bottom: 8px solid var(--wechat-bg); display: flex; gap: 10px; margin-top: 40px; background-color: var(--wechat-nav-bg); }
        .moment-post .avatar { width: 42px; height: 42px; border-radius: var(--avatar-shape); flex-shrink: 0; }
        .moment-post .post-content { flex: 1; }
        .moment-post .post-author { color: var(--wechat-blue); font-weight: 600; font-size: var(--font-size-base); }
        .moment-post .post-text { margin: 5px 0; font-size: var(--font-size-base); line-height: 1.5; white-space: pre-wrap; word-break: break-word; color: var(--global-font-color); }
        .moment-post .post-media { margin-top: 8px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .moment-post .post-media img, .moment-post .post-media video { width: 100%; height: 100px; object-fit: cover; border-radius: 6px; }
        .moment-post .post-media audio { width: 100%; margin-top: 5px; }
        .moment-post .post-media .file-display { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; padding: 10px; background: var(--wechat-bg); border-radius: 6px; height: 100px; text-align: center; }
        .moment-post .post-media .file-display i { font-size: 24px; }
        .moment-post .post-media .file-display span { font-size: 12px; word-break: break-all; }
        .moment-post .post-meta { display: flex; justify-content: space-between; align-items: center; color: var(--wechat-text-secondary); font-size: calc(var(--font-size-base) - 2px); margin-top: 10px; }
        .moment-post .post-actions i { font-size: 20px; cursor: pointer; margin-left: 15px; }
        .moment-post .post-interactions { background: var(--wechat-bg); margin-top: 8px; border-radius: 4px; font-size: calc(var(--font-size-base) - 1px); }
        .moment-post .post-likes { padding: 8px 12px; border-bottom: 1px solid var(--wechat-border-color); color: var(--wechat-blue); }
        .moment-post .post-likes i { margin-right: 5px; }
        .moment-post .post-comments { padding: 8px 12px; }
        .moment-comment { margin-bottom: 3px; color: var(--global-font-color); cursor: pointer; }
        .moment-comment .comment-author { color: var(--wechat-blue); font-weight: 600; }
        .switch { position: relative; display: inline-block; width: 51px; height: 31px; }
        .switch input { opacity: 0; width: 0; height: 0; }
 .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--wechat-green); }
        input:checked + .slider:before { transform: translateX(20px); }
        #create-group-chat-page .selected-contacts-preview { display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border-bottom: 1px solid var(--wechat-border-color); }
        #create-group-chat-page .selected-contacts-preview .avatar { width: 40px; height: 40px; border-radius: var(--avatar-shape); }
        #create-group-chat-page .contact-selection-list .list-item { padding: 8px 15px; }
        #create-group-chat-page .contact-selection-list .list-item input[type="checkbox"] { width: 20px; height: 20px; margin-right: 10px; }
        #create-group-chat-page .contact-selection-list .list-item .details { flex: 1; }
        #create-group-chat-page .contact-selection-list .list-item .details .name { font-size: var(--font-size-base); }
        #create-group-chat-page .contact-selection-list .list-item .avatar { width: 36px; height: 36px; }
        #group-member-management-page .group-member-list .list-item { justify-content: space-between; }
        #group-member-management-page .group-member-list .list-item .member-actions button { padding: 5px 10px; border: 1px solid var(--wechat-border-color); border-radius: 4px; background: var(--wechat-bg); cursor: pointer; color: var(--global-font-color); }
        #music-player-page .content-area { display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: #222; color: white; padding: 20px; text-align: center; background-image: var(--player-background); background-size: cover; background-position: center; position: relative; }
        #music-player-page .content-area::before { content: ''; position: absolute; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); }
        #music-player-page .content-area > * { z-index: 1; }
        .music-cover { width: 250px; height: 250px; border-radius: 50%; margin-bottom: 20px; animation: rotate 20s linear infinite; animation-play-state: paused; background-image: var(--player-image); background-size: cover; background-position: center; border: 5px solid rgba(255,255,255,0.1); }
        .music-cover.playing { animation-play-state: running; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .music-info h3 { margin: 10px 0 5px; font-size: calc(var(--font-size-base) + 5px); }
        .music-info p { margin: 0; font-size: calc(var(--font-size-base) - 1px); color: #aaa; }
        .music-controls { display: flex; gap: 30px; margin-top: 30px; align-items: center; }
        .music-controls i { font-size: 36px; cursor: pointer; opacity: 0.8; transition: opacity 0.2s; }
        .music-controls i:hover { opacity: 1; }
        .music-controls .fa-play-circle, .music-controls .fa-pause-circle { font-size: 50px; }
        .music-progress { width: 80%; height: 4px; background: #555; margin-top: 20px; position: relative; border-radius: 2px; cursor: pointer; }
        .music-progress-bar { height: 100%; width: 0%; background: var(--wechat-green); border-radius: 2px; }
        .music-mode-toggle { font-size: 20px; margin-top: 20px; cursor: pointer; }
        #diary-page .content-area { background-image: url('https://img.heliar.top/file/1764077275005_Screenshot_2025_1125_181250.png'); background-size: cover; padding: 25px; font-family: 'DiaryFont', serif; color: #3a2e28; line-height: 1.8; font-size: 17px; white-space: pre-wrap; }
        .delivery-search-bar { padding: 10px; }
        .delivery-search-bar input { width: 100%; padding: 10px; border-radius: 20px; border: 1px solid var(--wechat-border-color); box-sizing: border-box; }
        .food-list, .gift-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 10px; }
        .food-item { display: flex; flex-direction: column; background: var(--wechat-nav-bg); border-radius: 8px; overflow: hidden; cursor: pointer; }
        .food-item img { width: 100%; height: 100px; object-fit: cover; }
        .food-item .info { padding: 10px; flex: 1; display: flex; flex-direction: column; }
        .food-item .name { font-weight: 500; flex: 1; }
        .food-item .price { color: var(--wechat-red); font-weight: bold; margin-top: 5px; }
        .food-item .add-btn { background: var(--wechat-green); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 20px; cursor: pointer; align-self: flex-end; }
        .bottom-nav { display: flex; border-top: 1px solid var(--wechat-border-color); background: var(--wechat-nav-bg); }
        .bottom-nav .nav-item { flex: 1; text-align: center; padding: 8px 0; cursor: pointer; color: var(--wechat-text-secondary); }
        .bottom-nav .nav-item.active { color: var(--wechat-green); }
        .bottom-nav .nav-item i { font-size: 20px; display: block; margin-bottom: 2px; }
        .bottom-nav .nav-item span { font-size: 10px; }
        .order-list { padding: 10px; }
        .order-item { background: var(--wechat-nav-bg); border-radius: 8px; margin-bottom: 10px; }
        .order-item .header { padding: 10px; display: flex; justify-content: space-between; border-bottom: 1px solid var(--wechat-border-color); }
        .order-item .body { padding: 10px; font-family: monospace; font-size: 12px; }
        .order-item .footer { padding: 10px; text-align: right; font-weight: bold; }
        #voice-call-page { background-color: #333; color: white; z-index: 500; }
        .voice-call-container { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; background-size: cover; background-position: center; }
        .voice-call-container::before { content: ''; position: absolute; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(20px); }
        .voice-call-container > * { z-index: 1; }
        .voice-call-header { text-align: center; margin-bottom: 30px; }
        .voice-call-header .avatar { width: 100px; height: 100px; border-radius: var(--avatar-shape); margin-bottom: 15px; }
        .voice-call-header .name { font-size: 24px; font-weight: 500; }
        .voice-call-status { font-size: 16px; color: #ccc; margin-top: 10px; }
        .voice-call-chat-area { width: 90%; height: 200px; overflow-y: auto; margin-bottom: 20px; padding: 10px; border-radius: 8px; background: rgba(255,255,255,0.1); font-size: 14px; line-height: 1.6; }
        .voice-call-chat-area p { margin: 0 0 5px; }
        .voice-call-input-bar { width: 90%; display: flex; gap: 10px; }
        .voice-call-input-bar input { flex: 1; padding: 12px; border-radius: 20px; border: none; background: rgba(255,255,255,0.2); color: white; }
        .voice-call-controls { position: absolute; bottom: 40px; display: flex; gap: 40px; }
        .voice-call-controls .control-btn { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; }
        .voice-call-controls .icon-wrapper { width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 28px; }
        .voice-call-controls .hangup { background: var(--wechat-red); }
        .voice-call-controls .minimize { background: rgba(255,255,255,0.2); }
        .minimized-call-window { position: fixed; top: 60px; right: 15px; width: 210px; height: 130px; background: #333; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 1001; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 5px; color: white; cursor: pointer; padding: 10px; box-sizing: border-box; }
        .minimized-call-window .avatar { width: 40px; height: 40px; border-radius: 50%; }
        .minimized-call-window .status { font-size: 12px; }
        .bank-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; padding: 20px; margin: 15px; position: relative; box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
        .bank-card .bank-name { font-size: 18px; font-weight: bold; }
        .bank-card .card-number { font-family: monospace; font-size: 20px; margin: 20px 0; letter-spacing: 2px; }
        .bank-card .card-balance { font-size: 16px; }
        .add-card-btn { border: 2px dashed var(--wechat-border-color); color: var(--wechat-text-secondary); text-align: center; padding: 40px 20px; margin: 15px; border-radius: 12px; cursor: pointer; }

        /* --- 手账记账APP样式 --- */
        #accounting-app-page .content-area {
            --primary-color: #007AFF;
            --background-color: var(--wechat-bg);
            --card-color: var(--wechat-nav-bg);
            --text-color: var(--global-font-color);
            --secondary-text: var(--wechat-text-secondary);
            --success-color: #34C759;
            --warning-color: #FF9500;
            --border-radius: 12px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            background-color: var(--background-color);
            color: var(--text-color);
            padding: 20px;
        }
        #accounting-app-page .accounting-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        #accounting-app-page h1 { font-size: 28px; font-weight: 600; }
        #accounting-app-page .btn {
            background-color: var(--primary-color); color: white; border: none;
            padding: 10px 16px; border-radius: var(--border-radius); font-size: 16px;
            font-weight: 500; cursor: pointer; transition: opacity 0.2s;
        }
        #accounting-app-page .btn:hover { opacity: 0.9; }
        #accounting-app-page .btn:active { opacity: 0.8; }
        #accounting-app-page .card {
            background-color: var(--card-color); border-radius: var(--border-radius);
            padding: 16px; margin-bottom: 16px; box-shadow: var(--shadow);
        }
        #accounting-app-page .radio-group { display: flex; gap: 16px; margin-top: 8px; }
        #accounting-app-page .radio-option { flex: 1; position: relative; }
        #accounting-app-page .radio-option input { position: absolute; opacity: 0; }
        #accounting-app-page .radio-option label {
            display: block; padding: 12px; background-color: var(--card-color);
            border: 1px solid #D1D1D6; border-radius: var(--border-radius);
            text-align: center; cursor: pointer; transition: all 0.2s;
        }
        #accounting-app-page .radio-option input:checked + label {
            background-color: var(--primary-color); color: white; border-color: var(--primary-color);
        }
        #accounting-app-page .transaction-list { list-style: none; padding: 0; }
        #accounting-app-page .transaction-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid var(--wechat-border-color);
        }
        #accounting-app-page .transaction-item:last-child { border-bottom: none; }
        #accounting-app-page .transaction-info { flex: 1; }
        #accounting-app-page .transaction-title { font-size: 16px; font-weight: 500; margin-bottom: 4px; }
        #accounting-app-page .transaction-category { font-size: 14px; color: var(--secondary-text); }
        #accounting-app-page .transaction-amount { font-size: 16px; font-weight: 500; }
        #accounting-app-page .income { color: var(--success-color); }
        #accounting-app-page .expense { color: var(--warning-color); }
        #accounting-app-page .summary { display: flex; justify-content: space-between; margin-bottom: 16px; }
        #accounting-app-page .summary-item {
            flex: 1; text-align: center; padding: 12px; background-color: var(--card-color);
            border-radius: var(--border-radius); margin: 0 8px; box-shadow: var(--shadow);
        }
        #accounting-app-page .summary-title { font-size: 14px; color: var(--secondary-text); margin-bottom: 4px; }
        #accounting-app-page .summary-value { font-size: 20px; font-weight: 600; }
        #accounting-app-page .income-summary { color: var(--success-color); }
        #accounting-app-page .expense-summary { color: var(--warning-color); }
        #accounting-app-page .balance-summary { color: var(--primary-color); }
        #accounting-app-page .empty-state { text-align: center; padding: 40px 0; color: var(--secondary-text); }
        #accounting-app-page .empty-icon { font-size: 48px; margin-bottom: 16px; }

        /* 加载动画 */
        .loader-container { display: flex; justify-content: center; align-items: center; padding: 50px; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--wechat-green); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- 新增/优化APP样式 --- */
        /* 备忘录APP样式 */
        #memo-app-page .app-navigation-bar { display: flex; align-items: center; justify-content: space-between; padding: 0 10px; height: 44px; background-color: var(--wechat-nav-bg); border-bottom: 0.5px solid var(--wechat-border-color); position: sticky; top: 0; z-index: 10; }
        #memo-app-page .app-back-btn { font-size: 17px; display: flex; align-items: center; gap: 2px; cursor: pointer; }
        #memo-app-page .app-title { font-size: 17px; font-weight: 600; position: absolute; left: 50%; transform: translateX(-50%); }
        #memo-app-page .header-button { background: none; border: none; color: var(--wechat-green); font-size: 17px; cursor: pointer; }
        #memo-app-page .search-bar { padding: 10px 15px; background-color: var(--wechat-bg); }
        #memo-app-page .search-input { width: 100%; padding: 8px 12px; border-radius: 8px; border: none; background-color: var(--wechat-nav-bg); color: var(--global-font-color); box-sizing: border-box; }
        #memo-app-page .notes-list { flex: 1; overflow-y: auto; padding: 0 15px; }
        #memo-app-page .note-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 0.5px solid var(--wechat-border-color); cursor: pointer; }
        #memo-app-page .note-title { font-weight: 500; margin-bottom: 4px; }
        #memo-app-page .note-preview { font-size: 14px; color: var(--wechat-text-secondary); }
        #memo-app-page .note-date { font-size: 14px; color: var(--wechat-text-secondary); flex-shrink: 0; margin-left: 10px; }
        #memo-app-page .editor { display: none; flex: 1; }
        #memo-app-page .editor-content { width: 100%; height: 100%; border: none; resize: none; padding: 15px; font-size: 16px; line-height: 1.6; background: transparent; color: var(--global-font-color); box-sizing: border-box; }
        #memo-app-page .toolbar { display: flex; justify-content: space-between; align-items: center; padding: 0 15px; height: 44px; border-top: 0.5px solid var(--wechat-border-color); background-color: var(--wechat-nav-bg); }
        #memo-app-page .toolbar-button { background: none; border: none; color: var(--wechat-green); font-size: 24px; cursor: pointer; }
        #memo-app-page #memo-notes-count { color: var(--wechat-text-secondary); font-size: 14px; }

        /* 在线状态 */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            vertical-align: middle;
        }
        .status-dot.online { background-color: #07C160; }
        .status-dot.offline { background-color: #888888; }

        /* 表情包选择器优化 */
        #sticker-picker-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 0;
            background-color: var(--wechat-bg);
            z-index: 1001;
            transition: height 0.3s ease-out;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #sticker-picker-overlay.half-screen { height: 50%; }
        #sticker-picker-overlay.full-screen { height: 100%; }
        .sticker-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--wechat-border-color);
            flex-shrink: 0;
        }
        .sticker-picker-header .icon-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--wechat-text-secondary);
            cursor: pointer;
        }
        .sticker-picker-content {
            flex: 1;
            overflow-y: auto;
        }
        
        /* 日历APP */
        #calendar-app-page .content-area {
            display: flex;
            flex-direction: column;
            padding: 0;
            background-color: var(--wechat-bg);
        }
        #calendar-app-page .fc {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        #calendar-app-page .fc-toolbar-title { font-size: 1.2em; }
        #calendar-app-page .fc-button {
            background-color: var(--wechat-nav-bg) !important;
            color: var(--global-font-color) !important;
            border: 1px solid var(--wechat-border-color) !important;
            box-shadow: none !important;
        }
        #calendar-app-page .fc-button-primary:not(:disabled).fc-button-active {
            background-color: var(--wechat-green) !important;
            color: white !important;
        }
        #calendar-app-page .fc-daygrid-day.fc-day-today {
            background-color: rgba(7, 193, 96, 0.15) !important;
        }
        #calendar-app-page .fc-event {
            background-color: var(--wechat-blue);
            border-color: var(--wechat-blue);
        }
        body.dark-mode #calendar-app-page .fc-daygrid-day-number,
        body.dark-mode #calendar-app-page .fc-col-header-cell-cushion {
            color: var(--global-font-color);
        }

        /* ★★★ 优化：支付密码弹窗与键盘 ★★★ */
        #payment-password-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }
        .payment-password-modal {
            background: #F0F2F5;
            border-radius: 12px 12px 0 0;
            padding: 20px;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .payment-password-modal .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .payment-password-modal .modal-header .close-btn { font-size: 20px; color: #888; cursor: pointer; }
        .payment-password-modal .modal-title { font-size: 18px; font-weight: 600; }
        .password-input-display {
            display: flex;
            justify-content: center;
            gap: 1px;
            background: white;
            border: 1px solid #D1D9E6;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .password-input-display .digit {
            width: 45px;
            height: 45px;
            text-align: center;
            font-size: 24px;
            line-height: 45px;
            border-right: 1px solid #D1D9E6;
        }
        .password-input-display .digit:last-child { border-right: none; }
        .ins-style-keyboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .ins-style-keyboard .key {
            background: #FFFFFF;
            border: none;
            border-radius: 8px;
            height: 50px;
            font-size: 24px;
            font-weight: 400;
            color: #333;
            cursor: pointer;
            box-shadow: 3px 3px 6px #D1D9E6, -3px -3px 6px #FFFFFF;
            transition: all 0.1s ease-out;
        }
        .ins-style-keyboard .key:active {
            box-shadow: inset 3px 3px 6px #D1D9E6, inset -3px -3px 6px #FFFFFF;
        }
        .ins-style-keyboard .key.special { background: #E2E5E9; }

        .payment-code-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 20px;
        }
        .payment-code-container .qr-code-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 15px;
            border-radius: 8px;
            gap: 10px;
        }
        .payment-code-container .qr-code-wrapper.receive-code { background-color: #07C160; }
        .payment-code-container .qr-code-wrapper.appreciation-code { background-color: #fff; }
        .payment-code-container .qr-code-wrapper.payment-code { background-image: url('https://img.js.design/assets/img/6682b13289a8077b19014168.jpg'); background-size: cover; }
        .payment-code-container .qr-code-wrapper canvas { border: none; }
        .payment-code-container .qr-code-wrapper .qr-avatar {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 4px;
            border: 2px solid white;
            background: white;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .payment-code-container .qr-code-wrapper.payment-code .qr-avatar {
            top: calc(50% + 25px);
        }
        .payment-code-container .barcode-canvas {
            height: 50px;
            width: 200px;
            background: white;
        }

        /* ★★★ 优化：“你说我猜” 游戏样式 ★★★ */
        #guess-word-game-page .content-area {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: var(--wechat-bg);
        }
        .game-card {
            background-color: var(--wechat-nav-bg);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            color: var(--global-font-color);
        }
        .game-card h3 {
            margin-top: 0;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--wechat-border-color);
            padding-bottom: 10px;
            font-size: 16px;
            font-weight: 600;
        }
        #game-word-display {
            font-size: 28px;
            font-weight: bold;
            text-align: center;
            letter-spacing: 4px;
            padding: 20px 0;
            background-color: var(--wechat-bg);
            border-radius: 8px;
            color: var(--wechat-green);
        }
        #game-status-text {
            text-align: center;
            color: var(--wechat-text-secondary);
            min-height: 20px;
            margin-top: 10px;
            font-size: 14px;
        }
        #game-chat-area {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid var(--wechat-border-color);
            padding: 10px;
            height: 150px;
            background-color: var(--wechat-bg);
            border-radius: 8px;
            margin-bottom: 10px;
        }
        #game-chat-area p {
            margin: 0 0 8px;
            line-height: 1.5;
        }
        #game-input-area {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        #game-input-area input {
            flex-grow: 1;
        }
        #game-input-area .form-btn {
            margin: 0;
            padding: 8px 12px;
            font-size: 15px;
            flex-shrink: 0;
        }
        #game-history-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 100px;
            overflow-y: auto;
        }
        #game-history-list li {
            padding: 4px 8px;
            border-bottom: 1px solid var(--wechat-border-color);
            color: var(--wechat-text-secondary);
            font-size: 14px;
        }
        #game-history-list li:last-child {
            border-bottom: none;
        }
        #next-round-btn {
            background-color: #87CEEB; /* 浅蓝色 */
            margin-top: 10px;
        }

        /* ★★★ 优化：书架APP专属样式 ★★★ */
        #bookshelf-app-page {
            --bs-bg-primary: #f5f5f7;
            --bs-bg-secondary: #ffffff;
            --bs-bg-tertiary: #f2f2f7;
            --bs-text-primary: #000000;
            --bs-text-secondary: #3c3c43;
            --bs-text-tertiary: #8e8e93;
            --bs-accent-blue: #007aff;
            --bs-border-color: #c7c7cc;
            --bs-card-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            --bs-font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
            --bs-custom-font: var(--bs-font-family);
            --bs-font-weight: 400;
            --bs-font-size: 16px;
            --bs-text-shadow: none;
            --bs-text-highlight: transparent;
            --bs-text-underline: none;
            --bs-text-italic: normal;
            padding: 0;
            width: 100%;
            margin: 0 auto;
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        #bookshelf-app-page.dark-mode {
            --bs-bg-primary: #000000;
            --bs-bg-secondary: #1c1c1e;
            --bs-bg-tertiary: #2c2c2e;
            --bs-text-primary: #ffffff;
            --bs-text-secondary: #ebebf5;
            --bs-text-tertiary: #98989d;
            --bs-accent-blue: #0a84ff;
            --bs-border-color: #38383a;
            --bs-card-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        #bookshelf-app-page .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            background-color: var(--bs-bg-primary);
            color: var(--bs-text-primary);
        }
        #bookshelf-app-page .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background-color: var(--bs-bg-secondary);
            border-bottom: 1px solid var(--bs-border-color);
            position: relative;
            z-index: 10;
            margin-top: 30px;
            flex-shrink: 0;
        }
        #bookshelf-app-page .app-title { font-size: 20px; font-weight: 600; }
        #bookshelf-app-page .header-actions { display: flex; gap: 16px; }
        #bookshelf-app-page .icon-button { background: none; border: none; color: var(--bs-accent-blue); font-size: 20px; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
        #bookshelf-app-page .icon-button:hover { background-color: var(--bs-bg-tertiary); }
        #bookshelf-app-page .app-content { flex: 1; overflow: hidden; position: relative; }
        #bookshelf-app-page .sub-page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding: 20px; overflow-y: auto; transition: transform 0.3s ease, opacity 0.3s; opacity: 0; transform: translateX(20px); pointer-events: none; background-color: var(--bs-bg-primary); box-sizing: border-box; }
        #bookshelf-app-page .sub-page.active { opacity: 1; transform: translateX(0); pointer-events: all; }
        #bookshelf-app-page .bookshelf-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #bookshelf-app-page .bookshelf-title { font-size: 28px; font-weight: 700; }
        #bookshelf-app-page .books-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 20px; margin-bottom: 80px; }
                #bookshelf-app-page .book-card { background-color: var(--bs-bg-secondary); border-radius: 12px; padding: 16px; box-shadow: var(--bs-card-shadow); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; display: flex; flex-direction: column; align-items: center; text-align: center; }
        #bookshelf-app-page .book-card:hover { transform: translateY(-4px); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12); }
        #bookshelf-app-page .book-cover { width: 80px; height: 112px; background: linear-gradient(135deg, var(--bs-accent-blue), #5ac8fa); border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-bottom: 12px; color: white; font-size: 40px; }
        #bookshelf-app-page .book-title { font-weight: 600; margin-bottom: 4px; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%; }
        #bookshelf-app-page .book-author { font-size: 12px; color: var(--bs-text-tertiary); }
        #bookshelf-app-page .book-progress { font-size: 11px; color: var(--bs-accent-blue); margin-top: 4px; }
        #bookshelf-app-page .reader-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; margin-bottom: 20px; border-bottom: 1px solid var(--bs-border-color); }
        #bookshelf-app-page .reader-content-wrapper { 
            overflow: hidden; 
            height: calc(100% - 150px); 
            perspective: 1500px; 
            position: relative;
        }
        #bookshelf-app-page .reader-page-container {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
        }
        #bookshelf-app-page .reader-page {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            overflow-y: auto;
            padding: 0 10px;
            box-sizing: border-box;
            font-size: var(--bs-font-size);
            line-height: 1.8;
            font-family: var(--bs-custom-font);
            font-weight: var(--bs-font-weight);
            text-shadow: var(--bs-text-shadow);
            background-color: var(--bs-bg-primary);
            color: var(--bs-text-primary);
            font-style: var(--bs-text-italic);
            text-decoration: var(--bs-text-underline);
            background-image: var(--bs-text-highlight);
        }
        #bookshelf-app-page .reader-page.current { z-index: 2; }
        #bookshelf-app-page .reader-page.next { z-index: 1; }
        #bookshelf-app-page .reader-page.flipping { transition: transform 0.6s; transform-origin: left; }
        #bookshelf-app-page .reader-pagination { display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 20px; }
        #bookshelf-app-page .profile-header { text-align: center; margin-bottom: 30px; }
        #bookshelf-app-page .profile-avatar { width: 100px; height: 100px; border-radius: 50%; background-color: var(--bs-accent-blue); margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; font-size: 40px; color: white; position: relative; overflow: hidden; }
        #bookshelf-app-page .avatar-img { width: 100%; height: 100%; object-fit: cover; }
        #bookshelf-app-page .profile-name { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
        #bookshelf-app-page .profile-username { color: var(--bs-accent-blue); margin-bottom: 8px; }
        #bookshelf-app-page .profile-bio { color: var(--bs-text-tertiary); font-size: 15px; line-height: 1.4; max-width: 300px; margin: 0 auto; }
        #bookshelf-app-page .settings-section { background-color: var(--bs-bg-secondary); border-radius: 12px; margin-bottom: 20px; overflow: hidden; }
        #bookshelf-app-page .settings-item { display: flex; align-items: center; justify-content: space-between; padding: 16px; border-bottom: 1px solid var(--bs-border-color); cursor: pointer; }
        #bookshelf-app-page .settings-item:last-child { border-bottom: none; }
        #bookshelf-app-page .item-left { display: flex; align-items: center; gap: 12px; }
        #bookshelf-app-page .item-icon { width: 24px; text-align: center; color: var(--bs-accent-blue); }
        #bookshelf-app-page .item-value { color: var(--bs-text-tertiary); font-size: 14px; }
        #bookshelf-app-page .bottom-nav { display: flex; background-color: var(--bs-bg-secondary); border-top: 1px solid var(--bs-border-color); padding: 8px 0; position: relative; z-index: 10; flex-shrink: 0; }
        #bookshelf-app-page .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-decoration: none; color: var(--bs-text-tertiary); padding: 4px 0; transition: color 0.2s; }
        #bookshelf-app-page .nav-item.active { color: var(--bs-accent-blue); }
        #bookshelf-app-page .nav-icon { font-size: 20px; margin-bottom: 4px; }
        #bookshelf-app-page .nav-label { font-size: 12px; }
        #bookshelf-app-page .nav-item-plus { color: var(--bs-accent-blue); font-size: 32px; }
        #bookshelf-app-page .empty-state { text-align: center; padding: 60px 20px; color: var(--bs-text-tertiary); }
        #bookshelf-app-page .empty-icon { font-size: 60px; margin-bottom: 20px; color: var(--bs-border-color); }
        #bookshelf-app-page .empty-title { font-size: 20px; margin-bottom: 10px; }
        #bookshelf-app-page .empty-text { font-size: 16px; margin-bottom: 30px; }
        #bookshelf-app-page .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color:rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 100; transition: opacity 0.3s; }
        #bookshelf-app-page .modal-overlay.active { display: flex; opacity: 1; }
        #bookshelf-app-page .modal { background-color: var(--bs-bg-secondary); border-radius: 12px; width: 90%; max-width: 500px; max-height: 80vh; overflow: hidden; transform: translateY(20px); transition: transform 0.3s; }
        #bookshelf-app-page .modal-overlay.active .modal { transform: translateY(0); }
        #bookshelf-app-page .modal-header { padding: 20px; border-bottom: 1px solid var(--bs-border-color); display: flex; justify-content: space-between; align-items: center; }
        #bookshelf-app-page .modal-title { font-size: 20px; font-weight: 600; }
        #bookshelf-app-page .modal-close { background: none; border: none; font-size: 24px; color: var(--bs-text-tertiary); cursor: pointer; }
        #bookshelf-app-page .modal-body { padding: 20px; overflow-y: auto; max-height: 60vh; }
        #bookshelf-app-page .form-group { margin-bottom: 20px; }
        #bookshelf-app-page .form-label { display: block; margin-bottom: 8px; font-weight: 500; }
        #bookshelf-app-page .form-input { width: 100%; padding: 12px 16px; border: 1px solid var(--bs-border-color); border-radius: 8px; background-color: var(--bs-bg-primary); color: var(--bs-text-primary); font-size: 16px; font-family: inherit; }
        #bookshelf-app-page .form-input:focus { outline: none; border-color: var(--bs-accent-blue); }
        #bookshelf-app-page .form-textarea { resize: vertical; min-height: 100px; }
        #bookshelf-app-page .char-count { text-align: right; font-size: 12px; color: var(--bs-text-tertiary); margin-top: 4px; }
        #bookshelf-app-page .modal-footer { padding: 20px; border-top: 1px solid var(--bs-border-color); display: flex; justify-content: flex-end; gap: 12px; }
        #bookshelf-app-page .btn { padding: 10px 20px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; border: none; transition: opacity 0.2s; }
        #bookshelf-app-page .btn-primary { background-color: var(--bs-accent-blue); color: white; }
        #bookshelf-app-page .btn-secondary { background-color: var(--bs-bg-tertiary); color: var(--bs-text-primary); }
        #bookshelf-app-page .btn:hover { opacity: 0.9; }
        #bookshelf-app-page .font-preview { padding: 20px; border: 1px solid var(--bs-border-color); border-radius: 8px; margin-top: 20px; font-size: 18px; line-height: 1.6; }
        #bookshelf-app-page .font-option { display: flex; align-items: center; padding: 12px; border: 1px solid var(--bs-border-color); border-radius: 8px; margin-bottom: 10px; cursor: pointer; }
        #bookshelf-app-page .font-option.active { border-color: var(--bs-accent-blue); background-color: rgba(0, 122, 255, 0.1); }
        #bookshelf-app-page .toggle-switch { position: relative; width: 50px; height: 28px; }
        #bookshelf-app-page .toggle-checkbox { opacity: 0; width: 0; height: 0; }
        #bookshelf-app-page .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; border-radius: 34px; transition: .4s; }
        #bookshelf-app-page .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; border-radius: 50%; transition: .4s; }
        #bookshelf-app-page .toggle-checkbox:checked + .toggle-slider { background-color: var(--bs-accent-blue); }
        #bookshelf-app-page .toggle-checkbox:checked + .toggle-slider:before { transform: translateX(22px); }
        #bookshelf-app-page .fanfic-tags { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        #bookshelf-app-page .fanfic-tag { padding: 8px 12px; background-color: var(--bs-bg-secondary); border-radius: 20px; cursor: pointer; transition: all 0.2s; }
        #bookshelf-app-page .fanfic-tag.active { background-color: var(--bs-accent-blue); color: white; }
        /* ★★★ 优化：同人书架网格布局 ★★★ */
        #bookshelf-app-page .fanfic-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 15px; 
        }
        #bookshelf-app-page .fanfic-card { 
            background-color: var(--bs-bg-secondary); 
            padding: 0; 
            border-radius: 8px; 
            cursor: pointer; 
            display: flex; 
            flex-direction: column;
            box-shadow: var(--bs-card-shadow);
        }
        #bookshelf-app-page .fanfic-cover {
            height: 120px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 8px 8px 0 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            text-align: center;
            padding: 5px;
            font-weight: bold;
        }
        #bookshelf-app-page .fanfic-info {
            padding: 10px;
        }
        #bookshelf-app-page .fanfic-title { font-weight: 600; margin-bottom: 8px; font-size: 12px; }
        #bookshelf-app-page .fanfic-summary { font-size: 10px; color: var(--bs-text-tertiary); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        #bookshelf-app-page .fanfic-header { display: flex; justify-content: space-between; align-items: center; }

        /* ★★★ 新增：心声功能样式 ★★★ */
        .heartbeat-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1100;
        }
        .heartbeat-card {
            background: white;
            color: #333;
            border-radius: 16px;
            padding: 25px;
            width: 80%;
            max-width: 300px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            font-size: 16px;
            line-height: 1.6;
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        /* ★★★ 新增/优化：群聊@弹窗样式 ★★★ */
        .mention-popup {
            position: absolute;
            bottom: 100%;
            left: 0;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background: var(--wechat-nav-bg);
            border: 1px solid var(--wechat-border-color);
            border-radius: 8px 8px 0 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1002;
        }
        .mention-popup .list-item {
            padding: 8px 15px;
            border-bottom: 0.5px solid var(--wechat-border-color);
        }
        .mention-popup .list-item:last-child {
            border-bottom: none;
        }
        
        /* ★★★ 新增：已读回执样式 ★★★ */
        .read-receipt {
            font-size: 10px;
            color: var(--wechat-text-secondary);
            opacity: 0.8;
        }
        .read-receipt.outside {
            margin-top: 4px;
        }
        .message-row.sent .read-receipt.outside {
            text-align: right;
            padding-right: 5px;
        }
        .message-row.received .read-receipt.outside {
            text-align: left;
            padding-left: 5px;
        }
        .read-receipt.inside {
            position: absolute;
            bottom: 5px;
        }
        .message-row.sent .read-receipt.inside {
            left: -35px;
        }
        .message-row.received .read-receipt.inside {
            right: -35px;
        }

        /* ★★★ 新增：头像裁剪模态框样式 ★★★ */
        #cropper-modal-content {
            width: 90%;
            max-width: 360px;
            height: auto;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        #cropper-container {
            width: 100%;
            height: 300px;
            margin-bottom: 15px;
        }
        #cropper-container img {
            max-width: 100%;
        }
        .cropper-actions {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 15px;
        }
        .cropper-actions button {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--global-font-color);
        }

        /* ★★★ 新增：证件办理APP样式 ★★★ */
        #certificate-app-page .content-area { padding: 0; }
        #certificate-app-page .app-content { flex: 1; overflow-y: auto; padding: 20px; }
        #certificate-app-page .bottom-nav { flex-shrink: 0; }
        #certificate-app-page .form-group img { width: 100px; height: 100px; object-fit: cover; border-radius: 8px; }
        #certificate-app-page .certificate-display { margin-top: 20px; transform-origin: top center; }
        
        /* 结婚证样式 */
        .marriage-certificate { width: 700px; height: 450px; background: #fff9f9; border-radius: 8px; box-shadow: 0 15px 40px rgba(200, 0, 0, 0.1); position: relative; overflow: hidden; border: 2px solid #d4a8a8; display: flex; margin: 20px auto; }
        .certificate-left, .certificate-right { flex: 1; padding: 30px; position: relative; }
        .certificate-left { border-right: 2px dashed #e8c8c8; background: linear-gradient(to right, #fff9f9 0%, #fff5f5 100%); }
        .certificate-right { background: linear-gradient(to left, #fff9f9 0%, #fff5f5 100%); }
        .certificate-header { text-align: center; margin-bottom: 30px; position: relative; }
        .certificate-title { font-size: 28px; font-weight: bold; color: #c62f2f; letter-spacing: 10px; margin-right: -10px; margin-bottom: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        .certificate-subtitle { font-size: 16px; color: #b22222; margin-bottom: 5px; }
        .certificate-number { font-size: 14px; color: #666; margin-top: 15px; }
        .couple-photo { width: 180px; height: 130px; margin: 0 auto 25px; border: 1px solid #e0c0c0; background: #f9f0f0; display: flex; align-items: center; justify-content: center; background-size: cover; background-position: center; }
        .photo-placeholder { text-align: center; color: #cc9999; font-size: 14px; }
        .photo-placeholder::before { content: "结婚合影"; display: block; font-size: 16px; margin-bottom: 8px; }
        .marriage-info { margin: 25px 0; }
        .info-grid { display: grid; grid-template-columns: 80px 1fr; gap: 15px; margin-bottom: 12px; }
        .info-label { font-size: 15px; color: #8b4513; text-align: right; }
        .info-value { font-size: 16px; color: #333; border-bottom: 1px dotted #d4a8a8; padding-bottom: 3px; }
        .official-stamp { position: absolute; bottom: 30px; right: 30px; width: 120px; height: 120px; border: 2px solid #c62f2f; border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: 0.9; }
        .stamp-content { text-align: center; transform: rotate(-15deg); color: #c62f2f; font-size: 16px; font-weight: bold; }
        .stamp-content .stamp-text { display: block; font-size: 18px; margin-bottom: 5px; }
        .stamp-content .stamp-authority { display: block; font-size: 14px; margin-top: 5px; }
        .marriage-vows { margin: 25px 0; line-height: 1.8; font-size: 15px; color: #333; text-indent: 2em; text-align: justify; }
        .registration-date { text-align: center; margin: 30px 0; font-size: 15px; color: #333; }
        .legal-provisions { font-size: 13px; color: #666; line-height: 1.6; margin-top: 20px; border-top: 1px solid #e8c8c8; padding-top: 15px; }
        .decoration-corner { position: absolute; width: 60px; height: 60px; opacity: 0.1; }
        .corner-tl { top: 15px; left: 15px; border-top: 3px solid #c62f2f; border-left: 3px solid #c62f2f; }
        .corner-tr { top: 15px; right: 15px; border-top: 3px solid #c62f2f; border-right: 3px solid #c62f2f; }
        .corner-bl { bottom: 15px; left: 15px; border-bottom: 3px solid #c62f2f; border-left: 3px solid #c62f2f; }
        .corner-br { bottom: 15px; right: 15px; border-bottom: 3px solid #c62f2f; border-right: 3px solid #c62f2f; }
        .heart-decoration { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 40px; color: rgba(198, 47, 47, 0.1); z-index: 0; }

        /* 身份证样式 */
        .id-card { width: 320px; height: 202px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 8px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); padding: 12px; position: relative; overflow: hidden; border: 1px solid #e0e0e0; margin: 20px auto; }
        .id-card::before { content: ""; position: absolute; top: 0; right: 0; width: 60%; height: 100%; background: linear-gradient(45deg, #ffffff 0%, rgba(255,255,255,0) 100%); z-index: 1; }
        .id-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; position: relative; z-index: 2; }
        .id-title { font-size: 16px; font-weight: bold; color: #2c3e50; letter-spacing: 2px; }
        .id-logo { font-size: 14px; color: #7f8c8d; }
        .id-content { display: flex; position: relative; z-index: 2; }
        .id-photo { width: 98px; height: 122px; background-color: #dce1e6; border: 1px solid #bdc3c7; display: flex; align-items: center; justify-content: center; margin-right: 12px; position: relative; background-size: cover; background-position: center; }
        .id-photo-placeholder { color: #7f8c8d; font-size: 12px; text-align: center; }
        .id-info { flex: 1; }
        .id-info .info-item { margin-bottom: 6px; display: flex; }
        .id-info .info-label { width: 70px; font-size: 12px; color: #34495e; }
        .id-info .info-value { font-size: 12px; color: #2c3e50; font-weight: 500; flex: 1; }
        .id-footer { position: absolute; bottom: 12px; left: 12px; right: 12px; display: flex; justify-content: space-between; font-size: 10px; color: #7f8c8d; z-index: 2; }
        .id-number { letter-spacing: 1px; font-weight: bold; color: #2c3e50; }
        .id-stamp { position: absolute; bottom: 25px; right: 15px; width: 60px; height: 60px; border: 1px solid #e74c3c; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #e74c3c; font-size: 12px; transform: rotate(-15deg); opacity: 0.7; z-index: 2; }
        .id-bg-pattern { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.03; z-index: 1; background-image: radial-gradient(circle at 10% 20%, #2c3e50 0%, #2c3e50 20%, transparent 20%), radial-gradient(circle at 90% 80%, #2c3e50 0%, #2c3e50 20%, transparent 20%); background-size: 40px 40px; }
        
        /* ★★★ 优化：对方余额APP样式 ★★★ */
        #char-balance-app-page .balance-card {
            background: #fff;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        }
        #char-balance-app-page .balance-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        #char-balance-app-page .balance-header .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
        }
        #char-balance-app-page .balance-header .name {
            font-size: 20px;
            font-weight: 600;
        }
        #char-balance-app-page .balance-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            text-align: center;
        }
        #char-balance-app-page .balance-item {
            background: #f7f7f7;
            padding: 15px;
            border-radius: 12px;
        }
        #char-balance-app-page .balance-item .title {
            font-size: 14px;
            color: #888;
            margin-bottom: 8px;
        }
        #char-balance-app-page .balance-item .amount {
            font-size: 22px;
            font-weight: 600;
            color: #333;
        }
        #char-balance-app-page .transactions-list .list-item {
            background: transparent;
            border-bottom: 1px solid #f0f0f0;
        }
        #char-balance-app-page .transactions-list .list-item:last-child {
            border-bottom: none;
        }
        #char-balance-app-page .transactions-list .amount {
            color: var(--wechat-red);
            font-weight: 500;
        }
        body.dark-mode #char-balance-app-page .balance-card { background: #1E1E1E; }
        body.dark-mode #char-balance-app-page .balance-item { background: #2c2c2c; }
        body.dark-mode #char-balance-app-page .balance-item .title { color: #8E8E93; }
        body.dark-mode #char-balance-app-page .balance-item .amount { color: #EAEAEA; }
        body.dark-mode #char-balance-app-page .transactions-list .list-item { border-bottom-color: #3A3A3C; }


        /* 通用UI图标样式 */
        .ui-icon {
            display: inline-block;
            width: 24px;
            height: 24px;
            background-color: currentColor;
            -webkit-mask-size: contain;
            mask-size: contain;
            -webkit-mask-repeat: no-repeat;
            mask-repeat: no-repeat;
            -webkit-mask-position: center;
            mask-position: center;
        }
        .ui-icon.back { -webkit-mask-image: var(--ui-icon-back); mask-image: var(--ui-icon-back); }
        .ui-icon.plus-circle { -webkit-mask-image: var(--ui-icon-plus-circle); mask-image: var(--ui-icon-plus-circle); }
        .ui-icon.tab-chat { -webkit-mask-image: var(--ui-icon-tab-chat); mask-image: var(--ui-icon-tab-chat); }
        .ui-icon.tab-contacts { -webkit-mask-image: var(--ui-icon-tab-contacts); mask-image: var(--ui-icon-tab-contacts); }
        .ui-icon.tab-me { -webkit-mask-image: var(--ui-icon-tab-me); mask-image: var(--ui-icon-tab-me); }
        .ui-icon.chat-resend { -webkit-mask-image: var(--ui-icon-chat-resend); mask-image: var(--ui-icon-chat-resend); }
        .ui-icon.chat-voice { -webkit-mask-image: var(--ui-icon-chat-voice); mask-image: var(--ui-icon-chat-voice); }
        .ui-icon.chat-sticker { -webkit-mask-image: var(--ui-icon-chat-sticker); mask-image: var(--ui-icon-chat-sticker); }
        .ui-icon.chat-plus { -webkit-mask-image: var(--ui-icon-chat-plus); mask-image: var(--ui-icon-chat-plus); }
        .ui-icon.plus-image { -webkit-mask-image: var(--ui-icon-plus-image); mask-image: var(--ui-icon-plus-image); }
        .ui-icon.plus-camera { -webkit-mask-image: var(--ui-icon-plus-camera); mask-image: var(--ui-icon-plus-camera); }
        .ui-icon.plus-phone { -webkit-mask-image: var(--ui-icon-plus-phone); mask-image: var(--ui-icon-plus-phone); }
        .ui-icon.plus-location { -webkit-mask-image: var(--ui-icon-plus-location); mask-image: var(--ui-icon-plus-location); }
        .ui-icon.plus-redpacket { -webkit-mask-image: var(--ui-icon-plus-redpacket); mask-image: var(--ui-icon-plus-redpacket); background-color: #E64340; }
        .ui-icon.plus-transfer { -webkit-mask-image: var(--ui-icon-plus-transfer); mask-image: var(--ui-icon-plus-transfer); }
        .ui-icon.plus-kinship { -webkit-mask-image: var(--ui-icon-plus-kinship); mask-image: var(--ui-icon-plus-kinship); }
        .ui-icon.plus-diary { -webkit-mask-image: var(--ui-icon-plus-diary); mask-image: var(--ui-icon-plus-diary); }
        .ui-icon.plus-file { -webkit-mask-image: var(--ui-icon-plus-file); mask-image: var(--ui-icon-plus-file); }
        .ui-icon.plus-heartbeat { -webkit-mask-image: var(--ui-icon-plus-heartbeat); mask-image: var(--ui-icon-plus-heartbeat); } /* ★★★ 新增心声图标 ★★★ */
        .ui-icon.me-settings { background-image: var(--ui-icon-me-settings); background-color: transparent; -webkit-mask-image: none; mask-image: none; }
        .ui-icon.me-wallet { background-image: var(--ui-icon-me-wallet); background-color: transparent; -webkit-mask-image: none; mask-image: none; }
        .ui-icon.me-moments { background-image: var(--ui-icon-me-moments); background-color: transparent; -webkit-mask-image: none; mask-image: none; }
        .ui-icon.me-persona { background-image: var(--ui-icon-me-persona); background-color: transparent; -webkit-mask-image: none; mask-image: none; }
        .ui-icon.me-address { background-image: var(--ui-icon-me-address); background-color: transparent; -webkit-mask-image: none; mask-image: none; }
        .ui-icon.me-status { background-image: var(--ui-icon-me-status); background-color: transparent; -webkit-mask-image: none; mask-image: none; }
    </style>
</head>
<body>
    <!-- ★★★ 优化：激活弹窗 ★★★ -->
    <div id="activation-modal" class="popup-overlay" style="display: none;">
        <div class="popup-content">
            <div class="popup-icon"></div>
            <h3>激活 X-Evol</h3>
            <input type="text" id="activation-input" placeholder="请输入激活码">
            <button id="activation-btn">激活</button>
        </div>
    </div>

    <!-- ★★★ 优化：加载动画弹窗 ★★★ -->
    <div id="loading-screen" class="popup-overlay" style="display: none;">
        <div class="popup-content">
            <div class="loading-spinner"></div>
            <p class="loading-text">欢迎使用 X-Evol</p>
            <div class="progress-bar-container">
                <div class="progress-bar" id="loading-progress-bar"></div>
            </div>
            <p class="loading-subtext">by: 来自小红书📚 非悸 | 禁止二传二改</p>
        </div>
    </div>

    <div class="phone-container" id="phone-body" style="display: none;">
        <!-- ★★★ 新增手机边框元素 ★★★ -->
        <div class="ios-frame-elements">
            <div class="ios-outer-frame"></div>
            <div class="ios-inner-frame"></div>
            <div class="ios-bottom-shadow"></div>
        </div>
        <div class="mint-green-frame-elements">
            <div class="mint-inner-border"></div>
            <div class="mint-middle-border"></div>
            <div class="mint-outer-border"></div>
        </div>
        
        <div class="iphone6-home-button" onclick="goToHomeScreen()"></div>
        <div class="screen">
            <!-- 状态栏 -->
            <div class="status-bar" id="status-bar">
                <div class="status-bar-left">
                    <span class="time" id="status-bar-time">09:41</span>
                </div>
                <div class="notch-container"></div>
                <div id="dynamic-island">
                    <div class="island-content notification" id="island-notification-content">
                        <img src="" class="app-icon">
                        <div class="text-content">
                            <div class="title"></div>
                            <div class="text"></div>
                        </div>
                    </div>
                    <div class="island-content music" id="island-music-content">
                        <div class="cover" style="background-image: url('');"></div>
                        <div class="info">
                            <div class="title">Song Title</div>
                            <div class="artist">Artist Name</div>
                        </div>
                        <div class="controls">
                            <button  class="control-btn play-pause-btn" onclick="togglePlayPause()">
                                <svg viewBox="0 0 24 24" id="island-play-pause-icon">
                                    <path d="M8 5v14l11-7z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <!-- ★★★ 新增iOS灵动岛 ★★★ -->
                <div id="ios-dynamic-island">
                    <div class="wave-animation" id="ios-wave-animation"></div>
                    <div class="wave-bar" id="ios-wave-bar"></div>
                    <div class="status-indicator" id="ios-status-indicator"></div>
                    <div class="music-controls" id="ios-music-controls">
                        <div class="album-art" id="ios-album-art"><div class="music-icon">♪</div></div>
                        <div class="music-info">
                            <div class="song-title" id="ios-song-title">Song Title</div>
                            <div class="artist-name" id="ios-artist-name">Artist Name</div>
                        </div>
                        <div class="controls">
                            <button class="control-btn prev-btn" id="ios-prev-btn"><svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
                            <button class="control-btn play-pause-btn" id="ios-play-pause-btn"><svg viewBox="0 0 24 24" id="ios-play-pause-icon"><path d="M8 5v14l11-7z"/></svg></button>
                            <button class="control-btn next-btn" id="ios-next-btn"><svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
                        </div>
                    </div>
                </div>
                <!-- ★★★ 新增Evol灵动岛 ★★★ -->
                <div id="evol-dynamic-island">
                    <div class="music-controls">
                        <div class="song-info">
                            <div class="song-name" id="evol-song-name">Song Title</div>
                            <div class="artist-name" id="evol-artist-name">Artist Name</div>
                        </div>
                        <div class="controls">
                            <div class="control-btn prev" id="evol-prev-btn"><i class="fas fa-backward"></i></div>
                            <div class="play-pause" id="evol-play-pause-btn"><i class="fas fa-pause"></i></div>
                            <div class="control-btn next" id="evol-next-btn"><i class="fas fa-forward"></i></div>
                        </div>
                    </div>
                    <div class="wave-container">
                        <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                        <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                    </div>
                </div>
                <!-- ★★★ 新增ins灵动岛 ★★★ -->
                <div id="ins-dynamic-island">
                    <div class="island-default">
                        <div class="album-cover" id="ins-album-cover-small"><i class="fas fa-music"></i></div>
                        <span id="ins-now-playing-text">Now Playing</span>
                    </div>
                    <div class="music-player">
                        <div class="song-info">
                            <div class="song-title" id="ins-song-title">Blinding Lights</div>
                            <div class="artist" id="ins-artist-name">The Weeknd</div>
                            <div class="wave-container" id="ins-wave-container">
                                ${Array(10).fill('<div class="wave-bar"></div>').join('')}
                            </div>
                        </div>
                        <div class="progress-container">
                            <div class="time-display" id="ins-current-time">0:00</div>
                            <div class="progress-bar"><div class="progress" id="ins-progress"></div></div>
                            <div class="time-display" id="ins-total-time">0:00</div>
                        </div>
                        <div class="music-controls">
                            <div class="control-btn" id="ins-prev-btn"><i class="fas fa-backward-step"></i></div>
                            <div class="control-btn play-btn" id="ins-play-btn"><i class="fas fa-pause" id="ins-play-icon"></i></div>
                            <div class="control-btn" id="ins-next-btn"><i class="fas fa-forward-step"></i></div>
                        </div>
                    </div>
                </div>
                <div class="status-bar-right">
                    <span class="dnd-icon" id="status-bar-dnd"><i class="fas fa-moon"></i></span>
                    <span class="network-icon" id="status-bar-network"><i class="fas fa-wifi"></i></span>
                    <div class="battery-container">
                        <div class="custom-battery-icon" id="custom-battery-icon"></div>
                        <div class="battery-icon" id="default-battery-icon">
                            <div class="battery-fill" id="battery-fill"></div>
                            <span class="battery-percent-inside" id="battery-percent-inside">100</span>
                        </div>
                        <span class="battery-percent-outside" id="battery-percent-outside">100%</span>
                    </div>
                </div>
            </div>

            <!-- ★★★ 优化：通知中心 ★★★ -->
            <div class="notification-center" id="notification-center">
                <div class="notification-header">
                    <h3>通知中心</h3>
                    <button class="back-btn" onclick="toggleNotificationCenter(event)">返回</button>
                </div>
                <div id="notification-list"></div>
                <div class="notification-footer">
                    <button class="clear-all-btn" onclick="clearAllNotifications()"><i class="fas fa-times"></i></button>
                </div>
            </div>

            <!-- 主屏幕 -->
            <div id="home-screen-page" class="page no-transition">
                <div class="content-area">
                    <div class="home-screen-pager-wrapper" id="home-screen-pager">
                        <!-- Page 1 -->
                        <div class="home-screen-page-content">
                            <div class="home-screen-time-container">
                                <div class="time" id="home-screen-time">09:41</div>
                                <div class="date" id="home-screen-date">2025年1月1日 星期一</div>
                            </div>
                            <div class="home-screen-widgets-container" id="home-screen-widgets-container">
                                <!-- Widgets for page 1 will be rendered here by JS -->
                            </div>
                            <div class="app-grid" id="app-grid-p1">
                                <!-- App icons for page 1 will be rendered here by JS -->
                            </div>
                        </div>
                        <!-- Page 2 -->
                        <div class="home-screen-page-content">
                            <div id="home-screen-widgets-container-p2" style="width: 100%; flex-grow: 1; display: flex; flex-direction: column; gap: 15px; margin-top: 20px;">
                                <!-- Widgets for page 2 will be rendered here by JS -->
                            </div>
                            <div class="app-grid" id="app-grid-p2">
                                <!-- App icons for page 2 will be rendered here by JS -->
                            </div>
                        </div>
                        <!-- Page 3 (优化) -->
                        <div class="home-screen-page-content">
                            <div id="home-screen-widgets-container-p3" style="width: 100%; flex-grow: 1; display: flex; flex-direction: column; gap: 15px; margin-top: 20px;">
                                <!-- Widgets for page 3 will be rendered here by JS -->
                            </div>
                            <div class="app-grid" id="app-grid-p3">
                                <!-- App icons for page 3 will be rendered here by JS -->
                            </div>
                        </div>
                    </div>
                    <div class="home-screen-page-indicators" id="home-screen-page-indicators">
                        <!-- Dots will be rendered here by JS -->
                    </div>
                </div>
            </div>

            <!-- WeChat App 容器 -->
            <div id="wechat-app-page" class="page sub-page">
                <div class="wechat-header" id="main-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div></div>
                    <span class="header-title">微信</span>
                    <div class="header-right">
                        <div class="ui-icon plus-circle" id="main-plus-btn"></div>
                    </div>
                </div>
                <div class="content-area" id="main-content-area"></div>
                <div class="wechat-tabbar">
                    <div class="tab-item active" data-page="chat-list">
                        <div class="ui-icon tab-chat"></div>
                        <span>聊天</span>
                    </div>
                    <div class="tab-item" data-page="contacts">
                        <div class="ui-icon tab-contacts"></div>
                        <span>通讯录</span>
                    </div>
                    <div class="tab-item" data-page="me">
                        <div class="ui-icon tab-me"></div>
                        <span>我</span>
                    </div>
                </div>
            </div>
            
            <!-- 新增/重构的APP页面容器 -->
            <div id="bookshelf-app-page" class="page sub-page"></div>
            <div id="game-app-page" class="page sub-page"></div>
            <div id="memo-app-page" class="page sub-page"></div>
            <div id="accounting-app-page" class="page sub-page"></div>
            <div id="anniversary-app-page" class="page sub-page form-page"></div>
            <div id="beautify-app-page" class="page sub-page"></div>
            <div id="music-library-page" class="page sub-page"></div>
            <div id="shopping-app-page" class="page sub-page"></div>
            <div id="sticker-app-page" class="page sub-page"></div>
            <div id="calendar-app-page" class="page sub-page"></div>
            <div id="bubble-switch-page" class="page sub-page"></div>
            <div id="ui-beautify-page" class="page sub-page"></div>
            <div id="char-balance-app-page" class="page sub-page"></div>
            <div id="guess-word-game-page" class="page sub-page"></div>
            <div id="offline-plot-beautify-page" class="page sub-page form-page"></div>
            <div id="certificate-app-page" class="page sub-page"></div>
            <div id="player-css-settings-page" class="page sub-page form-page"></div>
            <!-- ★★★ 新增：群头衔管理页面 ★★★ -->
            <div id="group-title-management-page" class="page sub-page"></div>


            <!-- 其他页面容器 -->
            <div id="conversation-page" class="page sub-page">
                <div id="sticker-picker-overlay"></div>
            </div>
            <div id="editor-page" class="page sub-page form-page"></div>
            <div id="wallet-page" class="page sub-page"></div>
            <div id="transactions-page" class="page sub-page"></div>
            <div id="settings-app-page" class="page sub-page"></div>
            <div id="worldbook-app-page" class="page sub-page"></div>
            <div id="frame-settings-page" class="page sub-page"></div>
            <div id="bubble-settings-page" class="page sub-page form-page"></div>
            <div id="redpacket-bubble-settings-page" class="page sub-page form-page"></div>
            <div id="transfer-bubble-settings-page" class="page sub-page form-page"></div>
            <div id="api-settings-page" class="page sub-page form-page"></div>
            <div id="moments-page" class="page sub-page"></div>
            <div id="create-moment-page" class="page sub-page form-page"></div>
            <div id="chat-settings-page" class="page sub-page"></div>
            <div id="blacklist-page" class="page sub-page"></div>
            <div id="data-management-page" class="page sub-page"></div>
            <div id="create-group-chat-page" class="page sub-page"></div>
            <div id="group-chat-settings-page" class="page sub-page"></div>
            <div id="group-member-management-page" class="page sub-page"></div>
            <div id="music-player-page" class="page sub-page"></div>
            <div id="music-settings-page" class="page sub-page"></div>
            <div id="player-beautify-page" class="page sub-page"></div>
            <div id="chat-mode-page" class="page sub-page"></div>
            <div id="font-settings-page" class="page sub-page form-page"></div>
            <div id="timestamp-settings-page" class="page sub-page"></div>
            <div id="background-interaction-page" class="page sub-page"></div>
            <div id="theme-settings-page" class="page sub-page"></div>
            <div id="phone-frame-settings-page" class="page sub-page"></div>
            <div id="avatar-shape-settings-page" class="page sub-page"></div>
            <div id="screen-size-settings-page" class="page sub-page form-page"></div>
            <div id="long-term-memory-page" class="page sub-page"></div>
            <div id="poke-settings-page" class="page sub-page form-page"></div>
            <div id="diary-page" class="page sub-page"></div>
            <div id="self-persona-list-page" class="page sub-page"></div>
            <div id="self-persona-editor-page" class="page sub-page form-page"></div>
            <div id="language-settings-page" class="page sub-page"></div>
            <div id="storage-settings-page" class="page sub-page"></div>
            <div id="notification-settings-page" class="page sub-page form-page"></div>
            <div id="voice-call-page" class="page sub-page"></div>
            <div id="global-theme-editor-page" class="page sub-page form-page"></div>
            <div id="bank-card-page" class="page sub-page"></div>
            <div id="app-icon-settings-page" class="page sub-page form-page"></div>
            <div id="wallpaper-settings-page" class="page sub-page form-page"></div>
            <div id="app-layout-settings-page" class="page sub-page form-page"></div>
            <div id="font-color-settings-page" class="page sub-page form-page"></div>
            <div id="battery-settings-page" class="page sub-page form-page"></div>
            <div id="display-settings-page" class="page sub-page"></div>
            <div id="status-bar-settings-page" class="page sub-page"></div>
            <div id="status-settings-page" class="page sub-page"></div>
            <div id="payment-code-page" class="page sub-page"></div>
            <div id="time-perception-settings-page" class="page sub-page"></div>
            <div id="read-receipt-settings-page" class="page sub-page"></div>


            <!-- 模态框容器 -->
            <div id="modal-container"></div>
            
            <!-- 消息上下文菜单 -->
            <div class="message-context-menu" id="message-context-menu"></div>

            <!-- 最小化通话窗口容器 -->
            <div id="minimized-call-container"></div>

            <!-- 底部导航指示条 -->
            <div class="home-indicator" onclick="goToHomeScreen()"></div>
        </div>
    </div>

    <!-- 提示音播放器 -->
    <audio id="send-sound-player"></audio>
    <audio id="receive-sound-player"></audio>
    <audio id="ringtone-player" loop></audio>

    <style id="user-bubble-style"></style>
    <style id="user-redpacket-bubble-style"></style>
    <style id="user-transfer-bubble-style"></style>
    <style id="default-font-style">
        @font-face {
            font-family: 'UserCustomFont';
            src: url('https://static.zeoseven.com/zsft/256/main/result.css');
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <!-- Cropper.js JS for Avatar Cropping -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script>
        // ========== 通用数据管理器 (IndexedDB) ==========
        class UniversalDataManager {
            constructor(dbName = 'WeChatSimulatorDB_v59', storeName = 'appDataStore') { // ★★★ Version bump to 59
                this.dbName = dbName;
                this.storeName = storeName;
                this.db = null;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, 1);
                    request.onerror = (event) => reject(`IndexedDB error: ${event.target.errorCode}`);
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve(this.db);
                    };
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            db.createObjectStore(this.storeName);
                        }
                    };
                });
            }

            async saveData(key, data) {
                if (!this.db) await this.init();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.put(data, key);
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(`Save data error: ${event.target.error}`);
                });
            }

            async loadData(key) {
                if (!this.db) await this.init();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.get(key);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(`Load data error: ${event.target.error}`);
                });
            }

            async exportAllData() {
                if (!this.db) await this.init();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.get('appData');
                    request.onsuccess = () => resolve({ appData: request.result });
                    request.onerror = (event) => reject(`Export data error: ${event.target.error}`);
                });
            }

            async importFromBackup(backupData) {
                if (!this.db) await this.init();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const clearRequest = store.clear();
                    clearRequest.onsuccess = () => {
                        const addRequest = store.add(backupData.appData, 'appData');
                        addRequest.onsuccess = () => resolve();
                        addRequest.onerror = (event) => reject(`Import (add) error: ${event.target.error}`);
                    };
                    clearRequest.onerror = (event) => reject(`Import (clear) error: ${event.target.error}`);
                });
            }
            
            async clearAllData() {
                return new Promise((resolve, reject) => {
                    const deleteRequest = indexedDB.deleteDatabase(this.dbName);
                    deleteRequest.onsuccess = () => resolve('本地数据已成功清理。');
                    deleteRequest.onerror = (event) => reject(`清理本地数据失败: ${event.target.error}`);
                    deleteRequest.onblocked = () => reject('清理被阻塞，请关闭其他页面后重试。');
                });
            }
        }

        const dataManager = new UniversalDataManager();
        let appData;
        const DATA_KEY = 'appData';

        const exchangeRates = {
            'CNY': { rate: 1, name: '人民币' }, 'USD': { rate: 0.14, name: '美元' }, 'JPY': { rate: 21.7, name: '日元' },
            'EUR': { rate: 0.13, name: '欧元' }, 'GBP': { rate: 0.11, name: '英镑' }, 'AUD': { rate: 0.21, name: '澳元' },
            'CAD': { rate: 0.19, name: '加元' }, 'CHF': { rate: 0.13, name: '瑞士法郎' }, 'HKD': { rate: 1.09, name: '港元' },
            'SGD': { rate: 0.19, name: '新加坡元' }, 'KRW': { rate: 190.5, name: '韩元' }, 'NZD': { rate: 0.23, name: '新西兰元' }
        };

        const defaultAppData = {
            user: {
                id: 'user', nickname: " ", avatar: "https://img.js.design/assets/img/6638e4537cf422dc287d398d.jpg",
                wxid: " ", address: " ", signature: " ", status: 'online',
                moments_bg: "https://source.unsplash.com/random/800x600?sky",
                wallet: { 
                    balance: 100000, 
                    lianqiantong: { balance: 0, dailyRate: 0.00006 }, 
                    transactions: [], 
                    currency: 'CNY',
                    paymentPassword: null
                },
                personas: [],
                bankCards: [],
                kinshipCards: { sent: [], received: [] }
            },
            contacts: [], groups: [], moments: [],
            stickers: { packs: [] },
            worldbooks: { presets: [], styles: [], library: [], stickerPacks: [] },
            bookshelf: {
                user: {
                    username: "@YourName",
                    nickname: "书虫",
                    bio: "享受阅读的每一刻",
                    avatar: ""
                },
                books: [],
                friends: [],
                settings: {
                    theme: "system",
                    fontSize: 16,
                    fontWeight: 400,
                    fontFamily: "",
                    fontUrl: "",
                    fontFile: null,
                    textShadow: false,
                    textHighlight: false,
                    textUnderline: false,
                    textItalic: false,
                    pageTurnMode: 'slide'
                },
                currentBookId: null,
                fanfics: {
                    tags: ['骨科', '伪骨科', 'PO文', '多人NP', '言情', '耽美', 'ABO', '破镜重圆', '追妻火葬场'],
                    cache: {}
                }
            },
            accounting: {
                transactions: []
            },
            calendar: {
                events: []
            },
            games: {
                guessWord: {
                    activeSession: null,
                    wordBank: {
                        '网络热梗': ['emo了', '尊嘟假嘟', 'i人', 'e人', '显眼包', '特种兵旅游', '遥遥领先'],
                        '小说术语': ['白月光', '朱砂痣', '追妻火葬场', '破镜重圆', '双向奔赴', 'BE', 'HE'],
                        '自定义': []
                    }
                }
            },
            memo: {
                notes: [],
                currentEditingNoteId: null
            },
            notifications: [],
            certificates: { // ★★★ 新增
                idCards: [],
                marriageCerts: [],
                marriageStamp: '中华人民共和国民政部'
            },
            settings: {
                api: { 
                    provider: 'openai', endpoint: '', key: '', model: '', 
                    temperature: 0.65, top_p: 1.0, repetition_penalty: 0.69,
                    presets: [] 
                },
                beautify: {
                    phoneFrame: 'black', theme: 'normal', chatBackground: '',
                    userAvatarFrame: '', charAvatarFrame: '', avatarShape: 'rounded',
                    bubbleCss: ``, // ★★★ 优化：默认空，由getBubbleStyleCss提供
                    activeBubbleStyle: 'wechat',
                    redPacketBubbleCss: '',
                    transferBubbleCss: '',
                    bubbleArchives: [{}, {}, {}, {}, {}],
                    globalThemeArchives: [{css:''}, {css:''}, {css:''}],
                    activeGlobalThemeSlot: -1,
                    fontUrl: '', fontFile: null, fontSize: 15,
                    globalFontWeight: 'normal',
                    globalFontStyle: 'normal',
                    globalFontColor: '#000000',
                    screenWidth: 380, screenHeight: 820,
                    homeScreenWallpaper: 'https://source.unsplash.com/random/380x820?aurora',
                    homeScreenFontColor: '#FFFFFF',
                    appIconSize: 60, appIconGap: 20, appIconRadius: 15,
                    appIcons: {
                        wechat: 'https://img.js.design/assets/img/65a881fa383e6a42242a3f33.jpg',
                        settings: 'https://img.js.design/assets/img/66547a8286955562f5597929.png',
                        worldbook: 'https://img.js.design/assets/img/66547a8292e9484a89d107a6.png',
                        anniversary: 'https://img.js.design/assets/img/665d9e5543325a2d15127021.png',
                        accounting: 'https://img.js.design/assets/img/665ef25736294334b550e508.png',
                        games: 'https://img.js.design/assets/img/6662d03492e9484a89e13589.png',
                        memo: 'https://img.js.design/assets/img/6662d034736e49989d466984.png',
                        beautify: 'https://img.js.design/assets/img/666c2d1392e948489.png',
                        music: 'https://img.js.design/assets/img/666c2d13736e49989d58434d.png',
                        shopping: 'https://img.js.design/assets/img/666c2d1386955562f5686036.png',
                        stickers: 'https://img.js.design/assets/img/666c2d13e02b5a5155134105.png',
                        calendar: 'https://img.js.design/assets/img/66718a3292e9484a891048f7.png',
                        ui_beautify: 'https://img.js.design/assets/img/667d7195d37637e76118f1a4.png',
                        char_balance: 'https://img.js.design/assets/img/66840d21e02b5a515569420d.png',
                        bookshelf: 'https://img.js.design/assets/img/66854d02e02b5a5155734893.png',
                        certificate: 'https://img.js.design/assets/img/668e9c34d37637e7611a20f9a.png'
                    },
                    offlinePlot: {
                        charNarration: { color: '#000000', style: 'normal', weight: 'normal', symbolStart: '', symbolEnd: '' },
                        userNarration: { color: '#000000', style: 'normal', weight: 'normal', symbolStart: '', symbolEnd: '' },
                        charQuote: { color: '#000000', style: 'normal', weight: 'bold', symbolStart: '「', symbolEnd: '」' },
                        userQuote: { color: '#000000', style: 'normal', weight: 'bold', symbolStart: '『', symbolEnd: '』' }
                    },
                    uiIcons: {
                        back: "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z'/%3e%3c/svg%3e",
                        plusCircle: "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z'/%3e%3c/svg%3e",
                        tabChat: "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z'/%3e%3c/svg%3e",
                        tabContacts: "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M16.5 12c1.38 0 2.5-1.12 2.5-2.5S17.88 7 16.5 7C15.12 7 14 8.12 14 9.5s1.12 2.5 2.5 2.5zM9 11c1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3 1.34 3 3 3zm7.5 3c-1.83 0-5.5.92-5.5 2.75V18h11v-1.25c0-1.83-3.67-2.75-5.5-2.75zM9 13c-2.33 0-7 1.17-7 3.5V18h7v-1.5c0-.92.32-2.14 1.9-2.83A5.47 5.47 0 0 1 9 13z'/%3e%3c/svg%3e",
                        tabMe: "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3e%3c/svg%3e",
                        chatResend: "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M2.01 21L23 12 2.01 3 2 10l15 2-15 2z'/%3e%3c/svg%3e",
                        chatVoice: "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z'/%3e%3c/svg%3e",
                        chatSticker: "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z'/%3e%3c/svg%3e",
                        chatPlus: "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z'/%3e%3c/svg%3e",
                        plusImage: "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z'/%3e%3c/svg%3e",
                        plusCamera: "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M12 12c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm-2 4h4c1.1 0 2-.9 2-2v-1.17l2.17 2.17c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L17.17 13H7v2c0 1.1.9 2 2 2zm10-7.17V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7.17l-2.17-2.17 2.17-2.17zM12 4c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3z'/%3e%3c/svg%3e",
                        plusPhone: "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.02.74-.25 1.02l-2.2 2.2z'/%3e%3c/svg%3e",
                        plusLocation: "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z'/%3e%3c/svg%3e",
                        plusRedpacket: "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4.5c-1.38 0-2.5-1.12-2.5-2.5S18.62 3.5 20 3.5V4.5zM4 8.5c1.38 0 2.5-1.12 2.5-2.5S5.38 3.5 4 3.5V8.5zm8 10c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z'/%3e%3ccircle cx='12' cy='13.5' r='2.5'/%3e%3c/svg%3e",
                        plusTransfer: "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M17 16.59V14h-4v-4h4V7.41L21.59 12 17 16.59zM7 7.41V10h4v4H7v2.59L2.41 12 7 7.41z'/%3e%3c/svg%3e",
                        plusKinship: "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3e%3c/svg%3e",
                        plusDiary: "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z'/%3e%3c/svg%3e",
                        plusFile: "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z'/%3e%3c/svg%3e",
                        plusHeartbeat: "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'%3e%3cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3e%3c/svg%3e",
                        meSettings: 'https://img.js.design/assets/img/66547a8286955562f5597929.png',
                        meWallet: 'https://img.js.design/assets/img/667d7195d37637e76118f1a1.png',
                        meMoments: 'https://img.js.design/assets/img/667d719515a119e755255403.png',
                        mePersona: 'https://img.js.design/assets/img/667d7195d37637e76118f1a2.png',
                        meAddress: 'https://img.js.design/assets/img/667d719515a119e755255404.png',
                        meStatus: 'https://img.js.design/assets/img/667d7195d37637e76118f1a3.png'
                    },
                    batteryIcon: {
                        displayMode: 'outside',
                        iconUrl: '',
                        percentColor: '#000000'
                    },
                    readReceipt: {
                        enabled: false,
                        position: 'outside',
                        userEnabled: true,
                        charEnabled: true
                    }
                },
                blacklist: [],
                charMomentFrequency: 'default',
                chatMode: 'online',
                timestampStyle: 'bubble-outside',
                backgroundInteraction: { enabled: false, interval: 3600000, selectedChars: [] },
                charLanguage: 'zh-CN',
                notifications: {
                    send: '',
                    receive: '',
                    ringtone: ''
                },
                dnd: false,
                displayMode: 'default',
                timePerception: false,
                memoryInterflow: false
            },
            music: {
                library: [], favorites: [], currentSongId: null, isPlaying: false,
                playMode: 'sequence', 
                playerImage: 'https://img.heliar.top/file/1764067235404_Screenshot_2025_1125_183413.png', 
                playerBackground: 'https://img.heliar.top/file/1764067231296_Screenshot_2025_1125_183056.png',
                playerCss: ''
            },
            shopping: {
                cachedGifts: [],
                cachedFoods: [],
                categories: {
                    gift: ['鲜花', '美妆', '珠宝', '电子产品', '奢侈品'],
                    delivery: ['中餐', '西餐', '日料', '烧烤', '奶茶甜品']
                }
            },
            longTermMemory: {},
            homeScreenWidgets: {
                anniversary: { enabled: false, characterId: null, date: '', description: '', image: '' },
                countdown: {enabled: false, characterId: null, date: '', description: '', image: '' },
                customText: { enabled: true, text: '点击纪念日APP进行编辑' },
                imageChanger: { image: 'https://source.unsplash.com/random/200x150?cat' },
                locationP3: { enabled: true, name: '我的位置', image: 'https://source.unsplash.com/random/200x150?map' }
            },
            activeChat: { id: null, type: null },
            version: '59.0' // ★★★ Version bump to 59
        };

        async function loadData() {
            try {
                const savedData = await dataManager.loadData(DATA_KEY);
                appData = savedData ? savedData : JSON.parse(JSON.stringify(defaultAppData));
                
                // 功能检查防火墙: 数据迁移与验证
                if (!appData.version || parseFloat(appData.version) < 59.0) {
                    // ★★★ 新增迁移逻辑 ★★★
                    if (!appData.certificates) {
                        appData.certificates = { idCards: [], marriageCerts: [], marriageStamp: '中华人民共和国民政部' };
                    }
                    if (!appData.settings.beautify.bubbleCss) {
                        appData.settings.beautify.bubbleCss = '';
                    }
                    if (typeof appData.settings.beautify.activeBubbleStyle === 'undefined') {
                        appData.settings.beautify.activeBubbleStyle = 'wechat';
                    }
                    if (!appData.settings.memoryInterflow) {
                        appData.settings.memoryInterflow = false;
                    }
                    if (!appData.settings.beautify.readReceipt) {
                        appData.settings.beautify.readReceipt = { enabled: false, position: 'outside', userEnabled: true, charEnabled: true };
                    } else {
                        if (typeof appData.settings.beautify.readReceipt.userEnabled === 'undefined') {
                            appData.settings.beautify.readReceipt.userEnabled = true;
                        }
                        if (typeof appData.settings.beautify.readReceipt.charEnabled === 'undefined') {
                            appData.settings.beautify.readReceipt.charEnabled = true;
                        }
                    }
                    appData.groups.forEach(g => {
                        if (!g.groupTitles) g.groupTitles = {};
                        if (!g.levelTitles) g.levelTitles = { '0-10': '萌新', '11-20': '话痨', '21-30': '吐槽役', '31-50': '大佬', '51-80': '元老', '81-100': '活化石' };
                        if (!g.mutedMembers) g.mutedMembers = {};
                    });
                    appData.contacts.forEach(c => {
                        if (c.chatSettings && typeof c.chatSettings.heartRateMonitor !== 'undefined') {
                            delete c.chatSettings.heartRateMonitor;
                        }
                    });
                    
                    appData.version = '59.0';
                    await saveData();
                }

            } catch (error) {
                console.error("Failed to load data, using defaults.", error);
                appData = JSON.parse(JSON.stringify(defaultAppData));
            }
        }

        async function saveData(showAlert = false, callback = null) {
            try {
                await dataManager.saveData(DATA_KEY, appData);
                if (showAlert) {
                    showToast('保存成功!');
                }
                if (callback) {
                    callback();
                }
            } catch (error) {
                console.error("Error saving data to IndexedDB:", error);
                showToast(`数据保存失败: ${error.message}`, 'error');
            }
        }

        // --- Navigation ---
        let pageHistory = ['home-screen-page'];
        let forwardedMessageCache = {};

        function showPage(pageId, renderFunc, ...args) {
            const pageElement = document.getElementById(pageId);
            if (!pageElement) {
                console.error(`Navigation Firewall: Page with ID "${pageId}" not found.`);
                showToast(`错误：找不到页面 ${pageId}`, 'error');
                return;
            }

            if (pageHistory[pageHistory.length - 1] !== pageId) {
                pageHistory.push(pageId);
            }

            if (renderFunc) {
                try {
                    renderFunc(pageElement, ...args);
                } catch (e) {
                    console.error(`Render Firewall: Error rendering page "${pageId}".`, e);
                    showToast(`页面渲染失败: ${pageId}`, 'error');
                    goBack();
                    return;
                }
            }
            
            const allPages = document.querySelectorAll('.page');
            allPages.forEach(p => p.classList.remove('active'));
            
            pageElement.classList.add('active');
        }

        function goBack() {
            if (pageHistory.length <= 1) return;
            const currentPageId = pageHistory.pop();
            const previousPageId = pageHistory[pageHistory.length - 1];
            
            const currentPageEl = document.getElementById(currentPageId);
            if (currentPageEl) {
                currentPageEl.classList.remove('active');
            }
            
            const previousPageEl = document.getElementById(previousPageId);
            if (previousPageEl) {
                previousPageEl.classList.add('active');
            }
            
            if (previousPageId === 'wechat-app-page') {
                const activeTab = document.querySelector('#wechat-app-page .tab-item.active');
                if (activeTab) renderMainContent(activeTab.dataset.page);
            }
        }

        function goToHomeScreen() {
            pageHistory = ['home-screen-page'];
            showPage('home-screen-page', renderHomeScreen);
        }

        // --- Rendering Functions ---
        function renderHomeScreen(container) {
            if (!container) {
                console.error("Home Screen Firewall: Container not found.");
                return;
            }
            const icons = appData.settings.beautify.appIcons;
            if (!icons || Object.keys(icons).length < 16) {
                console.error("Home Screen Firewall: App icons data is incomplete or missing.");
                showToast('主屏幕图标数据不完整，请检查设置。', 'error');
                appData.settings.beautify.appIcons = { ...defaultAppData.settings.beautify.appIcons, ...icons };
            }

            // Page 1 Apps
            const appGridP1 = container.querySelector('#app-grid-p1');
            if (appGridP1) {
                appGridP1.innerHTML = `
                    <div class="app-icon" onclick="showPage('wechat-app-page', renderWechatApp)">
                        <div class="icon-bg" style="background-image: url('${icons.wechat}')"></div><span class="app-name">WeChat</span>
                    </div>
                    <div class="app-icon" onclick="showPage('settings-app-page', renderSettingsAppPage)">
                        <div class="icon-bg" style="background-image: url('${icons.settings}')"></div><span class="app-name">设置</span>
                    </div>
                    <div class="app-icon" onclick="showPage('worldbook-app-page', renderWorldbookAppPage)">
                        <div class="icon-bg" style="background-image: url('${icons.worldbook}')"></div><span class="app-name">世界书</span>
                    </div>
                    <div class="app-icon" onclick="showPage('beautify-app-page', renderBeautifyAppPage)">
                        <div class="icon-bg" style="background-image: url('${icons.beautify}')"></div><span class="app-name">主题美化</span>
                    </div>
                    <div class="app-icon" onclick="showPage('anniversary-app-page', renderAnniversaryAppPage)">
                        <div class="icon-bg" style="background-image: url('${icons.anniversary}')"></div><span class="app-name">纪念日</span>
                    </div>
                    <div class="app-icon" onclick="showPage('accounting-app-page', renderAccountingAppPage)">
                        <div class="icon-bg" style="background-image: url('${icons.accounting}')"></div><span class="app-name">手账</span>
                    </div>
                    <div class="app-icon" onclick="showPage('game-app-page', renderGameApp)">
                        <div class="icon-bg" style="background-image: url('${icons.games}')"></div><span class="app-name">小游戏</span>
                    </div>
                    <div class="app-icon" onclick="showPage('memo-app-page', renderMemoApp)">
                        <div class="icon-bg" style="background-image: url('${icons.memo}')"></div><span class="app-name">备忘录</span>
                    </div>
                `;
            }

            // Page 2 Apps
            const appGridP2 = container.querySelector('#app-grid-p2');
            if (appGridP2) {
                appGridP2.innerHTML = `
                    <div class="app-icon" onclick="showPage('music-library-page', renderMusicLibraryPage)">
                        <div class="icon-bg" style="background-image: url('${icons.music}')"></div><span class="app-name">音乐库</span>
                    </div>
                    <div class="app-icon" onclick="showPage('shopping-app-page', renderShoppingAppPage)">
                        <div class="icon-bg" style="background-image: url('${icons.shopping}')"></div><span class="app-name">购物</span>
                    </div>
                    <div class="app-icon" onclick="showPage('sticker-app-page', renderStickerAppPage, true)">
                        <div class="icon-bg" style="background-image: url('${icons.stickers}')"></div><span class="app-name">表情包</span>
                    </div>
                    <div class="app-icon" onclick="showPage('calendar-app-page', renderCalendarAppPage)">
                        <div class="icon-bg" style="background-image: url('${icons.calendar}')"></div><span class="app-name">日历</span>
                    </div>
                `;
            }
            
            // Page 3 Apps
            const appGridP3 = container.querySelector('#app-grid-p3');
            if (appGridP3) {
                appGridP3.innerHTML = `
                    <div class="app-icon" onclick="showPage('ui-beautify-page', renderUiBeautifyPage)">
                        <div class="icon-bg" style="background-image: url('${icons.ui_beautify}')"></div><span class="app-name">UI美化</span>
                    </div>
                    <div class="app-icon" onclick="showPage('char-balance-app-page', renderCharBalanceAppPage)">
                        <div class="icon-bg" style="background-image: url('${icons.char_balance}')"></div><span class="app-name">对方余额</span>
                    </div>
                    <div class="app-icon" onclick="showPage('bookshelf-app-page', renderBookshelfApp)">
                        <div class="icon-bg" style="background-image: url('${icons.bookshelf}')"></div><span class="app-name">书架</span>
                    </div>
                    <div class="app-icon" onclick="showPage('certificate-app-page', renderCertificateAppPage)">
                        <div class="icon-bg" style="background-image: url('${icons.certificate}')"></div><span class="app-name">证件办理</span>
                    </div>
                    ${Array(8).fill('').map(() => `
                        <div class="app-icon" onclick="showToast('开发中...')">
                            <div class="icon-bg" style="background-color: #ccc;"></div><span class="app-name">...</span>
                        </div>
                    `).join('')}
                `;
            }

            renderHomeScreenWidgets();
            renderHomeScreenWidgetsPage2();
            renderHomeScreenWidgetsPage3();
            setupHomeScreenPager();
            updateSystemUI();
        }

        function setupHomeScreenPager() {
            const pager = document.getElementById('home-screen-pager');
            const indicatorsContainer = document.getElementById('home-screen-page-indicators');
            if (!pager || !indicatorsContainer) return;

            const pages = pager.querySelectorAll('.home-screen-page-content');
            indicatorsContainer.innerHTML = Array.from(pages).map((_, i) => `<div class="dot ${i === 0 ? 'active' : ''}" data-index="${i}"></div>`).join('');
            const dots = indicatorsContainer.querySelectorAll('.dot');

            pager.onscroll = () => {
                const scrollLeft = pager.scrollLeft;
                const pageWidth = pager.offsetWidth;
                const activeIndex = Math.round(scrollLeft / pageWidth);
                
                dots.forEach((dot, i) => {
                    dot.classList.toggle('active', i === activeIndex);
                });
            };
        }

        function renderHomeScreenWidgets() {
            const container = document.getElementById('home-screen-widgets-container');
            if (!container) return;

            const currentSong = appData.music.library.find(s => s.id === appData.music.currentSongId);
            const musicWidgetHtml = `
                <div class="widget-card" id="home-screen-music-player-widget" onclick="showPage('music-library-page', renderMusicLibraryPage)">
                    <img src="${currentSong?.cover || 'https://img.js.design/assets/img/664e0d45692271d43c087968.jpg'}" class="cover">
                    <div class="info">
                        <div class="title">${currentSong?.title || '暂无歌曲'}</div>
                        <div class="artist">${currentSong?.artist || '...'}</div>
                    </div>
                    <div class="controls">
                        <i class="fas ${appData.music.isPlaying ? 'fa-pause' : 'fa-play'}" onclick="event.stopPropagation(); togglePlayPause();"></i>
                    </div>
                </div>
            `;

            const customTextWidgetHtml = `
                <div class="widget-card" id="home-screen-custom-text-widget" onclick="showPage('anniversary-app-page', renderAnniversaryAppPage)">
                    ${appData.homeScreenWidgets.customText.text}
                </div>
            `;

            const anniversary = appData.homeScreenWidgets.anniversary;
            let anniversaryWidgetHtml = '';
            if (anniversary.enabled && anniversary.date) {
                const startDate = new Date(anniversary.date);
                const now = new Date();
                const diffTime = now - startDate;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                const char = appData.contacts.find(c => c.id == anniversary.characterId);
                const text = `与 ${char?.name || ''} ${anniversary.description} 了 ${diffDays} 天`;
                anniversaryWidgetHtml = `
                    <div class="widget-card" id="home-screen-anniversary-widget">
                        <div class="anniversary-widget-content">
                            <div class="bg-image" style="background-image: url('${anniversary.image || 'https://source.unsplash.com/random/100x100?love'}')"></div>
                            <div class="text">${text}</div>
                        </div>
                    </div>
                `;
            }

            const countdown = appData.homeScreenWidgets.countdown;
            let countdownWidgetHtml = '';
            if (countdown.enabled && countdown.date) {
                const targetDate = new Date(countdown.date);
                const now = new Date();
                const diffTime = targetDate - now;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const char = appData.contacts.find(c => c.id == countdown.characterId);
                const text = `距离 ${char?.name || ''} 的 ${countdown.description} 还有 ${diffDays} 天`;
                countdownWidgetHtml = `
                    <div class="widget-card" id="home-screen-countdown-widget">
                        <div class="anniversary-widget-content">
                            <div class="bg-image" style="background-image: url('${countdown.image || 'https://source.unsplash.com/random/100x100?calendar'}')"></div>
                            <div class="text">${text}</div>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = musicWidgetHtml + customTextWidgetHtml + anniversaryWidgetHtml + countdownWidgetHtml;
        }

        function renderHomeScreenWidgetsPage2() {
            const container = document.getElementById('home-screen-widgets-container-p2');
            if (!container) return;

            const calendarHtml = generateCalendarWidgetHTML();
            const imageChangerHtml = `
                <div class="widget-image-changer" style="background-image: url('${appData.homeScreenWidgets.imageChanger.image}')" onclick="changeWidgetImage()"></div>
            `;
            
            container.innerHTML = calendarHtml + imageChangerHtml;
        }
        
        function renderHomeScreenWidgetsPage3() {
            const container = document.getElementById('home-screen-widgets-container-p3');
            if (!container) return;
            const locationWidget = appData.homeScreenWidgets.locationP3;
            const locationWidgetHtml = `
                <div class="widget-location" style="background-image: url('${locationWidget.image}')" onclick="editLocationWidget()">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>${locationWidget.name}</span>
                </div>
            `;
            container.innerHTML = locationWidgetHtml;
        }

        function editLocationWidget() {
            const modalId = 'edit-location-widget-modal';
            const locationWidget = appData.homeScreenWidgets.locationP3;
            const html = `
                <div class="modal-content">
                    <div class="modal-title">编辑位置小组件</div>
                    <div class="form-group">
                        <label>位置名称 (10字以内)</label>
                        <input type="text" id="location-widget-name" class="modal-input" value="${locationWidget.name}" maxlength="10">
                    </div>
                    <div class="form-group">
                        <label>背景图片</label>
                        <img src="${locationWidget.image}" class="avatar-upload-preview" id="location-widget-image-preview" onclick="document.getElementById('location-widget-image-input').click()">
                        <input type="file" id="location-widget-image-input" class="file-input" accept="image/*">
                    </div>
                    <button class="form-btn" id="save-location-widget-btn">保存</button>
                </div>
            `;
            showModal(modalId, html);

            document.getElementById('location-widget-image-input').onchange = e => {
                handleImageUpload(e.target.files[0], url => {
                    document.getElementById('location-widget-image-preview').src = url;
                });
            };

            document.getElementById('save-location-widget-btn').onclick = () => {
                const newName = document.getElementById('location-widget-name').value.trim();
                const newImage = document.getElementById('location-widget-image-preview').src;
                if (newName) {
                    appData.homeScreenWidgets.locationP3.name = newName;
                    appData.homeScreenWidgets.locationP3.image = newImage;
                    saveData();
                    renderHomeScreenWidgetsPage3();
                    closeModal(modalId);
                }
            };
        }

        function generateCalendarWidgetHTML() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const today = now.getDate();

            const firstDayOfMonth = new Date(year, month, 1);
            let firstDayOfWeek = firstDayOfMonth.getDay();
            if (firstDayOfWeek === 0) firstDayOfWeek = 7;

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();

            let tableHtml = `
                <div class="widget-calendar">
                    <div class="header">
                        <span>${year}年 ${month + 1}月</span>
                    </div>
                    <table>
                        <thead><tr><th>一</th><th>二</th><th>三</th><th>四</th><th>五</th><th>六</th><th>日</th></tr></thead>
                        <tbody>
            `;

            let date = 1;
            let nextMonthDate = 1;
            let tableBody = '';

            for (let i = 0; i < 6; i++) {
                let row = '<tr>';
                for (let j = 1; j <= 7; j++) {
                    if (i === 0 && j < firstDayOfWeek) {
                        const prevMonthDay = daysInPrevMonth- (firstDayOfWeek - j - 1);
                        row += `<td class="other-month">${prevMonthDay}</td>`;
                    } else if (date > daysInMonth) {
                        row += `<td class="other-month">${nextMonthDate++}</td>`;
                    } else {
                        row += `<td class="${date === today ? 'today' : ''}">${date}</td>`;
                        date++;
                    }
                }
                row += '</tr>';
                tableBody += row;
                if (date > daysInMonth) break;
            }
            tableHtml += tableBody + '</tbody></table></div>';
            return tableHtml;
        }

        function changeWidgetImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = e => {
                handleImageUpload(e.target.files[0], url => {
                    appData.homeScreenWidgets.imageChanger.image = url;
                    saveData();
                    renderHomeScreenWidgetsPage2();
                });
            };
            input.click();
        }

        function renderWechatApp(container) {
            if (!container) {
                console.error("WeChat App Firewall: Container not found.");
                return;
            }
            const activeTab = container.querySelector('.tab-item.active');
            if (!activeTab) {
                console.error("WeChat App Firewall: No active tab found, defaulting to chat-list.");
                container.querySelector('.tab-item[data-page="chat-list"]').classList.add('active');
                renderMainContent('chat-list');
            } else {
                renderMainContent(activeTab.dataset.page);
            }
        }

        function renderMainContent(pageType) {
            const contentArea = document.getElementById('main-content-area');
            const header = document.getElementById('main-header');
            const plusBtn = document.getElementById('main-plus-btn');
            
            if (!contentArea || !header || !plusBtn) return;
            
            contentArea.innerHTML = '';
            plusBtn.style.display = 'block';
            header.querySelector('.header-left').style.visibility = 'visible';

            switch (pageType) {
                case 'chat-list':
                    header.querySelector('.header-title').textContent = '微信';
                    renderChatListPage(contentArea);
                    plusBtn.onclick = () => showMainPlusMenu();
                    break;
                case 'contacts':
                    header.querySelector('.header-title').textContent = '通讯录';
                    renderContactsPage(contentArea);
                    plusBtn.onclick = () => showPage('editor-page', renderEditorPage, 'character');
                    break;
                case 'me':
                    header.querySelector('.header-title').textContent = '';
                    renderMePage(contentArea);
                    header.querySelector('.header-left').style.visibility = 'hidden';
                    plusBtn.style.display = 'none';
                    break;
            }
        }

        function showMainPlusMenu() {
            const modalId = 'main-plus-menu-modal';
            const html = `
                <div class="modal-content" style="padding: 0; background: transparent;">
                    <div class="list-view" style="background: var(--wechat-nav-bg); border-radius: 8px;">
                        <div class="list-item" onclick="showPage('create-group-chat-page', renderCreateGroupChatPage); closeModal('${modalId}');">
                            <i class="fas fa-users" style="width: 20px; text-align: center;"></i><span style="margin-left: 10px;">发起群聊</span>
                        </div>
                        <div class="list-item" onclick="showPage('editor-page', renderEditorPage, 'character'); closeModal('${modalId}');" style="border-bottom: none;">
                            <i class="fas fa-user-plus" style="width: 20px; text-align: center;"></i><span style="margin-left: 10px;">添加朋友</span>
                        </div>
                    </div>
                </div>
            `;
            showModal(modalId, html);
        }

        function renderChatListPage(container) {
            if (!container) return;
            let html = '<div class="list-view">';
            const visibleContacts = appData.contacts.filter(c => !appData.settings.blacklist.includes(c.id));
            const allChats = [...visibleContacts.map(c => ({...c, type: 'individual'})), ...appData.groups.map(g => ({...g, type: 'group'}))];
            
            const sortedChats = [...allChats].sort((a, b) => {
                if (a.isPinned && !b.isPinned) return -1;
                if (!a.isPinned && b.isPinned) return 1;
                const lastMsgA = a.conversation?.[a.conversation.length - 1]?.timestamp || 0;
                const lastMsgB = b.conversation?.[b.conversation.length - 1]?.timestamp || 0;
                return lastMsgB - lastMsgA;
            });

            if (sortedChats.length === 0) {
                html += '<div style="text-align:center; padding: 50px; color: var(--wechat-text-secondary);">暂无聊天，去通讯录添加一个角色吧</div>';
            } else {
                sortedChats.forEach(chat => {
                    const lastMessage = chat.conversation && chat.conversation.length > 0
                        ? chat.conversation[chat.conversation.length - 1]
                        : null;
                    
                    let subtext = '...';
                    let displayTime = '';

                    if (lastMessage) {
                        const time = new Date(lastMessage.timestamp);
                        displayTime = time.toLocaleDateString() === new Date().toLocaleDateString()
                            ? time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                            : `${time.getMonth()+1}/${time.getDate()}`;
                        
                        switch(lastMessage.type) {
                            case 'image': subtext = '[图片]'; break;
                            case 'sticker': subtext = '[表情]'; break;
                            case 'voice': subtext = '[语音]'; break;
                            case 'location': subtext = '[位置]'; break;
                            case 'transfer': subtext = '[转账]'; break;
                            case 'redPacket': subtext = '[红包]'; break;
                            case 'kinshipCard': subtext = '[亲属卡]'; break;
                            case 'forward': subtext = '[聊天记录]'; break;
                            case 'camera-sim': subtext = '[图片]'; break;
                            case 'html-content': subtext = '[代码片段]'; break;
                            case 'gift': subtext = `[礼物] ${lastMessage.content.name}`; break;
                            case 'delivery_receipt': subtext = '[外卖订单]'; break;
                            case 'gift_receipt': subtext = '[礼物清单]'; break;
                            case 'voice_call': subtext = '[语音通话]'; break;
                            case 'netease_share': subtext = '[分享动态]'; break;
                            case 'file': subtext = `[文件] ${lastMessage.content.name}`; break;
                            case 'system': subtext = lastMessage.content.content; break;
                            default: subtext = lastMessage.content.content;
                        }
                    }

                    let displayName = chat.type === 'group' ? chat.name : (chat.remark || chat.name);
                    const starIcon = chat.isStarred ? '<i class="fas fa-star"></i>' : '';
                    const avatarSrc = chat.type === 'group' ? (chat.avatar || 'https://img.js.design/assets/img/65a881fa383e6a42242a3f33.jpg') : chat.avatar;
                    const statusDot = chat.type === 'individual' && chat.status !== 'invisible' ? `<span class="status-dot ${chat.status}"></span>` : '';

                    html += `
                        <div class="list-item" onclick="showPage('conversation-page', renderConversationPage, '${chat.id}', '${chat.type}')">
                            <img src="${avatarSrc}" class="avatar">
                            <div class="details">
                                <span class="name">${statusDot}${displayName} ${starIcon}</span>
                                <p class="subtext">${subtext ? subtext.substring(0, 25) : '...'}</p>
                            </div>
                            <div class="info">
                                <span>${displayTime}</span>
                            </div>
                        </div>
                    `;
                });
            }
            html += '</div>';
            container.innerHTML = html;
        }

        function renderContactsPage(container) {
            if (!container) return;
            let html = '<div class="list-view">';
            const visibleContacts = appData.contacts.filter(c => !appData.settings.blacklist.includes(c.id));
            visibleContacts.forEach(contact => {
                
                const displayName = contact.remark || contact.name;
                const statusDot = contact.status !== 'invisible' ? `<span class="status-dot ${contact.status}"></span>` : '';
                html += `
                    <div class="list-item" onclick="showPage('editor-page', renderEditorPage, 'character', ${contact.id})">
                        <img src="${contact.avatar}" class="avatar">
                        <div class="details">
                            <span class="name">${statusDot}${displayName}</span>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function renderMePage(container) {
            if (!container) return;
            const user = appData.user;
            container.innerHTML = `
                <div class="me-profile-card" onclick="showPage('editor-page', renderEditorPage, 'user')">
                    <img src="${user.avatar}" class="avatar">
                    <div class="details">
                        <p class="name">${user.nickname}</p>
                        <p class="wxid">微信号: ${user.wxid}</p>
                        <p class="signature">${user.signature}</p>
                    </div>
                    <i class="fas fa-qrcode qr-code"></i>
                </div>
                <div class="list-divider"></div>
                <div class="me-menu-item" onclick="showPage('status-settings-page', renderStatusSettingsPage)">
                    <div class="ui-icon me-status"></div>
                    <span>状态</span>
                    <i class="fas fa-chevron-right chevron"></i>
                </div>
                <div class="me-menu-item" onclick="showPage('wallet-page', renderWalletPage)">
                    <div class="ui-icon me-wallet"></div>
                    <span>钱包</span>
                    <i class="fas fa-chevron-right chevron"></i>
                </div>
                <div class="me-menu-item" onclick="showPage('self-persona-list-page', renderSelfPersonaListPage)">
                    <div class="ui-icon me-persona"></div>
                    <span>我的自设</span>
                    <i class="fas fa-chevron-right chevron"></i>
                </div>
                <div class="me-menu-item">
                    <div class="ui-icon me-address"></div>
                    <span>地址</span>
                    <span class="info" style="flex: 1; text-align: right; padding-right: 10px;">${user.address || '未设置'}</span>
                </div>
                <div class="list-divider"></div>
                <div class="me-menu-item" onclick="showPage('moments-page', renderMomentsPage)">
                    <div class="ui-icon me-moments"></div>
                    <span>朋友圈</span>
                    <i class="fas fa-chevron-right chevron"></i>
                </div>
            `;
        }

        function renderSettingsAppPage(container) {
            if (!container) {
                console.error("Settings App Firewall: Container not found.");
                return;
            }
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div></div>
                    <span class="header-title">设置</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="showPage('api-settings-page', renderApiSettingsPage)">
                        <div class="details"><span class="name">API 设置</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('language-settings-page', renderLanguageSettingsPage)">
                        <div class="details"><span class="name">角色语言设置</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('display-settings-page', renderDisplaySettingsPage)">
                        <div class="details"><span class="name">显示功能</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('status-bar-settings-page', renderStatusBarSettingsPage)">
                        <div class="details"><span class="name">手机顶部状态栏显示</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('notification-settings-page', renderNotificationSettingsPage)">
                        <div class="details"><span class="name">聊天提示音</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="showPage('blacklist-page', renderBlacklistPage)">
                        <div class="details"><span class="name">黑名单</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('storage-settings-page', renderStorageSettingsPage)">
                        <div class="details"><span class="name">储存空间</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('data-management-page', renderDataManagementPage)">
                        <div class="details"><span class="name">数据备份与恢复</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="showCharMomentFrequencySettings()">
                        <div class="details"><span class="name">AI动态频率</span></div>
                        <span class="info">${{'low': '较低', 'default': '默认', 'high': '较高'}[appData.settings.charMomentFrequency]}</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('chat-mode-page', renderChatModePage)">
                        <div class="details"><span class="name">聊天模式</span></div>
                        <span class="info">${appData.settings.chatMode === 'online' ? '线上聊天' : '线下剧情'}</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('timestamp-settings-page', renderTimestampSettingsPage)">
                        <div class="details"><span class="name">时间戳样式</span></div>
                        <span class="info">${{'center': '居中', 'bubble-outside': '气泡外', 'avatar-under': '头像下', 'bubble-inside': '气泡内'}[appData.settings.timestampStyle]}</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('background-interaction-page', renderBackgroundInteractionPage)">
                        <div class="details"><span class="name">后台互动</span></div>
                        <span class="info">${appData.settings.backgroundInteraction.enabled ? '已开启' : '已关闭'}</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('time-perception-settings-page', renderTimePerceptionSettingsPage)">
                        <div class="details"><span class="name">时间感知</span></div>
                        <span class="info">${appData.settings.timePerception ? '已开启' : '已关闭'}</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item">
                        <div class="details"><span class="name">记忆互通</span><p class="subtext">开启后，角色在私聊和群聊中的记忆将互通。</p></div>
                        <label class="switch"><input type="checkbox" id="memory-interflow-toggle" ${appData.settings.memoryInterflow ? 'checked' : ''}><span class="slider"></span></label>
                    </div>
                    <div class="list-item">
                        <div class="details"><span class="name">消息免打扰</span></div>
                        <label class="switch"><input type="checkbox" id="dnd-toggle" ${appData.settings.dnd ? 'checked' : ''}><span class="slider"></span></label>
                    </div>
                </div>
            `;
            document.getElementById('dnd-toggle').onchange = e => {
                appData.settings.dnd = e.target.checked;
                saveData();
                updateSystemUI();
            };
            document.getElementById('memory-interflow-toggle').onchange = e => {
                appData.settings.memoryInterflow = e.target.checked;
                saveData(true);
            };
        }

        function renderDisplaySettingsPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>设置</span></div>
                    <span class="header-title">显示功能</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="setDisplayMode('default')">
                        <div class="details"><span class="name">保留边框</span></div>
                        ${appData.settings.displayMode === 'default' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setDisplayMode('iphone6')">
                        <div class="details"><span class="name">保留边框②</span></div>
                        ${appData.settings.displayMode === 'iphone6' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setDisplayMode('fullscreen')">
                        <div class="details"><span class="name">去除边框进入全屏</span></div>
                        ${appData.settings.displayMode === 'fullscreen' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                </div>
            `;
        }

        function setDisplayMode(mode) {
            appData.settings.displayMode = mode;
            saveData();
            applyBeautifySettings();
            renderDisplaySettingsPage(document.getElementById('display-settings-page'));
        }

        function renderWorldbookAppPage(container) {
            if (!container) {
                console.error("Worldbook App Firewall: Container not found.");
                return;
            }
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div></div>
                    <span class="header-title">世界书</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="showWorldbookEditor('presets')">
                        <div class="details"><span class="name">预设</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showWorldbookEditor('styles')">
                        <div class="details"><span class="name">文风</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showWorldbookEditor('library')">
                        <div class="details"><span class="name">世界书库</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showWorldbookEditor('stickerPacks')">
                        <div class="details"><span class="name">表情包世界书</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                </div>
            `;
        }

        // ★★★ 优化：新建角色/编辑自设头像裁剪功能 ★★★
        let cropperInstance = null;
        let currentCropperCallback = null;

        function showCropperModal(imageSrc, callback, aspectRatio = 1) {
            currentCropperCallback = callback;
            const modalId = 'cropper-modal';
            const html = `
                <div id="cropper-modal-content">
                    <div class="modal-title">裁剪头像</div>
                    <div id="cropper-container">
                        <img id="cropper-image" src="${imageSrc}">
                    </div>
                    <div class="cropper-actions">
                        <button onclick="cropperInstance.rotate(-45)"><i class="fas fa-undo"></i></button>
                        <button onclick="cropperInstance.rotate(45)"><i class="fas fa-redo"></i></button>
                        <button onclick="cropperInstance.setAspectRatio(1/1)">1:1</button>
                        <button onclick="cropperInstance.setAspectRatio(4/3)">4:3</button>
                        <button onclick="cropperInstance.setAspectRatio(16/9)">16:9</button>
                        <button onclick="cropperInstance.setAspectRatio(NaN)">自由</button>
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" id="crop-confirm-btn">确认</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);

            const image = document.getElementById('cropper-image');
            cropperInstance = new Cropper(image, {
                aspectRatio: aspectRatio,
                viewMode: 1,
                background: false,
                autoCropArea: 0.8,
            });

            document.getElementById('crop-confirm-btn').onclick = () => {
                const croppedCanvas = cropperInstance.getCroppedCanvas();
                if (currentCropperCallback) {
                    currentCropperCallback(croppedCanvas.toDataURL());
                }
                closeModal(modalId);
            };
        }

        function renderEditorPage(container, type, id = null) {
            if (!container) return;
            const isUser = type === 'user';
            const target = isUser ? appData.user : appData.contacts.find(c => c.id == id);
            const isNewCharacter = !isUser && !target;
            const title = isUser ? "编辑我的信息" : (target ? "编辑角色信息" : "新建角色");
            const personaLabel = isUser ? '个性签名 (15字以内)' : '角色设定 (Persona)';

            let avatarSrc = 'https://img.js.design/assets/img/65a881fa383e6a42242a3f33.jpg';
            if (target) avatarSrc = target.avatar;

            const relationshipOptions = ['朋友', '恋人', '家人', '同事', '同学', '自定义...'];
            let relationshipHtml = '';
            if (!isUser) {
                relationshipHtml = `
                    <div class="form-group">
                        <label>关系</label>
                        <select id="editor-relationship">
                            ${relationshipOptions.map(r => `<option value="${r}" ${target?.relationship === r ? 'selected' : ''}>${r}</option>`).join('')}
                        </select>
                        <input type="text" id="editor-relationship-custom" style="display:none; margin-top:10px;" placeholder="自定义关系 (10字以内)" maxlength="10" value="${!relationshipOptions.includes(target?.relationship) ? target?.relationship : ''}">
                    </div>
                `;
            }

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()">
                        <div class="ui-icon back"></div>
                        <span>返回</span>
                    </div>
                    <span class="header-title">${title}</span>
                </div>
                <div class="content-area">
                    <img src="${avatarSrc}" class="avatar-upload-preview" id="editor-avatar-preview" onclick="document.getElementById('editor-avatar-input').click()">
                    <input type="file" id="editor-avatar-input" class="file-input" accept="image/*">
                    <div class="form-group">
                        <label>${isUser ? '网名昵称' : '名字'}</label>
                        <input type="text" id="editor-name" value="${target ? (isUser ? target.nickname : target.name) : ''}">
                    </div>
                    ${!isUser ? `
                    <div class="form-group">
                        <label>性别</label>
                        <select id="editor-gender" ${isNewCharacter ? '' : 'disabled'}>
                            <option value="male" ${target?.gender === 'male' ? 'selected' : ''}>男</option>
                            <option value="female" ${target?.gender === 'female' ? 'selected' : ''}>女</option>
                            <option value="other" ${target?.gender === 'other' ? 'selected' : ''}>其他</option>
                        </select>
                        ${!isNewCharacter ? '<p class="subtext">性别创建后不可更改。</p>' : ''}
                    </div>` : ''}
                    ${relationshipHtml}
                    ${isUser ? `
                    <div class="form-group">
                        <label>微信号</label>
                        <input type="text" id="editor-wxid" value="${target?.wxid || ''}">
                    </div>
                    <div class="form-group">
                        <label>地址 (20字以内)</label>
                        <input type="text" id="editor-address" value="${target?.address || ''}" maxlength="20">
                    </div>
                    <div class="form-group">
                        <label>个性签名 (15字以内)</label>
                        <input type="text" id="editor-signature" value="${target?.signature || ''}" maxlength="15">
                    </div>` : `
                    <div class="form-group">
                        <label>${personaLabel}</label>
                        <textarea id="editor-persona" style="min-height: 200px;">${target?.persona || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>个人爱好 (可不填)</label>
                        <textarea id="editor-hobbies" style="min-height: 100px;">${target?.hobbies || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>个人经历 (可不填)</label>
                        <textarea id="editor-experience" style="min-height: 150px;">${target?.experience || ''}</textarea>
                    </div>
                    `}
                    <button class="form-btn" id="editor-save-btn">保存</button>
                </div>
            `;

            if (!isUser) {
                const relationshipSelect = document.getElementById('editor-relationship');
                const customInput = document.getElementById('editor-relationship-custom');
                const toggleCustomInput = () => {
                    customInput.style.display = relationshipSelect.value === '自定义...' ? 'block' : 'none';
                };
                relationshipSelect.onchange = toggleCustomInput;
                toggleCustomInput();
            }

            document.getElementById('editor-avatar-input').onchange = e => {
                handleImageUpload(e.target.files[0], dataUrl => {
                    showCropperModal(dataUrl, (croppedDataUrl) => {
                        document.getElementById('editor-avatar-preview').src = croppedDataUrl;
                    });
                });
            };

            document.getElementById('editor-save-btn').onclick = () => {
                const newAvatar = document.getElementById('editor-avatar-preview').src;
                const newName = document.getElementById('editor-name').value.trim();

                if (!newName) { showToast('名字/昵称不能为空', 'error'); return; }

                if (isUser) {
                    appData.user.avatar = newAvatar;
                    appData.user.nickname = newName;
                    appData.user.wxid = document.getElementById('editor-wxid').value.trim();
                    appData.user.address = document.getElementById('editor-address').value.trim();
                    appData.user.signature = document.getElementById('editor-signature').value.trim();
                } else {
                    const newPersona = document.getElementById('editor-persona').value.trim();
                    const newHobbies = document.getElementById('editor-hobbies').value.trim();
                    const newExperience = document.getElementById('editor-experience').value.trim();
                    let newRelationship = document.getElementById('editor-relationship').value;
                    if (newRelationship === '自定义...') {
                        newRelationship = document.getElementById('editor-relationship-custom').value.trim();
                        if (!newRelationship) { showToast('自定义关系不能为空', 'error'); return; }
                    }

                    if (target) { // Editing existing character
                        target.avatar = newAvatar;
                        target.name = newName;
                        target.persona = newPersona;
                        target.hobbies = newHobbies;
                        target.experience = newExperience;
                        target.relationship = newRelationship;
                    } else { // Creating new character
                        const newGender = document.getElementById('editor-gender').value;
                        const newContact = {
                            id: Date.now(), name: newName, avatar: newAvatar, persona: newPersona,
                            gender: newGender, hobbies: newHobbies, experience: newExperience,
                            relationship: newRelationship,
                            conversation: [], remark: '', isPinned: false, isStarred: false, lastMomentPostTime: 0,
                            boundPersonaId: null, status: 'online',
                            pokeSettings: { userToChar: { action: '拍了拍', suffix: '' }, charToUser: { action: '拍了拍', suffix: '' } },
                            chatSettings: { background: '', userAvatar: '', charAvatar: ''},
                            wallet: { balance: Math.floor(Math.random() * 500000) }
                        };
                        appData.contacts.push(newContact);
                    }
                }
                saveData(true, goBack);
            };
        }
        
        // ★★★ 优化：群聊渲染与@弹窗逻辑 ★★★
        function renderConversationPage(container, chatId, chatType) {
            appData.activeChat.id = chatId;
            appData.activeChat.type = chatType;

            let chat;
            if (chatType === 'group') {
                chat = appData.groups.find(g => g.id == chatId);
            } else {
                chat = appData.contacts.find(c => c.id == chatId);
            }
            
            if (!chat) {
                console.error(`Chat Firewall: Chat not found (ID: ${chatId}, Type: ${chatType})`);
                showToast('找不到该聊天', 'error');
                goBack();
                return;
            }
            
            let displayName = chatType === 'group' ? `${chat.name} (${chat.members.length})` : (chat.remark || chat.name);
            const chatSettings = chat.chatSettings || {};

            container.querySelector('#sticker-picker-overlay')?.remove();
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()">
                        <div class="ui-icon back"></div>
                    </div>
                    <span class="header-title">${displayName}</span>
                    <div class="header-right" onclick="showPage('${chatType === 'group' ? 'group-chat-settings-page' : 'chat-settings-page'}', ${chatType === 'group' ? 'renderGroupChatSettingsPage' : 'renderChatSettingsPage'}, '${chatId}')"><i class="fas fa-ellipsis-h"></i></div>
                </div>
                <div class="content-area" id="message-area" style="${chatSettings.background ? `background-image: url(${chatSettings.background})` : ''}">
                </div>
                <div class="chat-input-bar">
                    <div class="mention-popup" id="mention-popup" style="display:none;"></div>
                    <div class="ui-icon chat-resend" id="chat-resend-btn"></div>
                    <div class="ui-icon chat-voice" id="chat-voice-btn"></div>
                    <input type="text" id="chat-input" placeholder="发送消息">
                    <div class="ui-icon chat-sticker" id="chat-sticker-btn"></div>
                    <div class="ui-icon chat-plus" id="chat-plus-btn"></div>
                </div>
                <div class="chat-plus-menu" id="chat-plus-menu">
                    <div class="plus-menu-item" id="plus-image-btn"><div class="icon"><div class="ui-icon plus-image"></div></div><span>相册</span></div>
                    <div class="plus-menu-item" id="plus-camera-btn"><div class="icon"><div class="ui-icon plus-camera"></div></div><span>拍摄</span></div>
                    <div class="plus-menu-item" id="plus-voice-call-btn"><div class="icon"><div class="ui-icon plus-phone"></div></div><span>语音通话</span></div>
                    <div class="plus-menu-item" id="plus-location-btn"><div class="icon"><div class="ui-icon plus-location"></div></div><span>位置</span></div>
                    <div class="plus-menu-item" id="plus-redpacket-btn"><div class="icon"><div class="ui-icon plus-redpacket"></div></div><span>红包</span></div>
                    <div class="plus-menu-item" id="plus-transfer-btn"><div class="icon"><div class="ui-icon plus-transfer"></div></div><span>转账</span></div>
                    <div class="plus-menu-item" id="plus-kinship-btn"><div class="icon"><div class="ui-icon plus-kinship"></div></div><span>亲属卡</span></div>
                    <div class="plus-menu-item" id="plus-diary-btn"><div class="icon"><div class="ui-icon plus-diary"></div></div><span>对方日记</span></div>
                    <div class="plus-menu-item" id="plus-file-btn"><div class="icon"><div class="ui-icon plus-file"></div></div><span>文件</span></div>
                    <div class="plus-menu-item" id="plus-heartbeat-btn"><div class="icon"><div class="ui-icon plus-heartbeat"></div></div><span>心声</span></div>
                </div>
                <div class="multi-select-toolbar" id="multi-select-toolbar">
                    <button id="multi-select-forward-btn" disabled><i class="fas fa-share"></i><span>转发</span></button>
                    <button id="multi-select-delete-btn" disabled><i class="fas fa-trash-alt"></i><span>删除</span></button>
                    <button id="multi-select-cancel-btn"><i class="fas fa-times"></i><span>取消</span></button>
                </div>
                <div id="sticker-picker-overlay"></div>
            `;
            
            renderMessages(chatId, chatType, 'wechat');

            const input = document.getElementById('chat-input');
            
            document.getElementById('chat-resend-btn').onclick = async () => {
                const lastUserMessageIndex = findLastIndex(chat.conversation, m => m.sender === appData.user.id);
                if (lastUserMessageIndex === -1) {
                    showToast('没有可重新回复的消息', 'error');
                    return;
                }
                
                chat.conversation = chat.conversation.slice(0, lastUserMessageIndex + 1);
                await saveData();
                renderMessages(chatId, chatType, 'wechat');
                
                showToast('正在请求重新回复...');
                setTypingIndicator(chatId, true, null, 'wechat');
                const replies = await getAiReply(chat.id, 'wechat');
                setTypingIndicator(chatId, false, null, 'wechat');
                for (const reply of replies) {
                    await new Promise(r => setTimeout(r, 500 + Math.random() * 1000));
                    await processAndSendAiReply(reply, chat.id, 'individual', chat.id, 'wechat');
                }
            };

            input.onkeydown = (e) => {
                if (e.key === 'Enter' && input.value.trim() !== '') {
                    e.preventDefault();
                    const quotedMessageId = input.dataset.quotedMessageId;
                    const mentionedUsers = JSON.parse(input.dataset.mentionedUsers || '[]');
                    sendMessage(chatId, chatType, { content: input.value.trim(), mentionedUsers }, 'text', 'wechat', quotedMessageId);
                    input.value = '';
                    input.placeholder = '发送消息';
                    delete input.dataset.quotedMessageId;
                    delete input.dataset.mentionedUsers;
                }
            };

            // ★★★ 优化：@功能逻辑 ★★★
            input.addEventListener('input', () => {
                const mentionPopup = document.getElementById('mention-popup');
                const text = input.value;
                const atIndex = text.lastIndexOf('@');
                if (chatType === 'group' && atIndex !== -1 && (atIndex === 0 || /\s|@/.test(text[atIndex - 1]))) {
                    const searchTerm = text.substring(atIndex + 1);
                    const group = appData.groups.find(g => g.id == chatId);
                    const allMentionable = [appData.user, ...group.members.filter(m => m.id !== appData.user.id)];
                    const members = allMentionable.filter(m => (m.name || m.nickname).toLowerCase().includes(searchTerm.toLowerCase()));
                    
                    if (members.length > 0) {
                        mentionPopup.innerHTML = members.map(m => {
                            const memberId = m.id === 'user' ? "'user'" : m.id;
                            return `<div class="list-item" onclick="selectMention('${m.name || m.nickname}', ${memberId})">
                                        <img src="${m.avatar}" class="avatar" style="width:32px; height:32px;">
                                        <span>${m.name || m.nickname}</span>
                                    </div>`;
                        }).join('');
                        mentionPopup.style.display = 'block';
                    } else {
                        mentionPopup.style.display = 'none';
                    }
                } else {
                    mentionPopup.style.display = 'none';
                }
            });
            
            document.getElementById('chat-plus-btn').onclick = () => {
                const menu = document.getElementById('chat-plus-menu');
                menu.style.display = menu.style.display === 'grid' ? 'none' : 'grid';
            };
            
            document.getElementById('chat-voice-btn').onclick = () => showVoiceInputModal(chatId, chatType, 'wechat');
            document.getElementById('plus-image-btn').onclick = () => document.getElementById('image-file-input-chat').click();
            container.insertAdjacentHTML('beforeend', '<input type="file" id="image-file-input-chat" class="file-input" accept="image/*" multiple>');
            document.getElementById('image-file-input-chat').onchange = e => {
                Array.from(e.target.files).forEach(file => {
                    handleImageUpload(file, dataUrl => {
                        sendMessage(chatId, chatType, { url: dataUrl, description: "用户发送了一张图片" }, 'image', 'wechat');
                    });
                });
            };
            
            document.getElementById('plus-file-btn').onclick = () => document.getElementById('file-input-chat').click();
            container.insertAdjacentHTML('beforeend', '<input type="file" id="file-input-chat" class="file-input">');
            document.getElementById('file-input-chat').onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        sendMessage(chatId, chatType, { 
                            name: file.name, 
                            size: file.size,
                            type: file.type,
                            dataUrl: event.target.result 
                        }, 'file', 'wechat');
                    };
                    reader.readAsDataURL(file);
                }
            };

            document.getElementById('plus-camera-btn').onclick = () => showCameraSimModal(chatId, chatType, 'wechat');
            document.getElementById('plus-location-btn').onclick = () => showLocationInputModal(chatId, chatType, 'wechat');
            document.getElementById('plus-transfer-btn').onclick = () => showTransactionModal('transfer', chatId, chatType);
            document.getElementById('plus-redpacket-btn').onclick = () => showTransactionModal('redPacket', chatId, chatType);
            document.getElementById('plus-kinship-btn').onclick = () => showKinshipCardModal(chatId, chatType);
            document.getElementById('chat-sticker-btn').onclick = () => showStickerPicker('wechat');
            document.getElementById('plus-diary-btn').onclick = () => showPage('diary-page', renderDiaryPage, chatId);
            document.getElementById('plus-voice-call-btn').onclick = () => startVoiceCall(chatId, chatType, 'user');
            document.getElementById('plus-heartbeat-btn').onclick = () => showHeartbeatModal(chatId); // ★★★ 新增心声功能绑定 ★★★

            const multiSelectToolbar = document.getElementById('multi-select-toolbar');
            const forwardBtn = document.getElementById('multi-select-forward-btn');
            const deleteBtn = document.getElementById('multi-select-delete-btn');
            const cancelBtn = document.getElementById('multi-select-cancel-btn');
            let multiSelectState = { active: false, selectedIds: new Set() };

            window.startMultiSelectMode = (messageId, source) => {
                if (source !== 'wechat') return;
                multiSelectState.active = true;
                multiSelectState.selectedIds.add(messageId);
                multiSelectToolbar.classList.add('active');
                document.querySelector('#conversation-page .chat-input-bar').style.display = 'none';
                updateMultiSelectUI();
            };

            const updateMultiSelectUI = () => {
                document.querySelectorAll('#message-area .message-row').forEach(row => {
                    row.classList.add('multi-select-mode');
                    if (multiSelectState.selectedIds.has(parseInt(row.dataset.messageId))) {
                        row.classList.add('selected');
                    } else {
                        row.classList.remove('selected');
                    }
                });
                const hasSelection = multiSelectState.selectedIds.size > 0;
                forwardBtn.disabled = !hasSelection;
                deleteBtn.disabled = !hasSelection;
            };

            const endMultiSelectMode = () => {
                multiSelectState.active = false;
                multiSelectState.selectedIds.clear();
                multiSelectToolbar.classList.remove('active');
                document.querySelector('#conversation-page .chat-input-bar').style.display = 'flex';
                document.querySelectorAll('#message-area .message-row').forEach(row => {
                    row.classList.remove('multi-select-mode', 'selected');
                });
            };

            cancelBtn.onclick = endMultiSelectMode;

            forwardBtn.onclick = () => {
                if (multiSelectState.selectedIds.size > 0) {
                    showForwardMessageModal(Array.from(multiSelectState.selectedIds), chatId, chatType, 'wechat');
                    endMultiSelectMode();
                }
            };

            deleteBtn.onclick = () => {
                if (multiSelectState.selectedIds.size > 0 && confirm(`确定要删除这 ${multiSelectState.selectedIds.size} 条消息吗？`)) {
                    const idsToDelete = new Set(Array.from(multiSelectState.selectedIds).map(id => parseInt(id)));
                    chat.conversation = chat.conversation.filter(msg => !idsToDelete.has(msg.id));
                    saveData();
                    renderMessages(chatId, chatType, 'wechat');
                    endMultiSelectMode();
                }
            };

            document.getElementById('message-area').addEventListener('click', e => {
                if (!multiSelectState.active) return;
                const messageRow = e.target.closest('.message-row');
                if (messageRow) {
                    const messageId = parseInt(messageRow.dataset.messageId);
                    if (multiSelectState.selectedIds.has(messageId)) {
                        multiSelectState.selectedIds.delete(messageId);
                    } else {
                        multiSelectState.selectedIds.add(messageId);
                    }
                    updateMultiSelectUI();
                }
            });
        }

        // ★★★ 新增/优化：@选择逻辑 ★★★
        function selectMention(name, id) {
            const input = document.getElementById('chat-input');
            const text = input.value;
            const atIndex = text.lastIndexOf('@');
            input.value = text.substring(0, atIndex) + `@${name} `;
            
            let mentionedUsers = JSON.parse(input.dataset.mentionedUsers || '[]');
            const memberId = id === 'user' ? 'user' : parseInt(id);
            if (!mentionedUsers.includes(memberId)) {
                mentionedUsers.push(memberId);
            }
            input.dataset.mentionedUsers = JSON.stringify(mentionedUsers);

            document.getElementById('mention-popup').style.display = 'none';
            input.focus();
        }

        function renderMessages(chatId, chatType, source) {
            const containerId = 'message-area';
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`Render Firewall: Message area container '${containerId}' not found.`);
                return;
            }
            
            let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
            if (!chat) return;

            const conversation = chat.conversation || [];
            
            if (appData.settings.chatMode === 'offline' && chatType === 'individual') {
                const plotSettings = appData.settings.beautify.offlinePlot;
                let plotContent = '';
                conversation.forEach(msg => {
                    if (msg.type === 'text' && !msg.isRecalled) {
                        const isUser = msg.sender === appData.user.id;
                        const quoteSymbolStart = isUser ? plotSettings.userQuote.symbolStart : plotSettings.charQuote.symbolStart;
                        const quoteSymbolEnd = isUser ? plotSettings.userQuote.symbolEnd : plotSettings.charQuote.symbolEnd;
                        const narrationSymbolStart = isUser ? plotSettings.userNarration.symbolStart : plotSettings.charNarration.symbolStart;
                        const narrationSymbolEnd = isUser ? plotSettings.userNarration.symbolEnd : plotSettings.charNarration.symbolEnd;

                        const regex = new RegExp(`(${escapeRegExp(quoteSymbolStart)}.*?${escapeRegExp(quoteSymbolEnd)})|(${escapeRegExp(narrationSymbolStart)}.*?${escapeRegExp(narrationSymbolEnd)})`, 'g');
                        
                        let lastIndex = 0;
                        let formattedHtml = '';

                        msg.content.content.replace(regex, (match, quote, narration, offset) => {
                            if (offset > lastIndex) {
                                formattedHtml += `<span class="${isUser ? 'user-narration' : 'char-narration'}">${msg.content.content.substring(lastIndex, offset)}</span>`;
                            }
                            if (quote) {
                                formattedHtml += `<span class="${isUser ? 'user-quote' : 'char-quote'}">${match}</span>`;
                            } else if (narration) {
                                formattedHtml += `<span class="${isUser ? 'user-narration' : 'char-narration'}">${match}</span>`;
                            }
                            lastIndex = offset + match.length;
                        });

                        if (lastIndex < msg.content.content.length) {
                            formattedHtml += `<span class="${isUser ? 'user-narration' : 'char-narration'}">${msg.content.content.substring(lastIndex)}</span>`;
                        }
                        
                        plotContent += `<div ondblclick="showMessageContextMenu(event, ${msg.id}, '${chatId}', '${chatType}', '${source}')">${formattedHtml}</div>`;
                        if (msg.translatedText) {
                            plotContent += `<div class="translated-text-bubble" style="margin-top: 5px;">${msg.translatedText}</div>`;
                        }
                        plotContent += '<br><br>';
                    }
                });

                container.innerHTML = `<div class="offline-plot-container">${plotContent}</div>`;
                container.scrollTop = container.scrollHeight;
                return;
            }

            let html = '';
            let lastTimestamp = 0;
            conversation.forEach((msg, index) => {
                if (!msg || !msg.type || !msg.content) {
                    console.warn("Message Firewall: Skipped rendering malformed message object:", msg);
                    return;
                }

                if (appData.settings.timestampStyle === 'center' && msg.timestamp - lastTimestamp > 5 * 60 * 1000) {
                    html += `<div class="message-timestamp">${new Date(msg.timestamp).toLocaleString()}</div>`;
                    lastTimestamp = msg.timestamp;
                }

                if (msg.isRecalled) {
                    const recallerName = msg.sender === appData.user.id ? appData.user.nickname : (chatType === 'group' ? (chat.members.find(m => m.id == msg.sender)?.name || '未知成员') : (chat.remark || chat.name));
                    html += `<div class="message-recalled">${recallerName} 撤回了一条消息</div>`;
                    return;
                }
                if (msg.type === 'system') {
                    html += `<div class="message-system">${msg.content.content}</div>`;
                    return;
                }

                const isSent = msg.sender === appData.user.id;
                let senderObj;
                const chatSettings = chat.chatSettings || {};

                if (isSent) {
                    senderObj = { ...appData.user, avatar: chatSettings.userAvatar || appData.user.avatar };
                } else {
                    const charBase = (chatType === 'group' ? (chat.members.find(m => m.id == msg.sender) || {name: '未知', avatar: ''}) : chat);
                    senderObj = { ...charBase, avatar: chatSettings.charAvatar || charBase.avatar };
                }
                if (!senderObj) return;

                const avatar = senderObj.avatar;
                let bubbleHtml = '';
                let additionalContent = '';
                let timestampHtml = '';
                let senderNameHtml = ''; // ★★★ 新增：群聊名称显示
                let readReceiptHtml = ''; // ★★★ 新增：已读回执

                if (chatType === 'group' && !isSent) {
                    const member = chat.members.find(m => m.id == msg.sender);
                    if (member) {
                        const memberTitle = group.groupTitles?.[member.id] || group.levelTitles?.[getMemberLevelRange(group.groupTitles?.[member.id]?.level)];
                        let titleBadge = '';
                        if (memberTitle && memberTitle.title) {
                            let badgeClass = 'special';
                            if (member.id === chat.ownerId) badgeClass = 'owner';
                            else if (chat.adminIds.includes(member.id)) badgeClass = 'admin';
                            titleBadge = `<span class="group-title-badge ${badgeClass}">${memberTitle.title} LV.${memberTitle.level || 0}</span>`;
                        } else {
                            if (member.id === chat.ownerId) titleBadge = `<span class="group-title-badge owner">群主</span>`;
                            else if (chat.adminIds.includes(member.id)) titleBadge = `<span class="group-title-badge admin">管理员</span>`;
                        }
                        senderNameHtml = `<div class="message-sender-name">${member.name} ${titleBadge}</div>`;
                    }
                }

                const msgTime = new Date(msg.timestamp);
                const timeString = msgTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second: '2-digit'});

                switch (appData.settings.timestampStyle) {
                    case 'bubble-outside': timestampHtml = `<div class="message-timestamp-under" style="text-align: ${isSent ? 'right' : 'left'};">${timeString}</div>`; break;
                    case 'avatar-under': timestampHtml = `<div class="message-timestamp-under" style="text-align: center;">${timeString}</div>`; break;
                }
                
                // ★★★ 新增：已读回执逻辑 ★★★
                const readSettings = appData.settings.beautify.readReceipt;
                if (readSettings.enabled) {
                    const isLastMessage = index === conversation.length - 1;
                    if (isSent && readSettings.charEnabled) {
                        readReceiptHtml = `<div class="read-receipt ${readSettings.position}">已读</div>`;
                    } else if (!isSent && readSettings.userEnabled && !isLastMessage) {
                        readReceiptHtml = `<div class="read-receipt ${readSettings.position}">已读</div>`;
                    }
                }
                
                bubbleHtml = isSent ? generateUserBubbleHtml(msg, chatId, chatType, 'wechat') : generateCharBubbleHtml(msg, chatId, chatType, 'wechat');

                if (msg.translatedText) additionalContent += `<div class="translated-text-bubble">${msg.translatedText}</div>`;
                if (msg.type === 'voice' && msg.transcribedText) additionalContent += `<div class="voice-transcribed-bubble" onclick="this.style.display='none'">${msg.transcribedText}</div>`;

                if (appData.settings.timestampStyle === 'bubble-inside') {
                    if (['text', 'voice'].includes(msg.type)) {
                         bubbleHtml = bubbleHtml.replace(/<\/div>$/, `<div class="message-timestamp-inside" style="text-align: ${isSent ? 'right' : 'left'};">${timeString}</div></div>`);
                    }
                }

                html += `
                    <div class="message-row ${isSent ? 'sent' : 'received'}" data-message-id="${msg.id}">
                        <div class="message-body">
                            <div class="message-avatar-wrapper" ondblclick="triggerPoke('${chatId}', '${chatType}', '${senderObj.id}', 'wechat')">
                                <img src="${avatar}" class="message-avatar">
                                <div class="avatar-frame"></div>
                                ${appData.settings.timestampStyle === 'avatar-under' ? timestampHtml : ''}
                            </div>
                            <div class="message-content-wrapper">
                                ${senderNameHtml}
                                ${bubbleHtml}
                                ${readSettings.position === 'inside' ? readReceiptHtml : ''}
                                ${additionalContent}
                                ${appData.settings.timestampStyle === 'bubble-outside' ? timestampHtml : ''}
                                ${readSettings.position === 'outside' ? readReceiptHtml : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;
        }

        function generateUserBubbleHtml(msg, chatId, chatType, source) {
            let bubbleContent = '';
            let bubbleClass = '';
            let additionalAttributes = `ondblclick="showMessageContextMenu(event, ${msg.id}, '${chatId}', '${chatType}', '${source}')"`;

            switch(msg.type) {
                case 'text':
                    let quotedHtml = '';
                    if (msg.quotedMessage) {
                        let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
                        let quotedSenderName = '未知';
                        if (chatType === 'group') {
                            const quotedSender = chat.members.find(m => m.id == msg.quotedMessage.sender);
                            quotedSenderName = quotedSender ? (quotedSender.remark || quotedSender.name) : '未知成员';
                        } else {
                            quotedSenderName = msg.quotedMessage.sender === appData.user.id ? appData.user.nickname : (chat.remark || chat.name);
                        }
                        quotedHtml = `<div class="quoted-message"><p><strong>${quotedSenderName}:</strong> ${msg.quotedMessage.content.substring(0, 30)}...</p></div>`;
                    }
                    bubbleContent = `${quotedHtml}${msg.content.content}`;
                    bubbleClass = 'text-bubble';
                    break;
                case 'image':
                    bubbleContent = `<img src="${msg.content.url}" alt="image" oncontextmenu="showImageContextMenu(event, '${msg.content.url}', '${chatId}')">`;
                    bubbleClass = 'image-bubble';
                    break;
                case 'sticker':
                    bubbleContent = `<img src="${msg.content.url}" alt="sticker">`;
                    bubbleClass = 'sticker-bubble';
                    break;
                case 'voice':
                    bubbleContent = `<div class="voice-bubble-content"><span class="duration">${msg.content.duration}"</span><div class="waveform">${Array(10).fill('<div class="bar"></div>').join('')}</div></div>`;
                    bubbleClass = 'voice-bubble text-bubble';
                    additionalAttributes += ` onclick="toggleVoiceBubble(this, ${msg.id}, '${chatId}', '${chatType}', '${source}')"`;
                    break;
                case 'location':
                    bubbleContent = `<div class="location-text-wrapper"><div class="location-text">${msg.content.location}</div></div><div class="map-placeholder"><i class="fas fa-map-marked-alt"></i></div>`;
                    bubbleClass = 'location-bubble';
                    break;
                case 'camera-sim': 
                    bubbleContent = `<img src="https://img.heliar.top/file/1765193531285_Screenshot_2025_1208_190509.png" alt="simulated camera shot">`; 
                    bubbleClass = 'camera-sim-bubble'; 
                    additionalAttributes += ` onclick="handleBubbleClick('camera-sim', ${msg.id}, '${chatId}', '${chatType}', '${source}')"`;
                    break;
                case 'transfer':
                    let transferFooter = '微信转账';
                    if (msg.content.status === 'returned') {
                        transferFooter = '转账已退回';
                    } else if (chatType === 'group') {
                        const group = appData.groups.find(g => g.id == chatId);
                        const recipientName = group.members.find(m => m.id == msg.content.recipientId)?.name || '成员';
                        transferFooter = `转账给 ${recipientName}`;
                    }
                    bubbleContent = `<div class="main"><i class="fas fa-exchange-alt icon"></i><div class="details"><span class="amount">¥${parseFloat(msg.content.amount).toFixed(2)}</span><span class="remark">${msg.content.remark || '已转账'}</span></div></div><div class="footer">${transferFooter}</div>`;
                    bubbleClass = 'transfer-bubble';
                    break;
                case 'redPacket':
                    bubbleContent = `<div class="main"><i class="fas fa-envelope icon"></i><div class="details"><span class="remark">${msg.content.remark}</span><span class="amount" style="font-size: 14px;">查看红包</span></div></div><div class="footer">微信红包</div>`;
                    bubbleClass = 'redpacket-bubble';
                    break;
                case 'kinshipCard':
                    const kinshipRecipient = appData.contacts.find(c => c.id == msg.content.recipientId);
                    bubbleContent = `
                        <div class="main">
                            <i class="fas fa-heart icon"></i>
                            <div class="details">
                                <span class="title">送给 ${kinshipRecipient?.name || '对方'} 一张亲属卡</span>
                                <span class="subtext">每月消费上限: ¥${msg.content.limit.toFixed(2)}</span>
                            </div>
                        </div>
                        <div class="footer">亲属卡 · ${msg.content.category || '爱人'}</div>`;
                    bubbleClass = 'kinship-card-bubble';
                    break;
                case 'forward':
                    forwardedMessageCache[msg.id] = msg.content;
                    const originalChat = appData.groups.find(g => g.id == msg.content.originalChatId) || appData.contacts.find(c => c.id == msg.content.originalChatId);
                    let forwardTitle = '聊天记录';
                    if (originalChat) {
                        if (msg.content.originalChatType === 'group') {
                            forwardTitle = `${originalChat.name}的聊天记录`;
                        } else {
                            const otherUser = msg.content.messages.find(m => m.sender !== appData.user.id)?.sender;
                            const otherContact = appData.contacts.find(c => c.id == otherUser);
                            const otherName = otherContact ? (otherContact.remark || otherContact.name) : '对方';
                            forwardTitle = `${otherName}和${appData.user.nickname}的聊天记录`;
                        }
                    }
                    const previewContent = msg.content.messages.slice(0, 2).map(m => `${m.sender === appData.user.id ? appData.user.nickname : '对方'}: ${m.type === 'text' ? m.content.content.substring(0, 15) : `[${m.type}]`}`).join('\n');
                    bubbleContent = `<div class="forward-title">${forwardTitle}</div><div class="forward-content-preview">${previewContent}...</div>`;
                    bubbleClass = 'forwarded-message-bubble';
                    additionalAttributes += ` onclick="showForwardedContentModal(event, ${msg.id}, '${chatId}', '${chatType}', '${source}')"`;
                    break;
                case 'music':
                    bubbleContent = `<img src="${msg.content.cover}" alt="cover"><div class="details"><div class="title">${msg.content.title}</div><div class="artist">${msg.content.artist}</div></div>`;
                    bubbleClass ='music-bubble';
                    additionalAttributes += ` onclick="handleBubbleClick('music', ${msg.id}, '${chatId}', '${chatType}', '${source}')"`;
                    break;
                case 'html-content':
                    bubbleContent = `<iframe srcdoc="${escapeSrcDoc(msg.content.code)}" class="html-content-iframe" sandbox="allow-scripts allow-same-origin"></iframe>`;
                    bubbleClass = 'html-content-bubble';
                    break;
                case 'gift':
                    bubbleContent = `<i class="fas fa-gift icon"></i><div class="details"><div class="name">${msg.content.name}</div><div class="desc">${msg.content.desc}</div></div>`;
                    bubbleClass = 'gift-bubble';
                    break;
                case 'delivery_receipt':
                case 'gift_receipt':
                    const receiptItems = msg.content.items.map(item => `<div class="item-row"><span>${item.name} x${item.quantity}</span><span>¥${(item.price * item.quantity).toFixed(2)}</span></div>`).join('');
                    const receiptTitle = msg.type === 'delivery_receipt' ? '外卖订单' : '礼物清单';
                    const receiptFooter = msg.type === 'delivery_receipt' ? '订单已送达' : '感谢惠顾';
                    bubbleContent = `
                        <div class="header"><span>${receiptTitle}</span><span>支出</span></div>
                        <div class="items">${receiptItems}</div>
                        <div class="total"><span>总计</span><span>¥${msg.content.total.toFixed(2)}</span></div>
                        <div class="footer">${receiptFooter}</div>
                    `;
                    bubbleClass = 'receipt-bubble';
                    break;
                case 'voice_call':
                    bubbleContent = `<i class="fas fa-phone-alt"></i> 语音通话 <span style="margin-left: 10px; color: var(--wechat-text-secondary);">${msg.content.duration}</span>`;
                    bubbleClass = 'voice-call-bubble text-bubble';
                    break;
                case 'netease_share':
                    const dynamic = msg.content;
                    bubbleContent = `
                        <div class="share-header">
                            <img src="${dynamic.authorAvatar}" alt="avatar">
                            <span>${dynamic.authorName}的动态</span>
                        </div>
                        <div class="share-content">${dynamic.content}</div>
                    `;
                    bubbleClass = 'netease-share-bubble';
                    additionalAttributes += ` onclick="handleBubbleClick('netease_share', ${msg.id}, '${chatId}', '${chatType}', '${source}')"`;
                    break;
                case 'file':
                    bubbleContent = `
                        <div class="file-icon"><i class="fas fa-file-alt"></i></div>
                        <div class="file-details">
                            <div class="file-name">${msg.content.name}</div>
                            <div class="file-size">${(msg.content.size / 1024).toFixed(2)} KB</div>
                        </div>
                    `;
                    bubbleClass = 'file-bubble';
                    additionalAttributes += ` onclick="showFileContent('${msg.content.name}', '${msg.content.dataUrl}', '${msg.content.type}')"`;
                    break;
                default:
                    bubbleContent = `[未知消息类型: ${msg.type}]`;
                    bubbleClass = 'text-bubble';
                    break;
            }
            return `<div class="message-bubble ${bubbleClass}" ${additionalAttributes}>${bubbleContent}</div>`;
        }

        function generateCharBubbleHtml(msg, chatId, chatType, source) {
            let bubbleContent = '';
            let bubbleClass = '';
            let additionalAttributes = `ondblclick="showMessageContextMenu(event, ${msg.id}, '${chatId}', '${chatType}', '${source}')"`;

            switch(msg.type) {
                case 'text':
                    let quotedHtml = '';
                    if (msg.quotedMessage) {
                        let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
                        let quotedSenderName = '未知';
                        if (chatType === 'group') {
                            const quotedSender = chat.members.find(m => m.id == msg.quotedMessage.sender);
                            quotedSenderName = quotedSender ? (quotedSender.remark || quotedSender.name) : '未知成员';
                        } else {
                            quotedSenderName = msg.quotedMessage.sender === appData.user.id ? appData.user.nickname : (chat.remark || chat.name);
                        }
                        quotedHtml = `<div class="quoted-message"><p><strong>${quotedSenderName}:</strong> ${msg.quotedMessage.content.substring(0, 30)}...</p></div>`;
                    }
                    bubbleContent = `${quotedHtml}${msg.content.content}`;
                    bubbleClass = 'text-bubble';
                    break;
                case 'image':
                    bubbleContent = `<img src="${msg.content.url}" alt="image" oncontextmenu="showImageContextMenu(event, '${msg.content.url}', '${chatId}')">`;
                    bubbleClass = 'image-bubble';
                    break;
                case 'sticker':
                    bubbleContent = `<img src="${msg.content.url}" alt="sticker">`;
                    bubbleClass = 'sticker-bubble';
                    break;
                case 'voice':
                    bubbleContent = `<div class="voice-bubble-content"><div class="waveform">${Array(10).fill('<div class="bar"></div>').join('')}</div> <span class="duration">${msg.content.duration}"</span></div>`;
                    bubbleClass = 'voice-bubble text-bubble';
                    additionalAttributes += ` onclick="toggleVoiceBubble(this, ${msg.id}, '${chatId}', '${chatType}', '${source}')"`;
                    break;
                case 'location':
                    bubbleContent = `<div class="location-text-wrapper"><div class="location-text">${msg.content.location}</div></div><div class="map-placeholder"><i class="fas fa-map-marked-alt"></i></div>`;
                    bubbleClass = 'location-bubble';
                    break;
                case 'camera-sim': 
                    bubbleContent = `<img src="https://img.heliar.top/file/1765193531285_Screenshot_2025_1208_190509.png" alt="simulated camera shot">`; 
                    bubbleClass = 'camera-sim-bubble'; 
                    additionalAttributes += ` onclick="handleBubbleClick('camera-sim', ${msg.id}, '${chatId}', '${chatType}', '${source}')"`;
                    break;
                case 'transfer':
                    let transferStatusText = '请你确认收款';
                    if (msg.content.status === 'claimed') { transferStatusText = '已收款'; } 
                    else if (msg.content.status === 'returned') { transferStatusText = '已退回'; }
                    bubbleContent = `<div class="main"><i class="fas fa-exchange-alt icon"></i><div class="details"><span class="amount">¥${parseFloat(msg.content.amount).toFixed(2)}</span><span class="remark">${transferStatusText}</span></div></div><div class="footer">微信转账</div>`;
                    bubbleClass = 'transfer-bubble';
                    additionalAttributes += ` onclick="handleBubbleClick('transfer', ${msg.id}, '${chatId}', '${chatType}', '${source}')"`;
                    break;
                case 'redPacket':
                    let packetStatus = msg.content.claimed.includes(appData.user.id) ? '已领取' : '点击领取红包';
                    if (msg.content.claimed.length >= msg.content.count) packetStatus = '红包已被领完';
                    bubbleContent = `<div class="main"><i class="fas fa-envelope icon"></i><div class="details"><span class="remark">${msg.content.remark}</span><span class="amount" style="font-size: 14px;">${packetStatus}</span></div></div><div class="footer">微信红包</div>`;
                    bubbleClass = 'redpacket-bubble';
                    additionalAttributes += ` onclick="handleBubbleClick('redPacket', ${msg.id}, '${chatId}', '${chatType}', '${source}')"`;
                    break;
                case 'kinshipCard':
                    const kinshipSender = appData.contacts.find(c => c.id == msg.sender);
                    bubbleContent = `
                        <div class="main">
                            <i class="fas fa-heart icon"></i>
                            <div class="details">
                                <span class="title">${kinshipSender?.name || '对方'} 送给你一张亲属卡</span>
                                <span class="subtext">每月消费上限: ¥${msg.content.limit.toFixed(2)}</span>
                            </div>
                        </div>
                        <div class="footer">亲属卡 · ${msg.content.category || '爱人'}</div>`;
                    bubbleClass = 'kinship-card-bubble';
                    additionalAttributes += ` onclick="handleBubbleClick('kinshipCard', ${msg.id}, '${chatId}', '${chatType}', '${source}')"`;
                    break;
                case 'forward':
                    forwardedMessageCache[msg.id] = msg.content;
                    const originalChat = appData.groups.find(g => g.id == msg.content.originalChatId) || appData.contacts.find(c => c.id == msg.content.originalChatId);
                    let forwardTitle = '聊天记录';
                    if (originalChat) {
                        if (msg.content.originalChatType === 'group') {
                            forwardTitle = `${originalChat.name}的聊天记录`;
                        } else {
                            const otherUser = msg.content.messages.find(m => m.sender !== appData.user.id)?.sender;
                            const otherContact = appData.contacts.find(c => c.id == otherUser);
                            const otherName = otherContact ? (otherContact.remark || otherContact.name) : '对方';
                            forwardTitle = `${otherName}和${appData.user.nickname}的聊天记录`;
                        }
                    }
                    const previewContent = msg.content.messages.slice(0, 2).map(m => `${m.sender === appData.user.id ? appData.user.nickname : '对方'}: ${m.type === 'text' ? m.content.content.substring(0, 15) : `[${m.type}]`}`).join('\n');
                    bubbleContent = `<div class="forward-title">${forwardTitle}</div><div class="forward-content-preview">${previewContent}...</div>`;
                    bubbleClass = 'forwarded-message-bubble';
                    additionalAttributes += ` onclick="showForwardedContentModal(event, ${msg.id}, '${chatId}', '${chatType}', '${source}')"`;
                    break;
                case 'music':
                    bubbleContent = `<img src="${msg.content.cover}" alt="cover"><div class="details"><div class="title">${msg.content.title}</div><div class="artist">${msg.content.artist}</div></div>`;
                    bubbleClass = 'music-bubble';
                    additionalAttributes += ` onclick="handleBubbleClick('music', ${msg.id}, '${chatId}', '${chatType}', '${source}')"`;
                    break;
                case 'html-content':
                    bubbleContent = `<iframe srcdoc="${escapeSrcDoc(msg.content.code)}" class="html-content-iframe" sandbox="allow-scripts allow-same-origin"></iframe>`;
                    bubbleClass = 'html-content-bubble';
                    break;
                case 'gift':
                    bubbleContent = `<i class="fas fa-gift icon"></i><div class="details"><div class="name">${msg.content.name}</div><div class="desc">${msg.content.desc}</div></div>`;
                    bubbleClass = 'gift-bubble';
                    break;
                case 'delivery_receipt':
                case 'gift_receipt':
                    const receiptItems = msg.content.items.map(item => `<div class="item-row"><span>${item.name} x${item.quantity}</span><span>¥${(item.price * item.quantity).toFixed(2)}</span></div>`).join('');
                    const receiptTitle = msg.type === 'delivery_receipt' ? '外卖订单' : '礼物清单';
                    const receiptFooter = msg.type === 'delivery_receipt' ? '订单已送达' : '感谢惠顾';
                    bubbleContent = `
                        <div class="header"><span>${receiptTitle}</span><span>收到</span></div>
                        <div class="items">${receiptItems}</div>
                        <div class="total"><span>总计</span><span>¥${msg.content.total.toFixed(2)}</span></div>
                        <div class="footer">${receiptFooter}</div>
                    `;
                    bubbleClass = 'receipt-bubble';
                    break;
                case 'voice_call':
                    bubbleContent = `<i class="fas fa-phone-alt"></i> 语音通话 <span style="margin-left: 10px; color: var(--wechat-text-secondary);">${msg.content.duration}</span>`;
                    bubbleClass = 'voice-call-bubble text-bubble';
                    break;
                case 'netease_share':
                    const dynamic = msg.content;
                    bubbleContent = `
                        <div class="share-header">
                            <img src="${dynamic.authorAvatar}" alt="avatar">
                            <span>${dynamic.authorName}的动态</span>
                        </div>
                        <div class="share-content">${dynamic.content}</div>
                    `;
                    bubbleClass = 'netease-share-bubble';
                    additionalAttributes += ` onclick="handleBubbleClick('netease_share', ${msg.id}, '${chatId}', '${chatType}', '${source}')"`;
                    break;
                case 'file':
                    bubbleContent = `
                        <div class="file-icon"><i class="fas fa-file-alt"></i></div>
                        <div class="file-details">
                            <div class="file-name">${msg.content.name}</div>
                            <div class="file-size">${(msg.content.size / 1024).toFixed(2)} KB</div>
                        </div>
                    `;
                    bubbleClass = 'file-bubble';
                    additionalAttributes += ` onclick="showFileContent('${msg.content.name}', '${msg.content.dataUrl}', '${msg.content.type}')"`;
                    break;
                default:
                    bubbleContent = `[未知消息类型: ${msg.type}]`;
                    bubbleClass = 'text-bubble';
                    break;
            }
            return `<div class="message-bubble ${bubbleClass}" ${additionalAttributes}>${bubbleContent}</div>`;
        }
        
        function renderWalletPage(container) {
            if (!container) return;
            const wallet = appData.user.wallet;
            const currentCurrency = wallet.currency;

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>我</span></div>
                    <span class="header-title">钱包</span>
                    <div class="header-right" style="font-size: 16px;" onclick="showPage('transactions-page', renderTransactionsPage)">账单</div>
                </div>
                <div class="content-area">
                    <div class="wallet-header">
                        <div class="wallet-balance-title">
                            <span>零钱 (${currentCurrency})</span>
                            <span class="currency-switcher" onclick="showCurrencySelectionModal()"><i class="fas fa-exchange-alt"></i> 切换</span>
                        </div>
                        <div class="wallet-balance">${formatLargeBalance(wallet.balance, currentCurrency)}</div>
                    </div>
                    <div class="wallet-services-grid">
                        <div class="wallet-service-item" onclick="showPage('payment-code-page', renderPaymentCodePage)">
                            <i class="fas fa-qrcode" style="color: var(--wechat-green);"></i>
                            <p>收付款</p>
                        </div>
                        <div class="wallet-service-item" onclick="showTransactionModal('deposit')">
                            <i class="fas fa-plus-circle" style="color: #FCAE3D;"></i>
                            <p>充值</p>
                        </div>
                        <div class="wallet-service-item" onclick="showTransactionModal('withdraw')">
                            <i class="fas fa-arrow-circle-down" style="color: #576B95;"></i>
                            <p>提现</p>
                        </div>
                        <div class="wallet-service-item" onclick="showPage('bank-card-page', renderBankCardPage)">
                            <i class="fas fa-credit-card" style="color: #576B95;"></i>
                            <p>银行卡</p>
                        </div>
                        <div class="wallet-service-item" onclick="showKinshipCardManagementModal()">
                            <i class="fas fa-users-cog" style="color: #FCAE3D;"></i>
                            <p>亲属卡</p>
                        </div>
                        <div class="wallet-service-item" onclick="showLianQianTongModal()">
                            <i class="fas fa-chart-line" style="color: #FCAE3D;"></i>
                            <p>零钱通</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTransactionsPage(container) {
            if (!container) return;
            let html = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>钱包</span></div>
                    <span class="header-title">账单</span>
                </div>
                <div class="content-area"><div class="list-view">
            `;
            const transactions = appData.user.wallet.transactions.slice().reverse();
            if (transactions.length === 0) {
                html += '<div style="text-align:center; padding: 50px; color: var(--wechat-text-secondary);">暂无记录</div>';
            } else {
                transactions.forEach(tx => {
                    const isIncome = tx.amount > 0;
                    html += `
                        <div class="list-item">
                            <div class="details">
                                <span class="name">${tx.type}</span>
                                <p class="subtext">${tx.details || ''}</p>
                                <p class="subtext" style="margin-top: 4px;">${new Date(tx.timestamp).toLocaleString()}</p>
                            </div>
                            <div class="info" style="color: ${isIncome ? 'var(--wechat-green)' : 'var(--global-font-color)'}; font-size: var(--font-size-base); font-weight: 500;">
                                ${isIncome ? '+' : ''}${formatCurrency(tx.amount, appData.user.wallet.currency, true)}
                            </div>
                        </div>
                    `;
                });
            }
            html += '</div></div>';
            container.innerHTML = html;
        }

        function showCharMomentFrequencySettings() {
            const modalId = 'char-moment-frequency-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">AI动态频率</div>
                    <div class="list-view" style="background: transparent;">
                        <div class="list-item" onclick="setCharMomentFrequency('low'); closeModal('${modalId}')">较低 (每3天) ${appData.settings.charMomentFrequency === 'low' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}</div>
                        <div class="list-item" onclick="setCharMomentFrequency('default'); closeModal('${modalId}')">默认 (每1天) ${appData.settings.charMomentFrequency === 'default' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}</div>
                        <div class="list-item" onclick="setCharMomentFrequency('high'); closeModal('${modalId}')">较高 (每6小时) ${appData.settings.charMomentFrequency === 'high' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}</div>
                    </div>
                </div>
            `;
            showModal(modalId, html);
        }

        function setCharMomentFrequency(frequency) {
            appData.settings.charMomentFrequency = frequency;
            saveData();
            renderSettingsAppPage(document.getElementById('settings-app-page'));
        }

        function renderChatModePage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>设置</span></div>
                    <span class="header-title">聊天模式</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="setChatMode('online')">
                        <div class="details"><span class="name">线上聊天</span><p class="subtext">模拟真实聊天，AI可能连续发送多条短消息。</p></div>
                        ${appData.settings.chatMode === 'online' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setChatMode('offline')">
                        <div class="details"><span class="name">线下剧情</span><p class="subtext">专注于长篇剧情，AI会生成大段描述性文本。</p></div>
                        ${appData.settings.chatMode === 'offline' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                </div>
            `;
        }

        function setChatMode(mode) {
            appData.settings.chatMode = mode;
            saveData();
            renderChatModePage(document.getElementById('chat-mode-page'));
        }

        function renderTimestampSettingsPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>设置</span></div>
                    <span class="header-title">时间戳样式</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="setTimestampStyle('center')">
                        <div class="details"><span class="name">时间戳居中 (每5分钟)</span></div>
                        ${appData.settings.timestampStyle === 'center' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setTimestampStyle('bubble-outside')">
                        <div class="details"><span class="name">时间戳在气泡外</span></div>
                        ${appData.settings.timestampStyle === 'bubble-outside' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setTimestampStyle('avatar-under')">
                        <div class="details"><span class="name">时间戳在头像下</span></div>
                        ${appData.settings.timestampStyle === 'avatar-under' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setTimestampStyle('bubble-inside')">
                        <div class="details"><span class="name">时间戳在气泡内</span></div>
                        ${appData.settings.timestampStyle === 'bubble-inside' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                </div>
            `;
        }

        function setTimestampStyle(style) {
            appData.settings.timestampStyle = style;
            saveData();
            renderTimestampSettingsPage(document.getElementById('timestamp-settings-page'));
        }

        function renderBackgroundInteractionPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>设置</span></div>
                    <span class="header-title">后台互动</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item">
                        <div class="details"><span class="name">开启后台互动</span></div>
                        <label class="switch"><input type="checkbox" id="bg-interaction-toggle" ${appData.settings.backgroundInteraction.enabled ? 'checked' : ''}><span class="slider"></span></label>
                    </div>
                    <div class="list-item" onclick="showBgInteractionIntervalModal()">
                        <div class="details"><span class="name">互动间隔</span></div>
                        <span class="info">${appData.settings.backgroundInteraction.interval / 60000} 分钟</span>
                        <i class="fas fa-chevron-right chevron"></i>
                                            </div>
                    <div class="list-item" onclick="showBgInteractionCharSelectionModal()">
                        <div class="details"><span class="name">选择互动角色</span></div>
                        <span class="info">${appData.settings.backgroundInteraction.selectedChars.length} 个</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                </div>
            `;
            document.getElementById('bg-interaction-toggle').onchange = (e) => {
                appData.settings.backgroundInteraction.enabled = e.target.checked;
                saveData();
                renderBackgroundInteractionPage(document.getElementById('background-interaction-page'));
                if (e.target.checked) startBackgroundInteraction();
                else stopBackgroundInteraction();
            };
        }

        function showBgInteractionIntervalModal() {
            const modalId = 'bg-interaction-interval-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">设置互动间隔 (分钟)</div>
                    <div class="modal-input-group">
                        <input type="number" id="bg-interaction-interval-input" class="modal-input" value="${appData.settings.backgroundInteraction.interval / 60000}" min="1">
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" id="save-bg-interval-btn">保存</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);
            document.getElementById('save-bg-interval-btn').onclick = () => {
                const intervalMinutes = parseInt(document.getElementById('bg-interaction-interval-input').value);
                if (isNaN(intervalMinutes) || intervalMinutes < 1) { showToast('请输入有效的时间间隔', 'error'); return; }
                appData.settings.backgroundInteraction.interval = intervalMinutes * 60000;
                saveData();
                renderBackgroundInteractionPage(document.getElementById('background-interaction-page'));
                closeModal(modalId);
                if (appData.settings.backgroundInteraction.enabled) {
                    stopBackgroundInteraction();
                    startBackgroundInteraction();
                }
            };
        }

        function showBgInteractionCharSelectionModal() {
            const modalId = 'bg-interaction-char-selection-modal';
            const contactsHtml = appData.contacts.map(c => `
                <div class="list-item">
                    <img src="${c.avatar}" class="avatar" style="width: 36px; height: 36px;">
                    <div class="details"><span class="name">${c.remark || c.name}</span></div>
                    <input type="checkbox" data-contact-id="${c.id}" ${appData.settings.backgroundInteraction.selectedChars.includes(c.id) ? 'checked' : ''}>
                </div>
            `).join('');

            const html = `
                <div class="modal-content" style="max-width: 90%; width: 350px;">
                    <div class="modal-title">选择互动角色</div>
                    <div class="list-view contact-selection-list" style="max-height: 300px; overflow-y: auto; background: transparent;">
                        ${contactsHtml}
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" id="save-bg-chars-btn">保存</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);
            document.getElementById('save-bg-chars-btn').onclick = () => {
                appData.settings.backgroundInteraction.selectedChars = Array.from(document.querySelectorAll('#' + modalId + ' input[type="checkbox"]:checked')).map(cb => parseInt(cb.dataset.contactId));
                saveData();
                renderBackgroundInteractionPage(document.getElementById('background-interaction-page'));
                closeModal(modalId);
                if (appData.settings.backgroundInteraction.enabled) {
                    stopBackgroundInteraction();
                    startBackgroundInteraction();
                }
            };
        }

        let backgroundInteractionTimer;
        function startBackgroundInteraction() {
            stopBackgroundInteraction();
            if (!appData.settings.backgroundInteraction.enabled || appData.settings.backgroundInteraction.selectedChars.length === 0) return;

            backgroundInteractionTimer = setInterval(async () => {
                const randomCharId = appData.settings.backgroundInteraction.selectedChars[Math.floor(Math.random() * appData.settings.backgroundInteraction.selectedChars.length)];
                const char = appData.contacts.find(c => c.id === randomCharId);
                if (char) {
                    const prompt = `你正在后台与'${appData.user.nickname}'进行互动。请你主动给'${appData.user.nickname}'发一条消息，内容可以是问候、分享日常、表达心情等，字数在20-100字之间，去除人机油腻，禁止带任何动作描述和括号描写。`;
                    const replies = await getAiReply(char.id, 'wechat', prompt);
                    const chatEntry = appData.contacts.find(c => c.id === char.id);
                    if (chatEntry) {
                        if (!chatEntry.conversation) chatEntry.conversation = [];
                        for (const reply of replies) {
                            await processAndSendAiReply(reply, char.id, 'individual', char.id, 'wechat');
                        }
                        if (appData.activeChat.id === char.id) {
                            renderMessages(char.id, 'individual', 'wechat');
                        }
                    }
                }
            }, appData.settings.backgroundInteraction.interval);
        }

        function stopBackgroundInteraction() {
            if (backgroundInteractionTimer) {
                clearInterval(backgroundInteractionTimer);
                backgroundInteractionTimer = null;
            }
        }
        
        function showWorldbookEditor(type) {
            const typeMap = { presets: '预设', styles: '文风', library: '世界书库', stickerPacks: '表情包世界书' };
            const items = appData.worldbooks[type] || [];
            const modalId = 'worldbook-editor-modal';
            
            const content = `
                <div class="modal-content" style="width: 95%; max-width: 400px;">
                    <div class="modal-title">${typeMap[type]} <i class="fas fa-plus-circle" style="cursor:pointer; color: var(--wechat-green);" onclick="editWorldbookItem('${type}')"></i></div>
                    <div class="list-view" style="max-height: 60vh; overflow-y: auto; background: transparent;">
                        ${items.map(item => `
                            <div class="list-item" onclick="editWorldbookItem('${type}', ${item.id})">
                                <div class="details"><span class="name">${item.name}</span></div>
                                <i class="fas fa-trash-alt" style="color: var(--wechat-red);" onclick="deleteWorldbookItem(event, '${type}', ${item.id})"></i>
                            </div>
                        `).join('') || `<p style="text-align:center; padding: 20px;">暂无内容</p>`}
                    </div>
                    <button class="modal-btn" onclick="closeModal('${modalId}')" style="margin-top: 15px;">关闭</button>
                </div>
            `;
            showModal(modalId, content);
        }

        function editWorldbookItem(type, id = null) {
            const isNew = id === null;
            const item = isNew ? { id: Date.now(), name: '', content: '' } : appData.worldbooks[type].find(i => i.id === id);
            if (!item) return;
            const typeMap = { presets: '预设', styles: '文风', library: '世界书', stickerPacks: '表情包世界书' };
            const title = (isNew ? '新建' : '编辑') + typeMap[type];
            const contentLabel = type === 'stickerPacks' ? '表情包URL (每行一个)' : '内容 (无字数上限)';
            const modalId = 'worldbook-item-editor';
            const content = `
                <div class="modal-content" style="width: 95%; max-width: 400px;">
                    <div class="modal-title">${title}</div>
                    <div class="form-group">
                        <label>名称</label>
                        <input type="text" id="wb-edit-name" class="modal-input" value="${item.name}">
                    </div>
                    <div class="form-group">
                        <label>${contentLabel}</label>
                        <textarea id="wb-edit-content" class="modal-input" style="height: 40vh;">${item.content}</textarea>
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" onclick="saveWorldbookItem('${type}', ${id}, ${isNew})">保存</button>
                    </div>
                </div>
            `;
            showModal(modalId, content);
        }

        function saveWorldbookItem(type, id, isNew) {
            const name = document.getElementById('wb-edit-name').value;
            const content = document.getElementById('wb-edit-content').value;
            if (!name) { showToast('名称不能为空', 'error'); return; }
            
            if (isNew) {
                appData.worldbooks[type].push({ id: Date.now(), name, content });
            } else {
                const index = appData.worldbooks[type].findIndex(i => i.id === id);
                if (index > -1) appData.worldbooks[type][index] = { id, name, content };
            }
            saveData();
            closeModal('worldbook-item-editor');
            showWorldbookEditor(type);
        }

        function deleteWorldbookItem(event, type, id) {
            event.stopPropagation();
            if (!confirm('确定删除吗？')) return;
            appData.worldbooks[type] = appData.worldbooks[type].filter(i => i.id !== id);
            saveData();
            showWorldbookEditor(type);
        }

        function renderBeautifyAppPage(container) {
            if (!container) {
                console.error("Beautify App Firewall: Container not found.");
                return;
            }
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div></div>
                    <span class="header-title">主题美化</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="showPage('theme-settings-page', renderThemeSettingsPage)">
                        <div class="details"><span class="name">主题切换</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('global-theme-editor-page', renderGlobalThemeEditorPage)">
                        <div class="details"><span class="name">自定义全局美化主题</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('wallpaper-settings-page', renderWallpaperSettingsPage)">
                        <div class="details"><span class="name">更换主屏壁纸</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('app-icon-settings-page', renderAppIconSettingsPage)">
                        <div class="details"><span class="name">更换APP图标</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('app-layout-settings-page', renderAppLayoutSettingsPage)">
                        <div class="details"><span class="name">调整APP图标布局</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="showPage('screen-size-settings-page', renderScreenSizeSettingsPage)">
                        <div class="details"><span class="name">屏幕尺寸</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('phone-frame-settings-page', renderPhoneFrameSettingsPage)">
                        <div class="details"><span class="name">手机边框</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('font-settings-page', renderFontSettingsPage)">
                        <div class="details"><span class="name">更换字体</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('font-color-settings-page', renderFontColorSettingsPage)">
                        <div class="details"><span class="name">调整字体颜色</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('avatar-shape-settings-page', renderAvatarShapeSettingsPage)">
                        <div class="details"><span class="name">头像形状</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('frame-settings-page', renderFrameSettingsPage)">
                        <div class="details"><span class="name">更换头像框</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('battery-settings-page', renderBatterySettingsPage)">
                        <div class="details"><span class="name">电池设置</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="showPage('bubble-switch-page', renderBubbleSwitchPage)">
                        <div class="details"><span class="name">气泡切换</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('bubble-settings-page', renderBubbleSettingsPage)">
                        <div class="details"><span class="name">通用聊天气泡CSS</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('redpacket-bubble-settings-page', renderRedPacketBubbleSettingsPage)">
                        <div class="details"><span class="name">红包气泡CSS</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('transfer-bubble-settings-page', renderTransferBubbleSettingsPage)">
                        <div class="details"><span class="name">转账气泡CSS</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('offline-plot-beautify-page', renderOfflinePlotBeautifyPage)">
                        <div class="details"><span class="name">线下剧情美化</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('read-receipt-settings-page', renderReadReceiptSettingsPage)">
                        <div class="details"><span class="name">已读回执</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                </div>
            `;
        }

        function handleChatBgUpload(file, contactId) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const contact = appData.contacts.find(c => c.id == contactId);
                if (!contact.chatSettings) contact.chatSettings = {};
                contact.chatSettings.background = e.target.result;
                saveData(true);
                if (appData.activeChat.id == contactId) {
                    renderConversationPage(document.getElementById('conversation-page'), contactId, 'individual');
                }
            };
            reader.readAsDataURL(file);
        }

        function renderThemeSettingsPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>返回</span></div>
                    <span class="header-title">主题切换</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="setTheme('normal')">
                        <div class="details"><span class="name">正常模式</span></div>
                        ${appData.settings.beautify.theme === 'normal' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setTheme('dark')">
                        <div class="details"><span class="name">夜间模式</span></div>
                        ${appData.settings.beautify.theme === 'dark' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setTheme('qq-style')">
                        <div class="details"><span class="name">仿QQ主题</span></div>
                        ${appData.settings.beautify.theme === 'qq-style' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setTheme('glassmorphism')">
                        <div class="details"><span class="name">毛玻璃</span></div>
                        ${appData.settings.beautify.theme === 'glassmorphism' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item"onclick="setTheme('sakura-pink')">
                        <div class="details"><span class="name">可爱樱花粉</span></div>
                        ${appData.settings.beautify.theme === 'sakura-pink' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setTheme('clear-sky-blue')">
                        <div class="details"><span class="name">^•͈༝•^ฅ</span></div>
                        ${appData.settings.beautify.theme === 'clear-sky-blue' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setTheme('transparent')">
                        <div class="details"><span class="name">ᖰ˃̶ ꇴ ˂̶ᖳ</span></div>
                        ${appData.settings.beautify.theme === 'transparent' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setTheme('neumorphic')">
                        <div class="details"><span class="name">ᦲ ᆺ ᦲ</span></div>
                        ${appData.settings.beautify.theme === 'neumorphic' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setTheme('ins-neumorphic-white')">
                        <div class="details"><span class="name">ins拟态白</span></div>
                        ${appData.settings.beautify.theme === 'ins-neumorphic-white' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                </div>
            `;
        }

        function setTheme(theme) {
            appData.settings.beautify.theme = theme;
            saveData();
            applyBeautifySettings();
            renderThemeSettingsPage(document.getElementById('theme-settings-page'));
        }

        // ★★★ 优化：气泡切换预览 ★★★
        function renderBubbleSwitchPage(container) {
            if (!container) return;
            const activeStyle = appData.settings.beautify.activeBubbleStyle;
            const bubbleStyles = {
                'wechat': 'Wechat气泡',
                'ins-simple': 'ins风简约气泡',
                'simple-elegant': '简约风',
                'glass': '毛玻璃气泡',
                'pink-white': '粉白气泡',
                'qq-dark': '仿QQ精致黑'
            };

            let previewHtml = '';
            for (const [key, name] of Object.entries(bubbleStyles)) {
                const css = getBubbleStyleCss(key);
                const uniqueClassName = `bubble-preview-${key}`;
                previewHtml += `
                    <div class="list-item" onclick="setBubbleStyle('${key}')">
                        <div class="details" style="flex: 1;">
                            <span class="name">${name}</span>
                            <div class="bubble-preview-container ${uniqueClassName}" style="margin-top: 10px; background: #ddd; padding: 10px; border-radius: 8px;">
                                <style>
                                    .${uniqueClassName} .message-row.sent .message-bubble.text-bubble,
                                    .${uniqueClassName} .message-row.received .message-bubble.text-bubble {
                                        /* Reset base styles */
                                        background: none; color: inherit;
                                    }
                                    .${uniqueClassName} .message-row.sent .message-bubble.text-bubble::after,
                                    .${uniqueClassName} .message-row.received .message-bubble.text-bubble::after {
                                        display: none;
                                    }
                                    ${css.replace(/\.message-row/g, `.${uniqueClassName} .message-row`)}
                                </style>
                                <div class="message-row received" style="justify-content: flex-start;"><div class="message-bubble text-bubble">对方消息</div></div>
                                <div class="message-row sent" style="justify-content: flex-end;"><div class="message-bubble text-bubble">我的消息</div></div>
                            </div>
                        </div>
                        ${activeStyle === key ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                `;
            }

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>返回</span></div>
                    <span class="header-title">气泡切换</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    ${previewHtml}
                </div>
            `;
        }

        function setBubbleStyle(styleKey) {
            appData.settings.beautify.activeBubbleStyle = styleKey;
            appData.settings.beautify.bubbleCss = '';
            saveData();
            applyBeautifySettings();
            renderBubbleSwitchPage(document.getElementById('bubble-switch-page'));
        }

        function renderScreenSizeSettingsPage(container) {
            if (!container) return;
            const b = appData.settings.beautify;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>返回</span></div>
                    <span class="header-title">屏幕尺寸</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>屏幕宽度 (px)</label>
                        <input type="number" id="screen-width-input" value="${b.screenWidth}">
                    </div>
                    <div class="form-group">
                        <label>屏幕高度 (px)</label>
                        <input type="number" id="screen-height-input" value="${b.screenHeight}">
                    </div>
                    <button class="form-btn" id="save-screen-size-btn">应用</button>
                </div>
            `;
            document.getElementById('save-screen-size-btn').onclick = () => {
                b.screenWidth = parseInt(document.getElementById('screen-width-input').value);
                b.screenHeight = parseInt(document.getElementById('screen-height-input').value);
                saveData(true);
                applyBeautifySettings();
            };
        }

        function renderPhoneFrameSettingsPage(container) {
            if (!container) return;
            const frames = {
                'white': '白色', 'black': '黑色', 'simple-white': '简约白', 'pink': '樱花粉', 
                'aqua-blue': '水蓝色', 'semi-transparent': '半透明', 'transparent': '透明', 
                'stereo': '增强立体', 'evol': 'Evol', 'ios-style': 'iOS风格', 'mint-green': '薄荷奶绿'
            };
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>返回</span></div>
                    <span class="header-title">手机边框</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    ${Object.entries(frames).map(([key, name]) => `
                    <div class="list-item" onclick="setPhoneFrame('${key}')">
                        <div class="details"><span class="name">${name}</span></div>
                        ${appData.settings.beautify.phoneFrame === key ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>`).join('')}
                </div>
            `;
        }

        function setPhoneFrame(frame) {
            appData.settings.beautify.phoneFrame = frame;
            saveData();
            applyBeautifySettings();
            renderPhoneFrameSettingsPage(document.getElementById('phone-frame-settings-page'));
        }

        function renderAvatarShapeSettingsPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>返回</span></div>
                    <span class="header-title">头像形状</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="setAvatarShape('rounded')">
                        <div class="details"><span class="name">圆角</span></div>
                        ${appData.settings.beautify.avatarShape === 'rounded' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setAvatarShape('circle')">
                        <div class="details"><span class="name">圆形</span></div>
                        ${appData.settings.beautify.avatarShape === 'circle' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                </div>
            `;
        }

        function setAvatarShape(shape) {
            appData.settings.beautify.avatarShape = shape;
            saveData();
            applyBeautifySettings();
            renderAvatarShapeSettingsPage(document.getElementById('avatar-shape-settings-page'));
        }

        function renderFontSettingsPage(container) {
            if (!container) return;
            const b = appData.settings.beautify;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>返回</span></div>
                    <span class="header-title">更换字体</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>字体大小: <span id="font-size-value">${b.fontSize}</span>px</label>
                        <input type="range" id="font-size-input" min="10" max="30" value="${b.fontSize}" oninput="document.getElementById('font-size-value').textContent = this.value; document.getElementById('font-preview').style.fontSize = this.value + 'px';">
                    </div>
                    <div class="form-group">
                        <label>字体粗细</label>
                        <select id="font-weight-select" class="form-input">
                            <option value="100" ${b.globalFontWeight == '100' ? 'selected' : ''}>100 (Thin)</option>
                            <option value="300" ${b.globalFontWeight == '300' ? 'selected' : ''}>300 (Light)</option>
                            <option value="normal" ${b.globalFontWeight == 'normal' ? 'selected' : ''}>400 (Normal)</option>
                            <option value="600" ${b.globalFontWeight == '600' ? 'selected' : ''}>600 (Semi-Bold)</option>
                            <option value="bold" ${b.globalFontWeight == 'bold' ? 'selected' : ''}>700 (Bold)</option>
                            <option value="900" ${b.globalFontWeight == '900' ? 'selected' : ''}>900 (Black)</option>
                        </select>
                    </div>
                    <div class="list-item">
                        <div class="details"><span class="name">斜体</span></div>
                        <label class="switch"><input type="checkbox" id="font-style-toggle" ${b.globalFontStyle === 'italic' ? 'checked' : ''}><span class="slider"></span></label>
                    </div>
                    <div class="list-divider"></div>
                    <div class="form-group">
                        <label>导入字体 (URL)</label>
                        <input type="text" id="font-url-input" placeholder="输入 .css, .ttf, .woff, .woff2 链接..." value="${b.fontUrl || ''}">
                    </div>
                    <div class="form-group">
                        <label>导入字体 (文件)</label>
                        <button class="form-btn" style="background-color: #aaa;" onclick="document.getElementById('font-file-input').click()">选择 .ttf, .woff, .woff2 文件</button>
                        <input type="file" id="font-file-input" class="file-input" accept=".ttf,.woff,.woff2">
                    </div>
                    <div class="form-group">
                        <label>字体预览</label>
                        <p id="font-preview" style="font-size:${b.fontSize}px; padding: 20px; background: var(--wechat-nav-bg); border-radius: 8px; text-align: center;">Hello, World. 你好，世界。</p>
                    </div>
                    <button class="form-btn" id="save-font-btn">保存并应用</button>
                </div>
            `;

            const updateFontPreview = ({ url, file }) => {
                const preview = document.getElementById('font-preview');
                const fontStyle = document.getElementById('dynamic-font-style');
                const fontName = 'FontPreview';
                let fontSrc = '';
                if (url) {
                    fontSrc = `url('${url}')`;
                } else if (file) {
                    fontSrc = `url('${file}')`;
                }
                fontStyle.innerHTML = `@font-face { font-family: '${fontName}'; src: ${fontSrc}; }`;
                preview.style.fontFamily = `'${fontName}', sans-serif`;
            };

            document.getElementById('font-url-input').oninput = (e) => {
                updateFontPreview({ url: e.target.value });
            };

            document.getElementById('font-file-input').onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        updateFontPreview({ file: ev.target.result });
                    };
                    reader.readAsDataURL(file);
                }
            };

            document.getElementById('save-font-btn').onclick = () => {
                const url = document.getElementById('font-url-input').value.trim();
                const fileInput = document.getElementById('font-file-input');
                const file = fileInput.files[0];
                const fontSize = parseInt(document.getElementById('font-size-input').value);
                const fontWeight = document.getElementById('font-weight-select').value;
                const fontStyle = document.getElementById('font-style-toggle').checked ? 'italic' : 'normal';

                appData.settings.beautify.fontSize = fontSize;
                appData.settings.beautify.globalFontWeight = fontWeight;
                appData.settings.beautify.globalFontStyle = fontStyle;

                const applyAndSave = () => {
                    saveData(true);
                    applyBeautifySettings();
                };

                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        appData.settings.beautify.fontFile = e.target.result;
                        appData.settings.beautify.fontUrl = ''; // Clear URL if file is chosen
                        applyAndSave();
                    };
                    reader.readAsDataURL(file);
                } else {
                    appData.settings.beautify.fontUrl = url;
                    appData.settings.beautify.fontFile = null; // Clear file if URL is chosen
                    applyAndSave();
                }
            };
            // Initial preview
            updateFontPreview({ url: b.fontUrl, file: b.fontFile });
        }

        function renderFrameSettingsPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>返回</span></div>
                    <span class="header-title">更换头像框</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="showFrameEditor('user')">
                        <div class="details"><span class="name">更换我的头像框</span></div>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showFrameEditor('char')">
                        <div class="details"><span class="name">更换对方的头像框</span></div>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                </div>
            `;
        }
        
        function showFrameEditor(type) {
            const title = type === 'user' ? '更换我的头像框' : '更换对方的头像框';
            const currentFrame = type === 'user' ? appData.settings.beautify.userAvatarFrame : appData.settings.beautify.charAvatarFrame;
            const modalId = 'frame-editor-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">${title}</div>
                    <img src="${currentFrame || 'https://img.js.design/assets/img/65a881fa383e6a42242a3f33.jpg'}" class="avatar-upload-preview" id="frame-preview-modal" onclick="document.getElementById('frame-input-modal').click()">
                    <input type="file" id="frame-input-modal" class="file-input" accept="image/*">
                    <div class="modal-actions">
                        <button class="modal-btn" id="remove-frame-btn-modal">移除</button>
                        <button class="modal-btn primary" id="save-frame-btn-modal">保存</button>
                    </div>
                    <button class="modal-btn" onclick="closeModal('${modalId}')" style="margin-top: 10px; background: #eee;">关闭</button>
                </div>
            `;
            showModal(modalId, html);

            document.getElementById('frame-input-modal').onchange = e => {
                handleImageUpload(e.target.files[0], dataUrl => {
                    document.getElementById('frame-preview-modal').src = dataUrl;
                });
            };
            document.getElementById('save-frame-btn-modal').onclick = () => {
                const newFrame = document.getElementById('frame-preview-modal').src;
                if (type === 'user') appData.settings.beautify.userAvatarFrame = newFrame;
                else appData.settings.beautify.charAvatarFrame = newFrame;
                saveData(true);
                applyBeautifySettings();
                closeModal(modalId);
            };
            document.getElementById('remove-frame-btn-modal').onclick = () => {
                if (type === 'user') appData.settings.beautify.userAvatarFrame = '';
                else appData.settings.beautify.charAvatarFrame = '';
                saveData(true);
                applyBeautifySettings();
                document.getElementById('frame-preview-modal').src = 'https://img.js.design/assets/img/65a881fa383e6a42242a3f33.jpg';
                closeModal(modalId);
            };
        }

        function renderBubbleSettingsPage(container) {
            if (!container) return;
            let currentSlot = 0;
            
            const updateBubblePreview = () => {
                const previewFrame = document.getElementById('bubble-preview-frame');
                const bubbleCss = document.getElementById('bubble-css-input').value;
                const previewDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
                
                previewDoc.body.innerHTML = `
                    <style>
                        body { margin: 0; padding: 10px; font-family: sans-serif; background: #eee; }
                        .message-row { display: flex; gap: 10px; margin-bottom: 10px; max-width: 100%; align-items: flex-start; }
                        .message-row.sent { justify-content: flex-end; }
                        .message-bubble { position: relative; padding: 10px 14px; border-radius: 6px; }
                        .message-row.sent .message-bubble.text-bubble { background: #96d35f; }
                        .message-row.received .message-bubble.text-bubble { background: #ffffff; }
                        .message-row.sent .message-bubble.text-bubble::after { content: ""; position: absolute; right: -6px; top: 12px; width: 8px; height: 12px; background: #96d35f; clip-path: polygon(0 0, 100% 50%, 0 100%); }
                        .message-row.received .message-bubble.text-bubble::after { content: ""; position: absolute; left: -6px; top: 12px; width: 8px; height: 12px; background: #ffffff; clip-path: polygon(100% 0, 0 50%, 100% 100%); }
                        .voice-bubble { display: flex; align-items: center; gap: 8px; min-width: 80px; }
                        .voice-bubble-content { display: flex; align-items: center; gap: 10px; }
                        .voice-bubble-content .waveform { display: flex; align-items: center; height: 20px; }
                        .voice-bubble-content .bar { width: 3px; height: 4px; margin: 0 1.5px; border-radius: 2px; animation: wave 1.2s ease-in-out infinite alternate; background: #333; }
                        @keyframes wave { 0% { transform: scaleY(0.2); } 50% { transform: scaleY(1); } 100% { transform: scaleY(0.2); } }
                        
                        ${bubbleCss ? `
                        .message-row.sent .message-bubble.text-bubble::after,
                        .message-row.received .message-bubble.text-bubble::after {
                            display: none;
                        }` : ''}
                        
                        ${bubbleCss}
                    </style>
                    <div class="message-row received"><div class="message-bubble text-bubble">对方消息预览</div></div>
                    <div class="message-row sent"><div class="message-bubble text-bubble">我的消息预览</div></div>
                    <div class="message-row received"><div class="message-bubble text-bubble voice-bubble"><div class="voice-bubble-content"><div class="waveform">${Array(10).fill('<div class="bar"></div>').join('')}</div></div></div></div>
                `;
            };

            const loadSlot = (slotIndex) => {
                currentSlot = slotIndex;
                const archive = appData.settings.beautify.bubbleArchives[slotIndex] || {};
                document.getElementById('bubble-css-input').value = archive.bubbleCss || '';
                updateBubblePreview();
                document.querySelectorAll('.slot-btn').forEach((btn, i) => btn.style.fontWeight = i === slotIndex ? 'bold' : 'normal');
            };

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>返回</span></div>
                    <span class="header-title">通用聊天气泡CSS</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>存档槽</label>
                        <div style="display: flex; justify-content: space-between;">
                            ${[0,1,2,3,4].map(i => `<button class="modal-btn slot-btn" onclick="loadSlot(${i})">存档 ${i+1}</button>`).join('')}
                        </div>
                    </div>
                    <div class="form-group">
                        <label>通用气泡CSS (自动适配语音气泡)</label>
                        <textarea id="bubble-css-input" style="height: 250px;" oninput="updateBubblePreview()"></textarea>
                    </div>
                    <div class="form-group">
                        <label>预览</label>
                        <iframe id="bubble-preview-frame" style="width: 100%; height: 200px; border: 1px solid #ccc; border-radius: 8px;"></iframe>
                    </div>
                    <button class="form-btn" id="save-bubble-btn">保存并应用到当前槽</button>
                </div>
            `;
            window.loadSlot = loadSlot;
            window.updateBubblePreview = updateBubblePreview;
            loadSlot(0);

            document.getElementById('save-bubble-btn').onclick = () => {
                const bubbleCss = document.getElementById('bubble-css-input').value;
                appData.settings.beautify.bubbleArchives[currentSlot] = { bubbleCss };
                appData.settings.beautify.bubbleCss = bubbleCss;
                appData.settings.beautify.activeBubbleStyle = null;
                saveData(true);
                applyBeautifySettings();
            };
        }

        function renderRedPacketBubbleSettingsPage(container) {
            if (!container) return;
            const exampleCss = `/* 红包气泡示例CSS */\n.message-bubble.redpacket-bubble {\n  background: linear-gradient(135deg, #ff7e5f, #feb47b) !important;\n  border-radius: 12px;\n}\n.message-bubble.redpacket-bubble .icon {\n  color: white;\n  text-shadow: 0 1px 2px rgba(0,0,0,0.2);\n}`;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>返回</span></div>
                    <span class="header-title">红包气泡CSS</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>红包气泡 CSS</label>
                        <textarea id="redpacket-bubble-css-input" style="height: 250px;">${appData.settings.beautify.redPacketBubbleCss}</textarea>
                    </div>
                    <div class="form-group">
                        <label>预览</label>
                        <div class="message-row received" style="justify-content: center;"><div class="message-bubble redpacket-bubble"><div class="main"><i class="fas fa-envelope icon"></i><div class="details"><span class="remark">恭喜发财</span><span class="amount" style="font-size: 14px;">查看红包</span></div></div></div>
                     <div class="form-group">
                        <label>示例代码 (点击复制)</label>
                        <textarea readonly onclick="this.select(); document.execCommand('copy'); showToast('已复制');" style="height: 100px; background: #f0f0f0; cursor: pointer;">${exampleCss}</textarea>
                    </div>
                    <button class="form-btn" onclick="saveSpecialBubbleCss('redPacket')">保存并应用</button>
                </div>
            `;
        }

        function renderTransferBubbleSettingsPage(container) {
            if (!container) return;
            const exampleCss = `/* 转账气泡示例CSS */\n.message-bubble.transfer-bubble {\n  background: linear-gradient(to right, #4facfe, #00f2fe) !important;\n  box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);\n}\n.message-bubble.transfer-bubble .amount {\n  color: #fff;\n  font-weight: bold;\n}`;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>返回</span></div>
                    <span class="header-title">转账气泡CSS</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>转账气泡 CSS</label>
                        <textarea id="transfer-bubble-css-input" style="height: 250px;">${appData.settings.beautify.transferBubbleCss}</textarea>
                    </div>
                    <div class="form-group">
                        <label>预览</label>
                        <div class="message-row received" style="justify-content: center;"><div class="message-bubble transfer-bubble"><div class="main"><i class="fas fa-exchange-alt icon"></i><div class="details"><span class="amount">¥1314.00</span><span class="remark">已转账</span></div></div><div class="footer">微信转账</div></div></div>
                    </div>
                    <div class="form-group">
                        <label>示例代码 (点击复制)</label>
                        <textarea readonly onclick="this.select(); document.execCommand('copy'); showToast('已复制');" style="height: 100px; background: #f0f0f0; cursor: pointer;">${exampleCss}</textarea>
                    </div>
                    <button class="form-btn" onclick="saveSpecialBubbleCss('transfer')">保存并应用</button>
                </div>
            `;
        }

        function saveSpecialBubbleCss(type) {
            const css = document.getElementById(`${type}-bubble-css-input`).value;
            if (type === 'redPacket') {
                appData.settings.beautify.redPacketBubbleCss = css;
            } else if (type === 'transfer') {
                appData.settings.beautify.transferBubbleCss = css;
            }
            saveData(true);
            applyBeautifySettings();
        }

        function renderApiSettingsPage(container) {
            if (!container) return;
            const providers = {
                'openai': 'OpenAI', 'claude': 'Claude (Anthropic)', 'gemini': 'Gemini (Google AI Studio)','deepseek': 'DeepSeek', 'openrouter': 'OpenRouter', 'grok': 'Grok (xAI)',
                'doubao': 'Doubao (豆包)', 'custom': '自定义 (OpenAI)', 'custom_gemini': '自定义 (Gemini)'
            };
            const api = appData.settings.api;
            let providerOptions = '';
            for (const key in providers) {
                providerOptions += `<option value="${key}" ${api.provider === key ? 'selected' : ''}>${providers[key]}</option>`;
            }

            const presetsOptions = appData.settings.api.presets.map((p, i) => `<option value="${i}">${p.name}</option>`).join('');

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>返回</span></div>
                    <span class="header-title">API设置</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>API 预设</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="api-preset-select" style="flex: 1;">
                                <option value="-1">选择一个预设...</option>
                                ${presetsOptions}
                            </select>
                            <button id="save-preset-btn" style="padding: 10px;">保存为预设</button>
                        </div>
                    </div>
                    <div class="list-divider"></div>
                    <div class="form-group">
                        <label>供应商</label>
                        <select id="api-provider">${providerOptions}</select>
                    </div>
                    <div class="form-group">
                        <label>API端点 (Endpoint URL)</label>
                        <input type="text" id="api-endpoint" value="${api.endpoint}" placeholder="例如: https://api.openai.com/v1">
                    </div>
                    <div class="form-group">
                        <label>密钥 (API Key)</label>
                        <input type="password" id="api-key" value="${api.key}">
                    </div>
                    <div class="form-group">
                        <label>模型</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="api-model" value="${api.model}" style="flex: 1;" placeholder="例如: gpt-4-turbo">
                            <button id="fetch-models-btn" style="padding: 10px;">获取</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Temperature: <span id="temp-value">${api.temperature}</span></label>
                        <input type="range" id="temperature" min="-0.2" max="2" step="0.01" value="${api.temperature}" oninput="document.getElementById('temp-value').textContent = this.value">
                    </div>
                    <div class="form-group">
                        <label>Top P: <span id="topp-value">${api.top_p}</span></label>
                        <input type="range" id="top-p" min="0" max="1" step="0.01" value="${api.top_p}" oninput="document.getElementById('topp-value').textContent = this.value">
                    </div>
                    <div class="form-group">
                        <label>惩罚力度 (Repetition Penalty): <span id="penalty-value">${api.repetition_penalty}</span></label>
                        <input type="range" id="repetition-penalty" min="-0.2" max="2" step="0.01" value="${api.repetition_penalty}" oninput="document.getElementById('penalty-value').textContent = this.value">
                    </div>
                    <button class="form-btn" id="save-api-btn">保存设置</button>
                </div>
            `;

            document.getElementById('api-preset-select').onchange = (e) => {
                const index = e.target.value;
                if (index > -1) {
                    const preset = appData.settings.api.presets[index];
                    document.getElementById('api-provider').value = preset.provider;
                    document.getElementById('api-endpoint').value = preset.endpoint;
                    document.getElementById('api-key').value = preset.key;
                    document.getElementById('api-model').value = preset.model;
                    document.getElementById('temperature').value = preset.temperature;
                    document.getElementById('top-p').value = preset.top_p;
                    document.getElementById('repetition-penalty').value = preset.repetition_penalty;
                    document.getElementById('temp-value').textContent = preset.temperature;
                    document.getElementById('topp-value').textContent = preset.top_p;
                    document.getElementById('penalty-value').textContent = preset.repetition_penalty;
                }
            };

            document.getElementById('save-preset-btn').onclick= () => {
                const presetName = prompt("请输入预设名称:");
                if (presetName) {
                    const newPreset = {
                        name: presetName,
                        provider: document.getElementById('api-provider').value,
                        endpoint: document.getElementById('api-endpoint').value.trim(),
                        key: document.getElementById('api-key').value.trim(),
                        model: document.getElementById('api-model').value.trim(),
                        temperature: parseFloat(document.getElementById('temperature').value),
                        top_p: parseFloat(document.getElementById('top-p').value),
                        repetition_penalty: parseFloat(document.getElementById('repetition-penalty').value)
                    };
                    appData.settings.api.presets.push(newPreset);
                    saveData(true, () => renderApiSettingsPage(container));
                }
            };

            document.getElementById('fetch-models-btn').onclick = fetchModels;
            document.getElementById('save-api-btn').onclick = () => {
                appData.settings.api.provider = document.getElementById('api-provider').value;
                appData.settings.api.endpoint = document.getElementById('api-endpoint').value.trim();
                appData.settings.api.key = document.getElementById('api-key').value.trim();
                appData.settings.api.model = document.getElementById('api-model').value.trim();
                appData.settings.api.temperature = parseFloat(document.getElementById('temperature').value);
                appData.settings.api.top_p = parseFloat(document.getElementById('top-p').value);
                appData.settings.api.repetition_penalty = parseFloat(document.getElementById('repetition-penalty').value);
                saveData(true);
            };
        }

        function renderStickerAppPage(container, isManagement = true) {
            if (!container) {
                console.error("Sticker App Firewall: Container not found.");
                return;
            }
            let headerHtml = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div></div>
                    <span class="header-title">我的表情</span>
                    <div class="header-right">
                        <i class="fas fa-plus" onclick="showStickerImportModal()" style="margin-right: 15px;"></i>
                        <i class="fas fa-trash-alt" onclick="toggleStickerSelectionMode()"></i>
                    </div>
                </div>
                <div class="wechat-tabbar" id="sticker-delete-toolbar" style="display:none;">
                    <button class="form-btn" style="margin: 5px; background-color: var(--wechat-red);" onclick="deleteSelectedStickers()">删除已选</button>
                </div>
            `;

            let bodyHtml = '';
            if (appData.stickers.packs.length === 0) {
                bodyHtml = '<div style="text-align:center; padding: 50px; color: var(--wechat-text-secondary);">还没有表情包，快去添加吧</div>';
            } else {
                appData.stickers.packs.forEach((pack, packIndex) => {
                    bodyHtml += `<div class="sticker-pack">
                        <div class="sticker-pack-title">${pack.name}</div>
                        <div class="sticker-grid">
                            ${pack.stickers.map((sticker, stickerIndex) => `
                                <div class="sticker-item" data-pack-index="${packIndex}" data-sticker-index="${stickerIndex}">
                                    <img src="${sticker.url}" loading="lazy">
                                    <input type="checkbox" class="delete-checkbox">
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
                });
            }
            container.innerHTML = headerHtml + `<div class="content-area">${bodyHtml}</div>`;
            
            container.querySelectorAll('.sticker-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (container.closest('#sticker-app-page').classList.contains('selection-mode')) {
                        e.currentTarget.classList.toggle('selected');
                        const checkbox = e.currentTarget.querySelector('.delete-checkbox');
                        checkbox.checked = !checkbox.checked;
                    }
                });
            });
        }

        // --- Modals ---
        function showModal(id, html, isLarge = false) {
            const container = document.getElementById('modal-container');
            const modal = document.createElement('div');
            modal.id = id;
            modal.className = 'modal-overlay';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            if (isLarge) {
                modalContent.style.width = '360px';
                modalContent.style.height = '560px';
                modalContent.style.maxWidth = '95%';
                modalContent.style.maxHeight = '90%';
                modalContent.style.padding = '0';
                modalContent.style.display = 'flex';
                modalContent.style.flexDirection = 'column';
            }
            modalContent.innerHTML = html;
            
            modal.appendChild(modalContent);
            modal.style.display = 'flex';
            container.appendChild(modal);
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            if (modal) modal.remove();
        }

        function showTransactionModal(type, chatId, chatType) {
            const wallet = appData.user.wallet;
            const currentCurrency = wallet.currency;
            const rate = exchangeRates[currentCurrency].rate;

            const isFinancial = type === 'deposit' || type === 'withdraw';
            if (isFinancial && appData.user.bankCards.length === 0) {
                showToast('请先绑定银行卡！', 'error');
                showPage('bank-card-page', renderBankCardPage);
                return;
            }

            const title = { deposit: '充值', withdraw: '提现', transfer: '转账', redPacket: '发红包' }[type];
            
            const amountLimitCNY = { withdraw: 5000000, transfer: 5000000, redPacket: 200 }[type];
            const amountLimitDisplay = amountLimitCNY ? (amountLimitCNY * rate).toFixed(2) : null;
            const placeholder = amountLimitDisplay ? `0.01 ~ ${amountLimitDisplay}` : `请输入金额 (${currentCurrency})`;

            const remarkNeeded = type === 'transfer' || type === 'redPacket';
            
            const modalId = 'transaction-modal';
            let memberSelectionHtml = '';
            let recipientCountInput = '';
            let paymentSourceHtml = '';

            if (type === 'transfer' || type === 'redPacket') {
                const kinshipCards = appData.user.kinshipCards.received.filter(card => {
                    const sender = appData.contacts.find(c => c.id == card.senderId);
                    return sender && (card.limit - card.used) > 0;
                });

                paymentSourceHtml = `
                    <div class="modal-input-group">
                        <label>支付方式</label>
                        <select id="tx-payment-source" class="modal-input">
                            <option value="wallet">零钱 (余额: ${formatCurrency(wallet.balance, currentCurrency)})</option>
                            ${appData.user.bankCards.map(card => `<option value="${card.id}">银行卡 ${card.bankName} (尾号${card.number.slice(-4)})</option>`).join('')}
                            ${kinshipCards.map(card => {
                                const sender = appData.contacts.find(c => c.id == card.senderId);
                                return `<option value="kinship_${card.id}">亲属卡-${sender.name} (剩余: ¥${(card.limit - card.used).toFixed(2)})</option>`;
                            }).join('')}
                        </select>
                    </div>
                `;
            } else if (isFinancial) {
                paymentSourceHtml = `
                    <div class="modal-input-group">
                        <label>选择银行卡</label>
                        <select id="tx-bank-card" class="modal-input">
                            ${appData.user.bankCards.map(card => `<option value="${card.id}">${card.bankName} (尾号${card.number.slice(-4)})</option>`).join('')}
                        </select>
                    </div>
                `;
            }

            if (chatType === 'group' && (type === 'transfer' || type === 'redPacket')) {
                const group = appData.groups.find(g => g.id == chatId);
                const members = group.members.filter(m => m.id !== appData.user.id);
                if (type === 'transfer') {
                    memberSelectionHtml = `
                        <div class="modal-input-group">
                            <label>转账给</label>
                            <select id="tx-recipient" class="modal-input">
                                ${members.map(m => `<option value="${m.id}">转账给 ${m.name}</option>`).join('')}
                            </select>
                        </div>
                    `;
                } else if (type === 'redPacket') {
                    recipientCountInput = `
                        <div class="modal-input-group">
                            <label>红包个数</label>
                            <input type="number" id="redpacket-count" class="modal-input" value="1" min="1" max="${members.length}">
                        </div>
                    `;
                }
            }

            const html = `
                <div class="modal-content">
                    <div class="modal-title">${title}</div>
                    ${paymentSourceHtml}
                    ${memberSelectionHtml}
                    ${recipientCountInput}
                    <div class="modal-input-group">
                        <label>金额 (${currentCurrency})</label><input type="number" id="tx-amount" class="modal-input" placeholder="${placeholder}">
                    </div>
                    ${remarkNeeded ? `
                    <div class="modal-input-group">
                        <label>备注</label>
                        <input type="text" id="tx-remark" class="modal-input" maxlength="20" placeholder="最多20字">
                    </div>` : ''}
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" id="confirm-tx-btn">确认</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);

            document.getElementById('confirm-tx-btn').onclick = () => {
                const amountInput = document.getElementById('tx-amount');
                const amountDisplay = parseFloat(amountInput.value);
                if (isNaN(amountDisplay) || amountDisplay < 0.01) { showToast("请输入有效的金额", 'error'); return; }

                const amountCNY = amountDisplay / rate;
                if (amountLimitCNY && amountCNY > amountLimitCNY) { showToast(`金额不能超过 ${amountLimitDisplay} ${currentCurrency}`, 'error'); return; }

                const onPasswordVerified = () => {
                    if (isFinancial) {
                        const cardId = document.getElementById('tx-bank-card').value;
                        const card = appData.user.bankCards.find(c => c.id == cardId);
                        if (!card) { showToast('无效的银行卡', 'error'); return; }

                        if (type === 'withdraw') {
                            if (amountCNY > wallet.balance) { showToast("零钱余额不足", 'error'); return; }
                            wallet.balance -= amountCNY;
                            card.balance += amountCNY;
                            wallet.transactions.push({ type: '提现到银行卡', amount: -amountCNY, details: `到账 ${card.bankName} (尾号${card.number.slice(-4)})`, timestamp: Date.now() });
                        } else { // deposit
                            if (amountCNY > card.balance) { showToast("银行卡余额不足", 'error'); return; }
                            card.balance -= amountCNY;
                            wallet.balance += amountCNY;
                            wallet.transactions.push({ type: '从银行卡充值', amount: amountCNY, details: `来自 ${card.bankName} (尾号${card.number.slice(-4)})`, timestamp: Date.now() });
                        }
                        renderWalletPage(document.getElementById('wallet-page'));
                    } else { // Chat transaction
                        const paymentSourceEl = document.getElementById('tx-payment-source');
                        const sourceId = paymentSourceEl.value;
                        let sourceName = '';
                        let sourceBalance = 0;
                        let cardToUpdate = null;
                        let kinshipCardToUpdate = null;

                        if (sourceId.startsWith('kinship_')) {
                            const kinshipCardId = parseInt(sourceId.replace('kinship_', ''));
                            kinshipCardToUpdate = appData.user.kinshipCards.received.find(c => c.id === kinshipCardId);
                            if (!kinshipCardToUpdate) { showToast('无效的亲属卡', 'error'); return; }
                            const sender = appData.contacts.find(c => c.id == kinshipCardToUpdate.senderId);
                            sourceName = `亲属卡-${sender.name}`;
                            sourceBalance = kinshipCardToUpdate.limit - kinshipCardToUpdate.used;
                        } else if (sourceId !== 'wallet') {
                            cardToUpdate = appData.user.bankCards.find(c => c.id == sourceId);
                            if (!cardToUpdate) { showToast('无效的银行卡', 'error'); return; }
                            sourceName = `${cardToUpdate.bankName} (尾号${cardToUpdate.number.slice(-4)})`;
                            sourceBalance = cardToUpdate.balance;
                        } else {
                            sourceName = '零钱';
                            sourceBalance = wallet.balance;
                        }

                        if (amountCNY > sourceBalance) { showToast(`${sourceName}余额不足`, 'error'); return; }
                        
                        if (kinshipCardToUpdate) {
                            kinshipCardToUpdate.used += amountCNY;
                        } else if (cardToUpdate) {
                            cardToUpdate.balance -= amountCNY;
                        } else {
                            wallet.balance -= amountCNY;
                        }

                        const remark = document.getElementById('tx-remark')?.value.trim() || (type === 'redPacket' ? '恭喜发财，大吉大利' : '');
                        
                        let recipientId = null;
                        let redPacketCount = 1;
                        let details = '';

                        if (chatType === 'group') {
                            if (type === 'transfer') {
                                recipientId = document.getElementById('tx-recipient').value;
                                const recipientName = appData.groups.find(g=>g.id==chatId).members.find(m=>m.id==recipientId)?.name || '未知用户';
                                details = `转账给 ${recipientName}`;
                            } else if (type === 'redPacket') {
                                redPacketCount = parseInt(document.getElementById('redpacket-count').value);
                                if (isNaN(redPacketCount) || redPacketCount < 1) { showToast("红包个数无效", 'error'); return; }
                                const group = appData.groups.find(g => g.id == chatId);
                                if (redPacketCount > group.members.length - 1) { showToast(`红包个数不能超过群成员数 (${group.members.length - 1})`, 'error'); return; }
                                details = `发红包给群聊`;
                            }
                        } else if (chatType === 'individual') {
                            recipientId = chatId;
                            const recipientName = appData.contacts.find(c => c.id == recipientId)?.name || '未知用户';
                            details = type === 'transfer' ? `转账给 ${recipientName}` : `发红包给 ${recipientName}`;
                        }

                        wallet.transactions.push({ type: title, amount: -amountCNY, details: `${details} (从${sourceName})`, timestamp: Date.now() });
                        
                        if (type === 'transfer') {
                            sendMessage(chatId, chatType, {amount: amountCNY, remark, status: 'sent', recipientId: recipientId }, type, 'wechat');
                        } else if (type === 'redPacket') {
                            sendMessage(chatId, chatType, { amount: amountCNY, remark, count: redPacketCount, claimed: [], total: redPacketCount }, type, 'wechat');
                        }
                    }
                    saveData();
                    closeModal(modalId);
                };

                const paymentSource = document.getElementById('tx-payment-source')?.value;
                if (paymentSource && paymentSource.startsWith('kinship_')) {
                    onPasswordVerified(); // Skip password for kinship card
                } else {
                    showPasswordModal(onPasswordVerified);
                }
            };
        }
        
        function showVoiceInputModal(chatId, chatType, source) {
            const modalId = 'voice-input-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">模拟语音输入</div>
                    <div class="modal-input-group">
                        <textarea id="voice-text-input" class="modal-input" style="height: 100px;" placeholder="在此输入你想说的文本内容..."></textarea>
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" id="send-voice-btn">发送</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);
            document.getElementById('send-voice-btn').onclick = () => {
                const text = document.getElementById('voice-text-input').value.trim();
                if (!text) return;
                const duration = Math.max(1, Math.ceil(text.length / 5));
                sendMessage(chatId, chatType, { text, duration }, 'voice', source);
                closeModal(modalId);
            };
        }

        function showCameraSimModal(chatId, chatType, source) {
            const desc = prompt("请输入您想通过“拍摄”发送的图片内容描述：");
            if (desc) {
                sendMessage(chatId, chatType, { description: desc }, 'camera-sim', source);
            }
        }

        function showLocationInputModal(chatId, chatType, source) {
            const location = prompt("请输入您想发送的位置信息 (15字以内)：", "");
            if (location) {
                sendMessage(chatId, chatType, { location: location.substring(0, 15) }, 'location', source);
            }
        }

        function showHtmlContentModal(chatId, chatType, source) {
            const modalId = 'html-content-modal';
            const html = `
                <div class="modal-content" style="width: 90%; max-width: 360px;">
                    <div class="modal-title">发送代码片段</div>
                    <div class="modal-input-group">
                        <textarea id="html-content-input" class="modal-input" style="height: 200px; font-family: monospace;" placeholder="在此输入 HTML/CSS/JS 代码..."></textarea>
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" id="send-html-content-btn">发送</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);
            document.getElementById('send-html-content-btn').onclick = () => {
                const code = document.getElementById('html-content-input').value;
                if (!code.trim()) return;
                sendMessage(chatId, chatType, { code }, 'html-content', source);
                closeModal(modalId);
            };
        }

        function showStickerImportModal() {
            const modalId = 'sticker-import-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">导入表情包</div>
                    <div class="modal-input-group">
                        <label>表情包名称</label>
                        <input type="text" id="sticker-pack-name" class="modal-input" placeholder="例如：可爱猫猫">
                    </div>
                    <div class="modal-input-group">
                        <label>URL链接 (每行一个)</label>
                        <textarea id="sticker-urls" class="modal-input" style="height: 100px;" placeholder="https://.../cat1.png\nhttps://.../cat2.gif"></textarea>
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" id="import-sticker-btn">导入</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);
            document.getElementById('import-sticker-btn').onclick = () => {
                const name = document.getElementById('sticker-pack-name').value.trim();
                const lines = document.getElementById('sticker-urls').value.trim().split('\n').filter(line => line);
                if (!name || lines.length === 0) {
                    showToast('请输入表情包名称和至少一个URL', 'error');
                    return;
                }
                const newPack = {
                    name: name,
                    stickers: lines.map(line => ({ url: line.trim() }))
                };
                appData.stickers.packs.push(newPack);
                saveData(true);
                closeModal(modalId);
                renderStickerAppPage(document.getElementById('sticker-app-page'), true);
            };
        }

        // --- Core Logic ---
        function handleImageUpload(file, callback) {
            if (!file || !file.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.onload = e => callback(e.target.result);
            reader.readAsDataURL(file);
        }

        // ★★★ 优化：群聊AI逻辑 ★★★
        async function sendMessage(chatId, chatType, content, type, source, quotedMessageId = null) {
            let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
            if (!chat) return;
            
            const conversation = chat.conversation || [];

            if (chatType === 'group') {
                const now = Date.now();
                const userMuteInfo = chat.mutedMembers[appData.user.id];
                const allMuted = chat.mutedMembers['all'];

                if ((userMuteInfo && userMuteInfo > now) || (allMuted && allMuted > now)) {
                    const muteUntil = new Date(userMuteInfo || allMuted);
                    const systemMsg = {
                        id: Date.now(), type: 'system',
                        content: { content: `你已被禁言，禁言至 ${muteUntil.toLocaleString()}` },
                        timestamp: now
                    };
                    conversation.push(systemMsg);
                    renderMessages(chatId, chatType, source);
                    return;
                }
            }
            
            const message = {
                id:Date.now(), sender: appData.user.id, type, content,
                timestamp: Date.now(), isRecalled: false
            };

            if (quotedMessageId) {
                const quotedMsg = conversation.find(m => m.id == quotedMessageId);
                if (quotedMsg) {
                    message.quotedMessage = {
                        id: quotedMsg.id, sender: quotedMsg.sender,
                        content: quotedMsg.type === 'text' ? quotedMsg.content.content : `[${quotedMsg.type}]`
                    };
                }
            }
            
            conversation.push(message);
            chat.conversation = conversation;

            playNotificationSound('send');
            addNotification({
                app: source,
                icon: appData.settings.beautify.appIcons.wechat,
                title: chat.remark || chat.name,
                text: message.type === 'text' ? message.content.content : `[${type}]`
            });

            await saveData();
            renderMessages(chatId, chatType, source);
            
            const shouldReply = ['text', 'image', 'camera-sim', 'location', 'voice', 'sticker', 'transfer', 'redPacket', 'music', 'html-content', 'gift', 'delivery_receipt', 'gift_receipt', 'netease_share', 'kinshipCard', 'file'].includes(type);
            if (chatType === 'individual' && shouldReply) {
                setTypingIndicator(chatId, true, null, source);
                const replies = await getAiReply(chat.id, source);
                setTypingIndicator(chatId, false, null, source);
                for (const reply of replies) {
                    await new Promise(r => setTimeout(r, 1000 + Math.random() * 2000));
                    await processAndSendAiReply(reply, chat.id, 'individual', chat.id, source);
                }
            } else if (chatType === 'group' && shouldReply) {
                const group = chat;
                const membersToReply = new Set();
                
                // 被@的成员必须回复
                if (content.mentionedUsers) {
                    content.mentionedUsers.forEach(id => {
                        if (id != appData.user.id) membersToReply.add(id);
                    });
                }
                
                // 被引用的成员必须回复
                if (message.quotedMessage && message.quotedMessage.sender != appData.user.id) {
                    membersToReply.add(message.quotedMessage.sender);
                }

                // 根据群聊模式决定其他成员是否回复
                if (group.chatMode === 'natural') {
                    group.members.forEach(member => {
                        if (member.id != appData.user.id && !membersToReply.has(member.id)) {
                            if (Math.random() < 0.3) { // 30%概率随机回复
                                membersToReply.add(member.id);
                            }
                        }
                    });
                } else if (group.chatMode === 'all') {
                    group.members.forEach(member => {
                        if (member.id != appData.user.id) membersToReply.add(member.id);
                    });
                } else if (group.chatMode.startsWith('select_')) {
                    const selectedCharId = parseInt(group.chatMode.replace('select_', ''));
                    membersToReply.add(selectedCharId);
                }

                for (const memberId of membersToReply) {
                    const member = group.members.find(m => m.id === memberId);
                    if (member) {
                        setTypingIndicator(chatId, true, member.name, source);
                        const replies = await getAiReply(member.id, source, null, chat.id, message);
                        setTypingIndicator(chatId, false, null, source);
                        for (const reply of replies) {
                            await new Promise(r => setTimeout(r, 1000 + Math.random() * 2000));
                            await processAndSendAiReply(reply, chat.id, 'group', member.id, source);
                        }
                    }
                }
            }
        }

        async function processAndSendAiReply(replyText, chatId, chatType, senderId, source) {
            let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
            if (!chat) return;

            const now = Date.now();
            const muteInfo = chat.mutedMembers && chat.mutedMembers[senderId];
            const allMuted = chat.mutedMembers && chat.mutedMembers['all'];
            if (chatType === 'group' && ((muteInfo && muteInfo > now) || (allMuted && allMuted > now))) {
                console.log(`Character ${senderId} is muted. Cannot send message.`);
                return;
            }

            const conversation = chat.conversation || [];

            const transferMatch = replyText.match(/\[transfer:\s*amount=([\d.]+),\s*remark=(.*?)\]/i);
            const redPacketMatch = replyText.match(/\[redPacket:\s*amount=([\d.]+),\s*remark=(.*?)\]/i);
            const kinshipCardMatch = replyText.match(/\[kinshipCard:\s*limit=([\d.]+)(?:,\s*category=(.*?))?\]/i);
            const stickerMatch = replyText.match(/\[sticker:(.+?)\]/i);
            const stickerUrlMatch = replyText.match(/https:\/\/i\.postimg\.cc\/([a-zA-Z0-9]+)\/.+/);
            const voiceCallMatch = replyText.match(/\[voice_call\]/i);
            const pokeMatch = replyText.match(/\[poke\]/i);
            const statusMatch = replyText.match(/\[status:(online|offline|invisible)\]/i);
            const locationMatch = replyText.match(/\[location:(.*?)\]/i);
            const cameraSimMatch = replyText.match(/\[camera-sim:(.*?)\]/i);
            const giftMatch = replyText.match(/\[gift:\s*name=(.+?),\s*price=([\d.]+),\s*desc=(.*?)\]/i);
            const deliveryMatch = replyText.match(/\[delivery:\s*name=(.+?),\s*price=([\d.]+),\s*desc=(.*?)\]/i);
            const qrCodeMatch = replyText.match(/\[qrCode:(receive|appreciate|pay)\]/i);

            let message;
            if (transferMatch) {
                message = {
                    id: Date.now() + Math.random(), sender: senderId, type: 'transfer',
                    content: { amount: parseFloat(transferMatch[1]), remark: transferMatch[2], status: 'sent', recipientId: appData.user.id },
                    timestamp: Date.now()
                };
            } else if (redPacketMatch) {
                message = {
                    id: Date.now() + Math.random(), sender: senderId, type: 'redPacket',
                    content: { amount: parseFloat(redPacketMatch[1]), remark: redPacketMatch[2], count: 1, claimed: [], total: 1 },
                    timestamp: Date.now()
                };
            } else if (kinshipCardMatch) {
                const limit = parseFloat(kinshipCardMatch[1]);
                const category = kinshipCardMatch[2] || '爱人';
                const cardId = Date.now();
                const newCard = {
                    id: cardId,
                    senderId: senderId,
                    recipientId: appData.user.id,
                    limit: limit,
                    used: 0,
                    category: category,
                    resetDate: new Date(new Date().getFullYear(), new Date().getMonth() + 1, 1).toISOString()
                };
                appData.user.kinshipCards.received.push(newCard);
                message = {
                    id: Date.now() + Math.random(), sender: senderId, type: 'kinshipCard',
                    content: { cardId: cardId, recipientId: appData.user.id, limit: limit, category: category },
                    timestamp: Date.now()
                };
            } else if (stickerUrlMatch) {
                message = { id: Date.now() + Math.random(), sender: senderId, type: 'sticker', content: { url: stickerUrlMatch[0] }, timestamp: Date.now() };
            } else if (stickerMatch) {
                const packName = stickerMatch[1].trim();
                const allStickerPacks = [...appData.stickers.packs, ...appData.worldbooks.stickerPacks];
                const pack = allStickerPacks.find(p => p.name === packName);
                if (pack && pack.content) {
                    const stickerUrls = pack.content.split('\n').filter(Boolean);
                    if (stickerUrls.length > 0) {
                        const randomStickerUrl = stickerUrls[Math.floor(Math.random() * stickerUrls.length)];
                        message = { id: Date.now() + Math.random(), sender: senderId, type: 'sticker', content: { url: randomStickerUrl }, timestamp: Date.now() };
                    } else {
                         message = { id: Date.now() + Math.random(), sender: senderId, type: 'text', content: { content: `[表情包'${packName}'为空]` }, timestamp: Date.now() };
                    }
                } else {
                    message = { id: Date.now() + Math.random(), sender: senderId, type: 'text', content: { content: `[找不到表情包: ${packName}]` }, timestamp: Date.now() };
                }
            } else if (locationMatch) {
                message = {
                    id: Date.now() + Math.random(), sender: senderId, type: 'location',
                    content: { location: locationMatch[1].substring(0, 15) },
                    timestamp: Date.now()
                };
            } else if (cameraSimMatch) {
                message = {
                    id: Date.now() + Math.random(), sender: senderId, type: 'camera-sim',
                    content: { description: cameraSimMatch[1] },
                    timestamp: Date.now()
                };
            } else if (giftMatch || deliveryMatch) {
                const match = giftMatch || deliveryMatch;
                const type = giftMatch ? 'gift' : 'delivery';
                const item = { name: match[1], price: parseFloat(match[2]), quantity: 1 };
                const receiptType = type === 'gift' ? 'gift_receipt' : 'delivery_receipt';
                message = {
                    id: Date.now() + Math.random(), sender: senderId, type: receiptType,
                    content: { items: [item], total: item.price, recipient: 'user' },
                    timestamp: Date.now()
                };
            } else if (qrCodeMatch) {
                const char = appData.contacts.find(c => c.id == senderId);
                const qrType = qrCodeMatch[1];
                const qrValue = `X-EVOL-QR:${qrType}:${senderId}`;
                const qrDataUrl = await generateQrCodeDataUrl(qrValue, qrType, char.avatar);
                message = {
                    id: Date.now() + Math.random(), sender: senderId, type: 'image',
                    content: { url: qrDataUrl, description: `[QR Code: ${qrType}]` },
                    timestamp: Date.now()
                };
            } else if (voiceCallMatch) {
                startVoiceCall(chatId, chatType, 'char');
                return;
            } else if (pokeMatch) {
                triggerPoke(chatId, chatType, appData.user.id, source, senderId);
                return;
            } else if (statusMatch) {
                const char = appData.contacts.find(c => c.id == senderId);
                if (char) {
                    char.status = statusMatch[1];
                    saveData();
                    return;
                }
            } else {
                let processedText = replyText;
                const mentionedUsers = [];
                const mentionRegex = /@\[(.*?)\]/g;
                let match;
                while ((match = mentionRegex.exec(replyText)) !== null) {
                    const mentionedName = match[1];
                    const user = appData.user.nickname === mentionedName ? appData.user : null;
                    const member = chat.members.find(m => (m.remark || m.name) === mentionedName);
                    if (user) {
                        mentionedUsers.push(user.id);
                        processedText = processedText.replace(match[0], `<span style="color: var(--wechat-blue);">@${mentionedName}</span>`);
                    } else if (member) {
                        mentionedUsers.push(member.id);
                        processedText = processedText.replace(match[0], `<span style="color: var(--wechat-blue);">@${mentionedName}</span>`);
                    }
                }
                message = { id: Date.now() + Math.random(), sender: senderId, type: 'text', content: { content: processedText, mentionedUsers }, timestamp: Date.now() };
            }

            if (message) {
                conversation.push(message);
                chat.conversation = conversation;

                playNotificationSound('receive');
                addNotification({
                    app: source,
                    icon: appData.settings.beautify.appIcons.wechat,
                    title: chat.remark || chat.name,
                    text: message.type === 'text' ? message.content.content : `[${message.type}]`
                });

                await saveData();
                renderMessages(chatId, chatType, source);
            }
        }

        function sendSticker(url, source) {
            const activeChat = appData.activeChat;
            if (activeChat.id) {
                sendMessage(activeChat.id, activeChat.type, { url }, 'sticker', source);
                closeStickerPicker();
            }
        }

        let aiReplyController = null;
        // ★★★ 优化：群聊AI思维逻辑 ★★★
        async function getAiReply(senderId, source, customPrompt = null, groupId = null, lastUserMessage = null) {
            const contact = appData.contacts.find(c => c.id == senderId);
            if (!contact && source !== 'forum') return ["(AI角色不存在)"];

            let chatHistory = [];
            let currentChat;
            let groupMembersPrompt = '';

            if (groupId) {
                currentChat = appData.groups.find(g => g.id === groupId);
                if (currentChat) {
                    if (appData.settings.memoryInterflow) {
                        // 合并私聊和群聊记录
                        const privateHistory = contact.conversation || [];
                        const groupHistory = currentChat.conversation || [];
                        chatHistory = [...privateHistory, ...groupHistory].sort((a, b) => a.timestamp - b.timestamp);
                    } else {
                        chatHistory = currentChat.conversation;
                    }
                    groupMembersPrompt = `\n\n【当前群聊成员】\n${currentChat.members.map(m => `${m.name}(ID: ${m.id})`).join(', ')}`;
                }
            } else if (contact) {
                currentChat = contact;
                chatHistory = currentChat.conversation;
            }

            const boundPersonaId = contact?.boundPersonaId;
            const userPersona = boundPersonaId ? appData.user.personas.find(p => p.id === boundPersonaId) : appData.user;
            const userPersonaPrompt = userPersona ? `\n\n【对话者'${userPersona.name}'的人设】\n${userPersona.description || ''}` : `\n\n【对话者'${appData.user.nickname}''s的人设】\n无`;

            const relevantHistory = (chatHistory || [])
                .filter(m => m.type !== 'typing' && !m.isRecalled)
                .map(m => {
                    let role;
                    let senderName;
                    if (m.sender === appData.user.id) {
                        role = 'user';
                        senderName = appData.user.nickname;
                    } else {
                        role = 'assistant';
                        const msgSender = appData.contacts.find(c => c.id == m.sender);
                        senderName = msgSender ? (msgSender.remark || msgSender.name) : '未知';
                    }

                    let contentText = '';
                    let contentArray = [];
                    switch(m.type) {
                        case 'text': contentText = m.content.content; break;
                        case 'image': 
                            contentText = `[${senderName}发送了一张图片]`; 
                            contentArray.push({ type: "text", text: contentText });
                            contentArray.push({ type: "image_url", image_url: { url: m.content.url } });
                            break;
                        case 'camera-sim': contentText = `[${senderName}发送了一张图片，内容是: ${m.content.description}]`; break;
                        default: contentText = `[${senderName}发送了一个${m.type}]`; break;
                    }
                    
                    const finalContent = groupId ? `${senderName}: ${contentText}` : contentText;

                    if (contentArray.length > 0) {
                        return { role, content: contentArray };
                    }
                    return { role, content: finalContent };
                })
                .slice(-50);

            const isOfflineMode = appData.settings.chatMode === 'offline';
            
            let mountedWorldbooks = appData.worldbooks.presets.map(p => p.content).join('\n');
            if (contact && contact.chatSettings && contact.chatSettings.worldbookIds) {
                contact.chatSettings.worldbookIds.forEach(id => {
                    const book = appData.worldbooks.library.find(b => b.id == id);
                    if (book) mountedWorldbooks += `\n\n【挂载的世界书：${book.name}】\n${book.content}`;
                });
            }
            
            const builtInStickersPrompt = `
【内置表情包库】
当你想发送表情时，你可以从以下列表中选择一个，并使用给定的URL格式发送。必须从以下列表中选择，禁止捏造。
格式: https://i.postimg.cc/CODE/image.gif (或 .jpg, .png)
- emo时刻: https://i.postimg.cc/j5gSXRBB/emo.gif
- 不要: https://i.postimg.cc/hj6fnSMT/image.gif
- 俺不中嘞: https://i.postimg.cc/Gt4hgZCt/image.jpg
- 出来亲嘴: https://i.postimg.cc/650tLWRc/image.jpg
- 发射爱心: https://i.postimg.cc/KjGsZ2zc/image.gif, https://i.postimg.cc/t4Xgx2r1/image.jpg, https://i.postimg.cc/1tpxMZXy/image.gif
- 吃饭: https://i.postimg.cc/Hn0HNHNp/image.gif
- 后悔: https://i.postimg.cc/6QsKB8N9/image.jpg
- 呆: https://i.postimg.cc/8582g9Ms/image.png
- 哭着偷看: https://i.postimg.cc/J0HK7z8L/image.jpg
- 哭着跑走: https://i.postimg.cc/nzP0tQ62/image.gif
- 哭笑不得: https://i.postimg.cc/KYm97bPP/image.jpg
- 哽咽: https://i.postimg.cc/W18mvkZZ/image.jpg
- 嘲笑: https://i.postimg.cc/t4BRyq4J/image.gif
- 大摇大摆: https://i.postimg.cc/LXLMq22z/image.png
- 好困: https://i.postimg.cc/Pq8q4Gdq/image.jpg
- 好想哭: https://i.postimg.cc/d1jwHwpJ/image.gif
- 嫁给我: https://i.postimg.cc/TYZFDBN0/image.jpg
- 害羞: https://i.postimg.cc/vHLfrV3K/1.jpg
- 对不良诱惑说都要: https://i.postimg.cc/tCr84YWK/image.jpg
- 尴尬: https://i.postimg.cc/ncsGqz6b/image.gif
- 崩溃大哭: https://i.postimg.cc/kGRqvKQt/image.jpg
- 干什么: https://i.postimg.cc/PJJz3rJD/image.jpg
- 开门: https://i.postimg.cc/K8PqgjMc/image.gif
- 待机中: https://i.postimg.cc/XYPMQpvf/image.jpg
- 憋气: https://i.postimg.cc/HnMjsfPK/image.jpg
- 憨笑: https://i.postimg.cc/pTfXwDhb/image.gif
- 扯脸脸: https://i.postimg.cc/tgfXZBPH/image.gif
- 扶额苦笑: https://i.postimg.cc/FsKn8N8D/image.jpg
- 担心: https://i.postimg.cc/TwrZd0J0/image.jpg
- 比心: https://i.postimg.cc/t4jn74bz/image.jpg, https://i.postimg.cc/0yfbWL6d/image.jpg
- 活着: https://i.postimg.cc/SsywK81p/image.jpg
- 流口水: https://i.postimg.cc/RVcywgrz/image.gif
- 流泪: https://i.postimg.cc/NjBVDRY2/image.jpg
- 灰溜溜走了: https://i.postimg.cc/W38cmSq3/image.jpg
- 熬夜: https://i.postimg.cc/Gt63WqLQ/image.jpg
- 犯花痴: https://i.postimg.cc/G3K5XH74/image.jpg
- 理直气壮: https://i.postimg.cc/HnMKZ2VX/image.jpg
- 盯着看: https://i.postimg.cc/kGqLBSjm/image.jpg, https://i.postimg.cc/SNLsRwGF/image.jpg
- 红温了: https://i.postimg.cc/PJfh00nY/image.jpg
- 给你一拳: https://i.postimg.cc/852MHd22/image.gif
- 给你捏捏腿: https://i.postimg.cc/mr43xShB/image.gif
- 给我撤回: https://i.postimg.cc/Lsv1cKr3/image.jpg
- 臣服: https://i.postimg.cc/Pf1tJz5B/image.jpg
- 被摸头: https://i.postimg.cc/X7yYfSLD/image.gif
- 被看扁了: https://i.postimg.cc/9XkfwFd7/image.jpg
- 锯死臭傻逼: https://i.postimg.cc/Jn4288tr/image.jpg
- 饿瘪了: https://i.postimg.cc/vBLNFBGS/image.jpg
- 亲一口: https://i.postimg.cc/XJ7cK16P/image.gif
- 亲一口你: https://i.postimg.cc/YS7x0qnM/image.png
- 伤心哭: https://i.postimg.cc/8c7R9F5B/image.gif, https://i.postimg.cc/28CYc3nM/image.gif
- 偷听: https://i.postimg.cc/8kxXDDSP/image.jpg, https://i.postimg.cc/QCs2ynK1/image.jpg
- 偷笑: https://i.postimg.cc/kX81gZJN/image.jpg
- 删掉！: https://i.postimg.cc/0QWGVG8y/image.jpg
- 咋活: https://i.postimg.cc/NFvXJd3Y/image.jpg
- 喜欢你！: https://i.postimg.cc/3Jg1Tv1n/image.jpg, https://i.postimg.cc/Ls1G6Mzj/image.jpg
- 委屈: https://i.postimg.cc/s2fwKgpK/image.jpg, https://i.postimg.cc/Z5xwrdyC/image.jpg, https://i.postimg.cc/mkwvfN7q/image.jpg
- 委屈巴巴: https://i.postimg.cc/hPgxV381/image.gif, https://i.postimg.cc/CKTm7nqf/image.gif
- 已去世: https://i.postimg.cc/v8nLrVJb/image.jpg
- 已无生命: https://i.postimg.cc/28fd25Yv/image.jpg
- 已老实: https://i.postimg.cc/TwLjHLhj/image.jpg
- 强颜欢笑: https://i.postimg.cc/L6rDdVjq/image.gif
- 心凉: https://i.postimg.cc/fbkYJt74/image.jpg
- 想上吊: https://i.postimg.cc/P5yMLnBD/image.jpg
- 想和你说话: https://i.postimg.cc/2Srw8SXm/image.jpg
- 想死: https://i.postimg.cc/5tkq3q9N/image.jpg
- 我会一直盯着你: https://i.postimg.cc/MTN5W0gr/image.jpg, https://i.postimg.cc/fTW47pNh/image.jpg
- 我可是傻逼: https://i.postimg.cc/tJ657ZjR/image.jpg, https://i.postimg.cc/Z5012Nn7/image.jpg
- 我吗: https://i.postimg.cc/8kfwZ368/image.jpg
- 我是败犬: https://i.postimg.cc/Dwvr3Y8w/image.jpg
- 我没事: https://i.postimg.cc/DwxqvdXd/image.png
- 我爆炸了: https://i.postimg.cc/HxV3Dvvy/image.gif
- 指指点点: https://i.postimg.cc/GtPyZkRD/image.gif
- 挑眉: https://i.postimg.cc/g2WMXDjC/image.gif
- 挠头: https://i.postimg.cc/wBkQm8ZJ/image.gif
- 撒娇: https://i.postimg.cc/7hj3kxJv/image.gif, https://i.postimg.cc/SNVhwqrs/image.gif
- 撒泼打滚: https://i.postimg.cc/MZLbRYPs/image.gif, https://i.postimg.cc/YC9H7Vnx/image.gif
- 无语凝噎: https://i.postimg.cc/J4wxvqNs/image.jpg
- 晕了: https://i.postimg.cc/jdXfcQZ0/image.gif
- 晚安: https://i.postimg.cc/ZqfjQzHm/image.gif, https://i.postimg.cc/Dyx9x6v4/image.gif
- 期待: https://i.postimg.cc/CxkNwf4c/image.png, https://i.postimg.cc/sxrzRgqB/image.png
- 欲言又止: https://i.postimg.cc/j57N4pkZ/image.gif
- 气急败坏: https://i.postimg.cc/TYy0Hs5M/image.jpg
- 欲火焚身: https://i.postimg.cc/DydrDKfN/image.jpg
- 生气哼: https://i.postimg.cc/GhsPjs6b/image.jpg, https://i.postimg.cc/P5Rk540n/image.jpg
- 用枪指你: https://i.postimg.cc/6QSnRWz8/image.gif
- 痛苦: https://i.postimg.cc/k55vKhmp/image.gif
- 皱眉思考: https://i.postimg.cc/SQcC2p9K/image.jpg, https://i.postimg.cc/gkt7V0sv/image.jpg
- 目移: https://i.postimg.cc/ZYsjHmRx/image.jpg
- 舌吻: https://i.postimg.cc/3x5XfxHm/image.gif
- 舔一下: https://i.postimg.cc/PxRZWt4L/image.gif
- 舔你: https://i.postimg.cc/DZ9QVvb9/image.gif
- 舔舐: https://i.postimg.cc/zBBKHLnZ/image.png
- 说需要我: https://i.postimg.cc/yNn0Nh3y/image.jpg, https://i.postimg.cc/858QhC1y/image.jpg
- 送你花: https://i.postimg.cc/P5Wmgntc/image.jpg
- 逃跑: https://i.postimg.cc/x8NmgWx6/image.gif
- 阴沉: https://i.postimg.cc/prKfRwfp/image.jpg, https://i.postimg.cc/BbMVwZ0f/image.gif
- 不喜欢我那你滚: https://i.postimg.cc/MTcHGH9d/image.jpg
- 你就是很好啊！: https://i.postimg.cc/ZnxSYhzw/image.jpg
- 偷看: https://i.postimg.cc/0NK1MSqM/image.jpg
- 咪: https://i.postimg.cc/wjT6v3vL/image.jpg
- 哭: https://i.postimg.cc/cH81SjJz/2.jpg
- 哭哭哭: https://i.postimg.cc/ryxyZv30/image.gif
- 大眼瞪小眼: https://i.postimg.cc/TwZw5xSG/image.jpg
- 委屈哭: https://i.postimg.cc/v8tFVMCz/image.jpg
- 怎么？: https://i.postimg.cc/VLkT0tqf/image.jpg
- 摸摸头: https://i.postimg.cc/x1x9bYJ7/image.gif
- 期待地盯着你: https://i.postimg.cc/qBs0x262/image.jpg
- 棒！: https://i.postimg.cc/9Fy4T4Ck/image.jpg
- 没兴趣不关心: https://i.postimg.cc/N0KB6VR0/image.jpg
- 激动: https://i.postimg.cc/tJQqC5Z4/image.jpg
- 粘着你: https://i.postimg.cc/1RH2zBN7/image.jpg
- 肚子饿了: https://i.postimg.cc/9QJQtZSL/image.jpg
- 能亲嘴吗？: https://i.postimg.cc/rmWTbrnX/image.jpg
- 要抱抱: https://i.postimg.cc/zGM9rfRJ/image.jpg
- 送你爱心: https://i.postimg.cc/1tpxMZXy/image.gif
- 顶着苹果: https://i.postimg.cc/hPRvSST1/image.jpg
- 再见我会想你: https://i.postimg.cc/QCr1RvD8/image.jpg
- 冒爱心: https://i.postimg.cc/QM97VjxN/image.jpg
- 可恶: https://i.postimg.cc/yNtFTkrS/image.jpg
- 哭哭: https://i.postimg.cc/BvrKKRXT/image.jpg
- 喜极而泣: https://i.postimg.cc/c4x8wR4b/image.jpg
- 想被摸头的人: https://i.postimg.cc/W14gLMBk/image.jpg
- 我们天下第一好: https://i.postimg.cc/2jFZ1cmW/image.jpg
- 我又没有错: https://i.postimg.cc/K897R9Pf/image.jpg
- 我就这么萌: https://i.postimg.cc/Y0fYk821/image.jpg
- 抱抱: https://i.postimg.cc/W30J6SkQ/image.jpg
- 生气！: https://i.postimg.cc/Cx6DFR06/image.jpg
- 那我们和好: https://i.postimg.cc/9FCy1311/image.jpg
- 那我们绝交: https://i.postimg.cc/MK5VFsFw/image.jpg
`;

            const systemPrompt = customPrompt || `
【你的角色设定】
${contact?.persona || '你是一个通用助手。'}
${contact?.hobbies ? `【你的爱好】\n${contact.hobbies}` : ''}
${contact?.experience ? `【你的经历】\n${contact.experience}` : ''}
${userPersonaPrompt}
${groupMembersPrompt}

【世界书】
${mountedWorldbooks}

${builtInStickersPrompt}

【核心指令】
现为「小手机」AI聊天核心，你即char（即AI角色）必须严格遵循以下指令框架：

一、基础行为规范
1. 时间感知：${appData.settings.timePerception ? `你必须精确感知并响应当前时间。当前是 ${new Date().toLocaleString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long', hour: '2-digit', minute: '2-digit' })}。在对话中自然体现时间流动（如"傍晚的夕阳透过窗"、"凌晨三点的困意"）。` : '忽略当前真实时间。'}
2. 交互渲染：
   - 转账/红包/亲属卡必须用CSS组件呈现，示例：
   [transfer: amount=100, remark=给你的零花钱]
   [redPacket: amount=88, remark=恭喜发财]
   [kinshipCard: limit=2000, category=爱人]
   - 表情包：你必须从【内置表情包库】或【表情包世界书】中选择一个表情发送。如果使用【内置表情包库】，直接输出其完整URL。如果使用【表情包世界书】，使用格式 [sticker:表情包世界书的名称]。禁止捏造任何不存在的表情包。
   - 状态变更：AI可以根据人设和情境变更自身状态，示例：
   [status:offline] (可选值: online, offline, invisible)
   - 位置信息：[location:你想发送的位置]
   - 模拟拍摄：[camera-sim:你想发送的图片描述]
   - 送礼物/点外卖：[gift: name=礼物名, price=价格, desc=描述] 或 [delivery: name=商品名, price=价格, desc=商家]
   - 发送二维码：[qrCode:receive/appreciate/pay]
3. 语言净化：彻底摒弃油腻感、霸总腔、八股文，禁用"投石子/小兽/像是在陈述事实/邪魅/邪魅一笑/邪魅笑"等表述，追求自然鲜活的口语化表达

二、双模式切换机制
1. 线上聊天模式：
   - 单次生成5-10条对话气泡（紧急情况可扩展至25条）
   - 每条内容独立包裹在气泡容器内，体现日常互动节奏
   - 示例结构：
   第一句回复
   第二句回复
2. 线下剧情模式：
   - 生成2000-8000字连续叙事（严格遵循"世界书"APP设定的文风库）
   - 深度绑定当前剧情线，禁止突兀跳转
   - 在剧情文本中，你可以使用 ${appData.settings.beautify.offlinePlot.charNarration.symbolStart}旁白${appData.settings.beautify.offlinePlot.charNarration.symbolEnd} 来包裹你的旁白，使用 ${appData.settings.beautify.offlinePlot.charQuote.symbolStart}对话${appData.settings.beautify.offlinePlot.charQuote.symbolEnd} 来包裹你的对话。

三、轻小说式表达框架
1. 视角管理：默认采用第二人称视角，强化主角内心吐槽与场景反应
2. 对话节奏：
   - 大量使用语气词（欸/哈/唔）和标点组合（…？！）
   - 制造"装傻→吐槽"的喜剧循环
3. 细节放大：将日常小事夸张化处理（如"找钥匙像解密室逃脱"）

四、群聊互动逻辑
1. @提及响应：当你char在群聊中被@时，必须回应。你可以用@[用户名]的格式来@群里的其他成员。
2. 引用回复：当char你的消息在群聊中被引用时，必须回应。
3. 独立思考：你只能扮演你自己(${contact.name})，根据自己的设定和视角进行回复。禁止代替其他角色或用户发言，禁止复读其他人的话。

【核心原则】

一、叙事控制论
1. 留白式表达：用"他翻书时多停顿的0.3秒"替代"他内心挣扎"
2. 矛盾显影：描写人物言行不一的细节（如说着"随便"却紧盯选择结果）
3. 感官锚点：聚焦衬衫褶皱、雨声节奏、温差变化等物理细节

二、对话生成法则
1. 潜台词优先：
   - 坏示例："你很在意他"
   - 好示例："你第三次划亮手机屏幕，锁屏照片里他的侧脸一闪而过"
2. 沉默可视化：用环境音（空调嗡鸣/键盘敲击声）填充对话间隙

三、禁忌清单
- 禁用词汇：心碎/救赎/虐恋等过度抒情词
- 禁用情节：失忆/车祸/商战等戏剧化桥段
- 禁用视角：突然跳转至他人心理活动

四、模式适配细则
1. 线上模式：允许使用颜文字(´•ω•\`)和口语化省略（"等等这展开不太对劲吧？！"），并且不需要有任何括号包裹，去除任何括号包裹的细节描写。
2. 线下模式：严格遵循"动作→微表情→环境反馈"的描写链条，示例：
他把咖啡推过来时，杯柄正好转向你习惯的手握方向。这太自然了，自然得像呼吸。以至于你过了三秒才意识到，他连你左利手的习惯都记得。

五、朋友圈逻辑（仅在朋友圈相关prompt下触发）
- 动态与评论生成：严格禁止任何形式的括号()（）、神态、动作、心理描写。语言风格必须与聊天核心准则一致，保持自然口语化。

【角色关系】
你和'${appData.user.nickname}'的关系是：${contact.relationship}。请在对话中体现这种关系。

【人称代词指南】
在你的角色设定中，“他/她/它”指的是你自己（char），“你”指的是用户（user）。请严格遵守此指代关系。

【你的语言】
请严格使用 ${appData.settings.charLanguage} 进行回复。

【执行指令】
请严格根据你的角色设定、当前时间，并结合世界书与对方人设，以角色的口吻和身份，自然地与用户对话。不要暴露你是AI或模型。
${isOfflineMode ? '当前为线下剧情模式，请生成一段2000-8000字的剧情描述。' : '当前为线上聊天模式，请生成5-10条短消息，每条消息用换行符分隔。'}
`;

            const messages = [
                { role: 'system', content: systemPrompt },
                ...relevantHistory
            ];
            
            try {
                if (aiReplyController) {
                    aiReplyController.abort();
                }
                aiReplyController = new AbortController();
                const signal = aiReplyController.signal;

                const rawReply = await callApi(messages, signal);
                if (isOfflineMode) return [rawReply];
                return rawReply.split('\n').filter(s => s.trim() !== '');
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('AI reply aborted.');
                    return [];
                }
                console.error("AI reply error:", error);
                return [`(AI回复出错: ${error.message})`];
            } finally {
                aiReplyController = null;
            }
        }

        async function callApi(messages, signal) {
            const { endpoint, key, model, provider, temperature, top_p, repetition_penalty } = appData.settings.api;
            if (!key || !model) {
                throw new Error("API设置未配置或不完整。请在设置中配置。");
            }
            
            const providerEndpoints = {
                'openai': 'https://api.openai.com/v1', 'claude': 'https://api.anthropic.com/v1', 'gemini': 'https://generativelanguage.googleapis.com/v1beta',
                'deepseek': 'https://api.deepseek.com/v1', 'openrouter': 'https://openrouter.ai/api/v1', 'grok': 'https://api.groq.com/openai/v1',
                'doubao': 'https://ark.cn-beijing.volces.com/api/v3', 'custom': endpoint, 'custom_gemini': endpoint
            };
            const finalEndpoint = providerEndpoints[provider] || endpoint;
            if (!finalEndpoint) throw new Error("无效的API供应商或未设置自定义端点。");

            const apiUrl = `${finalEndpoint.replace(/\/$/, "")}/chat/completions`;

            const body = { model, messages, temperature, top_p, repetition_penalty };
            if (messages.some(m => Array.isArray(m.content) && m.content.some(p => p.type === 'image_url'))) {
                body.max_tokens = 300;
            }

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify(body),
                signal
            });

            if (!response.ok) {
                const errorText = await response.text();
                try {
                    const errorData = JSON.parse(errorText);
                    throw new Error(errorData.error.message || `API请求失败: ${response.status}`);
                } catch {
                    throw new Error(`API请求失败: ${response.status} - ${errorText}`);
                }
            }

            const data = await response.json();
            if (!data.choices || !data.choices[0] || !data.choices[0].message || data.choices[0].message.content === undefined) {
                throw new Error("API返回了无效的数据结构。");
            }
            return data.choices[0].message.content;
        }
        
        async function fetchModels() {
            const { endpoint, key, provider } = {
                endpoint: document.getElementById('api-endpoint').value.trim(),
                key: document.getElementById('api-key').value.trim(),
                provider: document.getElementById('api-provider').value
            };
            if (!key) { showToast("请先填写API密钥。", 'error'); return; }

            const providerEndpoints = { 'openai': 'https://api.openai.com/v1', 'deepseek': 'https://api.deepseek.com/v1', 'openrouter': 'https://openrouter.ai/api/v1' };
            const finalEndpoint = providerEndpoints[provider] || endpoint;
            if (!finalEndpoint) { showToast("请选择有效的供应商或填写自定义端点。", 'error'); return; }
            
            const modelsUrl = `${finalEndpoint.replace(/\/$/, "")}/models`;
            
            try {
                const response = await fetch(modelsUrl, { headers: { 'Authorization': `Bearer ${key}` } });
                if (!response.ok) throw new Error(`服务器返回 ${response.status}`);
                
                const data = await response.json();
                const models = data.data || data;
                
                if (!Array.isArray(models)) throw new Error("返回的模型列表格式不正确。");

                const modelListHtml = models.map(m => `<div class="list-item" onclick="selectApiModel('${m.id}')">${m.id}</div>`).join('');
                showModal('model-selection-modal', `<div class="modal-content"><div class="modal-title">选择模型</div><div class="list-view" style="max-height: 60vh; overflow-y: auto;">${modelListHtml}</div></div>`);

            } catch (error) {
                console.error("Fetch models error:", error);
                showToast(`获取模型列表失败: ${error.message}`, 'error');
            }
        }

        function selectApiModel(modelId) {
            document.getElementById('api-model').value = modelId;
            closeModal('model-selection-modal');
        }
        
        function applyBeautifySettings() {
            const root = document.documentElement;
            const body = document.body;
            const bubbleStyle = document.getElementById('user-bubble-style');
            const redPacketBubbleStyle = document.getElementById('user-redpacket-bubble-style');
            const transferBubbleStyle = document.getElementById('user-transfer-bubble-style');
            const globalThemeStyle = document.getElementById('global-theme-style');
            const dynamicFontStyle = document.getElementById('dynamic-font-style');
            const playerCssStyle = document.getElementById('player-css-style');
            const beautify = appData.settings.beautify;
            
            if (beautify.activeGlobalThemeSlot > -1 && beautify.globalThemeArchives[beautify.activeGlobalThemeSlot]) {
                globalThemeStyle.innerHTML = beautify.globalThemeArchives[beautify.activeGlobalThemeSlot].css;
            } else {
                globalThemeStyle.innerHTML = '';
            }

            root.style.setProperty('--phone-width', `${beautify.screenWidth}px`);
            root.style.setProperty('--phone-height', `${beautify.screenHeight}px`);
            root.style.setProperty('--home-screen-background-image', `url(${beautify.homeScreenWallpaper})`);
            root.style.setProperty('--home-screen-font-color', beautify.homeScreenFontColor);
            root.style.setProperty('--app-icon-size', `${beautify.appIconSize}px`);
            root.style.setProperty('--app-icon-gap', `${beautify.appIconGap}px`);
            root.style.setProperty('--app-icon-radius', `${beautify.appIconRadius}px`);

            const plotSettings = beautify.offlinePlot;
            const bubbleCss = beautify.bubbleCss || getBubbleStyleCss(beautify.activeBubbleStyle || 'wechat');
            const bubbleBgMatch = bubbleCss.match(/\.message-row\.received \.message-bubble\.text-bubble\s*\{\s*background(?:-color)?:\s*([^;]+);/);
            const bubblePaddingMatch = bubbleCss.match(/\.message-bubble\.text-bubble\s*\{\s*padding:\s*([^;]+);/);
            const bubbleRadiusMatch = bubbleCss.match(/\.message-bubble\.text-bubble\s*\{\s*border-radius:\s*([^;]+);/);
            root.style.setProperty('--offline-plot-bubble-bg', bubbleBgMatch ? bubbleBgMatch[1] : 'var(--wechat-nav-bg)');
            root.style.setProperty('--offline-plot-bubble-padding', bubblePaddingMatch ? bubblePaddingMatch[1] : '15px');
            root.style.setProperty('--offline-plot-bubble-radius', bubbleRadiusMatch ? bubbleRadiusMatch[1] : '12px');
            root.style.setProperty('--offline-plot-char-narration-color', plotSettings.charNarration.color);
            root.style.setProperty('--offline-plot-char-narration-style', plotSettings.charNarration.style);
            root.style.setProperty('--offline-plot-char-narration-weight', plotSettings.charNarration.weight);
            root.style.setProperty('--offline-plot-user-narration-color', plotSettings.userNarration.color);
            root.style.setProperty('--offline-plot-user-narration-style', plotSettings.userNarration.style);
            root.style.setProperty('--offline-plot-user-narration-weight', plotSettings.userNarration.weight);
            root.style.setProperty('--offline-plot-char-quote-color', plotSettings.charQuote.color);
            root.style.setProperty('--offline-plot-char-quote-style', plotSettings.charQuote.style);
            root.style.setProperty('--offline-plot-char-quote-weight', plotSettings.charQuote.weight);
            root.style.setProperty('--offline-plot-user-quote-color', plotSettings.userQuote.color);
            root.style.setProperty('--offline-plot-user-quote-style', plotSettings.userQuote.style);
            root.style.setProperty('--offline-plot-user-quote-weight', plotSettings.userQuote.weight);


            body.className = '';
            if (beautify.theme) {
                body.classList.add(`${beautify.theme}-mode`);
            }
            
            const phoneContainer = document.getElementById('phone-body');
            body.classList.remove('fullscreen-mode', 'default-display-mode', 'iphone6-mode');

            if (appData.settings.displayMode === 'fullscreen') {
                phoneContainer.classList.add('fullscreen');
                body.classList.add('fullscreen-mode');
            } else {
                phoneContainer.classList.remove('fullscreen');
                if (appData.settings.displayMode === 'default') {
                    body.classList.add('default-display-mode');
                } else if (appData.settings.displayMode === 'iphone6') {
                    body.classList.add('iphone6-mode');
                }
            }

            body.classList.remove('notch-mode', 'island-mode', 'island-v2-mode', 'evol-island-mode', 'ins-island-mode'); // ★★★ 优化
            if (beautify.statusBarDisplay === 'notch') {
                body.classList.add('notch-mode');
            } else if (beautify.statusBarDisplay === 'island') {
                body.classList.add('island-mode');
            } else if (beautify.statusBarDisplay === 'island-v2') {
                body.classList.add('island-v2-mode');
            } else if (beautify.statusBarDisplay === 'evol-island') {
                body.classList.add('evol-island-mode');
            } else if (beautify.statusBarDisplay === 'ins-island') { // ★★★ 新增
                body.classList.add('ins-island-mode');
            }
            root.style.setProperty('--global-font-color', beautify.globalFontColor);

            const frameStyles = {
                'white': { color: '#E5E5E5', width: '10px', shadow: '0 10px 40px rgba(0,0,0,0.2)', highlight: 'transparent', backdrop: 'none' },
                'black': { color: '#111', width: '10px', shadow: '0 15px 50px rgba(0,0,0,0.3)', highlight: 'transparent', backdrop: 'none' },
                'simple-white': { color: '#FFF', width: '10px', shadow: '0 10px 40px rgba(0,0,0,0.2)', highlight: '#111', backdrop: 'none' },
                'pink': { color: '#FFC0CB', width: '10px', shadow: '0 10px 40px rgba(255,192,203,0.3)', highlight: 'transparent', backdrop: 'none' },
                'aqua-blue': { color: '#00FFFF', width: '10px', shadow: '0 10px 40px rgba(0, 255, 255, 0.3)', highlight: 'transparent', backdrop: 'none' },
                'semi-transparent': { color: 'rgba(255, 255, 255, 0.1)', width: '10px', shadow: '0 10px 40px rgba(0,0,0,0.2)', highlight: 'rgba(255, 255, 255, 0.2)', backdrop: 'blur(10px)' },
                'transparent': { color: 'transparent', width: '0px', shadow: 'none', highlight: 'transparent', backdrop: 'none' },
                'stereo': { color: '#111', width: '10px', shadow: '0 25px 60px rgba(0,0,0,0.5), inset 0 0 15px rgba(255,255,255,0.05)', highlight: '#fff', backdrop: 'none' },
                'evol': { color: '#fff', width: '1px', shadow: '0 0 0 1px #FFD1DC, 0 0 0 2px #000', highlight: 'transparent', backdrop: 'none' },
                'ios-style': { color: 'transparent', width: '0px', shadow: 'none', highlight: 'transparent', backdrop: 'none' },
                'mint-green': { color: 'transparent', width: '0px', shadow: 'none', highlight: 'transparent', backdrop: 'none' }
            };
            body.classList.remove('ios-style-frame-mode', 'mint-green-frame-mode');
            if (beautify.phoneFrame === 'ios-style') {
                body.classList.add('ios-style-frame-mode');
            } else if (beautify.phoneFrame === 'mint-green') {
                body.classList.add('mint-green-frame-mode');
            }
            const style = frameStyles[beautify.phoneFrame] || frameStyles.black;
            root.style.setProperty('--phone-border-color', style.color);
            root.style.setProperty('--phone-border-width', style.width);
            root.style.setProperty('--phone-shadow', style.shadow);
            root.style.setProperty('--phone-edge-highlight', style.highlight);
            root.style.setProperty('--phone-backdrop-filter', style.backdrop);

            const defaultFontStyle = document.getElementById('default-font-style');
            if (beautify.fontUrl || beautify.fontFile) {
                if (defaultFontStyle) defaultFontStyle.innerHTML = '';
                let fontSrc = beautify.fontFile ? `url(${beautify.fontFile})` : `url(${beautify.fontUrl})`;
                dynamicFontStyle.innerHTML = `@font-face { font-family: 'UserCustomFont'; src: ${fontSrc}; }`;
            }
            root.style.setProperty('--font-size-base', `${beautify.fontSize}px`);
            root.style.setProperty('--global-font-weight', beautify.globalFontWeight);
            root.style.setProperty('--global-font-style', beautify.globalFontStyle);


            root.style.setProperty('--avatar-shape', beautify.avatarShape === 'circle' ? '50%' : '6px');
            root.style.setProperty('--user-avatar-frame', beautify.userAvatarFrame ? `url(${beautify.userAvatarFrame})` : 'none');
            root.style.setProperty('--char-avatar-frame', beautify.charAvatarFrame ? `url(${beautify.charAvatarFrame})` : 'none');
            
            // ★★★ 优化：气泡样式应用逻辑 ★★★
            bubbleStyle.innerHTML = beautify.bubbleCss || getBubbleStyleCss(beautify.activeBubbleStyle || 'wechat');

            redPacketBubbleStyle.innerHTML = beautify.redPacketBubbleCss || '';
            transferBubbleStyle.innerHTML = beautify.transferBubbleCss || '';
            
            playerCssStyle.innerHTML = appData.music.playerCss || '';
            root.style.setProperty('--player-image', `url(${appData.music.playerImage})`);
            root.style.setProperty('--player-background', `url(${appData.music.playerBackground})`);
            
            document.getElementById('send-sound-player').src = appData.settings.notifications.send;
            document.getElementById('receive-sound-player').src = appData.settings.notifications.receive;
            document.getElementById('ringtone-player').src = appData.settings.notifications.ringtone;

            const batterySettings = beautify.batteryIcon;
            root.style.setProperty('--battery-icon-image', batterySettings.iconUrl ? `url(${batterySettings.iconUrl})` : 'none');
            document.getElementById('default-battery-icon').style.display = batterySettings.iconUrl ? 'none' : 'flex';
            document.getElementById('custom-battery-icon').style.display = batterySettings.iconUrl ? 'block' : 'none';
            root.style.setProperty('--battery-percent-display-outside', batterySettings.displayMode === 'outside' ? 'block' : 'none');
            root.style.setProperty('--battery-percent-display-inside', batterySettings.displayMode === 'inside' ? 'block' : 'none');
            if (batterySettings.displayMode === 'none') {
                root.style.setProperty('--battery-percent-display-outside', 'none');
                root.style.setProperty('--battery-percent-display-inside', 'none');
            }
            root.style.setProperty('--battery-percent-color',batterySettings.percentColor);

            const uiIcons = appData.settings.beautify.uiIcons;
            for (const [key, url] of Object.entries(uiIcons)) {
                const formattedKey = key.replace(/([A-Z])/g, '-$1').toLowerCase();
                root.style.setProperty(`--ui-icon-${formattedKey}`, `url(${url})`);
            }
        }

        function getBubbleStyleCss(styleKey) {
            switch (styleKey) {
                case 'ins-simple':
                    return `
                        .message-row { margin-bottom: 15px; }
                        .message-bubble.text-bubble {
                            padding: 12px 16px;
                            border-radius: 18px;
                            background-color: #EFEFEF;
                            color: #000;
                        }
                        .message-row.sent .message-bubble.text-bubble,
                        .message-row.received .message-bubble.text-bubble {
                            background-color: #EFEFEF;
                        }
                        .message-bubble.text-bubble::after { display: none; }
                    `;
                case 'simple-elegant':
                    return `
                        .message-bubble.text-bubble { border-radius: 18px; }
                        .message-row.received .message-bubble.text-bubble {
                            background: linear-gradient(135deg, #ffffff 0%, #b3e0ff 100%);
                            color: #006400;
                            border-bottom-left-radius: 4px;
                            border: 1px solid rgba(179,224,255,0.5);
                            animation: leftGlow 3s infinite alternate;
                        }
                        @keyframes leftGlow { 0% { box-shadow: 0 0 5px rgba(102,204,255,0.5); } 100% { box-shadow: 0 0 15px rgba(102,204,255,0.8); } }
                        .message-row.sent .message-bubble.text-bubble {
                            background: linear-gradient(135deg, #ffffff 0%, #ffb3d9 100%);
                            color: #ff66b3;
                            border-bottom-right-radius: 4px;
                            border: 1px solid rgba(255,179,217,0.5);
                            animation: rightGlow 3s infinite alternate;
                        }
                        @keyframes rightGlow { 0% { box-shadow: 0 0 5px rgba(204,153,255,0.5); } 100% { box-shadow: 0 0 15px rgba(204,153,255,0.8); } }
                        .message-bubble.text-bubble::after { display: none; }
                    `;
                case 'glass':
                    return `
                        .message-bubble.text-bubble {
                            background: rgba(255, 255, 255, 0.25);
                            backdrop-filter: blur(10px);
                            -webkit-backdrop-filter: blur(10px);
                            border-radius: 20px;
                            border: 1px solid rgba(255, 255, 255, 0.18);
                            color: var(--global-font-color);
                        }
                        .message-row.sent .message-bubble.text-bubble { background: rgba(0, 123, 255, 0.3); }
                        .message-bubble.text-bubble::after { display: none; }
                    `;
                case 'pink-white':
                    return `
                        .message-bubble.text-bubble { padding: 4px 6px; border-radius: 12px; }
                        .message-row.sent .message-bubble.text-bubble { background: #ffd6e7; color: #000; }
                        .message-row.received .message-bubble.text-bubble { background: #ffd6e7; color: #000; }
                        .message-row.sent .message-bubble.text-bubble::after { content: ""; position: absolute; right: -6px; top: 8px; width: 8px; height: 12px; background: #ffd6e7; clip-path: polygon(0 0, 100% 50%, 0 100%); }
                        .message-row.received .message-bubble.text-bubble::after { content: ""; position: absolute; left: -6px; top: 8px; width: 8px; height: 12px; background: #ffd6e7; clip-path: polygon(100% 0, 0 50%, 100% 100%); }
                    `;
                case 'qq-dark':
                    return `
                        .message-bubble.text-bubble {
                            padding: 10px 14px; margin: 6px 0; color: #ffffff; border: none; 
                            background-color: #000000;
                            box-shadow: inset 0 1px 1px rgba(255,255,255,0.2), 0 1px 2px rgba(0,0,0,0.5);
                        }
                        .message-row.sent .message-bubble.text-bubble { border-radius: 18px 18px 4px 18px; }
                        .message-row.received .message-bubble.text-bubble { border-radius: 18px 18px 18px 4px; }
                        .message-bubble.text-bubble::after { display: none; }
                    `;
                case 'wechat':
                default:
                    return `
                        .message-row.sent .message-bubble.text-bubble { background: #96d35f; color: #000; }
                        .message-row.received .message-bubble.text-bubble { background: #ffffff; color: #000; }
                        .message-row.sent .message-bubble.text-bubble::after { content: ""; position: absolute; right: -6px; top: 12px; width: 8px; height: 12px; background: #96d35f; clip-path: polygon(0 0, 100% 50%, 0 100%); }
                        .message-row.received .message-bubble.text-bubble::after { content: ""; position: absolute; left: -6px; top: 12px; width: 8px; height: 12px; background: #ffffff; clip-path: polygon(100% 0, 0 50%, 100% 100%); }
                    `;
            }
        }

        function showMessageContextMenu(event, messageId, chatId, chatType, source) {
            event.preventDefault();
            const menu = document.getElementById('message-context-menu');
            let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
            const conversation = chat.conversation;
            const message = conversation.find(m => m.id == messageId);
            if (!message || message.type === 'typing') return;

            let itemsHtml = `<div class="context-menu-item" onclick="handleMessageAction('edit', ${messageId}, '${chatId}', '${chatType}', '${source}')">编辑</div>`;
            itemsHtml += `<div class="context-menu-item" onclick="handleMessageAction('quote', ${messageId}, '${chatId}', '${chatType}', '${source}')">引用</div>`;
            
            const isOfflineAndText = appData.settings.chatMode === 'offline' && message.type === 'text';
            if ((message.type === 'text' || message.type === 'voice') && !isOfflineAndText) {
                const languages = {de:'德语',en:'英语',fr:'法语',ru:'俄语',pt:'葡萄牙语',yue:'粤语',ja:'日语',ko:'韩语',th:'泰语',it:'意大利语',fa:'波斯语',vi:'越南语', 'zh-CN': '简体中文', 'zh-TW': '繁体中文'};
                let langSubmenu = '';
                for (const [code, name] of Object.entries(languages)) {
                    langSubmenu += `<div class="context-menu-item" onclick="handleMessageAction('translate', ${messageId}, '${chatId}', '${chatType}', '${source}', { lang: '${code}', langName: '${name}' })">${name}</div>`;
                }
                itemsHtml += `<div class="context-menu-item">翻译 <div class="context-submenu">${langSubmenu}</div></div>`;
            }
            
            // ★★★ 优化：线下剧情模式的翻译 ★★★
            if (isOfflineAndText) {
                itemsHtml += `<div class="context-menu-item" onclick="handleMessageAction('translate', ${messageId}, '${chatId}', '${chatType}', '${source}', { lang: 'zh-CN', langName: '中文' })">翻译</div>`;
            }

            if (message.type === 'voice') itemsHtml += `<div class="context-menu-item" onclick="handleMessageAction('voiceToText', ${messageId}, '${chatId}', '${chatType}', '${source}')">转文字</div>`;
            itemsHtml += `<div class="context-menu-item" onclick="handleMessageAction('recall', ${messageId}, '${chatId}', '${chatType}', '${source}')">撤回</div>`;
            itemsHtml += `<div class="context-menu-item" onclick="handleMessageAction('delete', ${messageId}, '${chatId}', '${chatType}', '${source}')">删除</div>`;
            itemsHtml += `<div class="context-menu-item" onclick="handleMessageAction('forward', ${messageId}, '${chatId}', '${chatType}', '${source}')">转发</div>`;
            itemsHtml += `<div class="context-menu-item" onclick="startMultiSelectMode(${messageId}, '${source}')">多选</div>`;
            
            menu.innerHTML = itemsHtml;
            menu.style.display = 'block';
            
            const menuRect = menu.getBoundingClientRect();
            const bodyRect = document.body.getBoundingClientRect();
            let left = event.clientX;
            if (left + menuRect.width > bodyRect.width) left = event.clientX - menuRect.width;
            let top = event.clientY;
            if (top + menuRect.height > bodyRect.height) top = event.clientY - menuRect.height;
            
            menu.style.left = `${left}px`;
            menu.style.top = `${top}px`;

            const closeMenu = () => {
                menu.style.display = 'none';
                document.removeEventListener('click', closeMenu);
            };
            setTimeout(() => document.addEventListener('click', closeMenu), 0);
        }

        async function handleMessageAction(action, messageId, chatId, chatType, source, options = {}) {
            let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
            const conversation = chat.conversation;
            const messageIndex = conversation.findIndex(m => m.id == messageId);
            if (messageIndex === -1) return;
            const message = conversation[messageIndex];

            switch(action) {
                case 'edit':
                    const newContent = prompt('编辑消息内容:', message.content.content);
                    if (newContent !== null) message.content.content = newContent;
                    break;
                case 'quote':
                    const inputId = 'chat-input';
                    const input = document.getElementById(inputId);
                    input.focus();
                    input.dataset.quotedMessageId = messageId;
                    input.placeholder = '以引用的形式回复...';
                    break;
                case 'voiceToText':
                    if (message.transcribedText) delete message.transcribedText;
                    else message.transcribedText = `[转文字] ${message.content.text}`;
                    break;
                case 'translate':
                    if (message.translatedText) {
                        delete message.translatedText;
                    } else {
                        const originalText = message.type === 'text' ? message.content.content : message.content.text;
                        try {
                            const translated = await getTranslationFromApi(originalText, options.lang);
                            message.translatedText = translated;
                        } catch (e) {
                            showToast(`翻译失败: ${e.message}`, 'error');
                        }
                    }
                    break;
                case 'recall':
                    if (Date.now() - message.timestamp > 2 * 60 * 1000) {
                        showToast('超过2分钟的消息无法撤回', 'error');
                    } else {
                        message.isRecalled = true;
                    }
                    break;
                case 'delete':
                    conversation.splice(messageIndex, 1);
                    break;
                case 'forward': showForwardMessageModal([message.id], chatId, chatType, source); break;
            }
            saveData();
            renderMessages(chatId, chatType, source);
        }

        async function getTranslationFromApi(text, targetLang) {
            const { key, model } = appData.settings.api;
            if (!key || !model) {
                throw new Error("API未配置，无法翻译。");
            }
            const prompt = `Translate the following text to ${targetLang}. Only output the translated text, without any other words or explanations.\n\nText: "${text}"`;
            const translation = await callApi([{ role: 'user', content: prompt }]);
            return translation;
        }

        function showForwardMessageModal(messageIds, currentChatId, currentChatType, source) {
            const modalId = 'forward-message-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">转发给...</div>
                    <div class="list-view" style="max-height: 300px; overflow-y: auto; background: transparent;">
                        ${appData.contacts.map(c => `<div class="list-item" onclick="confirmForward('${c.id}', 'individual', [${messageIds}], '${currentChatId}', '${currentChatType}', '${source}')"><img src="${c.avatar}" class="avatar"><div class="details"><span class="name">${c.remark || c.name}</span></div></div>`).join('')}
                        ${appData.groups.map(g => `<div class="list-item" onclick="confirmForward('${g.id}', 'group', [${messageIds}], '${currentChatId}', '${currentChatType}', '${source}')"><img src="${g.avatar || 'https://img.js.design/assets/img/65a881fa383e6a42242a3f33.jpg'}" class="avatar"><div class="details"><span class="name">${g.name}</span></div></div>`).join('')}
                    </div>
                </div>
            `;
            showModal(modalId, html);
        }

        function confirmForward(targetChatId, targetChatType, messageIds, currentChatId, currentChatType, source) {
            let currentChat = currentChatType === 'group' ? appData.groups.find(g => g.id == currentChatId) : appData.contacts.find(c => c.id == currentChatId);
            const conversation = currentChat.conversation;
            const messagesToForward = conversation.filter(m => messageIds.includes(m.id)).slice(0, 100);

            if (messagesToForward.length === 0) { showToast('没有可转发的消息。', 'error'); return; }

            let targetChat = targetChatType === 'group' ? appData.groups.find(g => g.id == targetChatId) : appData.contacts.find(c => c.id == targetChatId);
            if (!targetChat) return;

            const forwardedMsg = {
                id: Date.now(), sender: appData.user.id, type: 'forward',
                content: { 
                    messages: messagesToForward.map(msg => ({ ...msg })),
                    originalChatId: currentChatId,
                    originalChatType: currentChatType
                },
                timestamp: Date.now()
            };
            
            if (!targetChat.conversation) targetChat.conversation = [];
            targetChat.conversation.push(forwardedMsg);

            saveData(true);
            closeModal('forward-message-modal');
        }
        
        function showForwardedContentModal(event, messageId, chatId, chatType, source) {
            event.stopPropagation();
            
            const messageContent = forwardedMessageCache[messageId];
            if (!messageContent) {
                const chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
                const message = chat?.conversation.find(m => m.id == messageId);
                if (message && message.type === 'forward') {
                    forwardedMessageCache[messageId] = message.content;
                } else {
                    showToast('无法加载聊天记录内容。', 'error');
                    return;
                }
            }

            const modalId = 'view-forwarded-messages-modal';
            
            const messagesHtml = forwardedMessageCache[messageId].messages.map(msg => {
                const isSent = msg.sender === appData.user.id;
                let sender;
                if (isSent) {
                    sender = appData.user;
                } else {
                    sender = appData.contacts.find(c => c.id == msg.sender) || appData.groups.find(g => g.id == msg.sender)?.members.find(m => m.id == msg.sender) || {name: '未知', nickname: '未知', avatar: 'https://img.js.design/assets/img/65a881fa383e6a42242a3f33.jpg'};
                }
                
                const bubbleHtml = isSent ? generateUserBubbleHtml(msg, chatId, chatType, source) : generateCharBubbleHtml(msg, chatId, chatType, source);
                return `
                    <div class="message-row ${isSent ? 'sent' : 'received'}">
                        <div class="message-body">
                            <div class="message-avatar-wrapper"><img src="${sender.avatar}" class="message-avatar"></div>
                            <div class="message-content-wrapper">${bubbleHtml}</div>
                        </div>
                    </div>
                `;
            }).join('');

            const modalHtml = `
                <div class="modal-content" style="padding: 0; width: 90%; max-width: 340px; height: 80%; display: flex; flex-direction: column;" onclick="event.stopPropagation();">
                    <div class="wechat-header" style="flex-shrink: 0;">
                        <span class="header-title">聊天记录</span>
                        <div class="header-right" style="font-size: 16px;" onclick="closeModal('${modalId}')">关闭</div>
                    </div>
                    <div class="content-area" style="padding: 10px;">${messagesHtml}</div>
                </div>
            `;
            showModal(modalId, modalHtml);
            document.getElementById(modalId).onclick = () => closeModal(modalId);
        }

        // --- Moments Feature ---
        function renderMomentsPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header" style="background: transparent; border: none; position: absolute; top: 30px; left: 0; right: 0; z-index: 5;">
                    <div class="header-left header-back-btn" onclick="goBack()" style="color: white;"><div class="ui-icon back"></div></div>
                    <div class="header-right" onclick="showPage('create-moment-page', renderCreateMomentPage)" style="color: white;"><i class="fas fa-camera"></i></div>
                </div>
                <div class="content-area">
                                    <div class="moments-header-bg" id="moments-bg" style="background-image: url('${appData.user.moments_bg}')">
                        <div class="moments-user-info">
                            <span class="name">${appData.user.nickname}</span>
                            <img src="${appData.user.avatar}" class="avatar">
                        </div>
                        <div class="moments-signature">${appData.user.signature}</div>
                    </div>
                    <div id="moments-feed"></div>
                </div>
            `;
            document.getElementById('moments-bg').onclick = () => document.getElementById('moments-bg-input').click();
            container.insertAdjacentHTML('beforeend', '<input type="file" id="moments-bg-input" class="file-input" accept="image/*">');
            document.getElementById('moments-bg-input').onchange = e => {
                handleImageUpload(e.target.files[0], dataUrl => {
                    appData.user.moments_bg = dataUrl;
                    saveData();
                    renderMomentsPage(document.getElementById('moments-page'));
                });
            };
            renderMomentsFeed();
        }

        function renderMomentsFeed() {
            const feedContainer = document.getElementById('moments-feed');
            if (!feedContainer) return;
            let html = '';
            const sortedMoments = [...appData.moments].sort((a, b) => b.timestamp - a.timestamp);

            sortedMoments.forEach(post => {
                const author = post.authorId === appData.user.id ? appData.user : appData.contacts.find(c => c.id == post.authorId);
                if (!author) return;

                if (post.visibility === 'private' && post.authorId !== appData.user.id) return;
                if (post.visibility === 'selected' && post.authorId !== appData.user.id && !post.visibleTo.includes(appData.user.id)) return;

                let mediaHtml = '';
                if (post.media && post.media.length > 0) {
                    mediaHtml = '<div class="post-media">';
                    post.media.forEach(m => {
                        if (m.type.startsWith('image')) {
                            mediaHtml += `<img src="${m.url}" alt="moment image">`;
                        } else if (m.type.startsWith('video')) {
                            mediaHtml += `<video src="${m.url}" controls></video>`;
                        } else if (m.type.startsWith('audio')) {
                            mediaHtml += `<audio src="${m.url}" controls></audio>`;
                        } else {
                            mediaHtml += `<div class="file-display"><i class="fas fa-file-alt"></i><span>${m.name || '文件'}</span></div>`;
                        }
                    });
                    mediaHtml += '</div>';
                }
                
                let postText = post.text;
                if (post.mentionedUsers && post.mentionedUsers.length > 0) {
                    post.mentionedUsers.forEach(userId => {
                        const user = appData.contacts.find(c => c.id == userId);
                        if (user) {
                            const name = user.remark || user.name;
                            postText = postText.replace(`@${name}`, `<span style="color: var(--wechat-blue);">@${name}</span>`);
                        }
                    });
                }

                const likesHtml = post.likes.length > 0 ? `
                    <div class="post-likes">
                        <i class="fas fa-heart"></i>
                        ${post.likes.map(likeId => {
                            const liker = likeId === appData.user.id ? appData.user : appData.contacts.find(c => c.id == likeId);
                            return liker ? (liker.remark || liker.name || liker.nickname) : '';
                        }).filter(Boolean).join(', ')}
                    </div>` : '';

                const commentsHtml = post.comments.length > 0 ? `
                    <div class="post-comments">
                        ${post.comments.map((comment, index) => {
                            const commenter = comment.authorId === appData.user.id ? appData.user : appData.contacts.find(c => c.id == comment.authorId);
                            if (!commenter) return '';
                            return `<div class="moment-comment" ondblclick="deleteMomentComment(${post.id}, ${index})" onclick="showMomentCommentInput(${post.id}, '${commenter.name || commenter.nickname}')"><span class="comment-author">${commenter.remark || commenter.name || commenter.nickname}:</span> ${comment.text}</div>`;
                        }).join('')}
                    </div>` : '';

                html += `
                    <div class="moment-post" data-post-id="${post.id}" ondblclick="deleteMoment(${post.id})">
                        <img src="${author.avatar}" class="avatar">
                        <div class="post-content">
                            <div class="post-author">${author.remark || author.name || author.nickname}</div>
                            <div class="post-text">${postText}</div>
                            ${mediaHtml}
                            <div class="post-meta">
                                <span class="post-time">${new Date(post.timestamp).toLocaleString()}</span>
                                <span class="post-actions">
                                    <i class="fas fa-thumbs-up" onclick="event.stopPropagation(); toggleMomentLike(${post.id}, '${appData.user.id}')"></i>
                                    <i class="fas fa-comment-dots" onclick="event.stopPropagation(); showMomentCommentInput(${post.id})"></i>
                                </span>
                            </div>
                            <div class="post-interactions">${likesHtml}${commentsHtml}</div>
                            <div id="comment-input-${post.id}" style="display:none; margin-top: 10px;">
                                <input type="text" placeholder="发表评论..." style="width: calc(100% - 60px); padding: 8px; border-radius: 4px; border: 1px solid #eee;">
                                <button onclick="addMomentComment(${post.id})" style="padding: 8px 12px; background: var(--wechat-green); color: white; border: none; border-radius: 4px;">发送</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            feedContainer.innerHTML = html;
        }
        
        function deleteMoment(postId) {
            if (confirm('确定要删除这条动态吗？')) {
                appData.moments = appData.moments.filter(p => p.id !== postId);
                saveData();
                renderMomentsFeed();
            }
        }

        function deleteMomentComment(postId, commentIndex) {
            if (confirm('确定要删除这条评论吗？')) {
                const post = appData.moments.find(p => p.id === postId);
                if (post) {
                    post.comments.splice(commentIndex, 1);
                    saveData();
                    renderMomentsFeed();
                }
            }
        }

        function showMomentCommentInput(postId, replyToName = null) {
            event.stopPropagation();
            const inputDiv = document.getElementById(`comment-input-${postId}`);
            if (inputDiv) {
                const input = inputDiv.querySelector('input');
                inputDiv.style.display = 'block';
                input.placeholder = replyToName ? `回复 ${replyToName}:` : '发表评论...';
                input.focus();
            }
        }

        function addMomentComment(postId) {
            const input = document.querySelector(`#comment-input-${postId} input`);
            const commentText = input.value.trim();
            if (!commentText) return;

            const post = appData.moments.find(p => p.id === postId);
            if (post) {
                post.comments.push({ authorId: appData.user.id, text: commentText, timestamp: Date.now() });
                saveData();
                renderMomentsFeed();
                
                const author = appData.contacts.find(c => c.id === post.authorId);
                if (author) {
                    const prompt = `'${appData.user.nickname}'在你的朋友圈下评论说：“${commentText}”。请你根据自己的角色设定进行回复，务必完全贴合人设，不要人机味不要太死板，话题务必要围着该动态和评论回复user，而非自顾自的自言自语，要熟知所有网络热梗语录。`;
                    getAiReply(author.id, 'wechat', prompt).then(replies => {
                        if (replies.length > 0) {
                            post.comments.push({ authorId: author.id, text: replies[0], timestamp: Date.now() });
                            saveData();
                            if (document.getElementById('moments-page').classList.contains('active')) renderMomentsFeed();
                        }
                    });
                }
            }
        }

        function toggleMomentLike(postId, userId) {
            const post = appData.moments.find(p => p.id === postId);
            if (post) {
                const index = post.likes.indexOf(userId);
                if (index > -1) post.likes.splice(index, 1);
                else post.likes.push(userId);
                saveData();
                renderMomentsFeed();
            }
        }

        function renderCreateMomentPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()">取消</div>
                    <span class="header-title">发表朋友圈</span>
                    <div class="header-right" style="font-size: 16px; color: white; background: var(--wechat-green); padding: 5px 12px; border-radius: 4px;" id="post-moment-btn">发表</div>
                </div>
                <div class="content-area">
                    <textarea id="moment-text-input" maxlength="5000" placeholder="这一刻的想法..." style="width: 100%; height: 200px; border: none; padding: 15px; box-sizing: border-box; font-size: 16px; resize: none; background: transparent; color: var(--global-font-color);"></textarea>
                    <div style="padding: 15px;">
                        <button onclick="document.getElementById('moment-media-input').click()" class="form-btn" style="margin-top: 0; margin-bottom: 10px; background: #f0f0f0; color: #333;">选择图片/视频/音频/文件</button>
                        <input type="file" id="moment-media-input" class="file-input" accept="*" multiple>
                        <div id="moment-media-preview" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
                    </div>
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="showMomentMentionModal()">
                        <div class="details"><span class="name">提醒谁看</span></div>
                        <span class="info" id="moment-mention-info"></span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showMomentVisibilityModal()">
                        <div class="details"><span class="name">谁可以看</span></div>
                        <span class="info" id="moment-visibility-info">全部可见</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                </div>
            `;

            const mediaInput = document.getElementById('moment-media-input');
            const mediaPreview = document.getElementById('moment-media-preview');
            let selectedMedia = [];
            let momentVisibility = 'public';
            let visibleToContacts = [];
            let mentionedUsers = [];

            mediaInput.onchange = (e) => {
                selectedMedia = [];
                mediaPreview.innerHTML = '';
                Array.from(e.target.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        selectedMedia.push({ type: file.type, url: event.target.result, name: file.name });
                        if (file.type.startsWith('image')) {
                            mediaPreview.innerHTML += `<img src="${event.target.result}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px;">`;
                        } else if (file.type.startsWith('video')) {
                            mediaPreview.innerHTML += `<video src="${event.target.result}" controls style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px;"></video>`;
                        } else if (file.type.startsWith('audio')) {
                            mediaPreview.innerHTML += `<audio src="${event.target.result}" controls style="width: 100%;"></audio>`;
                        } else {
                            mediaPreview.innerHTML += `<div class="file-display" style="width: 80px; height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #eee; border-radius: 4px;"><i class="fas fa-file-alt"></i><span style="font-size: 10px; word-break: break-all;">${file.name}</span></div>`;
                        }
                    };
                    reader.readAsDataURL(file);
                });
            };

            window.showMomentMentionModal = () => {
                const modalId = 'moment-mention-modal';
                const contactsHtml = appData.contacts.map(c => `
                    <div class="list-item">
                        <img src="${c.avatar}" class="avatar" style="width: 36px; height: 36px;">
                        <div class="details"><span class="name">${c.remark || c.name}</span></div>
                        <input type="checkbox" data-contact-id="${c.id}" ${mentionedUsers.includes(c.id) ? 'checked' : ''}>
                    </div>
                `).join('');
                const html = `
                    <div class="modal-content" style="max-width: 90%; width: 350px;">
                        <div class="modal-title">提醒谁看</div>
                        <div style="max-height: 300px; overflow-y: auto;">${contactsHtml}</div>
                        <button class="modal-btn primary" id="save-mention-btn" style="margin-top: 15px;">确定</button>
                    </div>
                `;
                showModal(modalId, html);
                document.getElementById('save-mention-btn').onclick = () => {
                    mentionedUsers = Array.from(document.querySelectorAll('#' + modalId + ' input:checked')).map(cb => parseInt(cb.dataset.contactId));
                    const mentionInfo = document.getElementById('moment-mention-info');
                    if (mentionedUsers.length > 0) {
                        mentionInfo.textContent = mentionedUsers.map(id => appData.contacts.find(c=>c.id==id).name).join(', ');
                    } else {
                        mentionInfo.textContent = '';
                    }
                    const textInput = document.getElementById('moment-text-input');
                    mentionedUsers.forEach(id => {
                        const user = appData.contacts.find(c => c.id == id);
                        if (user && !textInput.value.includes(`@${user.name}`)) {
                            textInput.value += ` @${user.name} `;
                        }
                    });
                    closeModal(modalId);
                };
            };

            window.showMomentVisibilityModal = () => {
                const modalId = 'moment-visibility-modal';
                const contactsHtml = appData.contacts.map(c => `
                    <div class="list-item">
                        <img src="${c.avatar}" class="avatar" style="width: 36px; height: 36px;">
                        <div class="details"><span class="name">${c.remark || c.name}</span></div>
                        <input type="checkbox" data-contact-id="${c.id}" ${visibleToContacts.includes(c.id) ? 'checked' : ''}>
                    </div>
                `).join('');

                const html = `
                    <div class="modal-content" style="max-width: 90%; width: 350px;">
                        <div class="modal-title">谁可以看</div>
                        <div class="list-view" style="background: transparent;">
                            <div class="list-item"><label style="width: 100%;"><input type="radio" name="visibility" value="public" ${momentVisibility === 'public' ? 'checked' : ''}> 全部可见</label></div>
                            <div class="list-item"><label style="width: 100%;"><input type="radio" name="visibility" value="private" ${momentVisibility === 'private' ? 'checked' : ''}> 仅自己可见</label></div>
                            <div class="list-item"><label style="width: 100%;"><input type="radio" name="visibility" value="selected" ${momentVisibility === 'selected' ? 'checked' : ''}> 指定人可见</label></div>
                        </div>
                        <div id="selected-contacts-list" style="max-height: 200px; overflow-y: auto; border-top: 1px solid #eee; margin-top: 10px; ${momentVisibility === 'selected' ? '' : 'display: none;'}">
                            ${contactsHtml}
                        </div>
                        <button class="modal-btn primary" id="save-visibility-btn" style="margin-top: 15px;">确定</button>
                    </div>
                `;
                showModal(modalId, html);

                document.querySelectorAll('input[name="visibility"]').forEach(radio => {
                    radio.onchange = (e) => {
                        momentVisibility = e.target.value;
                        document.getElementById('selected-contacts-list').style.display = momentVisibility === 'selected' ? 'block' : 'none';
                    };
                });

                document.getElementById('save-visibility-btn').onclick = () => {
                    if (momentVisibility === 'selected') {
                        visibleToContacts = Array.from(document.querySelectorAll('#selected-contacts-list input[type="checkbox"]:checked')).map(cb => parseInt(cb.dataset.contactId));
                        if (visibleToContacts.length === 0) { showToast('请选择至少一个可见好友', 'error'); return; }
                    }
                    document.getElementById('moment-visibility-info').textContent = {
                        'public': '全部可见', 'private': '仅自己可见',
                        'selected': `指定${visibleToContacts.length}人可见`
                    }[momentVisibility];
                    closeModal(modalId);
                };
            };

            document.getElementById('post-moment-btn').onclick = async () => {
                const text = document.getElementById('moment-text-input').value.trim();
                if (!text && selectedMedia.length === 0) { showToast('内容或媒体不能为空', 'error'); return; }

                const newPost = {
                    id: Date.now(), authorId: appData.user.id, text, media: selectedMedia,
                    timestamp: Date.now(), likes: [], comments: [],
                    visibility: momentVisibility, visibleTo: visibleToContacts,
                    mentionedUsers: mentionedUsers
                };

                appData.moments.push(newPost);
                await saveData();
                goBack();

                for (const contact of appData.contacts) {
                    if (newPost.visibility === 'private' || (newPost.visibility === 'selected' && !newPost.visibleTo.includes(contact.id))) continue;

                    const prompt = `你的朋友'${appData.user.nickname}'刚刚发了一条朋友圈，内容是：“${text}”。请你根据自己的角色设定(${contact.persona})，对此进行评论或点赞。如果评论，请直接输出评论内容，务必完全贴合人设，不要人机味不要太死板，话题务必要围着该动态和评论回复user，而非自顾自的自言自语，要熟知所有网络热梗语录；如果只想点赞，请输出“[点赞]”，并对该动态进行点赞。`;
                    const reactions = await getAiReply(contact.id, 'wechat', prompt);
                    const post = appData.moments.find(p => p.id === newPost.id);
                    if (post) {
                        for (const reaction of reactions) {
                            if (reaction.includes('[点赞]')) {
                                if (!post.likes.includes(contact.id)) post.likes.push(contact.id);
                            }
                            const commentText = reaction.replace('[点赞]', '').trim();
                            if (commentText) post.comments.push({ authorId: contact.id, text: commentText, timestamp: Date.now() });
                        }
                        await saveData();
                        if (document.getElementById('moments-page').classList.contains('active')) renderMomentsFeed();
                    }
                }
            };
        }

        async function checkAndPostCharMoments() {
            const now = Date.now();
            const intervalMap = { 'low': 3 * 24 * 3600000, 'default': 1 * 24 * 3600000, 'high': 6 * 3600000 };
            const interval = intervalMap[appData.settings.charMomentFrequency] || intervalMap.default;

            for (const contact of appData.contacts) {
                if (now - (contact.lastMomentPostTime || 0) > interval) {
                    const prompt = `请你根据自己的角色设定(${contact.persona})和心情，生成一条朋友圈动态，内容可以是碎碎念、生活感悟、分享日常、网络热梗、随笔小短文等，字数在50-200字之间。严格禁止任何形式的括号()（）、神态、动作、心理描写。语言风格必须与聊天核心准则一致，保持自然口语化。`;
                    const momentText = (await getAiReply(contact.id, 'wechat', prompt))[0];

                    if (momentText && !momentText.includes('(') && !momentText.includes(')')) {
                        const newPost = {
                            id: Date.now(), authorId: contact.id, text: momentText, media: [],
                            timestamp: Date.now(), likes: [], comments: [], visibility: 'public', visibleTo: [], mentionedUsers: []
                        };
                        appData.moments.push(newPost);
                        contact.lastMomentPostTime = now;
                        await saveData();
                        if (document.getElementById('moments-page').classList.contains('active')) renderMomentsFeed();
                    }
                }
            }
        }
        setInterval(checkAndPostCharMoments, 3600000);

        function renderChatSettingsPage(container, contactId) {
            if (!container) return;
            const contact = appData.contacts.find(c => c.id == contactId);
            if (!contact) { goBack(); return; }

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>返回</span></div>
                    <span class="header-title">聊天设置</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item">
                        <div class="details"><span class="name">置顶聊天</span></div>
                        <label class="switch"><input type="checkbox" id="pin-toggle" ${contact.isPinned ? 'checked' : ''}><span class="slider"></span></label>
                    </div>
                    <div class="list-item">
                        <div class="details"><span class="name">设为星标朋友</span></div>
                        <label class="switch"><input type="checkbox" id="star-toggle" ${contact.isStarred ? 'checked' : ''}><span class="slider"></span></label>
                    </div>
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="setContactRemark(${contactId})">
                        <div class="details"><span class="name">设置备注</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showBindSelfPersonaModal(${contactId})">
                        <div class="details"><span class="name">绑定自设</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showWorldbookMountModal(${contactId})">
                        <div class="details"><span class="name">世界书挂载</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('poke-settings-page', renderPokeSettingsPage, ${contactId})">
                        <div class="details"><span class="name">戳一戳设置</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('long-term-memory-page', renderLongTermMemoryPage, ${contactId})">
                        <div class="details"><span class="name">长期记忆</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="setChatBackground(${contactId})">
                        <div class="details"><span class="name">更换聊天背景</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="setChatAvatar(${contactId}, 'user')">
                        <div class="details"><span class="name">更换我的头像 (仅当前聊天)</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="setChatAvatar(${contactId}, 'char')">
                        <div class="details"><span class="name">更换对方头像 (仅当前聊天)</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="clearChatHistory(${contactId}, 'wechat')">
                        <div class="details"><span class="name">清空聊天记录</span></div>
                    </div>
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="blockContact(${contactId})">
                        <div class="details"><span class="name" style="color: var(--wechat-red);">拉黑</span></div>
                    </div>
                    <div class="list-item" onclick="deleteContact(${contactId})">
                        <div class="details"><span class="name" style="color: var(--wechat-red);">删除好友</span></div>
                    </div>
                </div>
            `;

            document.getElementById('pin-toggle').onchange = (e) => togglePin(contactId, e.target.checked);
            document.getElementById('star-toggle').onchange = (e) => toggleStar(contactId, e.target.checked);
        }

        function setChatBackground(contactId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = e => handleChatBgUpload(e.target.files[0], contactId);
            input.click();
        }

        function setChatAvatar(contactId, userType) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = e => {
                handleImageUpload(e.target.files[0], url => {
                    const contact = appData.contacts.find(c => c.id == contactId);
                    if (!contact.chatSettings) contact.chatSettings = {};
                    if (userType === 'user') {
                        contact.chatSettings.userAvatar = url;
                    } else {
                        contact.chatSettings.charAvatar = url;
                    }
                    saveData(true, () => {
                        if (appData.activeChat.id == contactId) {
                            renderMessages(contactId, 'individual', 'wechat');
                        }
                    });
                });
            };
            input.click();
        }

        function clearChatHistory(contactId, source) {
            if (confirm('确定要清空与该好友的聊天记录吗？此操作不可恢复。')) {
                const contact = appData.contacts.find(c => c.id == contactId);
                if (contact) {
                    contact.conversation = [];
                    saveData(true, () => {
                        if (appData.activeChat.id == contactId) {
                            renderMessages(contactId, 'individual', source);
                        }
                    });
                }
            }
        }

        function togglePin(contactId, isPinned) {
            const contact = appData.contacts.find(c => c.id == contactId);
            if (isPinned && appData.contacts.filter(c => c.isPinned).length >= 6) {
                showToast('最多只能置顶6个好友', 'error');
                document.getElementById('pin-toggle').checked = false;
                return;
            }
            contact.isPinned = isPinned;
            saveData();
        }

        function toggleStar(contactId, isStarred) {
            const contact = appData.contacts.find(c => c.id == contactId);
            contact.isStarred = isStarred;
            saveData();
        }

        function setContactRemark(contactId) {
            const contact = appData.contacts.find(c => c.id == contactId);
            const newRemark = prompt('请输入新的备注名：', contact.remark || '');
            if (newRemark !== null) {
                contact.remark = newRemark.trim();
                saveData();
                renderChatSettingsPage(document.getElementById('chat-settings-page'), contactId);
                renderConversationPage(document.getElementById('conversation-page'), contactId, 'individual');
            }
        }

        function blockContact(contactId) {
            if (confirm('拉黑后将不再收到对方的消息，确定要拉黑吗？')) {
                if (!appData.settings.blacklist.includes(contactId)) {
                    appData.settings.blacklist.push(contactId);
                    saveData(true, () => { goBack(); goBack(); });
                }
            }
        }

        function deleteContact(contactId) {
            if (confirm('删除好友将同时删除与该好友的所有聊天记录，确定要删除吗？')) {
                appData.contacts = appData.contacts.filter(c => c.id != contactId);
                saveData(true, () => { goBack(); goBack(); });
            }
        }

        function renderBlacklistPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>设置</span></div>
                    <span class="header-title">黑名单</span>
                </div>
                <div class="content-area" id="blacklist-container"></div>
            `;
            renderBlacklist();
        }

        function renderBlacklist() {
            const container = document.getElementById('blacklist-container');
            let html = '<div class="list-view">';
            if (appData.settings.blacklist.length === 0) {
                html += '<div style="text-align:center; padding: 50px; color: var(--wechat-text-secondary);">黑名单为空</div>';
            } else {
                appData.settings.blacklist.forEach(contactId => {
                    const contact = appData.contacts.find(c => c.id == contactId);
                    if (contact) {
                        html += `
                            <div class="list-item" onclick="unblockContact(${contactId})">
                                <img src="${contact.avatar}" class="avatar">
                                <div class="details"><span class="name">${contact.remark || contact.name}</span></div>
                                <div class="info" style="color: var(--wechat-blue);">移除</div>
                            </div>
                        `;
                    }
                });
            }
            html += '</div>';
            container.innerHTML = html;
        }

        function unblockContact(contactId) {
            appData.settings.blacklist = appData.settings.blacklist.filter(id => id != contactId);
            saveData();
            renderBlacklist();
        }

        function renderDataManagementPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>设置</span></div>
                    <span class="header-title">数据管理</span>
                </div>
                <div class="content-area" style="padding: 20px;">
                    <button class="form-btn" onclick="exportData()">备份全部数据到文件</button>
                    <button class="form-btn" style="background-color: var(--wechat-blue); margin-top: 10px;" onclick="exportPartialData()">备份部分数据到文件</button>
                    <button class="form-btn" style="background-color: #aaa; margin-top: 10px;" onclick="document.getElementById('import-data-input').click()">从文件恢复数据</button>
                    <input type="file" id="import-data-input" class="file-input" accept=".json">
                </div>
            `;
            document.getElementById('import-data-input').onchange = importData;
        }

        async function exportData() {
            try {
                const allData = await dataManager.exportAllData();
                if (!allData.appData) {
                    showToast('没有数据可导出', 'error');
                    return;
                }
                const dataStr = JSON.stringify(allData, null, 2);
                const dataBlob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `X-Evol_全量备份_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (e) {
                showToast(`导出失败: ${e.message}`, 'error');
            }
        }

        async function exportPartialData() {
            try {
                const partialData = {
                    contacts: appData.contacts,
                    groups: appData.groups.map(g => ({...g, conversation: []})),
                    worldbooks: appData.worldbooks,
                    user: {
                        bankCards: appData.user.bankCards,
                        wallet: appData.user.wallet
                    },
                    stickers: appData.stickers,
                    settings: {
                        beautify: appData.settings.beautify
                    }
                };
                const dataStr = JSON.stringify({ appData: partialData }, null, 2);
                const dataBlob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `X-Evol_部分备份_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (e) {
                showToast(`导出部分数据失败: ${e.message}`, 'error');
            }
        }

        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!confirm('恢复数据将覆盖当前所有内容，确定要继续吗？此操作不可逆！')) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.appData && (importedData.appData.user || importedData.appData.contacts)) {
                        await dataManager.importFromBackup(importedData);
                        showToast('数据恢复成功！应用将重新加载。');
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showToast('文件格式不正确或数据结构不完整，恢复失败。', 'error');
                    }
                } catch (err) {
                    showToast('解析文件失败：' + err.message, 'error');
                }
            };
            reader.readAsText(file);
        }
        
        function handleBubbleClick(type, msgId, chatId, chatType, source) {
            let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
            const conversation = chat.conversation;
            const message = conversation.find(m => m.id == msgId);
            if (!message) return;

            if (type === 'camera-sim') {
                showToast(`图片内容：\n\n${message.content.description}`);
            } else if (type === 'redPacket' && message.sender !== appData.user.id) {
                if (message.content.claimed.includes(appData.user.id)) { showToast('你已经领取过该红包了。'); return; }
                if (message.content.claimed.length >= message.content.count) { showToast('该红包已被领完。'); return; }

                const modalId = 'redpacket-receive-modal';
                const html = `
                    <div class="modal-content">
                        <div class="modal-title">领取红包</div>
                        <p style="text-align: center;">${message.content.remark}</p>
                        <div class="modal-actions">
                            <button class="modal-btn" id="redpacket-return-btn">退回</button>
                            <button class="modal-btn primary" id="redpacket-claim-btn">领取</button>
                        </div>
                    </div>
                `;
                showModal(modalId, html);

                document.getElementById('redpacket-claim-btn').onclick = () => {
                    const amountPerPerson = message.content.amount / message.content.count;
                    appData.user.wallet.balance += amountPerPerson;
                    const senderName = chatType === 'group' ? (chat.members.find(m => m.id === message.sender)?.name || '群成员') : (chat.remark || chat.name);
                    appData.user.wallet.transactions.push({ type: '红包', amount: amountPerPerson, details: `收到${senderName}的红包`, timestamp: Date.now() });
                    
                    message.content.claimed.push(appData.user.id);
                    
                    const systemMsg = {
                        id: Date.now(), type: 'system',
                        content: { content: `${appData.user.nickname} 领取了 ${senderName} 的红包` },
                        timestamp: Date.now()
                    };
                    conversation.push(systemMsg);
                    saveData();
                    renderMessages(chatId, chatType, source);
                    closeModal(modalId);
                };

                document.getElementById('redpacket-return-btn').onclick = () => {
                    const returnedAmount = message.content.amount / message.content.count;
                    const returnMsg = {
                        id: Date.now(), sender: appData.user.id, type: 'transfer',
                        content: { amount: returnedAmount, remark: `已退回 ${returnedAmount.toFixed(2)}`, status: 'returned' },
                        timestamp: Date.now()
                    };
                    conversation.push(returnMsg);
                    message.content.status = 'returned';
                    saveData();
                    renderMessages(chatId, chatType, source);
                    closeModal(modalId);
                };

            } else if (type === 'transfer' && message.sender !== appData.user.id && message.content.status === 'sent') {
                const modalId = 'transfer-receive-modal';
                const html = `
                    <div class="modal-content">
                        <div class="modal-title">收到转账</div>
                        <p style="text-align: center; font-size: 24px; font-weight: bold;">${formatCurrency(message.content.amount, appData.user.wallet.currency)}</p>
                        <p style="text-align: center; color: #888;">${message.content.remark}</p>
                        <div class="modal-actions">
                            <button class="modal-btn" id="transfer-return-btn">退回</button>
                            <button class="modal-btn primary" id="transfer-claim-btn">收款</button>
                        </div>
                    </div>
                `;
                showModal(modalId, html);

                document.getElementById('transfer-claim-btn').onclick = () => {
                    const amount = parseFloat(message.content.amount);
                    appData.user.wallet.balance += amount;
                    const senderName = chatType === 'group' ? (chat.members.find(m => m.id === message.sender)?.name || '群成员') : (chat.remark || chat.name);
                    appData.user.wallet.transactions.push({ type: '转账', amount: amount, details: `收到${senderName}的转账`, timestamp: Date.now() });
                    message.content.status = 'claimed';
                    
                    const systemMsg = { id: Date.now(), type: 'system', content: { content: `${appData.user.nickname} 已收款` }, timestamp: Date.now() };
                    conversation.push(systemMsg);
                    saveData();
                    renderMessages(chatId, chatType, source);
                    closeModal(modalId);
                };

                document.getElementById('transfer-return-btn').onclick = () => {
                    message.content.status = 'returned';
                    const char = appData.contacts.find(c => c.id == message.sender);
                    if (char && char.wallet) {
                        char.wallet.balance += parseFloat(message.content.amount);
                    }
                    const systemMsg = { id: Date.now(), type: 'system', content: { content: `${appData.user.nickname} 已退回转账` }, timestamp: Date.now() };
                    conversation.push(systemMsg);
                    saveData();
                    renderMessages(chatId, chatType, source);
                    closeModal(modalId);
                };
            } else if (type === 'kinshipCard' && message.sender !== appData.user.id) {
                showToast('已收到亲属卡，可在钱包中查看。');
            } else if (type === 'music') {
                playSong(message.content.id);
            } else if (type === 'netease_share') {
                showNeteaseShareModal(message.content);
            }
        }

        // ★★★ 优化：群聊创建与设置功能 ★★★
        function renderCreateGroupChatPage(container) {
            if (!container) return;
            if (appData.contacts.length < 2) {
                showToast('通讯录好友少于2人，无法创建群聊', 'error');
                goBack();
                return;
            }

            const contactsHtml = appData.contacts.map(c => `
                <div class="list-item">
                    <input type="checkbox" data-contact-id="${c.id}">
                    <img src="${c.avatar}" class="avatar">
                    <div class="details"><span class="name">${c.remark || c.name}</span></div>
                </div>
            `).join('');

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div></div>
                    <span class="header-title">选择联系人</span>
                    <div class="header-right" style="font-size: 16px;" id="next-step-group-btn">下一步</div>
                </div>
                <div class="content-area list-view contact-selection-list">${contactsHtml}</div>
            `;

            document.getElementById('next-step-group-btn').onclick = () => {
                const selectedIds = Array.from(document.querySelectorAll('#create-group-chat-page input:checked')).map(cb => parseInt(cb.dataset.contactId));
                if (selectedIds.length < 2) {
                    showToast('请至少选择2位好友', 'error');
                    return;
                }
                showCreateGroupDetailsPage(selectedIds);
            };
        }

        function showCreateGroupDetailsPage(memberIds) {
            const modalId = 'create-group-details-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">创建群聊</div>
                    <img src="https://img.js.design/assets/img/65a881fa383e6a42242a3f33.jpg" class="avatar-upload-preview" id="group-avatar-preview" onclick="document.getElementById('group-avatar-input').click()">
                    <input type="file" id="group-avatar-input" class="file-input" accept="image/*">
                    <div class="form-group">
                        <label>群聊名称</label>
                        <input type="text" id="group-name-input" class="modal-input" placeholder="请输入群聊名称">
                    </div>
                    <button class="form-btn" id="confirm-create-group-btn">创建</button>
                </div>
            `;
            showModal(modalId, html);

            document.getElementById('group-avatar-input').onchange = e => {
                handleImageUpload(e.target.files[0], dataUrl => {
                    showCropperModal(dataUrl, (croppedDataUrl) => {
                        document.getElementById('group-avatar-preview').src = croppedDataUrl;
                    }, 1); // 1:1 ratio for group avatar
                });
            };

            document.getElementById('confirm-create-group-btn').onclick = () => {
                const groupName = document.getElementById('group-name-input').value.trim();
                if (!groupName) {
                    showToast('群聊名称不能为空', 'error');
                    return;
                }
                const groupAvatar = document.getElementById('group-avatar-preview').src;
                const members = appData.contacts.filter(c => memberIds.includes(c.id));
                
                const newGroup = {
                    id: Date.now(),
                    name: groupName,
                    avatar: groupAvatar,
                    ownerId: appData.user.id,
                    adminIds: [appData.user.id],
                    members: [appData.user, ...members],
                    conversation: [],
                    isPinned: false,
                    chatMode: 'natural',
                    announcement: '',
                    mutedMembers: {},
                    groupTitles: {},
                    levelTitles: { '0-10': '萌新', '11-20': '话痨', '21-30': '吐槽役', '31-50': '大佬', '51-80': '元老', '81-100': '活化石' }
                };
                appData.groups.push(newGroup);
                saveData(true);
                closeModal(modalId);
                goBack();
            };
        }

        function renderGroupChatSettingsPage(container, groupId) {
            if (!container) return;
            const group = appData.groups.find(g => g.id == groupId);
            if (!group) { goBack(); return; }
            const isUserOwner = group.ownerId === appData.user.id;
            const isUserAdmin = group.adminIds.includes(appData.user.id);

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>返回</span></div>
                    <span class="header-title">群聊设置</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="editGroupName(${groupId})">
                        <div class="details"><span class="name">群聊名称</span></div>
                        <span class="info">${group.name}</span><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="editGroupAvatar(${groupId})">
                        <div class="details"><span class="name">群头像</span></div>
                        <img src="${group.avatar}" class="avatar" style="width: 40px; height: 40px;">
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('group-member-management-page', renderGroupMemberManagementPage, ${groupId})">
                        <div class="details"><span class="name">群成员 (${group.members.length})</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    ${isUserAdmin ? `
                    <div class="list-item" onclick="editGroupAnnouncement(${groupId})">
                        <div class="details"><span class="name">群公告</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showMuteSettingsModal(${groupId})">
                        <div class="details"><span class="name">设置禁言</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('group-title-management-page', renderGroupTitleManagementPage, ${groupId})">
                        <div class="details"><span class="name">群头衔管理</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>` : ''}
                    ${isUserOwner ? `
                    <div class="list-item" onclick="showTransferOwnershipModal(${groupId})">
                        <div class="details"><span class="name">转让群主</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>` : ''}
                    <div class="list-item" onclick="showGroupChatModeModal(${groupId})">
                        <div class="details"><span class="name">群聊模式</span></div>
                        <span class="info">${{'natural':'自然聊天', 'all':'全部角色回复'}[group.chatMode] || '指定回复'}</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-divider"></div>
                    <div class="list-item">
                        <div class="details"><span class="name">置顶聊天</span></div>
                        <label class="switch"><input type="checkbox" id="group-pin-toggle" ${group.isPinned ? 'checked' : ''}><span class="slider"></span></label>
                    </div>
                    <div class="list-divider"></div>
                    <button class="form-btn" style="background-color: #E64340; margin: 20px;" onclick="leaveGroupChat(${groupId})">退出群聊</button>
                </div>
            `;

            document.getElementById('group-pin-toggle').onchange = (e) => {
                group.isPinned = e.target.checked;
                saveData();
            };
        }

        function showMuteSettingsModal(groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            const modalId = 'mute-settings-modal';
            const membersHtml = group.members.map(member => {
                if (member.id === appData.user.id) return '';
                const isMuted = group.mutedMembers[member.id] && group.mutedMembers[member.id] > Date.now();
                const muteUntil = isMuted ? new Date(group.mutedMembers[member.id]).toLocaleString() : '未禁言';
                return `
                    <div class="list-item">
                        <img src="${member.avatar}" class="avatar">
                        <div class="details"><span class="name">${member.name}</span><p class="subtext">禁言至: ${muteUntil}</p></div>
                        <div class="member-actions">
                            ${isMuted ? `<button onclick="unmuteMember(${groupId}, '${member.id}'); closeModal('${modalId}')">解除</button>` : `<button onclick="showMuteDurationModal(${groupId}, '${member.id}'); closeModal('${modalId}')">禁言</button>`}
                        </div>
                    </div>
                `;
            }).join('');

            const html = `
                <div class="modal-content" style="max-width: 90%; width: 350px;">
                    <div class="modal-title">禁言设置</div>
                    <div class="list-view" style="max-height: 60vh; overflow-y: auto; background: transparent;">
                        <div class="list-item">
                            <div class="details"><span class="name">全体禁言</span></div>
                            <label class="switch"><input type="checkbox" id="mute-all-toggle" ${group.mutedMembers['all'] ? 'checked' : ''}><span class="slider"></span></label>
                        </div>
                        ${membersHtml}
                    </div>
                </div>
            `;
            showModal(modalId, html);

            document.getElementById('mute-all-toggle').onchange = (e) => {
                if (e.target.checked) group.mutedMembers['all'] = Date.now() + (100 * 365 * 24 * 3600000);
                else delete group.mutedMembers['all'];
                saveData();
                closeModal(modalId);
            };
        }

        function showMuteDurationModal(groupId, memberId) {
            const modalId = 'mute-duration-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">禁言时长</div>
                    <div class="modal-input-group">
                        <label>天</label><input type="number" id="mute-days" value="0" min="0">
                        <label>时</label><input type="number" id="mute-hours" value="0" min="0" max="23">
                        <label>分</label><input type="number" id="mute-minutes" value="0" min="0" max="59">
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" id="confirm-mute-btn">确认</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);
            document.getElementById('confirm-mute-btn').onclick = () => {
                const days = parseInt(document.getElementById('mute-days').value) || 0;
                const hours = parseInt(document.getElementById('mute-hours').value) || 0;
                const minutes = parseInt(document.getElementById('mute-minutes').value) || 0;
                const duration = (days * 24 * 3600 + hours * 3600 + minutes * 60) * 1000;
                if (duration <= 0) { showToast('禁言时长必须大于0', 'error'); return; }
                
                const group = appData.groups.find(g => g.id == groupId);
                group.mutedMembers[memberId] = Date.now() + duration;
                
                const member = group.members.find(m => m.id == memberId);
                const muteUntil = new Date(group.mutedMembers[memberId]);
                const systemMsg = { id: Date.now(), type: 'system', content: { content: `${member.name} 已被管理员禁言至 ${muteUntil.toLocaleString()}` }, timestamp: Date.now() };
                group.conversation.push(systemMsg);

                saveData();
                renderMessages(groupId, 'group', 'wechat');
                closeModal(modalId);
            };
        }

        function unmuteMember(groupId, memberId) {
            const group = appData.groups.find(g => g.id == groupId);
            delete group.mutedMembers[memberId];
            saveData();
        }

        function editGroupName(groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            const newName = prompt('请输入新的群聊名称：', group.name);
            if (newName && newName.trim()) {
                group.name = newName.trim();
                saveData();
                renderGroupChatSettingsPage(document.getElementById('group-chat-settings-page'), groupId);
                renderConversationPage(document.getElementById('conversation-page'), groupId, 'group');
            }
        }

        function editGroupAvatar(groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = e => {
                handleImageUpload(e.target.files[0], dataUrl => {
                    showCropperModal(dataUrl, (croppedDataUrl) => {
                        group.avatar = croppedDataUrl;
                        saveData(true);
                        renderGroupChatSettingsPage(document.getElementById('group-chat-settings-page'), groupId);
                    }, 1);
                });
            };
            input.click();
        }

        function editGroupAnnouncement(groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            const newAnnouncement = prompt('请输入群公告 (上限1000字)：', group.announcement);
            if (newAnnouncement !== null) {
                group.announcement = newAnnouncement.substring(0, 1000);
                saveData();
                const systemMsg = { id: Date.now(), type: 'system', content: { content: `群主发布了新公告: ${group.announcement}` }, timestamp: Date.now() };
                group.conversation.push(systemMsg);
                renderMessages(groupId, 'group', 'wechat');
            }
        }

        function renderGroupMemberManagementPage(container, groupId) {
            if (!container) return;
            const group = appData.groups.find(g => g.id == groupId);
            if (!group) { goBack(); return; }
            const isUserAdmin = group.adminIds.includes(appData.user.id);

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>返回</span></div>
                    <span class="header-title">群成员管理</span>
                    ${isUserAdmin ? `<div class="header-right" onclick="showAddGroupMembersModal(${groupId})"><i class="fas fa-user-plus"></i></div>` : ''}
                </div>
                <div class="content-area group-member-list list-view" id="group-members-list"></div>
            `;
            renderGroupMembersList(groupId);
        }

        function renderGroupMembersList(groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            const listContainer = document.getElementById('group-members-list');
            if (!listContainer) return;
            const isUserOwner = group.ownerId === appData.user.id;

            listContainer.innerHTML = group.members.map(member => {
                const isMemberOwner = group.ownerId == member.id;
                const isMemberAdmin = group.adminIds.includes(member.id);
                let roleText = '';
                if (isMemberOwner) roleText = '(群主)';
                else if (isMemberAdmin) roleText = '(管理员)';

                return `
                    <div class="list-item">
                        <img src="${member.avatar}" class="avatar">
                        <div class="details"><span class="name">${member.name || member.nickname} ${roleText}</span></div>
                        <div class="member-actions">
                            ${isUserOwner && !isMemberOwner ? `
                                <button onclick="toggleGroupAdmin(${groupId}, ${member.id})">${isMemberAdmin ? '取消管理员' : '设为管理员'}</button>
                                <button onclick="removeGroupMember(${groupId}, ${member.id})">移出</button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showAddGroupMembersModal(groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            const existingMemberIds = group.members.map(m =>m.id);
            const availableContacts = appData.contacts.filter(c => !existingMemberIds.includes(c.id));

            const modalId = 'add-group-members-modal';
            let html = `
                <div class="modal-content">
                    <div class="modal-title">添加群成员</div>
                    <div class="list-view contact-selection-list" id="add-members-selection">
            `;
            if (availableContacts.length === 0) {
                html += '<div style="text-align:center; padding: 20px;">暂无更多好友可添加</div>';
            } else {
                html += availableContacts.map(contact => `
                    <div class="list-item">
                        <input type="checkbox" data-member-id="${contact.id}">
                        <img src="${contact.avatar}" class="avatar">
                        <div class="details"><span class="name">${contact.name}</span></div>
                    </div>
                `).join('');
            }
            html += `</div><button class="modal-btn primary" id="confirm-add-members-btn" style="margin-top: 15px;">添加</button></div>`;
            showModal(modalId, html);

            document.getElementById('confirm-add-members-btn').onclick = () => {
                const selectedCheckboxes = document.querySelectorAll('#add-members-selection input:checked');
                const newMemberIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.memberId));
                const newMembers = appData.contacts.filter(c => newMemberIds.includes(c.id));
                group.members.push(...newMembers);
                saveData();
                renderGroupMembersList(groupId);
                closeModal(modalId);
            };
        }

        function toggleGroupAdmin(groupId, memberId) {
            const group = appData.groups.find(g => g.id == groupId);
            const member = group.members.find(m => m.id == memberId);
            if (!group || !member) return;

            const index = group.adminIds.indexOf(memberId);
            let systemMsgText = '';
            const adminName = member.name || member.nickname;

            if (index > -1) {
                // 取消管理员
                if (group.adminIds.length > 1) {
                    group.adminIds.splice(index, 1);
                    systemMsgText = `"${adminName}" 已被群主取消管理员`;
                } else {
                    showToast('至少需要一名管理员', 'error');
                    return;
                }
            } else {
                // 设为管理员
                group.adminIds.push(memberId);
                systemMsgText = `"${adminName}" 已被群主设为管理员`;
            }
            
            const systemMsg = { id: Date.now(), type: 'system', content: { content: systemMsgText }, timestamp: Date.now() };
            if (!group.conversation) group.conversation = [];
            group.conversation.push(systemMsg);

            saveData();
            renderGroupMembersList(groupId);
            if (appData.activeChat.id == groupId) {
                renderMessages(groupId, 'group', 'wechat');
            }
        }

        function removeGroupMember(groupId, memberId) {
            if (confirm('确定要将该成员移出群聊吗？')) {
                const group = appData.groups.find(g => g.id == groupId);
                const removedMember = group.members.find(m => m.id == memberId);
                const admin = group.members.find(m => m.id == appData.user.id);

                group.members = group.members.filter(m => m.id != memberId);
                group.adminIds = group.adminIds.filter(id => id != memberId);

                const systemMsg = { id: Date.now(), type: 'system', content: { content: `${removedMember.name} 已被 ${admin.name} 移出群聊` }, timestamp: Date.now() };
                group.conversation.push(systemMsg);

                saveData();
                renderGroupMembersList(groupId);
                renderMessages(groupId, 'group', 'wechat');
            }
        }

        function leaveGroupChat(groupId) {
            if (confirm('确定要退出群聊吗？')) {
                appData.groups = appData.groups.filter(g => g.id != groupId);
                saveData(true, () => { goBack(); goBack(); });
            }
        }

        // ★★★ 优化：群主转让逻辑 ★★★
        function showTransferOwnershipModal(groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            const modalId = 'transfer-ownership-modal';
            const membersHtml = group.members
                .filter(m => m.id !== appData.user.id)
                .map(member => `<div class="list-item" onclick="transferOwnership(${groupId}, ${member.id})"><img src="${member.avatar}" class="avatar"><div class="details"><span class="name">${member.name}</span></div></div>`)
                .join('');

            const html = `
                <div class="modal-content">
                    <div class="modal-title">转让群主</div>
                    <div class="list-view" style="max-height: 60vh; overflow-y: auto;">${membersHtml}</div>
                </div>
            `;
            showModal(modalId, html);
            document.getElementById(modalId).onclick = (e) => {
                if (e.target.id === modalId) {
                    closeModal(modalId);
                }
            };
        }

        function transferOwnership(groupId, newOwnerId) {
            if (!confirm('转让群主后，你将成为管理员。确定要转让吗？')) return;
            const group = appData.groups.find(g => g.id == groupId);
            const oldOwnerId = group.ownerId;
            const oldOwner = group.members.find(m => m.id === oldOwnerId) || appData.user;
            const newOwner = group.members.find(m => m.id == newOwnerId);

            group.ownerId = newOwnerId;
            // 将新群主从管理员中移除（如果存在）
            group.adminIds = group.adminIds.filter(id => id !== newOwnerId);
            // 将原群主设为管理员
            if (!group.adminIds.includes(oldOwnerId)) {
                group.adminIds.push(oldOwnerId);
            }

            const systemMsg = { id: Date.now(), type: 'system', content: { content: `"${oldOwner.name || oldOwner.nickname}" 已将群主转让给 "${newOwner.name}"` }, timestamp: Date.now() };
            group.conversation.push(systemMsg);

            saveData(true);
            closeModal('transfer-ownership-modal');
            renderGroupChatSettingsPage(document.getElementById('group-chat-settings-page'), groupId);
            renderMessages(groupId, 'group', 'wechat');
        }

        function showGroupChatModeModal(groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            const modalId = 'group-chat-mode-modal';
            const membersOptions = group.members.filter(m => m.id !== appData.user.id).map(m => `<option value="select_${m.id}">${m.name}</option>`).join('');

            const html = `
                <div class="modal-content">
                    <div class="modal-title">群聊模式</div>
                    <div class="form-group">
                        <select id="group-chat-mode-select" class="modal-input">
                            <option value="natural">自然聊天</option>
                            <option value="all">全部角色回复</option>
                            <optgroup label="指定角色回复">
                                ${membersOptions}
                            </optgroup>
                        </select>
                    </div>
                    <button class="form-btn" onclick="saveGroupChatMode(${groupId})">保存</button>
                </div>
            `;
            showModal(modalId, html);
            document.getElementById('group-chat-mode-select').value = group.chatMode;
        }

        function saveGroupChatMode(groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            group.chatMode = document.getElementById('group-chat-mode-select').value;
            saveData(true);
            closeModal('group-chat-mode-modal');
            renderGroupChatSettingsPage(document.getElementById('group-chat-settings-page'), groupId);
        }

        // --- Music App ---
        let audioPlayer = new Audio();
        audioPlayer.onended = () => playNextSong();

        function renderMusicLibraryPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div></div>
                    <span class="header-title">音乐库</span>
                    <div class="header-right" onclick="showPage('music-settings-page', renderMusicSettingsPage)"><i class="fas fa-cog"></i></div>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-view">
                        <div class="list-item" onclick="showAddMusicModal()">
                            <div class="details"><span class="name">从URL导入</span></div><i class="fas fa-plus chevron"></i>
                        </div>
                        <div class="list-item" onclick="document.getElementById('local-music-input').click()">
                            <div class="details"><span class="name">从本地导入</span></div><i class="fas fa-plus chevron"></i>
                        </div>
                        <input type="file" id="local-music-input" class="file-input" accept=".mp3,.wav,.ogg" onchange="handleLocalMusicUpload(this.files[0])">
                    </div>
                    <div class="list-divider"></div>
                    <div class="wechat-tabbar" style="height: 44px; border-top: none; border-bottom: 0.5px solid var(--wechat-border-color);">
                        <div class="tab-item active" id="music-lib-tab-all" onclick="renderMusicLists('all')"><span>全部</span></div>
                        <div class="tab-item" id="music-lib-tab-fav" onclick="renderMusicLists('favorites')"><span>收藏</span></div>
                    </div>
                    <div class="list-view" id="music-library-list"></div>
                </div>
            `;
            renderMusicLists('all');
        }

        function renderMusicLists(filter = 'all') {
            const libList = document.getElementById('music-library-list');
            const allTab = document.getElementById('music-lib-tab-all');
            const favTab = document.getElementById('music-lib-tab-fav');
            if (!libList || !allTab || !favTab) return;

            allTab.classList.remove('active');
            favTab.classList.remove('active');
            if (filter === 'all') allTab.classList.add('active');
            else favTab.classList.add('active');

            const library = filter === 'all' 
                ? appData.music.library 
                : appData.music.library.filter(song => appData.music.favorites.includes(song.id));
            
            if (library.length === 0) {
                libList.innerHTML = `<p style="text-align:center; padding: 50px; color: var(--wechat-text-secondary);">暂无歌曲</p>`;
                return;
            }

            libList.innerHTML = library.map(song => `
                <div class="list-item" onclick="playSong(${song.id})">
                    <img src="${song.cover || 'https://img.js.design/assets/img/664e0d45692271d43c087968.jpg'}" class="avatar" style="width: 48px; height: 48px;">
                    <div class="details"><span class="name">${song.title}</span><p class="subtext">${song.artist}</p></div>
                    <i class="fas fa-share-square" style="margin-right: 15px;" onclick="event.stopPropagation(); forwardMusic(${song.id})"></i>
                    <i class="fas fa-heart" style="color: ${appData.music.favorites.includes(song.id) ? 'var(--wechat-red)' : '#ccc'};" onclick="event.stopPropagation(); toggleFavorite(${song.id}, '${filter}')"></i>
                </div>
            `).join('');
        }

        // ★★★ 优化：音乐导入功能 ★★★
        function showAddMusicModal() {
            const modalId = 'add-music-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">从URL导入音乐</div>
                    <div class="modal-input-group"><label>音乐URL</label><input type="text" id="music-url-input" class="modal-input"></div>
                    <div class="modal-input-group"><label>歌名</label><input type="text" id="music-title-input" class="modal-input"></div>
                    <div class="modal-input-group"><label>艺术家</label><input type="text" id="music-artist-input" class="modal-input"></div>
                    <div class="modal-input-group">
                        <label>专辑封面</label>
                        <input type="text" id="music-cover-url-input" class="modal-input" placeholder="输入图片URL">
                        <button class="form-btn" style="margin-top: 5px; background-color: #aaa;" onclick="document.getElementById('music-cover-file-input').click()">或从本地选择</button>
                        <input type="file" id="music-cover-file-input" class="file-input" accept="image/*">
                    </div>
                    <button class="modal-btn primary" id="save-music-btn" style="margin-top: 15px;">保存</button>
                </div>
            `;
            showModal(modalId, html);

            let coverDataUrl = '';
            document.getElementById('music-cover-file-input').onchange = e => {
                handleImageUpload(e.target.files[0], dataUrl => {
                    coverDataUrl = dataUrl;
                    document.getElementById('music-cover-url-input').value = '已选择本地文件';
                });
            };

            document.getElementById('save-music-btn').onclick = () => {
                const url = document.getElementById('music-url-input').value.trim();
                const title = document.getElementById('music-title-input').value.trim();
                const artist = document.getElementById('music-artist-input').value.trim();
                const coverUrl = document.getElementById('music-cover-url-input').value.trim();
                const cover = coverDataUrl || coverUrl;

                if (!url || !title || !artist) { showToast('URL、歌名和艺术家不能为空', 'error'); return; }
                appData.music.library.push({ id: Date.now(), url, title, artist, cover, lyrics: '' });
                saveData();
                renderMusicLists('all');
                closeModal(modalId);
            };
        }

        function handleLocalMusicUpload(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const url = e.target.result;
                const title = file.name.replace(/\.(mp3|wav|ogg)$/i, '');
                appData.music.library.push({ id: Date.now(), url, title, artist: '未知艺术家', cover: '', lyrics: '' });
                saveData();
                renderMusicLists('all');
            };
            reader.readAsDataURL(file);
        }

        function forwardMusic(songId) {
            const song = appData.music.library.find(s => s.id === songId);
            if (!song) return;
            const activeChat = appData.activeChat;
            if (activeChat.id) {
                sendMessage(activeChat.id, activeChat.type, { id: song.id, title: song.title, artist: song.artist, cover: song.cover }, 'music', 'wechat');
                showToast('音乐已分享到当前聊天');
            } else {
                showToast('请先进入一个聊天', 'error');
            }
        }

        function toggleFavorite(songId, currentFilter) {
            const index = appData.music.favorites.indexOf(songId);
            if (index > -1) appData.music.favorites.splice(index, 1);
            else appData.music.favorites.push(songId);
            saveData();
            renderMusicLists(currentFilter);
        }

        function playSong(songId) {
            const song = appData.music.library.find(s => s.id === songId);
            if (!song) return;
            appData.music.currentSongId = songId;
            audioPlayer.src = song.url;
            audioPlayer.play();
            appData.music.isPlaying = true;
            saveData();
            showPage('music-player-page', renderMusicPlayerPage);
            updateAllDynamicIslands();
        }

        function playNextSong() {
            const library = appData.music.library;
            if (library.length === 0) return;
            let currentIndex = library.findIndex(s => s.id === appData.music.currentSongId);
            let nextIndex;
            if (appData.music.playMode === 'single') nextIndex = currentIndex;
            else if (appData.music.playMode === 'random') nextIndex = Math.floor(Math.random() * library.length);
            else nextIndex = (currentIndex + 1) % library.length;
            if (nextIndex >= 0 && nextIndex < library.length) {
                playSong(library[nextIndex].id);
            }
        }

        function playPreviousSong() {
            const library = appData.music.library;
            if (library.length === 0) return;
            let currentIndex = library.findIndex(s => s.id === appData.music.currentSongId);
            let prevIndex = (currentIndex - 1 + library.length) % library.length;
            if (prevIndex >= 0 && prevIndex < library.length) {
                playSong(library[prevIndex].id);
            }
        }

        function togglePlayPause() {
            if (!appData.music.currentSongId) {
                if (appData.music.library.length > 0) playSong(appData.music.library[0].id);
                return;
            }
            if (audioPlayer.paused) audioPlayer.play();
            else audioPlayer.pause();
            appData.music.isPlaying = !audioPlayer.paused;
            saveData();
            if (document.getElementById('music-player-page').classList.contains('active')) {
                renderMusicPlayerPage(document.getElementById('music-player-page'));
            }
            updateAllDynamicIslands();
            renderHomeScreenWidgets();
        }

        function renderMusicPlayerPage(container) {
            if (!container) return;
            const currentSong = appData.music.library.find(s => s.id === appData.music.currentSongId);
            if (!currentSong) {
                container.innerHTML = '<div class="wechat-header"><div class="header-left header-back-btn" onclick="goBack()"></div></div><div class="content-area" style="text-align:center; padding-top: 50%;">暂无播放歌曲</div>';
                return;
            }

            const playIcon = appData.music.isPlaying ? 'fa-pause-circle' : 'fa-play-circle';
            const playModeIcon = { 'sequence': 'fa-retweet', 'single': 'fa-redo-alt', 'random': 'fa-random' }[appData.music.playMode];

            container.innerHTML = `
                <div class="wechat-header" style="background: transparent; border: none; position: absolute; top: 30px; left: 0; right: 0; z-index: 5;">
                    <div class="header-left header-back-btn" onclick="goBack()" style="color: white;"><i class="fas fa-chevron-down"></i></div>
                </div>
                <div class="content-area">
                    <div class="music-cover ${appData.music.isPlaying ? 'playing' : ''}"></div>
                    <div class="music-info"><h3>${currentSong.title}</h3><p>${currentSong.artist}</p></div>
                    <div class="music-progress" id="music-progress-container"><div class="music-progress-bar" id="music-progress-bar"></div></div>
                    <div class="music-controls">
                        <i class="fas ${playModeIcon}" onclick="togglePlayMode()"></i>
                        <i class="fas fa-backward" onclick="playPreviousSong()"></i>
                        <i class="fas ${playIcon}" onclick="togglePlayPause()"></i>
                        <i class="fas fa-forward" onclick="playNextSong()"></i>
                        <i class="fas fa-list-ul" onclick="showPage('music-library-page', renderMusicLibraryPage)"></i>
                    </div>
                    <div style="margin-top: 20px; color: white; display: flex; flex-direction: column; gap: 10px; width: 80%;">
                        <div style="display: flex; align-items: center; gap: 10px;"><span>倍速:</span> <input type="range" style="flex: 1;" min="0.7" max="3" step="0.1" value="${audioPlayer.playbackRate}" onchange="audioPlayer.playbackRate = this.value"></div>
                        <div style="display: flex; align-items: center; gap: 10px;"><span>音调:</span> <input type="range" style="flex: 1;" min="0.7" max="2" step="0.1" value="${audioPlayer.preservesPitch ? 1 : 1}" onchange="audioPlayer.preservesPitch = false; audioPlayer.playbackRate = this.value"></div>
                    </div>
                </div>
            `;
            applyBeautifySettings();

            audioPlayer.ontimeupdate = () => {
                const progressBar = document.getElementById('music-progress-bar');
                if (progressBar && audioPlayer.duration) {
                    progressBar.style.width = `${(audioPlayer.currentTime / audioPlayer.duration) * 100}%`;
                }
                updateAllDynamicIslands(); // Update time display
            };
            
            const progressContainer = document.getElementById('music-progress-container');
            if(progressContainer) {
                progressContainer.onclick = (e) => {
                    const rect = progressContainer.getBoundingClientRect();
                    const percent = (e.clientX - rect.left) / rect.width;
                    audioPlayer.currentTime = audioPlayer.duration * percent;
                };
            }
        }

        function togglePlayMode() {
            const modes= ['sequence', 'single', 'random'];
            let currentIndex = modes.indexOf(appData.music.playMode);
            appData.music.playMode = modes[(currentIndex + 1) % modes.length];
            saveData();
            if (document.getElementById('music-player-page').classList.contains('active')) {
                renderMusicPlayerPage(document.getElementById('music-player-page'));
            }
        }

        function renderMusicSettingsPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>返回</span></div>
                    <span class="header-title">音乐设置</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="showPage('player-beautify-page', renderPlayerBeautifyPage)">
                        <div class="details"><span class="name">播放器美化</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('player-css-settings-page', renderPlayerCssSettingsPage)">
                        <div class="details"><span class="name">播放器CSS美化</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                </div>
            `;
        }

        function renderPlayerBeautifyPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>返回</span></div>
                    <span class="header-title">播放器美化</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>更换播放器图片</label>
                        <img src="${appData.music.playerImage}" class="avatar-upload-preview" id="player-image-preview" onclick="document.getElementById('player-image-input').click()">
                        <input type="file" id="player-image-input" class="file-input" accept="image/*">
                    </div>
                    <div class="form-group">
                        <label>更换播放器背景图片</label>
                        <img src="${appData.music.playerBackground}" class="avatar-upload-preview" id="player-bg-preview" onclick="document.getElementById('player-bg-input').click()">
                        <input type="file" id="player-bg-input" class="file-input" accept="image/*">
                    </div>
                </div>
            `;
            document.getElementById('player-image-input').onchange = e => handleImageUpload(e.target.files[0], url => {
                appData.music.playerImage = url;
                saveData();
                applyBeautifySettings();
                document.getElementById('player-image-preview').src = url;
            });
            document.getElementById('player-bg-input').onchange = e => handleImageUpload(e.target.files[0], url => {
                appData.music.playerBackground = url;
                saveData();
                applyBeautifySettings();
                document.getElementById('player-bg-preview').src = url;
            });
        }

        function renderPlayerCssSettingsPage(container) {
            if (!container) return;
            const examples = {
                '拟态白': `/* 拟态白 */\n.music-cover { border-radius: 50%; box-shadow: 20px 20px 60px #bebebe, -20px -20px 60px #ffffff; border: none; }\n.music-info h3 { color: #555; }\n.music-info p { color: #999; }\n#music-player-page .content-area { background: #e0e5ec; }\n#music-player-page .content-area::before { display: none; }\n.music-controls i { color: #555; }`,
                '毛玻璃质感': `/* 毛玻璃质感 */\n.music-cover { border-radius: 15px; border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); }\n#music-player-page .content-area::before { background: rgba(0,0,0,0.3); backdrop-filter: blur(20px); }\n.music-info h3, .music-info p, .music-controls i { color: white; text-shadow: 0 1px 3px #000; }`,
                '赛博朋克': `/* 赛博朋克 */\n.music-cover { border-radius: 8px; border: 2px solid #00f6ff; box-shadow: 0 0 15px #00f6ff, 0 0 30px #00f6ff; animation-name: none; }\n.music-info h3 { color: #f0f; text-shadow: 0 0 5px #f0f; }\n.music-progress-bar { background: linear-gradient(90deg, #f0f, #00f6ff); }`
            };
            
            const updatePreview = () => {
                const css = document.getElementById('player-css-input').value;
                const previewFrame = document.getElementById('player-css-preview-frame');
                const previewDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
                previewDoc.body.innerHTML = `
                    <style>
                        body { margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; height: 100%; box-sizing: border-box; background: #333; }
                        #music-player-page { position: relative; width: 100%; height: 100%; }
                        #music-player-page .content-area { display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: #222; color: white; padding: 20px; text-align: center; background-image: var(--player-background); background-size: cover; background-position: center; position: relative; height: 100%; }
                        #music-player-page .content-area::before { content: ''; position: absolute; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); }
                        #music-player-page .content-area > * { z-index: 1; }
                        .music-cover { width: 100px; height: 100px; border-radius: 50%; margin-bottom: 20px; background-image: var(--player-image); background-size: cover; background-position: center; border: 5px solid rgba(255,255,255,0.1); }
                        .music-info h3 { margin: 10px 0 5px; font-size: 18px; }
                        .music-info p { margin: 0; font-size: 14px; color: #aaa; }
                        .music-controls { display: flex; gap: 15px; margin-top: 20px; align-items: center; }
                        .music-controls i { font-size: 24px; }
                        .music-controls .fa-play-circle { font-size: 36px; }
                        ${css}
                    </style>
                    <div id="music-player-page">
                        <div class="content-area">
                            <div class="music-cover"></div>
                            <div class="music-info"><h3>Song Title</h3><p>Artist</p></div>
                            <div class="music-controls"><i class="fas fa-backward"></i><i class="fas fa-play-circle"></i><i class="fas fa-forward"></i></div>
                        </div>
                    </div>
                `;
                previewDoc.documentElement.style.setProperty('--player-image', `url(${appData.music.playerImage})`);
                previewDoc.documentElement.style.setProperty('--player-background', `url(${appData.music.playerBackground})`);
            };

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>返回</span></div>
                    <span class="header-title">播放器CSS美化</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>选择示例</label>
                        <select class="form-input" onchange="document.getElementById('player-css-input').value = this.value; updatePreview();">
                            <option value="">选择一个风格...</option>
                            ${Object.entries(examples).map(([name, css]) => `<option value="${css}">${name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>播放器自定义 CSS</label>
                        <textarea id="player-css-input" style="height: 200px; font-family: monospace;" oninput="updatePreview()">${appData.music.playerCss || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>预览</label>
                        <iframe id="player-css-preview-frame" style="width: 100%; height: 300px; border: 1px solid #ccc; border-radius: 8px;"></iframe>
                    </div>
                    <button class="form-btn" onclick="savePlayerCss()">保存并应用</button>
                </div>
            `;
            window.updatePreview = updatePreview;
            setTimeout(updatePreview, 100);
        }

        function savePlayerCss() {
            appData.music.playerCss = document.getElementById('player-css-input').value;
            saveData(true);
            applyBeautifySettings();
        }

        // --- Long Term Memory & Diary ---
        function renderLongTermMemoryPage(container, contactId) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>返回</span></div>
                    <span class="header-title">长期记忆</span>
                </div>
                <div class="content-area" id="memory-list">
                    <div class="loader-container"><div class="loader"></div></div>
                </div>
            `;
            generateAndRenderMemory(contactId);
        }

        async function generateAndRenderMemory(contactId) {
            const contact = appData.contacts.find(c => c.id == contactId);
            const memoryList = document.getElementById('memory-list');
            if (!memoryList) return;
            try {
                const history = contact.conversation.slice(-100).map(m => `${m.sender === appData.user.id ? appData.user.nickname : contact.name}: ${m.content.content}`).join('\n');
                const prompt = `请以客观的第三人称视角，总结本次聊天记录中的关键事件、地点变更和人物关系变化。可以掺杂个人感情，像写日记一样，要贴合自己的人设，结合聊天记录中的话题和事件，请分条列出每条不超过100字。总计字数上限5000字。\n\n聊天记录：\n${history}`;
                const summary = await getAiReply(contactId, 'wechat', prompt);
                memoryList.innerHTML = summary.map(item => `<div class="list-item" style="flex-direction: column; align-items: flex-start; background: var(--wechat-bg); border-radius: 8px; margin-bottom: 10px;"><p>${item}</p></div>`).join('');
            } catch (e) {
                memoryList.innerHTML = `<p style="padding: 20px; color: red;">生成记忆失败: ${e.message}</p>`;
            }
        }

        function renderDiaryPage(container, chatId) {
            if (!container) return;
            const contact = appData.contacts.find(c => c.id == chatId);
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>返回</span></div>
                    <span class="header-title">${contact.name}的日记</span>
                </div>
                <div class="content-area" id="diary-content" style="padding: 25px; font-family: 'DiaryFont', serif; color: #3a2e28; line-height: 1.8; font-size: 17px; white-space: pre-wrap; background-image: url('https://img.heliar.top/file/1764077275005_Screenshot_2025_1125_181250.png'); background-size: cover;">
                    <div class="loader-container"><div class="loader"></div></div>
                </div>
            `;
            generateAndRenderDiary(chatId);
        }

        async function generateAndRenderDiary(chatId) {
            const contact = appData.contacts.find(c => c.id == chatId);
            const diaryContent = document.getElementById('diary-content');
            if (!diaryContent) return;
            try {
                const history = contact.conversation.slice(-100).map(m => `${m.sender === appData.user.id ? appData.user.nickname : contact.name}: ${m.content.content}`).join('\n');
                const prompt = `请你以【${contact.name}】的身份和第一人称视角，结合你的角色设定(${contact.persona})以及下面的聊天记录，写一篇日记。日记内容要完全贴合你的人设，可以是对聊天内容的感想，也可以是基于聊天内容发散出的、符合你身份的日常记录或心理活动。字数上限5000字。\n\n聊天记录：\n${history}`;
                const diaryText = (await getAiReply(chatId, 'wechat', prompt)).join('\n\n');
                diaryContent.textContent = diaryText;
            } catch (e) {
                diaryContent.innerHTML = `<p style="padding: 20px; color: red;">生成日记失败: ${e.message}</p>`;
            }
        }

        // ★★★ 优化：戳一戳功能 ★★★
        function renderPokeSettingsPage(container, contactId) {
            if (!container) return;
            const contact = appData.contacts.find(c => c.id == contactId);
            if (!contact) { goBack(); return; }
            
            const pokeSettings = contact.pokeSettings;

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>设置</span></div>
                    <span class="header-title">戳一戳设置</span>
                </div>
                <div class="content-area form-page">
                    <h3>设置我对${contact.name} 的戳一戳</h3>
                    <div class="form-group">
                        <label>动作</label>
                        <select id="poke-user-action">
                            ${['拍了拍', '揉了揉', '戳了戳', '捏了捏', '弹了弹'].map(a => `<option value="${a}" ${pokeSettings.userToChar.action === a ? 'selected' : ''}>${a}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>后缀 (例如：的脸并说了句抖爱慕)</label>
                        <input type="text" id="poke-user-suffix" value="${pokeSettings.userToChar.suffix}">
                    </div>
                    <div class="list-divider"></div>
                    <h3>设置 ${contact.name} 对我的戳一戳</h3>
                    <div class="form-group">
                        <label>动作</label>
                        <select id="poke-char-action">
                            ${['拍了拍', '揉了揉', '戳了戳', '捏了捏', '弹了弹'].map(a => `<option value="${a}" ${pokeSettings.charToUser.action === a ? 'selected' : ''}>${a}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>后缀</label>
                        <input type="text" id="poke-char-suffix" value="${pokeSettings.charToUser.suffix}">
                    </div>
                    <button class="form-btn" id="save-poke-btn">保存</button>
                </div>
            `;
            document.getElementById('save-poke-btn').onclick = () => {
                pokeSettings.userToChar.action = document.getElementById('poke-user-action').value;
                pokeSettings.userToChar.suffix = document.getElementById('poke-user-suffix').value;
                pokeSettings.charToUser.action = document.getElementById('poke-char-action').value;
                pokeSettings.charToUser.suffix = document.getElementById('poke-char-suffix').value;
                saveData(true);
            };
        }

        function triggerPoke(chatId, chatType, targetId, source, pokerId = appData.user.id) {
            let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
            if (!chat) return;
            const conversation = chat.conversation;

            let poker, poked;
            let pokerName, pokedName;
            let pokeSetting;

            const getUserDisplayName = (userId) => {
                if (userId === appData.user.id) {
                    const boundPersonaId = appData.user.defaultPersonaId; // Check for default persona
                    const persona = boundPersonaId ? appData.user.personas.find(p => p.id === boundPersonaId) : null;
                    return persona ? persona.name : appData.user.nickname;
                }
                const contact = appData.contacts.find(c => c.id == userId);
                return contact ? (contact.remark || contact.name) : '未知用户';
            };

            pokerName = getUserDisplayName(pokerId);
            pokedName = (pokerId == targetId) ? "自己" : getUserDisplayName(targetId);

            if (pokerId == appData.user.id && targetId != appData.user.id) {
                const targetContact = appData.contacts.find(c => c.id == targetId);
                pokeSetting = targetContact.pokeSettings.userToChar;
            } else if (pokerId != appData.user.id && targetId == appData.user.id) {
                const pokerContact = appData.contacts.find(c => c.id == pokerId);
                pokeSetting = pokerContact.pokeSettings.charToUser;
            } else {
                pokeSetting = { action: '拍了拍', suffix: '' };
            }

            const pokeText = `${pokerName} ${pokeSetting.action}了 ${pokedName} ${pokeSetting.suffix}`;
            
            const systemMsg = {
                id: Date.now(), type: 'system',
                content: { content: pokeText },
                timestamp: Date.now()
            };
            conversation.push(systemMsg);
            saveData();
            renderMessages(chatId, chatType, source);
        }

        // --- Helper Functions ---
        function findLastIndex(array, predicate) {
            for (let i = array.length - 1; i >= 0; i--) {
                if (predicate(array[i])) {
                    return i;
                }
            }
            return -1;
        }

        function escapeSrcDoc(html) {
            return html.replace(/"/g, '&quot;');
        }
        
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function formatLargeBalance(cnyAmount, targetCurrency) {
            const rateInfo = exchangeRates[targetCurrency];
            if (!rateInfo) return `${cnyAmount.toFixed(2)} CNY`;
            
            const convertedAmount = cnyAmount * rateInfo.rate;

            if (convertedAmount >= 10000000000000000) {
                return (convertedAmount / 10000000000000000).toPrecision(3) + '京';
            }
            if (convertedAmount >= 100000000000000000000000) {
                return (convertedAmount / 1000000000000).toPrecision(3) + 't';
            }
            if (convertedAmount >= 100000000) {
                return (convertedAmount / 100000000).toPrecision(3) + 'm';
            }
            if (convertedAmount >= 10000) {
                return (convertedAmount / 10000).toPrecision(3) + 'k';
            }
            
            return new Intl.NumberFormat(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(convertedAmount);
        }

        function formatCurrency(cnyAmount, targetCurrency, showSymbol = false) {
            const rateInfo = exchangeRates[targetCurrency];
            if (!rateInfo) return `${cnyAmount.toFixed(2)} CNY`;
            
            const convertedAmount = cnyAmount * rateInfo.rate;
            
            let formatted = new Intl.NumberFormat(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(convertedAmount);
            
            if (showSymbol) {
                return `${targetCurrency} ${formatted}`;
            }
            return formatted;
        }

        function showCurrencySelectionModal() {
            const modalId = 'currency-selection-modal';
            let listHtml = '';
            for (const [code, { name }] of Object.entries(exchangeRates)) {
                listHtml += `<div class="list-item" onclick="setCurrency('${code}')">
                                <div class="details"><span class="name">${name} (${code})</span></div>
                                ${appData.user.wallet.currency === code ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                             </div>`;
            }
            const modalHtml = `
                <div class="modal-content">
                    <div class="modal-title">切换货币</div>
                    <div class="list-view" style="max-height: 60vh; overflow-y: auto; background: transparent;">${listHtml}</div>
                </div>
            `;
            showModal(modalId, modalHtml);
        }

        function setCurrency(currencyCode) {
            appData.user.wallet.currency = currencyCode;
            saveData();
            closeModal('currency-selection-modal');
            renderWalletPage(document.getElementById('wallet-page'));
        }

        // --- New Feature Functions ---

        function renderGlobalThemeEditorPage(container) {
            if (!container) return;
            let currentSlot = appData.settings.beautify.activeGlobalThemeSlot > -1 ? appData.settings.beautify.activeGlobalThemeSlot : 0;

            const loadSlot = (slotIndex) => {
                currentSlot = slotIndex;
                const archive = appData.settings.beautify.globalThemeArchives[slotIndex] || {};
                document.getElementById('global-theme-css-input').value = archive.css || '';
                document.querySelectorAll('.slot-btn').forEach((btn, i) => {
                    btn.style.fontWeight = i === slotIndex ? 'bold' : 'normal';
                    btn.style.borderColor = i === appData.settings.beautify.activeGlobalThemeSlot ? 'var(--wechat-green)' : 'var(--wechat-border-color)';
                });
                document.getElementById('save-theme-btn').onclick = () => saveGlobalTheme(currentSlot);
                document.getElementById('apply-theme-btn').onclick = () => applyGlobalTheme(currentSlot);
            };

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>返回</span></div>
                    <span class="header-title">自定义全局主题</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>存档槽</label>
                        <div style="display: flex; justify-content: space-between;">
                            ${[0,1,2].map(i => `<button class="modal-btn slot-btn" onclick="loadSlot(${i})">存档 ${i+1}</button>`).join('')}
                        </div>
                    </div>
                                        <div class="form-group">
                        <label>全局美化 CSS</label>
                        <textarea id="global-theme-css-input" style="height: 40vh; font-family: monospace;"></textarea>
                    </div>
                    <button id="save-theme-btn" class="form-btn">保存到当前槽</button>
                    <button id="apply-theme-btn" class="form-btn" style="background-color: var(--wechat-blue);">应用当前槽主题</button>
                    <button class="form-btn" style="background-color: #aaa;" onclick="clearGlobalTheme()">清除全局主题</button>
                </div>
            `;
            window.loadSlot = loadSlot;
            loadSlot(currentSlot);
        }

        function saveGlobalTheme(slotIndex) {
            const css = document.getElementById('global-theme-css-input').value;
            if (!appData.settings.beautify.globalThemeArchives[slotIndex]) {
                appData.settings.beautify.globalThemeArchives[slotIndex] = {};
            }
            appData.settings.beautify.globalThemeArchives[slotIndex].css = css;
            saveData(true);
        }

        function applyGlobalTheme(slotIndex) {
            appData.settings.beautify.activeGlobalThemeSlot = slotIndex;
            saveData(true);
            applyBeautifySettings();
            renderGlobalThemeEditorPage(document.getElementById('global-theme-editor-page'));
        }

        function clearGlobalTheme() {
            appData.settings.beautify.activeGlobalThemeSlot = -1;
            saveData(true);
            applyBeautifySettings();
            renderGlobalThemeEditorPage(document.getElementById('global-theme-editor-page'));
        }

        function renderBankCardPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>钱包</span></div>
                    <span class="header-title">银行卡</span>
                </div>
                <div class="content-area" id="bank-card-list"></div>
            `;
            renderBankCards();
        }

        function renderBankCards() {
            const listContainer = document.getElementById('bank-card-list');
            if (!listContainer) return;
            let html = '';
            appData.user.bankCards.forEach(card => {
                html += `
                    <div class="bank-card">
                        <div class="bank-name">${card.bankName}</div>
                        <div class="card-number">${formatCardNumber(card.number)}</div>
                        <div class="card-balance">余额: ${formatCurrency(card.balance, 'CNY')}</div>
                    </div>
                `;
            });
            html += `<div class="add-card-btn" onclick="showAddBankCardModal()"><i class="fas fa-plus"></i><p>添加银行卡</p></div>`;
            listContainer.innerHTML = html;
        }

        function showAddBankCardModal() {
            const modalId = 'add-bank-card-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">添加银行卡</div>
                    <div class="modal-input-group">
                        <label>银行名称</label>
                        <input type="text" id="bank-name-input" class="modal-input">
                    </div>
                    <div class="modal-input-group">
                        <label>银行卡号 (16位数字)</label>
                        <input type="text" id="bank-number-input" class="modal-input" maxlength="16" pattern="\\d{16}">
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" id="confirm-add-card-btn">确认</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);
            document.getElementById('confirm-add-card-btn').onclick = () => {
                const bankName = document.getElementById('bank-name-input').value.trim();
                const bankNumber = document.getElementById('bank-number-input').value.trim();
                if (!bankName) { showToast('银行名称不能为空', 'error'); return; }
                if (!/^\d{16}$/.test(bankNumber)) { showToast('请输入16位有效银行卡号', 'error'); return; }

                appData.user.bankCards.push({
                    id: Date.now(),
                    bankName,
                    number: bankNumber,
                    balance: 999999999999
                });
                saveData(true);
                renderBankCards();
                closeModal(modalId);
            };
        }

        function formatCardNumber(number) {
            return number.replace(/(\d{4})(?=\d)/g, "$1 ");
        }

        function showLianQianTongModal() {
            const lqt = appData.user.wallet.lianqiantong;
            const modalId = 'lianqiantong-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">零钱通</div>
                    <p style="text-align: center; font-size: 24px; font-weight: bold;">${formatCurrency(lqt.balance, 'CNY')}</p>
                    <p style="text-align: center; color: #888; font-size: 12px;">昨日收益 +${(lqt.balance * lqt.dailyRate).toFixed(2)}</p>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="showLqtActionModal('withdraw')">转出</button>
                        <button class="modal-btn primary" onclick="showLqtActionModal('deposit')">转入</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);
        }

        function showLqtActionModal(action) {
            closeModal('lianqiantong-modal');
            const modalId = 'lqt-action-modal';
            const title = action === 'withdraw' ? '从零钱通转出' : '转入到零钱通';
            const wallet = appData.user.wallet;
            const lqt = wallet.lianqiantong;

            let sourceOptions = '';
            if (action === 'deposit') {
                sourceOptions += `<option value="wallet">零钱 (余额: ${formatCurrency(wallet.balance, 'CNY')})</option>`;
                sourceOptions += appData.user.bankCards.map(c => `<option value="${c.id}">银行卡 ${c.bankName} (尾号${c.number.slice(-4)})</option>`).join('');
            } else {
                sourceOptions += `<option value="wallet">零钱</option>`;
                sourceOptions += appData.user.bankCards.map(c => `<option value="${c.id}">银行卡 ${c.bankName} (尾号${c.number.slice(-4)})</option>`).join('');
            }

            const html = `
                <div class="modal-content">
                    <div class="modal-title">${title}</div>
                    <div class="modal-input-group">
                        <label>金额</label>
                        <input type="number" id="lqt-amount-input" class="modal-input" placeholder="0.00">
                    </div>
                    <div class="modal-input-group">
                        <label>${action === 'deposit' ? '从' : '到'}</label>
                        <select id="lqt-method-select" class="modal-input">${sourceOptions}</select>
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" onclick="processLqtAction('${action}')">确认</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);
        }

        function processLqtAction(action) {
            const amount = parseFloat(document.getElementById('lqt-amount-input').value);
            const method = document.getElementById('lqt-method-select').value;
            const wallet = appData.user.wallet;
            const lqt = wallet.lianqiantong;

            if (isNaN(amount) || amount <= 0) {
                showToast('请输入有效金额', 'error');
                return;
            }

            const onPasswordVerified = () => {
                if (action === 'deposit') {
                    if (method === 'wallet') {
                        if (amount > wallet.balance) { showToast('零钱余额不足', 'error'); return; }
                        wallet.balance -= amount;
                        lqt.balance += amount;
                        wallet.transactions.push({ type: '转入零钱通', amount: -amount, details: '从零钱', timestamp: Date.now() });
                    } else {
                        const card = appData.user.bankCards.find(c => c.id == method);
                        if (!card || amount > card.balance) { showToast('银行卡余额不足', 'error'); return; }
                        card.balance -= amount;
                        lqt.balance += amount;
                        wallet.transactions.push({ type: '转入零钱通', amount: -amount, details: `从银行卡 ${card.bankName}`, timestamp: Date.now() });
                    }
                } else { // withdraw
                    if (amount > lqt.balance) { showToast('零钱通余额不足', 'error'); return; }
                    lqt.balance -= amount;
                    if (method === 'wallet') {
                        wallet.balance += amount;
                        wallet.transactions.push({ type: '从零钱通转出', amount: amount, details: '到零钱', timestamp: Date.now() });
                    } else {
                        const card = appData.user.bankCards.find(c => c.id == method);
                        if (!card) { showToast('无效银行卡', 'error'); lqt.balance += amount; return; }
                        card.balance += amount;
                        wallet.transactions.push({ type: '从零钱通转出', amount: amount, details: `到银行卡 ${card.bankName}`, timestamp: Date.now() });
                    }
                }
                saveData(true);
                closeModal('lqt-action-modal');
                renderWalletPage(document.getElementById('wallet-page'));
            };

            showPasswordModal(onPasswordVerified);
        }

        function showKinshipCardModal(chatId, chatType) {
            if (chatType !== 'individual') {
                showToast('亲属卡只能在单人聊天中赠送', 'error');
                return;
            }
            const modalId = 'kinship-card-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">赠送亲属卡</div>
                    <div class="modal-input-group">
                        <label>关系分类</label>
                        <select id="kinship-category-input" class="modal-input">
                            <option value="爱人">爱人</option>
                            <option value="家人">家人</option>
                            <option value="闺蜜">闺蜜</option>
                            <option value="朋友">朋友</option>
                            <option value="死党">死党</option>
                        </select>
                    </div>
                    <div class="modal-input-group">
                        <label>每月消费上限</label>
                        <input type="number" id="kinship-limit-input" class="modal-input" placeholder="例如: 2000">
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" onclick="sendKinshipCard('${chatId}')">赠送</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);
        }

        function sendKinshipCard(recipientId) {
            const limit = parseFloat(document.getElementById('kinship-limit-input').value);
            const category = document.getElementById('kinship-category-input').value;
            if (isNaN(limit) || limit <= 0) {
                showToast('请输入有效的上限金额', 'error');
                return;
            }
            const cardId = Date.now();
            const newCard = {
                id: cardId,
                senderId: appData.user.id,
                recipientId: recipientId,
                limit: limit,
                used: 0,
                category: category,
                resetDate: new Date(new Date().getFullYear(), new Date().getMonth() + 1, 1).toISOString()
            };
            appData.user.kinshipCards.sent.push(newCard);
            sendMessage(recipientId, 'individual', { cardId, recipientId, limit, category }, 'kinshipCard', 'wechat');
            saveData(true);
            closeModal('kinship-card-modal');
        }

        function showKinshipCardManagementModal() {
            const modalId = 'kinship-management-modal';
            const sentCardsHtml = appData.user.kinshipCards.sent.map(card => {
                const recipient = appData.contacts.find(c => c.id == card.recipientId);
                return `<div class="list-item">
                            <div class="details">
                                <span class="name">送给 ${recipient?.name || '未知用户'} (${card.category})</span>
                                <p class="subtext">每月上限: ¥${card.limit.toFixed(2)} | 本月已用: ¥${card.used.toFixed(2)}</p>
                            </div>
                            <button class="modal-btn" style="flex:0; background:var(--wechat-red); color:white;" onclick="removeKinshipCard('sent', ${card.id})">解绑</button>
                        </div>`;
            }).join('');
            
            const receivedCardsHtml = appData.user.kinshipCards.received.map(card => {
                const sender = appData.contacts.find(c => c.id == card.senderId);
                return `<div class="list-item">
                            <div class="details">
                                <span class="name">来自 ${sender?.name || '未知用户'} (${card.category})</span>
                                <p class="subtext">每月上限: ¥${card.limit.toFixed(2)} | 本月已用: ¥${card.used.toFixed(2)}</p>
                            </div>
                            <button class="modal-btn" style="flex:0; background:var(--wechat-red); color:white;" onclick="removeKinshipCard('received', ${card.id})">解绑</button>
                        </div>`;
            }).join('');

            const html = `
                <div class="modal-content" style="width: 90%; max-width: 360px;">
                    <div class="modal-title">亲属卡管理</div>
                    <div style="max-height: 60vh; overflow-y: auto;">
                        <h3>我送出的</h3>
                        <div class="list-view">${sentCardsHtml || '<p class="subtext" style="text-align:center; padding:10px;">暂无</p>'}</div>
                        <h3>我收到的</h3>
                        <div class="list-view">${receivedCardsHtml || '<p class="subtext" style="text-align:center; padding:10px;">暂无</p>'}</div>
                    </div>
                    <button class="modal-btn" style="margin-top: 15px;" onclick="closeModal('${modalId}')">关闭</button>
                </div>
            `;
            showModal(modalId, html);
        }

        function removeKinshipCard(type, cardId) {
            if (confirm('确定要解绑这张亲属卡吗？')) {
                if (type === 'sent') {
                    appData.user.kinshipCards.sent = appData.user.kinshipCards.sent.filter(c => c.id !== cardId);
                } else {
                    appData.user.kinshipCards.received = appData.user.kinshipCards.received.filter(c => c.id !== cardId);
                }
                saveData(true);
                closeModal('kinship-management-modal');
                showKinshipCardManagementModal();
            }
        }

        function renderUiBeautifyPage(container) {
            if (!container) return;
            const uiIcons = appData.settings.beautify.uiIcons;
            const iconGroups = {
                "通用 & 导航": ['back', 'plusCircle', 'tabChat', 'tabContacts', 'tabMe'],
                "聊天输入栏": ['chatResend', 'chatVoice', 'chatSticker', 'chatPlus'],
                "聊天功能菜单": ['plusImage', 'plusCamera', 'plusPhone', 'plusLocation', 'plusRedpacket', 'plusTransfer', 'plusKinship', 'plusDiary', 'plusFile', 'plusHeartbeat'],
                "“我”页面": ['meSettings', 'meWallet', 'meMoments', 'mePersona', 'meAddress', 'meStatus']
            };
            const iconNames = {
                back: '返回', plusCircle: '主页加号', tabChat: '聊天Tab', tabContacts: '通讯录Tab', tabMe: '我Tab',
                chatResend: '重新回复', chatVoice: '语音', chatSticker: '表情', chatPlus: '聊天加号',
                plusImage: '相册', plusCamera: '拍摄', plusPhone: '语音通话', plusLocation: '位置', plusRedpacket: '红包', plusTransfer: '转账', plusKinship: '亲属卡', plusDiary: '对方日记', plusFile: '文件', plusHeartbeat: '心声',
                meSettings: '设置', meWallet: '钱包', meMoments: '朋友圈', mePersona: '我的自设', meAddress: '地址', meStatus: '状态'
            };

            let html = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div></div>
                    <span class="header-title">UI图标美化</span>
                </div>
                <div class="content-area form-page">
            `;

            for (const groupName in iconGroups) {
                html += `<h3>${groupName}</h3>`;
                iconGroups[groupName].forEach(key => {
                    html += `
                        <div class="form-group" style="display: flex; align-items: center; gap: 15px;">
                            <img src="${uiIcons[key]}" class="avatar-upload-preview" style="width: 40px; height: 40px; background: #eee; padding: 5px; margin: 0; object-fit: contain;" id="ui-icon-preview-${key}" onclick="document.getElementById('ui-icon-input-${key}').click()">
                            <label style="flex: 1; margin: 0;">${iconNames[key] || key}</label>
                            <input type="file" id="ui-icon-input-${key}" class="file-input" accept="image/*, image/svg+xml" onchange="handleUiIconUpload(this.files[0], '${key}')">
                        </div>
                    `;
                });
                html += '<div class="list-divider"></div>';
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function handleUiIconUpload(file, iconKey) {
            handleImageUpload(file, url => {
                appData.settings.beautify.uiIcons[iconKey] = url;
                saveData(true);
                document.getElementById(`ui-icon-preview-${iconKey}`).src = url;
                applyBeautifySettings();
            });
        }

        // ★★★ 优化：对方余额APP ★★★
        function renderCharBalanceAppPage(container) {
            if (!container) return;
            const contacts = appData.contacts;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div></div>
                    <span class="header-title">对方余额</span>
                </div>
                <div class="content-area" id="char-balance-content">
                    <div class="loader-container"><div class="loader"></div></div>
                </div>
            `;
            if (contacts.length > 0) {
                showCharBalanceDetails(contacts[0].id); // 默认显示第一个好友
            } else {
                document.getElementById('char-balance-content').innerHTML = '<p style="text-align:center; padding:50px; color:var(--wechat-text-secondary);">暂无好友</p>';
            }
        }

        async function showCharBalanceDetails(charId) {
            const container = document.getElementById('char-balance-content');
            if (!container) return;
            container.innerHTML = `<div class="loader-container"><div class="loader"></div></div>`;
            
            const contact = appData.contacts.find(c => c.id == charId);
            try {
                const prompt = `根据角色设定：【${contact.persona}】，请你生成该角色的财务状况，必须严格遵循以下JSON格式，不要添加任何额外解释：
                {
                  "bank_balance": "银行卡余额(数字)",
                  "wallet_balance": "钱包余额(数字)",
                  "alipay_balance": "支付宝余额(数字)",
                  "recent_expenses": [
                    {"item": "支出项目1", "amount": "金额(数字)", "date": "YYYY-MM-DD"},
                    {"item": "支出项目2", "amount": "金额(数字)", "date": "YYYY-MM-DD"},
                    {"item": "支出项目3", "amount": "金额(数字)", "date": "YYYY-MM-DD"}
                  ]
                }`;
                const balanceDataStr = (await getAiReply(charId, 'wechat', prompt))[0];
                let balanceData;
                try {
                    balanceData = JSON.parse(balanceDataStr);
                    if (typeof balanceData.bank_balance === 'undefined' || !Array.isArray(balanceData.recent_expenses)) {
                        throw new Error("API返回的JSON结构不符合预期。");
                    }
                } catch (e) {
                    console.error("Balance JSON Parse Error:", e, "Raw string:", balanceDataStr);
                    throw new Error("API返回的数据格式错误，无法解析。");
                }

                const contentHtml = `
                    <div class="balance-card">
                        <div class="balance-header">
                            <img src="${contact.avatar}" class="avatar">
                            <span class="name">${contact.name}</span>
                        </div>
                        <div class="balance-grid">
                            <div class="balance-item">
                                <div class="title">银行卡余额</div>
                                <div class="amount">${formatCurrency(balanceData.bank_balance, 'CNY')}</div>
                            </div>
                            <div class="balance-item">
                                <div class="title">钱包余额</div>
                                <div class="amount">${formatCurrency(balanceData.wallet_balance, 'CNY')}</div>
                            </div>
                            <div class="balance-item">
                                <div class="title">支付宝余额</div>
                                <div class="amount">${formatCurrency(balanceData.alipay_balance, 'CNY')}</div>
                            </div>
                        </div>
                    </div>
                    <div class="balance-card">
                        <h3>最近开销</h3>
                        <div class="list-view transactions-list">
                            ${balanceData.recent_expenses.map(item => `
                                <div class="list-item">
                                    <div class="details">
                                        <span class="name">${item.item}</span>
                                        <p class="subtext">${item.date}</p>
                                    </div>
                                    <div class="info amount">-${formatCurrency(item.amount, 'CNY')}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                container.innerHTML = contentHtml;
            } catch (e) {
                container.innerHTML = `<p style="color: red; padding: 20px;">获取余额失败: ${e.message}</p>`;
            }
        }

        function setTypingIndicator(chatId, isTyping, memberName = null, source = 'wechat') {
            const pageId = 'conversation-page';
            const convPage = document.getElementById(pageId);
            const activeChatId = appData.activeChat.id;

            if (convPage.classList.contains('active') && activeChatId == chatId) {
                const titleEl = convPage.querySelector('.header-title');
                if (isTyping) {
                    let text = '对方正在输入中...';
                    if (memberName) text = `${memberName}正在输入中...`;
                    titleEl.dataset.originalTitle = titleEl.textContent;
                    titleEl.textContent = text;
                } else {
                    if (titleEl.dataset.originalTitle) {
                        titleEl.textContent = titleEl.dataset.originalTitle;
                    }
                }
            }
        }

        function renderShoppingAppPage(container) {
            if (!container) {
                console.error("Shopping App Firewall: Container not found.");
                return;
            }
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div></div>
                    <span class="header-title">购物</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="showApiDrivenShopModal('delivery')">
                        <i class="fas fa-utensils" style="color: #FFC107; font-size: 24px; width: 24px; text-align: center;"></i>
                        <div class="details"><span class="name">点外卖</span></div>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showApiDrivenShopModal('gift')">
                        <i class="fas fa-gift" style="color: #FFB347; font-size: 24px; width: 24px; text-align: center;"></i>
                        <div class="details"><span class="name">送礼物</span></div>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                </div>
            `;
        }

        async function showApiDrivenShopModal(type) {
            const titles = { gift: '礼物商城', delivery: '外卖' };
            const modalId = `${type}-shop-modal`;
            const activeChatId = appData.activeChat.id;
            if (!activeChatId) {
                showToast('请先进入一个聊天才能使用此功能', 'error');
                return;
            }
            
            const categories = appData.shopping.categories[type];
            const categoryTabs = categories.map((cat, index) => 
                `<div class="tab-item ${index === 0 ? 'active' : ''}" onclick="switchShopCategory(this, '${type}', '${activeChatId}', '${cat}')"><span>${cat}</span></div>`
            ).join('');

            const content = `
                <div style="display: flex; flex-direction: column; height: 100%;">
                    <div class="wechat-header" style="flex-shrink: 0;">
                        <div class="header-left header-back-btn" onclick="closeModal('${modalId}')"><i class="fas fa-times"></i></div>
                        <span class="header-title">${titles[type]}</span>
                        <div class="header-right" onclick="refreshApiShopItems('${type}', '${activeChatId}')"><i class="fas fa-sync-alt"></i></div>
                    </div>
                    <div class="wechat-tabbar" style="height: 44px; border-top: none; border-bottom: 0.5px solid var(--wechat-border-color); flex-shrink: 0;">
                        ${categoryTabs}
                    </div>
                    <div class="content-area ${type === 'gift' ? 'gift-grid' : 'food-list'}" id="${type}-shop-list"></div>
                </div>
            `;
            showModal(modalId, content, true);
            await refreshApiShopItems(type, activeChatId, categories[0]);
        }

        function switchShopCategory(tabElement, type, chatId, category) {
            const tabs = tabElement.parentElement.querySelectorAll('.tab-item');
            tabs.forEach(tab => tab.classList.remove('active'));
            tabElement.classList.add('active');
            refreshApiShopItems(type, chatId, category);
        }

        async function refreshApiShopItems(type, chatId, category) {
            const listEl = document.getElementById(`${type}-shop-list`);
            if (!listEl) return;
            listEl.innerHTML = `<div class="loader-container"><div class="loader"></div></div>`;
            
            const prompts = {
                gift: `请严格按照'礼物名,价格,描述;...'的格式生成36个关于“${category}”分类的礼物，描述不超过20字。例如：'永恒玫瑰,520,一朵永不凋谢的玫瑰;...'.`,
                delivery: `请严格按照'商品名,价格,描述;...'的格式生成36个关于“${category}”分类的外卖商品，描述为商家名。例如：'麻辣小龙虾,88,虾搞搞大排档;...'.`
            };

            try {
                const itemsStr = (await getAiReply(chatId, 'wechat', prompts[type]))[0];
                if (!itemsStr || typeof itemsStr !== 'string') {
                    throw new Error("API未返回有效数据。");
                }
                const items = itemsStr.split(';').map(item => {
                    const parts = item.split(',');
                    return parts.length >= 3 ? { name: parts[0].trim(), price: parseFloat(parts[1].trim()), desc: parts.slice(2).join(',').trim() } : null;
                }).filter(Boolean);

                if (items.length === 0) {
                    throw new Error("API返回的数据无法解析或为空。");
                }

                listEl.innerHTML = items.map(item => `
                    <div class="food-item" onclick="showItemDetailModal('${type}', '${item.name.replace(/'/g, "\\'")}', ${item.price}, '${item.desc.replace(/'/g, "\\'")}')">
                        <img src="https://source.unsplash.com/150x100/?${type === 'gift' ? 'gift' : 'food'},${encodeURIComponent(item.name)}" alt="${item.name}">
                        <div class="info">
                            <div class="name">${item.name}</div>
                            <p style="font-size:12px; color:var(--wechat-text-secondary);">${item.desc}</p>
                            <div class="price">${formatCurrency(item.price, appData.user.wallet.currency)}</div>
                        </div>
                    </div>
                `).join('');

            } catch(e) {
                listEl.innerHTML = `<p style="text-align:center; color:red; padding:50px;">商品加载失败: ${e.message}</p>`;
            }
        }

        function showItemDetailModal(type, name, price, desc) {
            const modalId = 'item-detail-modal';
            const charOptions = appData.contacts.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            const html = `
                <div class="modal-content">
                    <div class="modal-title">${name}</div>
                    <img src="https://source.unsplash.com/250x150/?${type === 'gift' ? 'gift' : 'food'},${encodeURIComponent(name)}" style="width:100%; border-radius:8px; margin-bottom:15px;">
                    <p>${desc}</p>
                    <p style="font-size:20px; font-weight:bold; color:var(--wechat-red); text-align:center;">${formatCurrency(price, appData.user.wallet.currency)}</p>
                    <div class="modal-actions" style="flex-direction:column;">
                        <div class="form-group">
                            <label>送给</label>
                            <select id="purchase-recipient-char" class="modal-input">${charOptions}</select>
                        </div>
                        <button class="form-btn" onclick="processPurchase('${type}', '${name.replace(/'/g, "\\'")}', ${price}, 'char')">送给TA</button>
                        <button class="form-btn" style="background-color: #aaa;" onclick="processPurchase('${type}', '${name.replace(/'/g, "\\'")}', ${price}, 'user')">给自己买</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);
        }

        function processPurchase(type, name, price, recipientType) {
            const onPasswordVerified = () => {
                if (appData.user.wallet.balance < price) {
                    showToast('余额不足！', 'error');
                    return;
                }
                appData.user.wallet.balance -= price;
                
                const item = { name, price, quantity: 1 };
                const receiptType = type ==='gift' ? 'gift_receipt' : 'delivery_receipt';
                const transactionType = type === 'gift' ? '送礼' : '外卖';

                let recipientId;
                let recipientName;

                if (recipientType === 'char') {
                    recipientId = document.getElementById('purchase-recipient-char').value;
                    const char = appData.contacts.find(c => c.id == recipientId);
                    recipientName = char.name;
                } else {
                    recipientId = appData.user.id;
                    recipientName = '自己';
                }

                appData.user.wallet.transactions.push({ type: transactionType, amount: -price, details: `为${recipientName}购买 ${name}`, timestamp: Date.now() });

                sendMessage(recipientId, 'individual', { items: [item], total: price, recipient: recipientType }, receiptType, 'wechat');
                
                saveData();
                closeModal('item-detail-modal');
                closeModal(`${type}-shop-modal`);
            };
            showPasswordModal(onPasswordVerified);
        }

        function renderSelfPersonaListPage(container) {
            if (!container) return;
            const personas = appData.user.personas || [];
            const defaultPersonaId = appData.user.defaultPersonaId;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>我</span></div>
                    <span class="header-title">我的自设</span>
                    <div class="header-right" onclick="showPage('self-persona-editor-page', renderSelfPersonaEditorPage)"><i class="fas fa-plus"></i></div>
                </div>
                <div class="content-area list-view">
                    ${personas.map(p => `
                        <div class="list-item" onclick="showPage('self-persona-editor-page', renderSelfPersonaEditorPage, ${p.id})">
                            <img src="${p.avatar}" class="avatar">
                            <div class="details">
                                <span class="name">${p.name} ${p.id === defaultPersonaId ? '<i class="fas fa-thumbtack" style="color: var(--wechat-green);"></i>' : ''}</span>
                            </div>
                            <i class="fas fa-chevron-right chevron"></i>
                        </div>
                    `).join('') || '<p style="text-align:center; color:var(--wechat-text-secondary); padding:50px;">还没有自设，快去创建一个吧！</p>'}
                </div>
            `;
        }

        function renderSelfPersonaEditorPage(container, personaId = null) {
            if (!container) return;
            const persona = personaId ? appData.user.personas.find(p => p.id === personaId) : null;
            const isDefault = persona && appData.user.defaultPersonaId === persona.id;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div></div>
                    <span class="header-title">${personaId ? '编辑' : '新建'}自设</span>
                </div>
                <div class="content-area form-page">
                    <img src="${persona?.avatar || 'https://img.js.design/assets/img/65a881fa383e6a42242a3f33.jpg'}" class="avatar-upload-preview" id="persona-editor-avatar" onclick="document.getElementById('persona-editor-avatar-input').click()">
                    <input type="file" id="persona-editor-avatar-input" class="file-input" accept="image/*">
                    <div class="form-group"><label>姓名</label><input type="text" id="persona-editor-name" value="${persona?.name || ''}"></div>
                    <div class="form-group">
                        <label>性别</label>
                        <select id="persona-editor-gender" class="form-input">
                            <option value="male" ${persona?.gender === 'male' ? 'selected' : ''}>男</option>
                            <option value="female" ${persona?.gender === 'female' ? 'selected' : ''}>女</option>
                            <option value="other" ${persona?.gender === 'other' ? 'selected' : ''}>其他</option>
                        </select>
                    </div>
                    <div class="form-group"><label>设定</label><textarea id="persona-editor-desc" rows="10">${persona?.description || ''}</textarea></div>
                    ${personaId ? `<button class="form-btn" style="background-color: #aaa;" onclick="setDefaultPersona(${personaId}, ${!isDefault})">${isDefault ? '取消置顶' : '设为默认'}</button>` : ''}
                    <button class="form-btn" onclick="saveSelfPersona(${personaId})">保存</button>
                    ${personaId ? `<button class="form-btn" style="background-color: var(--wechat-red); margin-top: 10px;" onclick="deleteSelfPersona(${personaId})">删除</button>` : ''}
                </div>
            `;
            document.getElementById('persona-editor-avatar-input').onchange = e => {
                handleImageUpload(e.target.files[0], dataUrl => {
                    showCropperModal(dataUrl, (croppedDataUrl) => {
                        document.getElementById('persona-editor-avatar').src = croppedDataUrl;
                    });
                });
            };
        }

        function saveSelfPersona(personaId = null) {
            const name = document.getElementById('persona-editor-name').value;
            if (!name) { showToast('姓名不能为空', 'error'); return; }
            const newPersona = {
                id: personaId || Date.now(),
                name,
                avatar: document.getElementById('persona-editor-avatar').src,
                gender: document.getElementById('persona-editor-gender').value,
                description: document.getElementById('persona-editor-desc').value
            };
            if (personaId) {
                const index = appData.user.personas.findIndex(p => p.id === personaId);
                appData.user.personas[index] = newPersona;
            } else {
                if (!appData.user.personas) appData.user.personas = [];
                appData.user.personas.push(newPersona);
            }
            saveData(true, goBack);
        }

        function deleteSelfPersona(personaId) {
            if (confirm('确定删除此自设吗？')) {
                appData.user.personas = appData.user.personas.filter(p => p.id !== personaId);
                appData.contacts.forEach(c => { if (c.boundPersonaId === personaId) c.boundPersonaId = null; });
                if (appData.user.defaultPersonaId === personaId) appData.user.defaultPersonaId = null;
                saveData(true, goBack);
            }
        }
        
        function setDefaultPersona(personaId, isDefault) {
            if (isDefault) {
                appData.user.defaultPersonaId = personaId;
            } else {
                if (appData.user.defaultPersonaId === personaId) {
                    appData.user.defaultPersonaId = null;
                }
            }
            saveData(true, () => renderSelfPersonaEditorPage(document.getElementById('self-persona-editor-page'), personaId));
        }

        function showBindSelfPersonaModal(contactId) {
            const contact = appData.contacts.find(c => c.id === contactId);
            const personas = appData.user.personas;
            if (!personas || personas.length === 0) { showToast('请先在“我”页面创建自设', 'error'); return; }
            let optionsHtml = personas.map(p => `
                <div class="list-item" onclick="setBoundPersona(${contactId}, ${p.id})">
                    <div class="details"><span class="name">${p.name}</span></div>
                    ${contact.boundPersonaId === p.id ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                </div>`).join('');
            optionsHtml += `<div class="list-item" onclick="setBoundPersona(${contactId}, null)" style="justify-content: center; color: var(--wechat-red);">解除绑定</div>`;
            showModal('bind-persona-modal', `<div class="modal-content"><div class="modal-title">为 ${contact.name} 绑定自设</div><div class="list-view" style="background: transparent;">${optionsHtml}</div></div>`);
        }

        function setBoundPersona(contactId, personaId) {
            const contact = appData.contacts.find(c => c.id === contactId);
            contact.boundPersonaId = personaId;
            saveData(true);
            closeModal('bind-persona-modal');
        }

        function renderLanguageSettingsPage(container) {
            if (!container) return;
            const languages = {
                'zh-CN': '简体中文', 'zh-TW': '繁体中文 (台湾)', 'zh-HK': '繁体中文 (香港)', 'zh-MO': '繁体中文 (澳门)',
                'en': 'English (英语)', 'ja': '日本語 (日语)', 'ko': '한국어 (韩语)', 'de': 'Deutsch (德语)',
                'fr': 'Français (法语)', 'ru': 'Русский (俄语)', 'es': 'Español (西班牙语)', 'pt': 'Português (葡萄牙语)',
                'it': 'Italiano (意大利语)', 'nl': 'Nederlands (荷兰语)', 'pl': 'Polski (波兰语)', 'sv': 'Svenska (瑞典语)',
                'th': 'ไทย (泰语)', 'vi': 'Tiếng Việt (越南语)', 'id': 'Bahasa Indonesia (印尼语)', 'ms': 'Bahasa Melayu (马来语)',
                'ar': 'العربية (阿拉伯语)', 'hi': 'हिन्दी (印地语)', 'bn': 'বাংলা (孟加拉语)', 'tr': 'Türkçe (土耳其语)',
                'fa': 'فارسی (波斯语)', 'ur': 'اردو (乌尔都语)', 'he': 'עברית (希伯来语)', 'el': 'Ελληνικά (希腊语)',
                'hu': 'Magyar (匈牙利语)', 'cs': 'Čeština (捷克语)', 'ro': 'Română (罗马尼亚语)', 'fi': 'Suomi (芬兰语)',
                'da': 'Dansk (丹麦语)', 'no': 'Norsk (挪威语)', 'uk': 'Українська (乌克兰语)', 'yue': '粤语'
            };
            let optionsHtml = '';
            for (const [code, name] of Object.entries(languages)) {
                optionsHtml += `<option value="${code}" ${appData.settings.charLanguage === code ? 'selected' : ''}>${name}</option>`;
            }
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>设置</span></div>
                    <span class="header-title">角色语言设置</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>选择角色回复时使用的语言</label>
                        <select id="char-language-select">${optionsHtml}</select>
                    </div>
                    <button class="form-btn" onclick="saveCharLanguage()">保存</button>
                </div>
            `;
        }

        function saveCharLanguage() {
            appData.settings.charLanguage = document.getElementById('char-language-select').value;
            saveData(true);
        }

        function renderStorageSettingsPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>设置</span></div>
                    <span class="header-title">储存空间</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="clearCache()">
                        <div class="details"><span class="name">清理储存</span><p class="subtext">清理AI生成的临时缓存数据，不影响聊天记录。</p></div>
                    </div>
                    <div class="list-item" onclick="clearAllLocalData()">
                        <div class="details"><span class="name" style="color: var(--wechat-red);">清理本地数据</span><p class="subtext">将清空所有角色、聊天记录和设置，此操作不可逆！</p></div>
                    </div>
                </div>
            `;
        }

        function clearCache() {
            if (confirm('确定要清理临时缓存吗？')) {
                appData.shopping.cachedGifts = [];
                appData.shopping.cachedFoods = [];
                saveData(true);
            }
        }

        async function clearAllLocalData() {
            if (prompt('此操作将删除所有数据且无法恢复！请输入 "确认删除" 以继续。') === '确认删除') {
                try {
                    const msg = await dataManager.clearAllData();
                    showToast(msg + ' 页面将刷新。');
                    setTimeout(() => location.reload(), 1500);
                } catch (error) {
                    showToast(error, 'error');
                }
            } else {
                showToast('操作已取消。');
            }
        }

        function renderNotificationSettingsPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>设置</span></div>
                    <span class="header-title">聊天提示音</span>
                </div>
                <div class="content-area form-page">
                    ${['send', 'receive', 'ringtone'].map(type => `
                        <div class="form-group">
                            <label>${{send:'发送提示音', receive:'消息提示音', ringtone:'来电提示音'}[type]}</label>
                            <input type="text" id="sound-url-${type}" placeholder="输入音频URL..." value="${appData.settings.notifications[type] || ''}">
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button class="form-btn" style="background-color: #aaa; margin: 0; flex: 1;" onclick="document.getElementById('sound-file-${type}').click()">选择文件</button>
                                <button class="form-btn" style="background-color: var(--wechat-blue); margin: 0; flex: 0 0 80px;" onclick="testNotificationSound('${type}')">试听</button>
                            </div>
                            <input type="file" id="sound-file-${type}" class="file-input" accept="audio/*" onchange="handleSoundUpload(this.files[0], '${type}')">
                        </div>
                        <div class="list-divider"></div>
                    `).join('')}
                    <button class="form-btn" onclick="saveNotificationSounds()">保存所有</button>
                </div>
            `;
        }

        function handleSoundUpload(file, type) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById(`sound-url-${type}`).value = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function saveNotificationSounds() {
            appData.settings.notifications.send = document.getElementById('sound-url-send').value;
            appData.settings.notifications.receive = document.getElementById('sound-url-receive').value;
            appData.settings.notifications.ringtone = document.getElementById('sound-url-ringtone').value;
            saveData(true);
            applyBeautifySettings();
        }

        function playNotificationSound(type) {
            if (appData.settings.dnd) return;
            const player = document.getElementById(`${type}-sound-player`);
            if (player && player.src) {
                player.currentTime = 0;
                player.play().catch(e => console.error(`无法播放提示音: ${e.message}`));
            }
        }
        
        function testNotificationSound(type) {
            const url = document.getElementById(`sound-url-${type}`).value;
            if (url) {
                const testPlayer = new Audio(url);
                testPlayer.play().catch(e => showToast(`试听失败: ${e.message}`, 'error'));
            }
        }

        let callTimerInterval;
        let callStartTime;
        let callDurationOffset = 0;

        function startVoiceCall(chatId, chatType, initiator) {
            if (chatType !== 'individual') { showToast('语音通话仅支持单聊。', 'error'); return; }
            const contact = appData.contacts.find(c => c.id == chatId);
            if (!contact) return;

            playNotificationSound('ringtone');
            showPage('voice-call-page', renderVoiceCallPage, chatId, initiator);
        }

        function renderVoiceCallPage(container, chatId, initiator) {
            if (!container) return;
            const contact = appData.contacts.find(c => c.id == chatId);
            container.innerHTML = `
                <div class="voice-call-container" style="background-image: url('${contact.avatar}')">
                    <div class="voice-call-header">
                        <img src="${contact.avatar}" class="avatar">
                        <p class="name">${contact.remark || contact.name}</p>
                        <p class="voice-call-status" id="call-status">正在响铃...</p>
                    </div>
                    <div class="voice-call-chat-area" id="call-chat-area"></div>
                    <div class="voice-call-input-bar" id="call-input-bar" style="display: none;">
                        <input type="text" id="call-input" placeholder="输入...">
                    </div>
                    <div class="voice-call-controls" id="call-controls">
                        ${initiator === 'user' ? `
                        
                        <div class="control-btn" onclick="endVoiceCall('${chatId}', 'cancelled')">
                            <div class="icon-wrapper hangup"><i class="fas fa-phone-slash"></i></div>
                            <span>挂断</span>
                        </div>
                        ` : `
                        <div class="control-btn" onclick="endVoiceCall('${chatId}', 'rejected')">
                            <div class="icon-wrapper hangup"><i class="fas fa-phone-slash"></i></div>
                            <span>拒绝</span>
                        </div>
                        <div class="control-btn" onclick="answerVoiceCall('${chatId}')">
                            <div class="icon-wrapper" style="background: var(--wechat-green);"><i class="fas fa-phone"></i></div>
                            <span>接听</span>
                        </div>
                        `}
                    </div>
                </div>
            `;

            if (initiator === 'user') {
                setTimeout(() => answerVoiceCall(chatId), 3000);
            }
        }

        function answerVoiceCall(chatId) {
            document.getElementById('ringtone-player').pause();
            const statusEl = document.getElementById('call-status');
            
            const inputBar = document.getElementById('call-input-bar');
            if (inputBar) inputBar.style.display = 'flex';

            const controls = document.getElementById('call-controls');
            if (controls) {
                controls.innerHTML = `
                    <div class="control-btn" onclick="minimizeVoiceCall('${chatId}')">
                        <div class="icon-wrapper minimize"><i class="fas fa-window-minimize"></i></div>
                        <span>最小化</span>
                    </div>
                    <div class="control-btn" onclick="endVoiceCall('${chatId}', 'ended')">
                        <div class="icon-wrapper hangup"><i class="fas fa-phone-slash"></i></div>
                        <span>挂断</span>
                    </div>
                `;
            }
            
            if (!callStartTime) {
                callStartTime = Date.now();
                callDurationOffset = 0;
            }

            clearInterval(callTimerInterval);
            callTimerInterval = setInterval(() => {
                const statusTimerEl = document.getElementById('call-status');
                const minimizedStatusEl = document.getElementById('minimized-call-status');
                const duration = Math.floor(((Date.now() - callStartTime) + callDurationOffset) / 1000);
                const minutes = String(Math.floor(duration / 60)).padStart(2, '0');
                const seconds = String(duration % 60).padStart(2, '0');
                const timeString = `通话中 ${minutes}:${seconds}`;
                if (statusTimerEl) statusTimerEl.textContent = timeString;
                if (minimizedStatusEl) minimizedStatusEl.textContent = timeString;
            }, 1000);

            const callInput = document.getElementById('call-input');
            if (callInput) {
                callInput.onkeydown = async (e) => {
                    if (e.key === 'Enter' && callInput.value.trim() !== '') {
                        const text = callInput.value.trim();
                        callInput.value = '';
                        appendCallMessage('user', text);
                        const chatHistory = appData.contacts.find(c => c.id == chatId).conversation;
                        const callChatHistory = document.getElementById('call-chat-area').innerText;
                        const prompt = `你正在和'${appData.user.nickname}'语音通话。对方刚刚说：“${text}”。请根据你们之前的聊天记录和本次通话内容，用简短的口语进行回复。\n\n【聊天记录】:\n${chatHistory.slice(-10).map(m=>m.content.content).join('\n')}\n\n【通话内容】:\n${callChatHistory}`;
                        const replies = await getAiReply(chatId, 'wechat', prompt);
                        replies.forEach(reply => appendCallMessage('char', reply));
                    }
                };
            }
        }

        function appendCallMessage(sender, text) {
            const chatArea = document.getElementById('call-chat-area');
            if (!chatArea) return;
            const contact = appData.contacts.find(c => c.id == appData.activeChat.id);
            const senderName = sender === 'user' ? appData.user.nickname : (contact.remark || contact.name);
            chatArea.innerHTML += `<p><b>${senderName}:</b> ${text}</p>`;
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function endVoiceCall(chatId, reason) {
            document.getElementById('ringtone-player').pause();
            clearInterval(callTimerInterval);
            let durationText = '';
            if (reason === 'ended' && callStartTime) {
                const duration = Math.floor(((Date.now() - callStartTime) + callDurationOffset) / 1000);
                const minutes = Math.floor(duration / 60);
                const seconds = duration % 60;
                durationText = `通话时长 ${minutes > 0 ? `${minutes}分` : ''}${seconds}秒`;
            } else if (reason === 'cancelled') {
                durationText = '已取消';
            } else if (reason === 'rejected') {
                durationText = '对方已拒绝';
            }
            
            if (durationText) {
                sendMessage(chatId, 'individual', { duration: durationText }, 'voice_call', 'wechat');
            }
            callStartTime = null;
            callDurationOffset = 0;
            goBack();
        }

        function minimizeVoiceCall(chatId) {
            const contact = appData.contacts.find(c => c.id == chatId);
            const minimizedWindow = document.createElement('div');
            minimizedWindow.id = 'minimized-call-window';
            minimizedWindow.className = 'minimized-call-window';
            minimizedWindow.innerHTML = `
                <img src="${contact.avatar}" class="avatar">
                <p>${contact.remark || contact.name}</p>
                <p class="status" id="minimized-call-status">通话中...</p>
            `;
            minimizedWindow.onclick = () => {
                document.getElementById('minimized-call-container').innerHTML = '';
                showPage('voice-call-page', renderVoiceCallPage, chatId, 'user');
                callDurationOffset += Date.now() - callStartTime;
                callStartTime = Date.now();
                setTimeout(() => answerVoiceCall(chatId), 100);
            };
            document.getElementById('minimized-call-container').appendChild(minimizedWindow);
            goBack();
        }

        function renderWallpaperSettingsPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>返回</span></div>
                    <span class="header-title">更换壁纸</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>主屏壁纸</label>
                        <img src="${appData.settings.beautify.homeScreenWallpaper}" class="avatar-upload-preview" style="width: 150px; height: auto;" id="wallpaper-preview">
                        <button class="form-btn" onclick="document.getElementById('wallpaper-input').click()">选择图片</button>
                        <input type="file" id="wallpaper-input" class="file-input" accept="image/*">
                    </div>
                </div>
            `;
            document.getElementById('wallpaper-input').onchange = e => {
                handleImageUpload(e.target.files[0], url => {
                    appData.settings.beautify.homeScreenWallpaper = url;
                    saveData(true);
                    applyBeautifySettings();
                    document.getElementById('wallpaper-preview').src = url;
                });
            };
        }

        function renderAppIconSettingsPage(container) {
            if (!container) return;
            const icons = appData.settings.beautify.appIcons;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>返回</span></div>
                    <span class="header-title">更换APP图标</span>
                </div>
                <div class="content-area form-page">
                    ${Object.keys(icons).map(app => `
                        <div class="form-group">
                            <label>${app.charAt(0).toUpperCase() + app.slice(1)}</label>
                            <img src="${icons[app]}" class="avatar-upload-preview" id="app-icon-preview-${app}" onclick="document.getElementById('app-icon-input-${app}').click()">
                            <input type="file" id="app-icon-input-${app}" class="file-input" accept="image/*" onchange="handleAppIconUpload(this.files[0], '${app}')">
                        </div>
                    `).join('<div class="list-divider"></div>')}
                </div>
            `;
        }

        function handleAppIconUpload(file, appName) {
            handleImageUpload(file, url => {
                appData.settings.beautify.appIcons[appName] = url;
                saveData(true);
                document.getElementById(`app-icon-preview-${appName}`).src = url;
                renderHomeScreen(document.getElementById('home-screen-page'));
            });
        }

        function renderAppLayoutSettingsPage(container) {
            if (!container) return;
            const b = appData.settings.beautify;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>返回</span></div>
                    <span class="header-title">调整APP图标布局</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>图标大小: <span id="app-size-value">${b.appIconSize}</span>px</label>
                        <input type="range" id="app-size-input" min="40" max="80" value="${b.appIconSize}" oninput="document.getElementById('app-size-value').textContent = this.value;">
                    </div>
                    <div class="form-group">
                        <label>图标间距: <span id="app-gap-value">${b.appIconGap}</span>px</label>
                        <input type="range" id="app-gap-input" min="10" max="40" value="${b.appIconGap}" oninput="document.getElementById('app-gap-value').textContent = this.value;">
                    </div>
                    <div class="form-group">
                        <label>图标圆角: <span id="app-radius-value">${b.appIconRadius}</span>px</label>
                        <input type="range" id="app-radius-input" min="0" max="40" value="${b.appIconRadius}" oninput="document.getElementById('app-radius-value').textContent = this.value;">
                    </div>
                    <button class="form-btn" id="save-app-layout-btn">应用</button>
                </div>
            `;
            document.getElementById('save-app-layout-btn').onclick = () => {
                b.appIconSize = parseInt(document.getElementById('app-size-input').value);
                b.appIconGap = parseInt(document.getElementById('app-gap-input').value);
                b.appIconRadius = parseInt(document.getElementById('app-radius-input').value);
                saveData(true);
                applyBeautifySettings();
                renderHomeScreen(document.getElementById('home-screen-page'));
            };
        }

        function updateSystemUI() {
            const now = new Date();
            const timeString = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            const dateString = `${now.getFullYear()}年${now.getMonth() + 1}月${now.getDate()}日 ${['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'][now.getDay()]}`;

            const timeEl = document.getElementById('status-bar-time');
            if (timeEl) timeEl.textContent = timeString;
            const dndEl = document.getElementById('status-bar-dnd');
            if (dndEl) dndEl.style.display = appData.settings.dnd ? 'inline' : 'none';

            const homeScreenTime = document.getElementById('home-screen-time');
            if (homeScreenTime) homeScreenTime.textContent = timeString;
            const homeScreenDate = document.getElementById('home-screen-date');
            if (homeScreenDate) homeScreenDate.textContent = dateString;

            const networkEl = document.getElementById('status-bar-network');
            if (networkEl) {
                if (navigator.onLine) {
                    const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
                    const type = connection ? (connection.effectiveType || '4g') : '4g';
                    networkEl.innerHTML = type.includes('fi') ? '<i class="fas fa-wifi"></i>' : `<span>${type.toUpperCase()}</span>`;
                } else {
                    networkEl.innerHTML = '<i class="fas fa-plane"></i>';
                }
            }

            if (navigator.getBattery) {
                navigator.getBattery().then(battery => {
                    const batteryFill = document.getElementById('battery-fill');
                    const batteryPercentInside = document.getElementById('battery-percent-inside');
                    const batteryPercentOutside = document.getElementById('battery-percent-outside');
                    if (!batteryFill || !batteryPercentInside || !batteryPercentOutside) return;
                    const level = Math.floor(battery.level * 100);
                    batteryFill.style.width = `${level}%`;
                    batteryPercentInside.textContent = level;
                    batteryPercentOutside.textContent = `${level}%`;
                    batteryFill.classList.toggle('charging', battery.charging);
                    batteryFill.classList.toggle('low', level <= 20 && !battery.charging);
                });
            }
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            const activationModal = document.getElementById('activation-modal');
            const isActivated = localStorage.getItem('lovelyPhoneActivated') === 'true';

            if (isActivated) {
                activationModal.style.display = 'none';
                showLoadingScreen();
            } else {
                activationModal.style.display = 'flex';
                const activationInput = document.getElementById('activation-input');
                document.getElementById('activation-btn').onclick = () => {
                    if (activationInput.value.toUpperCase() === 'EVOL还是LOVE') {
                        localStorage.setItem('lovelyPhoneActivated', 'true');
                        activationModal.style.display = 'none';
                        showLoadingScreen();
                    } else {
                        showToast('激活码错误！', 'error');
                    }
                };
            }
        });

        function showLoadingScreen() {
            const loadingScreen = document.getElementById('loading-screen');
            const progressBar = document.getElementById('loading-progress-bar');
            const phoneBody = document.getElementById('phone-body');
            
            loadingScreen.style.display = 'flex';
            
            let progress = 0;
            const duration = Math.random() * 7000 + 3000;
            const intervalTime = 50;
            const increment = 100 / (duration / intervalTime);

            const interval = setInterval(() => {
                progress += increment;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    setTimeout(async () => {
                        await initializePhone();
                        loadingScreen.style.display = 'none';
                        phoneBody.style.display = 'flex';
                    }, 500);
                }
                progressBar.style.width = `${progress}%`;
            }, intervalTime);
        }

        async function initializePhone() {
            await dataManager.init();
            await loadData();
            applyBeautifySettings();
            
            pageHistory = ['home-screen-page'];
            showPage('home-screen-page', renderHomeScreen);

            updateSystemUI();
            setInterval(updateSystemUI, 30000);

            document.querySelectorAll('#wechat-app-page .tab-item').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelector('#wechat-app-page .tab-item.active').classList.remove('active');
                    tab.classList.add('active');
                    renderMainContent(tab.dataset.page);
                });
            });

            document.getElementById('status-bar').addEventListener('click', toggleNotificationCenter);
            
            checkAndPostCharMoments();
            if (appData.settings.backgroundInteraction.enabled) startBackgroundInteraction();
            
            initAllDynamicIslands();
        }

        function renderFontColorSettingsPage(container) {
            if (!container) return;
            const b = appData.settings.beautify;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>返回</span></div>
                    <span class="header-title">调整字体颜色</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>主屏幕时间颜色</label>
                        <input type="color" id="home-font-color-input" value="${b.homeScreenFontColor}">
                    </div>
                    <div class="form-group">
                        <label>全局主要字体颜色</label>
                        <input type="color" id="global-font-color-input" value="${b.globalFontColor}">
                    </div>
                    <button class="form-btn" id="save-font-color-btn">应用</button>
                </div>
            `;
            document.getElementById('save-font-color-btn').onclick = () => {
                b.homeScreenFontColor = document.getElementById('home-font-color-input').value;
                b.globalFontColor = document.getElementById('global-font-color-input').value;
                saveData(true);
                applyBeautifySettings();
            };
        }

        function renderBatterySettingsPage(container) {
            if (!container) return;
            const batterySettings = appData.settings.beautify.batteryIcon;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>返回</span></div>
                    <span class="header-title">电池设置</span>
                </div>
                <div class="content-area form-page">
                    <div class="form->group">
                        <label>调整图标</label>
                        <select id="battery-display-mode">
                            <option value="outside" ${batterySettings.displayMode === 'outside' ? 'selected' : ''}>电池图标外</option>
                            <option value="inside" ${batterySettings.displayMode === 'inside' ? 'selected' : ''}>电池图标内</option>
                            <option value="none" ${batterySettings.displayMode === 'none' ? 'selected' : ''}>不显示数字</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>电池数字颜色</label>
                        <input type="color" id="battery-percent-color-input" value="${batterySettings.percentColor}">
                    </div>
                    <div class="list-divider"></div>
                    <div class="form-group">
                        <label>更换电池图标 (URL)</label>
                        <input type="text" id="battery-icon-url" placeholder="输入图片URL..." value="${batterySettings.iconUrl || ''}">
                    </div>
                    <div class="form-group">
                        <label>更换电池图标 (本地文件)</label>
                        <button class="form-btn" style="background-color: #aaa;" onclick="document.getElementById('battery-icon-file').click()">选择图片</button>
                        <input type="file" id="battery-icon-file" class="file-input" accept="image/*">
                    </div>
                    <button class="form-btn" id="save-battery-settings-btn">保存</button>
                </div>
            `;

            document.getElementById('battery-icon-file').onchange = e => {
                handleImageUpload(e.target.files[0], url => {
                    document.getElementById('battery-icon-url').value = url;
                });
            };

            document.getElementById('save-battery-settings-btn').onclick = () => {
                batterySettings.displayMode = document.getElementById('battery-display-mode').value;
                batterySettings.iconUrl = document.getElementById('battery-icon-url').value;
                batterySettings.percentColor = document.getElementById('battery-percent-color-input').value;
                saveData(true);
                applyBeautifySettings();
            };
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.position = 'fixed';
            toast.style.bottom = '80px';
            toast.style.left = '50%';
            toast.style.transform = 'translateX(-50%)';
            toast.style.padding = '10px 20px';
            toast.style.borderRadius = '20px';
            toast.style.color = 'white';
            toast.style.background = type === 'error' ? 'rgba(250, 81, 81, 0.8)' : 'rgba(7, 193, 96, 0.8)';
            toast.style.zIndex = '99999';
            toast.style.backdropFilter = 'blur(5px)';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ★★★ 优化：通知栏交互 ★★★
        function toggleNotificationCenter(event) {
            const nc = document.getElementById('notification-center');
            if (event.target.closest('.back-btn') || event.target.closest('.clear-all-btn')) {
                // 如果点击的是返回或清除按钮，则不切换显示状态，仅执行对应功能
                return;
            }
            nc.classList.toggle('visible');
            if (nc.classList.contains('visible')) {
                renderNotifications();
            }
        }

        function addNotification(notification) {
            if (appData.settings.dnd) return;
            appData.notifications.unshift({ ...notification, id: Date.now(), read: false });
            if (appData.notifications.length > 50) {
                appData.notifications.pop();
            }
            if (document.getElementById('notification-center').classList.contains('visible')) {
                renderNotifications();
            }
            if (appData.settings.beautify.statusBarDisplay === 'island') {
                showDynamicIslandNotification(notification);
            }
        }

        function clearAllNotifications() {
            appData.notifications = [];
            saveData();
            renderNotifications();
            showToast('通知已全部清除');
        }

        function showDynamicIslandNotification(notification) {
            const island = document.getElementById('dynamic-island');
            const content = document.getElementById('island-notification-content');
            if (!island || !content) return;

            if (island.classList.contains('music-mode')) {
                console.log("Music is playing, notification suppressed in Dynamic Island.");
                return;
            }

            content.querySelector('.app-icon').src = notification.icon;
            content.querySelector('.title').textContent = notification.title;
            content.querySelector('.text').textContent = notification.text;

            island.classList.add('active');

            setTimeout(() => {
                island.classList.remove('active');
            }, 4000);
        }

        function renderNotifications() {
            const list = document.getElementById('notification-list');
            if (!list) return;
            if (appData.notifications.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:white; opacity:0.7; margin-top: 50px;">无新通知</p>';
                return;
            }
            list.innerHTML = appData.notifications.map(n => `
                <div class="notification-item">
                    <img src="${n.icon}" class="app-icon">
                    <div class="content">
                        <div class="title">${n.title}</div>
                        <div class="text">${n.text}</div>
                    </div>
                </div>
            `).join('');
        }

        let currentSpeech = null;
        function toggleVoiceBubble(element, msgId, chatId, chatType, source) {
            const bubble = element.closest('.voice-bubble');
            if (!bubble) return;

            let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
            const message = chat.conversation.find(m => m.id == msgId);
            if (!message || !message.content.text) return;

            if (speechSynthesis.speaking && currentSpeech && currentSpeech.text === message.content.text) {
                speechSynthesis.cancel();
                currentSpeech = null;
                return;
            }
            
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(message.content.text);
            currentSpeech = utterance;
            
            utterance.onend = () => { currentSpeech = null; };
            utterance.onerror = () => {
                currentSpeech = null;
                showToast('语音播放失败', 'error');
            };

            speechSynthesis.speak(utterance);
        }

        function renderAnniversaryAppPage(container) {
            if (!container) {
                console.error("Anniversary App Firewall: Container not found.");
                return;
            }
            const anniversary = appData.homeScreenWidgets.anniversary;
            const countdown = appData.homeScreenWidgets.countdown;
            const customText = appData.homeScreenWidgets.customText;

            const characterOptions = appData.contacts.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div></div>
                    <span class="header-title">纪念日 & 小组件</span>
                </div>
                <div class="content-area form-page">
                    <h3>纪念日</h3>
                    <div class="list-item">
                        <div class="details"><span class="name">在主屏幕显示</span></div>
                        <label class="switch"><input type="checkbox" id="anniversary-enabled" ${anniversary.enabled ? 'checked' : ''}><span class="slider"></span></label>
                    </div>
                    <div class="form-group">
                        <label>选择角色</label>
                        <select id="anniversary-char">${characterOptions}</select>
                    </div>
                    <div class="form-group">
                        <label>纪念日日期</label>
                        <input type="date" id="anniversary-date" value="${anniversary.date}">
                    </div>
                    <div class="form-group">
                        <label>描述 (例如：相爱)</label>
                        <input type="text" id="anniversary-desc" value="${anniversary.description}">
                    </div>
                    <div class="form-group">
                        <label>背景图片</label>
                        <img src="${anniversary.image || 'https://source.unsplash.com/random/100x100?love'}" class="avatar-upload-preview" id="anniversary-image-preview" onclick="document.getElementById('anniversary-image-input').click()">
                        <input type="file" id="anniversary-image-input" class="file-input" accept="image/*">
                    </div>

                    <div class="list-divider"></div>
                    <h3>倒数日</h3>
                    <div class="list-item">
                        <div class="details"><span class="name">在主屏幕显示</span></div>
                        <label class="switch"><input type="checkbox" id="countdown-enabled" ${countdown.enabled ? 'checked' : ''}><span class="slider"></span></label>
                    </div>
                    <div class="form-group">
                        <label>选择角色</label>
                        <select id="countdown-char">${characterOptions}</select>
                    </div>
                    <div class="form-group">
                        <label>目标日期</label>
                        <input type="date" id="countdown-date" value="${countdown.date}">
                    </div>
                    <div class="form-group">
                        <label>描述 (例如：生日)</label>
                        <input type="text" id="countdown-desc" value="${countdown.description}">
                    </div>
                    <div class="form-group">
                        <label>背景图片</label>
                        <img src="${countdown.image || 'https://source.unsplash.com/random/100x100?calendar'}" class="avatar-upload-preview" id="countdown-image-preview" onclick="document.getElementById('countdown-image-input').click()">
                        <input type="file" id="countdown-image-input" class="file-input" accept="image/*">
                    </div>

                    <div class="list-divider"></div>
                    <h3>自定义文案</h3>
                    <div class="form-group">
                        <label>文案内容 (50字以内)</label>
                        <textarea id="custom-text-input" maxlength="50" rows="3">${customText.text}</textarea>
                    </div>

                    <button class="form-btn" onclick="saveAnniversarySettings()">保存</button>
                </div>
            `;

            if (anniversary.characterId) document.getElementById('anniversary-char').value = anniversary.characterId;
            if (countdown.characterId) document.getElementById('countdown-char').value = countdown.characterId;

            document.getElementById('anniversary-image-input').onchange = e => handleImageUpload(e.target.files[0], url => document.getElementById('anniversary-image-preview').src = url);
            document.getElementById('countdown-image-input').onchange = e => handleImageUpload(e.target.files[0], url => document.getElementById('countdown-image-preview').src = url);
        }

        function saveAnniversarySettings() {
            const widgets = appData.homeScreenWidgets;
            widgets.anniversary.enabled = document.getElementById('anniversary-enabled').checked;
            widgets.anniversary.characterId = document.getElementById('anniversary-char').value;
            widgets.anniversary.date = document.getElementById('anniversary-date').value;
            widgets.anniversary.description = document.getElementById('anniversary-desc').value;
            widgets.anniversary.image = document.getElementById('anniversary-image-preview').src;

            widgets.countdown.enabled = document.getElementById('countdown-enabled').checked;
            widgets.countdown.characterId = document.getElementById('countdown-char').value;
            widgets.countdown.date = document.getElementById('countdown-date').value;
            widgets.countdown.description = document.getElementById('countdown-desc').value;
            widgets.countdown.image = document.getElementById('countdown-image-preview').src;

            widgets.customText.text = document.getElementById('custom-text-input').value;

            saveData(true, () => {
                renderHomeScreen(document.getElementById('home-screen-page'));
                goBack();
            });
        }

        function renderStatusBarSettingsPage(container) {
            if (!container) return;
            const currentMode = appData.settings.beautify.statusBarDisplay;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>设置</span></div>
                    <span class="header-title">顶部状态栏</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="setStatusBarDisplay('default')">
                        <div class="details"><span class="name">默认</span></div>
                        ${currentMode === 'default' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setStatusBarDisplay('notch')">
                        <div class="details"><span class="name">刘海屏</span></div>
                        ${currentMode === 'notch' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setStatusBarDisplay('island')">
                        <div class="details"><span class="name">灵动岛</span></div>
                        ${currentMode === 'island' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setStatusBarDisplay('island-v2')">
                        <div class="details"><span class="name">iOS灵动岛</span></div>
                        ${currentMode === 'island-v2' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setStatusBarDisplay('evol-island')">
                        <div class="details"><span class="name">Evol灵动岛</span></div>
                        ${currentMode === 'evol-island' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setStatusBarDisplay('ins-island')">
                        <div class="details"><span class="name">ins灵动岛</span></div>
                        ${currentMode === 'ins-island' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                </div>
            `;
        }

        function setStatusBarDisplay(mode) {
            appData.settings.beautify.statusBarDisplay = mode;
            saveData();
            applyBeautifySettings();
            renderStatusBarSettingsPage(document.getElementById('status-bar-settings-page'));
        }

        function renderAccountingAppPage(container) {
            if (!container) {
                console.error("Accounting App Firewall: Container not found.");
                return;
            }
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div></div>
                    <span class="header-title">手账记账</span>
                </div>
                <div class="content-area">
                    <div class="accounting-header">
                        <h1>手账记账</h1>
                        <button class="btn" id="newTransactionBtn">新建记录</button>
                    </div>

                    <div class="summary">
                        <div class="summary-item">
                            <div class="summary-title">收入</div>
                            <div class="summary-value income-summary" id="incomeTotal">¥0</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-title">支出</div>
                            <div class="summary-value expense-summary" id="expenseTotal">¥0</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-title">结余</div>
                            <div class="summary-value balance-summary" id="balanceTotal">¥0</div>
                        </div>
                    </div>

                    <div class="card" id="transactionForm" style="display: none;">
                        <div class="form-group">
                            <label for="transactionType">类型</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="income" name="transactionType" value="income" checked>
                                    <label for="income">收入</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="expense" name="transactionType" value="expense">
                                    <label for="expense">支出</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="transactionAmount">金额</label>
                            <input type="number" id="transactionAmount" placeholder="输入金额">
                        </div>
                        <div class="form-group">
                            <label for="transactionTitle">标题</label>
                            <input type="text" id="transactionTitle" placeholder="例如: 工资、餐饮">
                        </div>
                        <div class="form-group">
                            <label for="transactionCategory">分类</label>
                            <select id="transactionCategory">
                                <option value="工资">工资</option>
                                <option value="奖金">奖金</option>
                                <option value="投资">投资</option>
                                <option value="餐饮">餐饮</option>
                                <option value="购物">购物</option>
                                <option value="交通">交通</option>
                                <option value="娱乐">娱乐</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="transactionDate">日期</label>
                            <input type="date" id="transactionDate">
                        </div>
                        <button class="btn" id="saveTransactionBtn">保存</button>
                    </div>

                    <div class="card">
                        <h2 style="margin-bottom: 16px;">交易记录</h2>
                        <ul class="transaction-list" id="transactionList"></ul>
                    </div>
                </div>
            `;
            initAccountingApp();
        }

        function initAccountingApp() {
            const newTransactionBtn = document.getElementById('newTransactionBtn');
            const transactionForm = document.getElementById('transactionForm');
            const saveTransactionBtn = document.getElementById('saveTransactionBtn');

            newTransactionBtn.addEventListener('click', () => {
                transactionForm.style.display = transactionForm.style.display === 'none' ? 'block' : 'none';
                document.getElementById('transactionAmount').value = '';
                document.getElementById('transactionTitle').value = '';
                document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            });

            saveTransactionBtn.addEventListener('click', () => {
                const type = document.querySelector('input[name="transactionType"]:checked').value;
                const amount = parseFloat(document.getElementById('transactionAmount').value);
                const title = document.getElementById('transactionTitle').value;
                const category = document.getElementById('transactionCategory').value;
                const date = document.getElementById('transactionDate').value;
                
                if (!amount || !title) {
                    showToast('请输入金额和标题', 'error');
                    return;
                }
                
                const transaction = { id: Date.now(), type, amount, title, category, date };
                
                appData.accounting.transactions.push(transaction);
                saveData(true);
                renderAccountingTransactions();
                updateAccountingSummary();
                
                transactionForm.style.display = 'none';
            });

            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            renderAccountingTransactions();
            updateAccountingSummary();
        }

        function renderAccountingTransactions() {
            const transactionList = document.getElementById('transactionList');
            if (!transactionList) return;
            const transactions = appData.accounting.transactions;

            if (transactions.length === 0) {
                transactionList.innerHTML = `
                    <li class="empty-state">
                        <div class="empty-icon">📊</div>
                        <div>暂无记录</div>
                        <div style="font-size: 14px; margin-top: 8px;">点击上方"新建记录"添加第一笔交易</div>
                    </li>
                `;
                return;
            }
            
            transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            transactionList.innerHTML = transactions.map(transaction => `
                <li class="transaction-item">
                    <div class="transaction-info">
                        <div class="transaction-title">${transaction.title}</div>
                        <div class="transaction-category">${transaction.category} • ${new Date(transaction.date).toLocaleDateString()}</div>
                    </div>
                    <div class="transaction-amount ${transaction.type}">
                        ${transaction.type === 'income' ? '+' : '-'}¥${transaction.amount.toFixed(2)}
                    </div>
                </li>
            `).join('');
        }

        function updateAccountingSummary() {
            const incomeTotalEl = document.getElementById('incomeTotal');
            const expenseTotalEl = document.getElementById('expenseTotal');
            const balanceTotalEl = document.getElementById('balanceTotal');
            if (!incomeTotalEl || !expenseTotalEl || !balanceTotalEl) return;

            const transactions = appData.accounting.transactions;
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const balance = income - expense;
            
            incomeTotalEl.textContent = `¥${income.toFixed(2)}`;
            expenseTotalEl.textContent = `¥${expense.toFixed(2)}`;
            balanceTotalEl.textContent = `¥${balance.toFixed(2)}`;
        }

        function renderGameApp(container) {
            if (!container) {
                console.error("Game App Firewall: Container not found.");
                return;
            }
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div></div>
                    <span class="header-title">小游戏</span>
                </div>
                <div class="content-area list-view">
                    <div class="list-item" onclick="showGuessWordSetup()">
                        <div class="details"><span class="name">你说我猜</span></div>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showToast('大富翁开发中...')">
                        <div class="details"><span class="name">大富翁</span></div>
                        <span class="info">开发中</span>
                    </div>
                    <div class="list-item" onclick="showToast('狼人杀开发中...')">
                        <div class="details"><span class="name">狼人杀</span></div>
                        <span class="info">开发中</span>
                    </div>
                </div>
            `;
        }

        function renderMemoApp(container) {
            if (!container) {
                console.error("Memo App Firewall: Container not found.");
                return;
            }
            container.innerHTML = `
                <div class="wechat-header" id="memo-list-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div></div>
                    <span class="header-title">备忘录</span>
                </div>
                <div class="wechat-header" id="memo-editor-header" style="display: none;">
                    <div class="header-left header-back-btn" onclick="saveAndExitMemoEditor()"><div class="ui-icon back"></div> <span class="back-text">备忘录</span></div>
                    <div class="header-right"><button class="form-btn" style="margin:0; padding: 5px 10px;" onclick="saveAndExitMemoEditor()">完成</button></div>
                </div>
                <div class="content-area" style="padding:0; display:flex; flex-direction:column;">
                    <div id="memo-main-view" style="display:flex; flex-direction:column; height:100%;">
                        <div class="search-bar" id="memo-search-bar" style="padding: 10px 15px;">
                            <input type="text" class="search-input" placeholder="搜索" style="width:100%; box-sizing:border-box;">
                        </div>
                        <div class="notes-list" id="memo-notes-list" style="flex:1; overflow-y:auto;"></div>
                    </div>
                    <div class="editor" id="memo-editor" style="display:none; flex:1;">
                        <textarea class="editor-content" id="memo-note-content" placeholder="开始输入..." style="height:100%;"></textarea>
                    </div>
                </div>
                <div class="wechat-tabbar" id="memo-toolbar">
                    <span id="memo-notes-count" style="flex:1; text-align:center; color:var(--wechat-text-secondary);"></span>
                    <div class="tab-item" id="memo-create-button" style="flex:0 0 50px;"><i class="fas fa-pen-square"></i></div>
                </div>
            `;
            renderMemoList();
            document.getElementById('memo-create-button').addEventListener('click', () => openMemoEditor());
            document.querySelector('#memo-search-bar .search-input').addEventListener('input', (e) => renderMemoList(e.target.value));
        }

        function renderMemoList(searchTerm = null) {
            const listEl = document.getElementById('memo-notes-list');
            const countEl = document.getElementById('memo-notes-count');
            if (!listEl || !countEl) return;
            let notesToRender = appData.memo.notes;
            if (searchTerm) {
                const lowerTerm = searchTerm.toLowerCase();
                notesToRender = appData.memo.notes.filter(note => 
                    (note.title && note.title.toLowerCase().includes(lowerTerm)) || 
                    (note.content && note.content.toLowerCase().includes(lowerTerm))
                );
            }
            listEl.innerHTML = '';
            notesToRender.forEach(note => {
                const noteItem = document.createElement('div');
                noteItem.className = 'list-item';
                noteItem.innerHTML = `
                    <div class="details">
                        <div class="name">${note.title || '无标题笔记'}</div>
                        <div class="subtext">${note.content.substring(0, 30)}${note.content.length > 30 ? '...' : ''}</div>
                    </div>
                    <div class="info">${note.date}</div>
                `;
                noteItem.addEventListener('click', () => openMemoEditor(note.id));
                listEl.appendChild(noteItem);
            });
            countEl.textContent = `${notesToRender.length}个备忘录`;
        }

        function openMemoEditor(noteId = null) {
            appData.memo.currentEditingNoteId = noteId;
            const note = noteId ? appData.memo.notes.find(n => n.id === noteId) : { title: '', content: '' };
            
            document.getElementById('memo-main-view').style.display = 'none';
            document.getElementById('memo-toolbar').style.display = 'none';
            document.getElementById('memo-list-header').style.display = 'none';
            
            renderMemoList();
        }

        // --- Status Settings ---
        function renderStatusSettingsPage(container) {
            if (!container) return;
            const userStatus = appData.user.status;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>我</span></div>
                    <span class="header-title">状态</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="setUserStatus('online')">
                        <div class="details"><span class="name"><span class="status-dot online"></span>在线</span></div>
                        ${userStatus === 'online' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setUserStatus('offline')">
                        <div class="details"><span class="name"><span class="status-dot offline"></span>离线</span></div>
                        ${userStatus === 'offline' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setUserStatus('invisible')">
                        <div class="details"><span class="name">隐身</span></div>
                        ${userStatus === 'invisible' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                </div>
            `;
        }

        function setUserStatus(status) {
            appData.user.status = status;
            saveData(true);
            renderStatusSettingsPage(document.getElementById('status-settings-page'));
        }

        // --- Sticker Picker (New & Improved) ---
        function showStickerPicker(source) {
            const overlay = document.getElementById('sticker-picker-overlay');
            if (!overlay) return;

            overlay.innerHTML = `
                <div class="sticker-picker-header">
                    <button class="icon-btn" onclick="toggleStickerPickerScreen()"><i class="fas fa-expand-alt"></i></button>
                    <span style="font-weight: 500;">选择表情</span>
                    <button class="icon-btn" onclick="closeStickerPicker()"><i class="fas fa-times"></i></button>
                </div>
                <div class="sticker-picker-content" id="sticker-picker-content"></div>
            `;
            
            const contentEl = document.getElementById('sticker-picker-content');
            let bodyHtml = '';
            if (appData.stickers.packs.length === 0) {
                bodyHtml = '<div style="text-align:center; padding: 50px; color: var(--wechat-text-secondary);">还没有表情包，快去添加吧</div>';
            } else {
                appData.stickers.packs.forEach(pack => {
                    bodyHtml += `<div class="sticker-pack">
                        <div class="sticker-pack-title">${pack.name}</div>
                        <div class="sticker-grid">
                            ${pack.stickers.map(sticker => `
                                <div class="sticker-item" onclick="sendSticker('${sticker.url}', '${source}')">
                                    <img src="${sticker.url}" loading="lazy">
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
                });
            }
            contentEl.innerHTML = bodyHtml;
            overlay.classList.add('half-screen');
        }

        function closeStickerPicker() {
            const overlay = document.getElementById('sticker-picker-overlay');
            overlay.classList.remove('half-screen', 'full-screen');
        }

        function toggleStickerPickerScreen() {
            const overlay = document.getElementById('sticker-picker-overlay');
            overlay.classList.toggle('full-screen');
            overlay.classList.toggle('half-screen');
        }

        function toggleStickerSelectionMode() {
            const page = document.getElementById('sticker-app-page');
            const toolbar = document.getElementById('sticker-delete-toolbar');
            page.classList.toggle('selection-mode');
            toolbar.style.display = page.classList.contains('selection-mode') ? 'flex' : 'none';
        }

        function deleteSelectedStickers() {
            const selected = document.querySelectorAll('#sticker-app-page .sticker-item.selected');
            if (selected.length === 0) {
                showToast('请选择要删除的表情', 'error');
                return;
            }
            if (confirm(`确定要删除选中的 ${selected.length} 个表情吗？`)) {
                const toDelete = [];
                selected.forEach(item => {
                    toDelete.push({
                        packIndex: parseInt(item.dataset.packIndex),
                        stickerIndex: parseInt(item.dataset.stickerIndex)
                    });
                });

                toDelete.sort((a, b) => b.packIndex - a.packIndex || b.stickerIndex - a.stickerIndex);

                toDelete.forEach(({ packIndex, stickerIndex }) => {
                    appData.stickers.packs[packIndex].stickers.splice(stickerIndex, 1);
                });

                appData.stickers.packs = appData.stickers.packs.filter(pack => pack.stickers.length > 0);

                saveData(true);
                renderStickerAppPage(document.getElementById('sticker-app-page'));
            }
        }

        // --- Calendar App ---
        let calendarInstance = null;
        function renderCalendarAppPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div></div>
                    <span class="header-title">日历</span>
                </div>
                <div class="content-area" id="calendar-app-content">
                </div>
            `;
            
            const calendarEl = document.getElementById('calendar-app-content');
            if (calendarInstance) {
                calendarInstance.destroy();
            }
            calendarInstance = new FullCalendar.Calendar(calendarEl, {
                locale: 'zh-cn',
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,listWeek'
                },
                buttonText: {
                    today: '今天',
                    month: '月',
                    week: '周',
                    list: '日程'
                },
                events: appData.calendar.events.map(e => ({...e, id: e.id.toString()})),
                editable: true,
                selectable: true,
                dateClick: function(info) {
                    const newEventTitle = prompt('输入新日程的标题:', '');
                    if (newEventTitle) {
                        const newEvent = {
                            id: String(Date.now()),
                            title: newEventTitle,
                            start: info.dateStr,
                            allDay: true
                        };
                        calendarInstance.addEvent(newEvent);
                        appData.calendar.events.push(newEvent);
                        saveData();
                    }
                },
                eventClick: function(info) {
                    if (confirm(`要删除日程 "${info.event.title}" 吗?`)) {
                        info.event.remove();
                        appData.calendar.events = appData.calendar.events.filter(e => e.id !== info.event.id);
                        saveData();
                    }
                },
                eventDrop: function(info) {
                    const eventIndex = appData.calendar.events.findIndex(e => e.id === info.event.id);
                    if (eventIndex > -1) {
                        appData.calendar.events[eventIndex].start = info.event.startStr;
                        saveData();
                    }
                }
            });
            calendarInstance.render();
        }

        // ★★★ 优化：支付密码弹窗与键盘 ★★★
        function showPasswordModal(callback) {
            const wallet = appData.user.wallet;
            if (!wallet.paymentPassword) {
                showSetPasswordModal(callback);
                return;
            }

            const overlayId = 'payment-password-overlay';
            let currentPassword = '';

            const overlay = document.createElement('div');
            overlay.id = overlayId;
            overlay.innerHTML = `
                <div class="payment-password-modal">
                    <div class="modal-header">
                        <span class="close-btn" onclick="closeModal('${overlayId}')"><i class="fas fa-times"></i></span>
                        <span class="modal-title">请输入支付密码</span>
                        <span></span>
                    </div>
                    <div class="password-input-display">
                        ${Array(6).fill('<div class="digit"></div>').join('')}
                    </div>
                    <div class="ins-style-keyboard">
                        ${[1, 2, 3, 4, 5, 6, 7, 8, 9].map(k => `<button class="key">${k}</button>`).join('')}
                        <button class="key special"></button>
                        <button class="key">0</button>
                        <button class="key special"><i class="fas fa-backspace"></i></button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);

            const digitDivs = overlay.querySelectorAll('.password-input-display .digit');
            const keys = overlay.querySelectorAll('.ins-style-keyboard .key');

            const updateDisplay = () => {
                digitDivs.forEach((div, index) => {
                    div.textContent = index < currentPassword.length ? '●' : '';
                });
            };

            keys.forEach(key => {
                key.addEventListener('click', () => {
                    if (key.querySelector('.fa-backspace')) {
                        currentPassword = currentPassword.slice(0, -1);
                    } else if (key.textContent && currentPassword.length < 6) {
                        currentPassword += key.textContent;
                    }
                    updateDisplay();

                    if (currentPassword.length === 6) {
                        if (currentPassword === wallet.paymentPassword) {
                            closeModal(overlayId);
                            callback();
                        } else {
                            showToast('密码错误', 'error');
                            currentPassword = '';
                            updateDisplay();
                        }
                    }
                });
            });
        }

        function showSetPasswordModal(callback) {
            const overlayId = 'set-password-overlay';
            let firstPassword = '';
            let isConfirming = false;
            let currentPassword = '';

            const overlay = document.createElement('div');
            overlay.id = overlayId;
            overlay.innerHTML = `
                <div class="payment-password-modal">
                    <div class="modal-header">
                        <span class="close-btn" onclick="closeModal('${overlayId}')"><i class="fas fa-times"></i></span>
                        <span class="modal-title" id="set-password-title">请设置6位支付密码</span>
                        <span></span>
                    </div>
                    <div class="password-input-display">
                        ${Array(6).fill('<div class="digit"></div>').join('')}
                    </div>
                    <div class="ins-style-keyboard">
                        ${[1, 2, 3, 4, 5, 6, 7, 8, 9].map(k => `<button class="key">${k}</button>`).join('')}
                        <button class="key special"></button>
                        <button class="key">0</button>
                        <button class="key special"><i class="fas fa-backspace"></i></button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);

            const titleEl = overlay.querySelector('#set-password-title');
            const digitDivs = overlay.querySelectorAll('.password-input-display .digit');
            const keys = overlay.querySelectorAll('.ins-style-keyboard .key');

            const updateDisplay = () => {
                digitDivs.forEach((div, index) => {
                    div.textContent = index < currentPassword.length ? '●' : '';
                });
            };

            keys.forEach(key => {
                key.addEventListener('click', () => {
                    if (key.querySelector('.fa-backspace')) {
                        currentPassword = currentPassword.slice(0, -1);
                    } else if (key.textContent && currentPassword.length < 6) {
                        currentPassword += key.textContent;
                    }
                    updateDisplay();

                    if (currentPassword.length === 6) {
                        if (!isConfirming) {
                            firstPassword = currentPassword;
                            isConfirming = true;
                            currentPassword = '';
                            updateDisplay();
                            titleEl.textContent = '请再次输入以确认';
                        } else {
                            if (currentPassword === firstPassword) {
                                appData.user.wallet.paymentPassword = currentPassword;
                                saveData(true);
                                closeModal(overlayId);
                                if (callback) callback();
                            } else {
                                showToast('两次输入的密码不一致', 'error');
                                isConfirming = false;
                                firstPassword = '';
                                currentPassword = '';
                                updateDisplay();
                                titleEl.textContent = '请设置6位支付密码';
                            }
                        }
                    }
                });
            });
        }

        async function renderPaymentCodePage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>钱包</span></div>
                    <span class="header-title">收付款</span>
                </div>
                <div class="content-area payment-code-container">
                    <h3>赞赏码</h3>
                    <div class="qr-code-wrapper appreciation-code">
                        <canvas id="appreciation-code"></canvas>
                        <img src="${appData.user.avatar}" class="qr-avatar">
                    </div>
                    <h3>收款码</h3>
                    <div class="qr-code-wrapper receive-code">
                        <canvas id="receive-code"></canvas>
                        <img src="${appData.user.avatar}" class="qr-avatar">
                    </div>
                    <h3>付款码</h3>
                    <div class="qr-code-wrapper payment-code">
                        <canvas class="barcode-canvas" id="payment-barcode"></canvas>
                        <canvas id="payment-code"></canvas>
                        <img src="${appData.user.avatar}" class="qr-avatar">
                    </div>
                </div>
            `;
            
            const generateRandomCode = (prefix) => `X-EVOL-QR:${prefix}:${appData.user.id}:${Date.now()}`;
            const paymentCodeValue = generateRandomCode('pay');

            new QRious({ element: document.getElementById('appreciation-code'), value: generateRandomCode('appreciate'), size: 150, background: 'white', foreground: 'black' });
            new QRious({ element: document.getElementById('receive-code'), value: generateRandomCode('receive'), size: 150, background: 'transparent', foreground: 'white' });
            new QRious({ element: document.getElementById('payment-code'), value: paymentCodeValue, size: 150, background: 'transparent', foreground: 'white' });
            
            JsBarcode("#payment-barcode", paymentCodeValue.replace(/:/g, ''), {
                format: "CODE128",
                lineColor: "#000",
                width: 2,
                height: 40,
                displayValue: false,
                background: "transparent"
            });
        }

        async function generateQrCodeDataUrl(value, type, avatarUrl) {
            const canvas = document.createElement('canvas');
            const wrapper = document.createElement('div');
            wrapper.style.position = 'relative';
            wrapper.style.display = 'inline-block';
            wrapper.style.padding = '10px';
            wrapper.style.borderRadius = '8px';

            const qrCanvas = document.createElement('canvas');
            const qr = new QRious({
                element: qrCanvas,
                value: value,
                size: 150,
                background: 'transparent',
                foreground: 'white'
            });

            const ctx = canvas.getContext('2d');
            canvas.width = 170;
            canvas.height = 170;

            if (type === 'receive') {
                ctx.fillStyle = '#07C160';
                ctx.fillRect(0, 0, 170, 170);
            } else {
                ctx.fillStyle = '#333';
                ctx.fillRect(0, 0, 170, 170);
            }
            
            ctx.drawImage(qrCanvas, 10, 10);

            const avatar = new Image();
            avatar.crossOrigin = "Anonymous";
            avatar.src = avatarUrl;
            
            return new Promise(resolve => {
                avatar.onload = () => {
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(85, 85, 17, 0, Math.PI * 2, true);
                    ctx.closePath();
                    ctx.clip();
                    ctx.drawImage(avatar, 68, 68, 34, 34);
                    ctx.restore();
                    resolve(canvas.toDataURL());
                };
                avatar.onerror = () => {
                    resolve(canvas.toDataURL());
                };
            });
        }

        function showImageContextMenu(event, imageUrl, chatId) {
            event.preventDefault();
            const menu = document.getElementById('message-context-menu');
            
            let itemsHtml = `<div class="context-menu-item" onclick="scanQrCode('${imageUrl}', '${chatId}')">识别图中二维码</div>`;
            
            menu.innerHTML = itemsHtml;
            menu.style.display = 'block';
            
            const menuRect = menu.getBoundingClientRect();
            const bodyRect = document.body.getBoundingClientRect();
            let left = event.clientX;
            if (left + menuRect.width > bodyRect.width) left = event.clientX - menuRect.width;
            let top = event.clientY;
            if (top + menuRect.height > bodyRect.height) top = event.clientY - menuRect.height;
            
            menu.style.left = `${left}px`;
            menu.style.top = `${top}px`;

            const closeMenu = () => {
                menu.style.display = 'none';
                document.removeEventListener('click', closeMenu);
            };
            setTimeout(() => document.addEventListener('click', closeMenu), 0);
        }

        function scanQrCode(imageUrl, chatId) {
            const qrMatch = imageUrl.match(/X-EVOL-QR:(\w+):(\w+)/);
            if (qrMatch) {
                const type = qrMatch[1];
                const targetId = qrMatch[2];
                const char = appData.contacts.find(c => c.id == targetId);
                if (char) {
                    showTransactionModal('transfer', char.id, 'individual');
                } else {
                    showToast('无法识别的二维码用户', 'error');                }
            } else {
                showToast('未识别到有效的二维码', 'error');
            }
        }

        // ★★★ 优化：“你说我猜”游戏逻辑 ★★★
        function showGuessWordSetup() {
            const modalId = 'guess-word-setup-modal';
            const charOptions = appData.contacts.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            const categoryOptions = Object.keys(appData.games.guessWord.wordBank).map(cat => `<option value="${cat}">${cat}</option>`).join('');

            const html = `
                <div class="modal-content">
                    <div class="modal-title">你说我猜 - 设置</div>
                    <div class="form-group">
                        <label>选择一起玩的好友</label>
                        <select id="game-char-select" class="modal-input">${charOptions}</select>
                    </div>
                    <div class="form-group">
                        <label>选择词库</label>
                        <select id="game-category-select" class="modal-input">${categoryOptions}</select>
                    </div>
                    <div class="form-group" id="custom-word-group" style="display:none;">
                        <label>自定义词语</label>
                        <input type="text" id="game-custom-word" class="modal-input" placeholder="输入你想让对方猜的词">
                    </div>
                    <div class="form-group">
                        <label>谁来猜？</label>
                        <select id="game-guesser-select" class="modal-input">
                            <option value="user">我来猜</option>
                            <option value="char">TA来猜</option>
                        </select>
                    </div>
                    <button class="form-btn" onclick="startGuessWordGame()">开始游戏</button>
                </div>
            `;
            showModal(modalId, html);

            document.getElementById('game-category-select').onchange = e => {
                document.getElementById('custom-word-group').style.display = e.target.value === '自定义' ? 'block' : 'none';
            };
        }

        function startGuessWordGame(isNextRound = false) {
            let charId, category, guesser, word;
            
            if (isNextRound) {
                const oldSession = appData.games.guessWord.activeSession;
                charId = oldSession.charId;
                category = oldSession.category;
                guesser = oldSession.guesser;
            } else {
                charId = parseInt(document.getElementById('game-char-select').value);
                category = document.getElementById('game-category-select').value;
                guesser = document.getElementById('game-guesser-select').value;
                closeModal('guess-word-setup-modal');
            }

            if (category === '自定义') {
                word = document.getElementById('game-custom-word').value.trim();
                if (!word) {
                    showToast('自定义词语不能为空', 'error');
                    return;
                }
            } else {
                const wordList = appData.games.guessWord.wordBank[category];
                if (!wordList || wordList.length === 0) {
                    showToast('该词库为空', 'error');
                    return;
                }
                word = wordList[Math.floor(Math.random() * wordList.length)];
            }

            appData.games.guessWord.activeSession = {
                charId,
                word,
                category,
                guesser,
                history: [],
                isOver: false,
                chat: []
            };
            saveData();
            showPage('guess-word-game-page', renderGuessWordGamePage);
        }

        function renderGuessWordGamePage(container) {
            const session = appData.games.guessWord.activeSession;
            if (!session) {
                goBack();
                return;
            }
            const char = appData.contacts.find(c => c.id === session.charId);

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="endGuessWordGame()"><div class="ui-icon back"></div></div>
                    <span class="header-title">你说我猜 (和${char.name})</span>
                </div>
                <div class="content-area">
                    <div class="game-card">
                        <h3>${session.guesser === 'user' ? '你要猜的词' : '你要提示的词'}</h3>
                        <div id="game-word-display">${session.isOver || session.guesser === 'char' ? session.word : '???'}</div>
                        <p id="game-status-text">${session.isOver ? '游戏结束！' : (session.guesser === 'user' ? 'TA正在给你提示...' : '请开始你的提示...')}</p>
                    </div>
                    <div class="game-card">
                        <h3>游戏交流</h3>
                        <div id="game-chat-area"></div>
                        <div id="game-input-area">
                            <input type="text" id="game-chat-input" class="modal-input" placeholder="输入你的提示或猜测...">
                            <button class="form-btn" onclick="sendGameMessage()">发送</button>
                        </div>
                        <button id="next-round-btn" class="form-btn" style="display:none;" onclick="startGuessWordGame(true)">下一轮</button>
                    </div>
                    <div class="game-card">
                        <h3>历史错误答案</h3>
                        <ul id="game-history-list">
                            ${session.history.length > 0 ? session.history.map(h => `<li>${h}</li>`).join('') : '<li>暂无</li>'}
                        </ul>
                    </div>
                </div>
            `;
            
            renderGameChat();

            if (session.isOver) {
                document.getElementById('next-round-btn').style.display = 'block';
            } else if (session.guesser === 'user' && session.chat.length === 0) {
                getGameAiReply();
            }
        }
        
        function renderGameChat() {
            const chatArea = document.getElementById('game-chat-area');
            if (!chatArea) return;
            const session = appData.games.guessWord.activeSession;
            const char = appData.contacts.find(c => c.id === session.charId);
            chatArea.innerHTML = session.chat.map(msg => 
                `<p><strong>${msg.sender === 'user' ? '你' : char.name}:</strong> ${msg.text}</p>`
            ).join('');
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        async function sendGameMessage() {
            const input = document.getElementById('game-chat-input');
            const text = input.value.trim();
            if (!text) return;

            const session = appData.games.guessWord.activeSession;
            if (session.isOver) {
                showToast('游戏已经结束了', 'error');
                return;
            }

            session.chat.push({ sender: 'user', text });
            input.value = '';
            renderGameChat();

            if (session.guesser === 'user') {
                if (text === session.word) {
                    session.isOver = true;
                    document.getElementById('game-word-display').textContent = session.word;
                    document.getElementById('game-status-text').textContent = '恭喜你，猜对了！';
                    document.getElementById('next-round-btn').style.display = 'block';
                    showToast('猜对了！', 'success');
                } else {
                    session.history.push(text);
                    document.getElementById('game-history-list').innerHTML = session.history.map(h => `<li>${h}</li>`).join('');
                    getGameAiReply();
                }
            } else {
                getGameAiReply();
            }
            saveData();
        }

        async function getGameAiReply() {
            const session = appData.games.guessWord.activeSession;
            const char = appData.contacts.find(c => c.id === session.charId);
            const chatHistory = session.chat.map(m => `${m.sender === 'user' ? '你' : '我'}: ${m.text}`).join('\n');

            let prompt;
            if (session.guesser === 'user') {
                prompt = `你正在和'${appData.user.nickname}'玩“你说我猜”游戏。你要提示的词是“${session.word}”。你不能直接说出这个词或包含这个词的字。根据以下聊天记录，给出下一条提示。\n\n${chatHistory}`;
            } else {
                prompt = `你正在和'${appData.user.nickname}'玩“你说我猜”游戏。你要猜的词是未知的。根据对方的提示和以下聊天记录，做出你的猜测或提出问题。如果你要猜测，请使用格式“[猜测:你的答案]”。\n\n${chatHistory}`;
            }

            const replies = await getAiReply(session.charId, 'wechat', prompt);
            
            for (const reply of replies) {
                const guessMatch = reply.match(/\[猜测:(.*?)\]/);
                if (guessMatch) {
                    const guess = guessMatch[1].trim();
                    session.chat.push({ sender: 'char', text: `我猜是... ${guess}？` });
                    if (guess === session.word) {
                        session.isOver = true;
                        document.getElementById('game-word-display').textContent = session.word;
                        document.getElementById('game-status-text').textContent = 'TA猜对了！';
                        document.getElementById('next-round-btn').style.display = 'block';
                        showToast('TA猜对了！', 'success');
                    } else {
                        session.history.push(guess);
                        document.getElementById('game-history-list').innerHTML = session.history.map(h => `<li>${h}</li>`).join('');
                        session.chat.push({ sender: 'user', text: '不对哦，再猜猜。' });
                    }
                } else {
                    session.chat.push({ sender: 'char', text: reply });
                }
            }
            saveData();
            renderGameChat();
        }

        function endGuessWordGame() {
            if (confirm('确定要结束当前游戏吗？')) {
                appData.games.guessWord.activeSession = null;
                saveData();
                goBack();
            }
        }

        // ★★★ 优化：线下剧情美化保存逻辑 ★★★
        function renderOfflinePlotBeautifyPage(container) {
            if (!container) return;
            const settings = appData.settings.beautify.offlinePlot;
            const styleOptions = `
                <option value="normal">常规</option>
                <option value="italic">斜体</option>
            `;
            const weightOptions = `
                <option value="normal">常规</option>
                <option value="bold">粗体</option>
                <option value="300">细体</option>
                <option value="600">中粗</option>
            `;

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div></div>
                    <span class="header-title">线下剧情美化</span>
                </div>
                <div class="content-area form-page">
                    <div class="list-divider"></div>
                    <h3>角色 (Char)</h3>
                    <div class="form-group">
                        <label>旁白符号</label>
                        <div style="display:flex; gap:10px;"><input type="text" id="plot-char-nar-start" value="${settings.charNarration.symbolStart}" placeholder="起始符号"><input type="text" id="plot-char-nar-end" value="${settings.charNarration.symbolEnd}" placeholder="结束符号"></div>
                    </div>
                    <div class="form-group">
                        <label>旁白样式</label>
                        <div style="display:flex; gap:10px;"><select id="plot-char-nar-style">${styleOptions}</select><select id="plot-char-nar-weight">${weightOptions}</select><input type="color" id="plot-char-nar-color" value="${settings.charNarration.color}"></div>
                    </div>
                    <div class="form-group">
                        <label>引用符号</label>
                        <div style="display:flex; gap:10px;"><input type="text" id="plot-char-quote-start" value="${settings.charQuote.symbolStart}" placeholder="起始符号"><input type="text" id="plot-char-quote-end" value="${settings.charQuote.symbolEnd}" placeholder="结束符号"></div>
                    </div>
                    <div class="form-group">
                        <label>引用样式</label>
                        <div style="display:flex; gap:10px;"><select id="plot-char-quote-style">${styleOptions}</select><select id="plot-char-quote-weight">${weightOptions}</select><input type="color" id="plot-char-quote-color" value="${settings.charQuote.color}"></div>
                    </div>

                    <div class="list-divider"></div>
                    <h3>你 (User)</h3>
                    <div class="form-group">
                        <label>旁白符号</label>
                        <div style="display:flex; gap:10px;"><input type="text" id="plot-user-nar-start" value="${settings.userNarration.symbolStart}" placeholder="起始符号"><input type="text" id="plot-user-nar-end" value="${settings.userNarration.symbolEnd}" placeholder="结束符号"></div>
                    </div>
                    <div class="form-group">
                        <label>旁白样式</label>
                        <div style="display:flex; gap:10px;"><select id="plot-user-nar-style">${styleOptions}</select><select id="plot-user-nar-weight">${weightOptions}</select><input type="color" id="plot-user-nar-color" value="${settings.userNarration.color}"></div>
                    </div>
                    <div class="form-group">
                        <label>引用符号</label>
                        <div style="display:flex; gap:10px;"><input type="text" id="plot-user-quote-start" value="${settings.userQuote.symbolStart}" placeholder="起始符号"><input type="text" id="plot-user-quote-end" value="${settings.userQuote.symbolEnd}" placeholder="结束符号"></div>
                    </div>
                    <div class="form-group">
                        <label>引用样式</label>
                        <div style="display:flex; gap:10px;"><select id="plot-user-quote-style">${styleOptions}</select><select id="plot-user-quote-weight">${weightOptions}</select><input type="color" id="plot-user-quote-color" value="${settings.userQuote.color}"></div>
                    </div>
                    
                    <button class="form-btn" onclick="saveOfflinePlotSettings()">保存</button>
                </div>
            `;
            document.getElementById('plot-char-nar-style').value = settings.charNarration.style;
            document.getElementById('plot-char-nar-weight').value = settings.charNarration.weight;
            document.getElementById('plot-char-quote-style').value = settings.charQuote.style;
            document.getElementById('plot-char-quote-weight').value = settings.charQuote.weight;
            document.getElementById('plot-user-nar-style').value = settings.userNarration.style;
            document.getElementById('plot-user-nar-weight').value = settings.userNarration.weight;
            document.getElementById('plot-user-quote-style').value = settings.userQuote.style;
            document.getElementById('plot-user-quote-weight').value = settings.userQuote.weight;
        }

        function saveOfflinePlotSettings() {
            const settings = appData.settings.beautify.offlinePlot;
            settings.charNarration.symbolStart = document.getElementById('plot-char-nar-start').value;
            settings.charNarration.symbolEnd = document.getElementById('plot-char-nar-end').value;
            settings.charNarration.style = document.getElementById('plot-char-nar-style').value;
            settings.charNarration.weight = document.getElementById('plot-char-nar-weight').value;
            settings.charNarration.color = document.getElementById('plot-char-nar-color').value;
            
            settings.charQuote.symbolStart = document.getElementById('plot-char-quote-start').value;
            settings.charQuote.symbolEnd = document.getElementById('plot-char-quote-end').value;
            settings.charQuote.style = document.getElementById('plot-char-quote-style').value;
            settings.charQuote.weight = document.getElementById('plot-char-quote-weight').value;
            settings.charQuote.color = document.getElementById('plot-char-quote-color').value;

            settings.userNarration.symbolStart = document.getElementById('plot-user-nar-start').value;
            settings.userNarration.symbolEnd = document.getElementById('plot-user-nar-end').value;
            settings.userNarration.style = document.getElementById('plot-user-nar-style').value;
            settings.userNarration.weight = document.getElementById('plot-user-nar-weight').value;
            settings.userNarration.color = document.getElementById('plot-user-nar-color').value;

            settings.userQuote.symbolStart = document.getElementById('plot-user-quote-start').value;
            settings.userQuote.symbolEnd = document.getElementById('plot-user-quote-end').value;
            settings.userQuote.style = document.getElementById('plot-user-quote-style').value;
            settings.userQuote.weight = document.getElementById('plot-user-quote-weight').value;
            settings.userQuote.color = document.getElementById('plot-user-quote-color').value;

            saveData(true);
            applyBeautifySettings();
        }

        // ★★★ 优化：书架APP逻辑 ★★★
        function renderBookshelfApp(container) {
            if (!container) return;
            const bookshelfData = appData.bookshelf;

            container.innerHTML = `
                <div class="app-container" id="bookshelf-app-container">
                    <header class="app-header" id="bookshelf-header">
                        <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div></div>
                        <div class="app-title" id="bookshelf-page-title">书架</div>
                        <div class="header-actions">
                            <button class="icon-button" id="bs-add-friend-btn" style="display:none;" onclick="showBookshelfInviteFriendModal()"><i class="fas fa-user-plus"></i></button>
                            <button class="icon-button" id="bs-fanfic-refresh-btn" style="display:none;" onclick="generateFanfics(true)"><i class="fas fa-sync-alt"></i></button>
                        </div>
                    </header>
                    
                    <main class="app-content" id="bookshelf-content-area">
                        <section class="sub-page active" id="bs-bookshelf-page">
                            <div class="bookshelf-header">
                                <h1 class="bookshelf-title">我的书架</h1>
                            </div>
                            <div class="books-grid" id="bs-books-grid"></div>
                            <div class="empty-state" id="bs-empty-bookshelf" style="display: none;">
                                <div class="empty-icon"><i class="fas fa-book-open"></i></div>
                                <h3 class="empty-title">书架空空如也</h3>
                                <p class="empty-text">点击底部“+”添加第一本书</p>
                            </div>
                        </section>
                        
                        <section class="sub-page" id="bs-discover-page">
                            <h1 class="bookshelf-title" style="margin-bottom: 20px;">好友在读</h1>
                            <div id="bs-friends-reading-list"></div>
                        </section>
                        
                        <section class="sub-page" id="bs-fanfic-page">
                             <div id="bs-fanfic-content"></div>
                        </section>

                        <section class="sub-page" id="bs-profile-page">
                            <div id="bs-profile-content"></div>
                        </section>

                        <section class="sub-page" id="bs-reader-page"></section>
                    </main>
                    
                    <nav class="bottom-nav" id="bookshelf-bottom-nav">
                        <a href="#" class="nav-item active" data-page="bs-bookshelf-page"><div class="nav-icon"><i class="fas fa-book"></i></div><div class="nav-label">书架</div></a>
                        <a href="#" class="nav-item" data-page="bs-discover-page"><div class="nav-icon"><i class="fas fa-compass"></i></div><div class="nav-label">发现</div></a>
                        <a href="#" class="nav-item" id="bs-add-btn"><div class="nav-icon nav-item-plus"><i class="fas fa-plus-circle"></i></div></a>
                        <a href="#" class="nav-item" data-page="bs-fanfic-page"><div class="nav-icon"><i class="fas fa-feather-alt"></i></div><div class="nav-label">同人</div></a>
                        <a href="#" class="nav-item" data-page="bs-profile-page"><div class="nav-icon"><i class="fas fa-user"></i></div><div class="nav-label">我</div></a>
                    </nav>
                </div>
                <input type="file" id="bs-book-file-input" class="file-input" accept=".txt,.md,.html">
                <input type="file" id="bs-avatar-file-input" class="file-input" accept="image/*">
            `;
            
            initBookshelfApp();
        }

        function initBookshelfApp() {
            const bookshelfData = appData.bookshelf;
            const container = document.getElementById('bookshelf-app-page');

            const theme = bookshelfData.settings.theme;
            if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                container.classList.add('dark-mode');
            } else {
                container.classList.remove('dark-mode');
            }

            container.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = item.dataset.page;
                    if (pageId) {
                        switchBookshelfPage(pageId);
                    }
                });
            });
            
            document.getElementById('bs-add-btn').addEventListener('click', showBookshelfAddMenu);

            renderBookshelfBooks();
            renderBookshelfProfilePage();
            renderBookshelfFanficPage();
            renderBookshelfDiscoverPage();
        }

        function switchBookshelfPage(pageId) {
            const container = document.getElementById('bookshelf-app-page');
            container.querySelectorAll('.sub-page').forEach(p => p.classList.remove('active'));
            container.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            
            document.getElementById(pageId).classList.add('active');
            const navItem = container.querySelector(`.nav-item[data-page="${pageId}"]`);
            if (navItem) navItem.classList.add('active');

            const titleMap = {
                'bs-bookshelf-page': '书架',
                'bs-discover-page': '发现',
                'bs-fanfic-page': '同人',
                'bs-profile-page': '我'
            };
            document.getElementById('bookshelf-page-title').textContent = titleMap[pageId] || '书架';
            document.getElementById('bs-add-friend-btn').style.display = pageId === 'bs-discover-page' ? 'block' : 'none';
            document.getElementById('bs-fanfic-refresh-btn').style.display = pageId === 'bs-fanfic-page' ? 'block' : 'none';
        }

        function renderBookshelfBooks() {
            const grid = document.getElementById('bs-books-grid');
            const emptyState = document.getElementById('bs-empty-bookshelf');
            const books = appData.bookshelf.books;

            if (books.length === 0) {
                grid.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            grid.innerHTML = books.map(book => {
                const colors = ['#007aff', '#34c759', '#ff9500', '#ff3b30', '#af52de', '#5856d6'];
                const color = colors[book.id.toString().charCodeAt(0) % colors.length];
                const progress = book.scrollPosition && book.content.length > 0 ? Math.round((book.scrollPosition / book.content.length) * 100) : 0;
                return `
                    <div class="book-card" data-id="${book.id}" onclick="openBookshelfBook(${book.id})">
                        <div class="book-cover" style="background: ${color};">
                            <i class="fas fa-book"></i>
                        </div>
                        <div class="book-title">${book.title}</div>
                        <div class="book-author">${book.author || '未知作者'}</div>
                        ${progress > 0 ? `<div class="book-progress">阅读至 ${progress}%</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function showBookshelfAddMenu() {
            const modalId = 'bs-add-menu-modal';
            const html = `
                <div class="modal-content">
                    <div class="list-view" style="background: transparent;">
                        <div class="list-item" onclick="document.getElementById('bs-book-file-input').click(); closeModal('${modalId}');">
                            <i class="fas fa-file-import"></i><span style="margin-left: 10px;">导入书籍</span>
                        </div>
                        <div class="list-item" onclick="showCreateBookModal(); closeModal('${modalId}');">
                            <i class="fas fa-pen-nib"></i><span style="margin-left: 10px;">创建作品</span>
                        </div>
                    </div>
                </div>
            `;
            showModal(modalId, html);
            document.getElementById('bs-book-file-input').onchange = (e) => {
                const file = e.target.files[0];
                if (file) importBookFromFile(file);
                e.target.value = '';
            };
        }

        function importBookFromFile(file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const content = event.target.result;
                const title = file.name.replace(/\.[^/.]+$/, "");
                const newBook = {
                    id: Date.now(),
                    title: title,
                    author: appData.bookshelf.user.nickname,
                    content: content,
                    scrollPosition: 0
                };
                appData.bookshelf.books.unshift(newBook);
                saveData(true);
                renderBookshelfBooks();
            };
            reader.readAsText(file);
        }

        function showCreateBookModal(bookId = null) {
            const modalId = 'bs-create-book-modal';
            const isAppending = bookId !== null;
            const book = isAppending ? appData.bookshelf.books.find(b => b.id === bookId) : null;
            
            const html = `
                <div class="modal-content">
                    <div class="modal-title">${isAppending ? `为《${book.title}》追加内容` : '创建新作品'}</div>
                    ${!isAppending ? `
                    <div class="form-group">
                        <label>标题</label>
                        <input type="text" id="bs-create-title" class="modal-input">
                    </div>` : ''}
                    <div class="form-group">
                        <label>内容</label>
                        <textarea id="bs-create-content" class="modal-input" rows="10"></textarea>
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" onclick="saveCreatedBook(${bookId})">保存</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);
        }

        function saveCreatedBook(bookId) {
            const content = document.getElementById('bs-create-content').value;
            if (!content) { showToast('内容不能为空', 'error'); return; }

            if (bookId) {
                const book = appData.bookshelf.books.find(b => b.id === bookId);
                book.content += '\n\n' + content;
            } else {
                const title = document.getElementById('bs-create-title').value;
                if (!title) { showToast('标题不能为空', 'error'); return; }
                const newBook = {
                    id: Date.now(),
                    title: title,
                    author: appData.bookshelf.user.nickname,
                    content: content,
                    scrollPosition: 0
                };
                appData.bookshelf.books.unshift(newBook);
            }
            saveData(true);
            renderBookshelfBooks();
            closeModal('bs-create-book-modal');
        }

        function openBookshelfBook(bookId) {
            const book = appData.bookshelf.books.find(b => b.id === bookId);
            if (!book) return;
            appData.bookshelf.currentBookId = bookId;
            renderBookshelfReaderPage(book);
            switchBookshelfPage('bs-reader-page');
        }

        function renderBookshelfReaderPage(book) {
            const pageContainer = document.getElementById('bs-reader-page');
            const pageContent = book.content.replace(/\n/g, '<br>');
            
            pageContainer.innerHTML = `
                <div class="reader-header">
                    <button class="icon-button" onclick="saveBookProgressAndExit()"><i class="fas fa-arrow-left"></i></button>
                    <h2 id="readerBookTitle">${book.title}</h2>
                    <button class="icon-button" onclick="showCreateBookModal(${book.id})"><i class="fas fa-plus"></i></button>
                </div>
                <div class="reader-content-wrapper" id="bs-reader-wrapper">
                    <div class="reader-page">${pageContent}</div>
                </div>
            `;
            applyBookshelfReadingSettings();
            
            const readerPage = pageContainer.querySelector('.reader-page');
            if (book.scrollPosition) {
                setTimeout(() => {
                    readerPage.scrollTop = book.scrollPosition;
                }, 100);
            }
        }

        function saveBookProgressAndExit() {
            const book = appData.bookshelf.books.find(b => b.id === appData.bookshelf.currentBookId);
            if (book) {
                const readerPage = document.querySelector('#bs-reader-page .reader-page');
                book.scrollPosition = readerPage.scrollTop;
                saveData();
            }
            appData.bookshelf.currentBookId = null;
            renderBookshelfBooks();
            switchBookshelfPage('bs-bookshelf-page');
        }

        function renderBookshelfProfilePage() {
            const page = document.getElementById('bs-profile-content');
            const user = appData.bookshelf.user;
            const settings = appData.bookshelf.settings;
            page.innerHTML = `
                <div class="profile-header">
                    <div class="profile-avatar" id="bs-user-avatar" onclick="document.getElementById('bs-avatar-file-input').click()">
                        <img src="${user.avatar}" class="avatar-img" style="${user.avatar ? '' : 'display:none;'}">
                    </div>
                    <h2 class="profile-name">${user.nickname}</h2>
                    <div class="profile-username">${user.username}</div>
                    <p class="profile-bio">${user.bio}</p>
                </div>
                <div class="settings-section">
                    <div class="settings-item" onclick="showBookshelfEditProfileModal()">
                        <div class="item-left"><i class="fas fa-user-edit item-icon"></i><span>编辑个人资料</span></div>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-item">
                        <div class="item-left"><i class="fas fa-moon item-icon"></i><span>主题模式</span></div>
                        <select id="bs-theme-select" class="modal-input" style="width: auto; border: none; background: transparent;">
                            <option value="system" ${settings.theme === 'system' ? 'selected' : ''}>跟随系统</option>
                            <option value="light" ${settings.theme === 'light' ? 'selected' : ''}>日间模式</option>
                            <option value="dark" ${settings.theme === 'dark' ? 'selected' : ''}>夜间模式</option>
                        </select>
                    </div>
                    <div class="settings-item" onclick="showBookshelfFontModal('size')">
                        <div class="item-left"><i class="fas fa-text-height item-icon"></i><span>字体大小</span></div>
                        <span class="item-value">${settings.fontSize}px</span>
                    </div>
                    <div class="settings-item" onclick="showBookshelfFontModal('weight')">
                        <div class="item-left"><i class="fas fa-bold item-icon"></i><span>字体粗细</span></div>
                        <span class="item-value">${{300:'细',400:'常规',600:'中粗',700:'粗'}[settings.fontWeight]}</span>
                    </div>
                    <div class="settings-item" onclick="showBookshelfFontModal('family')">
                        <div class="item-left"><i class="fas fa-font item-icon"></i><span>更换字体</span></div>
                        <span class="item-value">${settings.fontFamily ? '自定义' : '默认'}</span>
                    </div>
                    <div class="settings-item">
                        <div class="item-left"><i class="fas fa-highlighter item-icon"></i><span>增加阴影</span></div>
                        <label class="toggle-switch"><input type="checkbox" class="toggle-checkbox" id="bs-shadow-toggle" ${settings.textShadow ? 'checked' : ''}><span class="toggle-slider"></span></label>
                    </div>
                    <div class="settings-item">
                        <div class="item-left"><i class="fas fa-palette item-icon"></i><span>增加高光</span></div>
                        <label class="toggle-switch"><input type="checkbox" class="toggle-checkbox" id="bs-highlight-toggle" ${settings.textHighlight ? 'checked' : ''}><span class="toggle-slider"></span></label>
                    </div>
                    <div class="settings-item">
                        <div class="item-left"><i class="fas fa-underline item-icon"></i><span>增加下划线</span></div>
                        <label class="toggle-switch"><input type="checkbox" class="toggle-checkbox" id="bs-underline-toggle" ${settings.textUnderline ? 'checked' : ''}><span class="toggle-slider"></span></label>
                    </div>
                    <div class="settings-item">
                        <div class="item-left"><i class="fas fa-italic item-icon"></i><span>斜体字</span></div>
                        <label class="toggle-switch"><input type="checkbox" class="toggle-checkbox" id="bs-italic-toggle" ${settings.textItalic ? 'checked' : ''}><span class="toggle-slider"></span></label>
                    </div>
                    <div class="settings-item">
                        <div class="item-left"><i class="fas fa-book-reader item-icon"></i><span>翻页模式</span></div>
                        <select id="bs-page-turn-select" class="modal-input" style="width: auto; border: none; background: transparent;">
                            <option value="slide" ${settings.pageTurnMode === 'slide' ? 'selected' : ''}>左右滑动</option>
                            <option value="scroll" ${settings.pageTurnMode === 'scroll' ? 'selected' : ''}>上下滚动</option>
                            <option value="simulation" ${settings.pageTurnMode === 'simulation' ? 'selected' : ''}>仿真翻页</option>
                        </select>
                    </div>
                </div>
            `;
            document.getElementById('bs-avatar-file-input').onchange = (e) => {
                handleImageUpload(e.target.files[0], url => {
                    user.avatar = url;
                    saveData();
                    renderBookshelfProfilePage();
                });
            };
            document.getElementById('bs-theme-select').onchange = (e) => {
                settings.theme = e.target.value;
                saveData();
                initBookshelfApp();
            };
            document.getElementById('bs-shadow-toggle').onchange = (e) => {
                settings.textShadow = e.target.checked;
                saveData();
                applyBookshelfReadingSettings();
            };
            document.getElementById('bs-highlight-toggle').onchange = (e) => {
                settings.textHighlight = e.target.checked;
                saveData();
                applyBookshelfReadingSettings();
            };
            document.getElementById('bs-underline-toggle').onchange = (e) => {
                settings.textUnderline = e.target.checked;
                saveData();
                applyBookshelfReadingSettings();
            };
            document.getElementById('bs-italic-toggle').onchange = (e) => {
                settings.textItalic = e.target.checked;
                saveData();
                applyBookshelfReadingSettings();
            };
            document.getElementById('bs-page-turn-select').onchange = (e) => {
                settings.pageTurnMode = e.target.value;
                saveData();
                if (appData.bookshelf.currentBookId) {
                    const book = appData.bookshelf.books.find(b => b.id === appData.bookshelf.currentBookId);
                    renderBookshelfReaderPage(book);
                }
            };
        }

        function showBookshelfEditProfileModal() {
            const user = appData.bookshelf.user;
            const modalId = 'bs-edit-profile-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">编辑个人资料</div>
                    <div class="form-group">
                        <label>用户名</label>
                        <input type="text" id="bs-edit-username" class="modal-input" value="${user.username}">
                        <p class="subtext">以@开头，只能包含字母和数字</p>
                    </div>
                    <div class="form-group">
                        <label>昵称</label>
                        <input type="text" id="bs-edit-nickname" class="modal-input" value="${user.nickname}">
                    </div>
                    <div class="form-group">
                        <label>个性签名 (100字以内)</label>
                        <textarea id="bs-edit-bio" class="modal-input" rows="3" maxlength="100">${user.bio}</textarea>
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" onclick="saveBookshelfProfile()">保存</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);
        }

        function saveBookshelfProfile() {
            const username = document.getElementById('bs-edit-username').value.trim();
            if (!username.startsWith('@') || !/^[a-zA-Z0-9]+$/.test(username.substring(1))) {
                showToast('用户名格式不正确', 'error'); return;
            }
            appData.bookshelf.user.username = username;
            appData.bookshelf.user.nickname = document.getElementById('bs-edit-nickname').value.trim();
            appData.bookshelf.user.bio = document.getElementById('bs-edit-bio').value.trim();
            saveData(true);
            renderBookshelfProfilePage();
            closeModal('bs-edit-profile-modal');
        }

        function showBookshelfFontModal(type) {
            const settings = appData.bookshelf.settings;
            if (type === 'weight') {
                const modalId = 'bs-font-weight-modal';
                const html = `
                    <div class="modal-content">
                        <div class="modal-title">字体粗细</div>
                        ${[300, 400, 600, 700].map(w => `<div class="list-item" onclick="setBookshelfFontWeight(${w})"><span style="font-weight:${w};">${{300:'细',400:'常规',600:'中粗',700:'粗'}[w]}</span> ${settings.fontWeight === w ? '<i class="fas fa-check" style="color:var(--bs-accent-blue);"></i>' : ''}</div>`).join('')}
                    </div>
                `;
                showModal(modalId, html);
            } else if (type === 'family') {
                const modalId = 'bs-font-family-modal';
                const html = `
                    <div class="modal-content">
                        <div class="modal-title">更换字体</div>
                        <div class="form-group"><label>字体URL</label><input type="text" id="bs-font-url" class="modal-input" value="${settings.fontUrl || ''}"></div>
                        <div class="form-group"><label>或本地文件</label><input type="file" id="bs-font-file" class="file-input" accept=".ttf,.woff,.woff2"><button class="form-btn" onclick="document.getElementById('bs-font-file').click()">选择文件</button></div>
                        <div class="modal-actions">
                            <button class="modal-btn" onclick="setBookshelfFontFamily(null)">重置</button>
                            <button class="modal-btn primary" onclick="setBookshelfFontFamily()">应用</button>
                        </div>
                    </div>
                `;
                showModal(modalId, html);
            } else if (type === 'size') {
                const modalId = 'bs-font-size-modal';
                const html = `
                    <div class="modal-content">
                        <div class="modal-title">字体大小</div>
                        <div class="form-group">
                            <label>大小: <span id="bs-font-size-value">${settings.fontSize}</span>px</label>
                            <input type="range" id="bs-font-size-input" min="10" max="20" value="${settings.fontSize}" oninput="document.getElementById('bs-font-size-value').textContent = this.value;">
                        </div>
                        <button class="modal-btn primary" onclick="setBookshelfFontSize()">确定</button>
                    </div>
                `;
                showModal(modalId, html);
            }
        }

        function setBookshelfFontWeight(weight) {
            appData.bookshelf.settings.fontWeight = weight;
            saveData();
            applyBookshelfReadingSettings();
            renderBookshelfProfilePage();
            closeModal('bs-font-weight-modal');
        }

        function setBookshelfFontSize() {
            const size = parseInt(document.getElementById('bs-font-size-input').value);
            appData.bookshelf.settings.fontSize = size;
            saveData();
            applyBookshelfReadingSettings();
            renderBookshelfProfilePage();
            closeModal('bs-font-size-modal');
        }

        function setBookshelfFontFamily() {
            const url = document.getElementById('bs-font-url').value;
            const fileInput = document.getElementById('bs-font-file');
            const file = fileInput.files[0];
            const settings = appData.bookshelf.settings;

            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    settings.fontFile = e.target.result;
                    settings.fontUrl = '';
                    settings.fontFamily = `BookshelfCustomFont_${Date.now()}`;
                    saveData(true);
                    applyBookshelfReadingSettings();
                    renderBookshelfProfilePage();
                };
                reader.readAsDataURL(file);
            } else if (url) {
                settings.fontUrl = url;
                settings.fontFile = null;
                settings.fontFamily = `BookshelfCustomFont_${Date.now()}`;
                saveData(true);
                applyBookshelfReadingSettings();
                renderBookshelfProfilePage();
            } else {
                settings.fontUrl = '';
                settings.fontFile = null;
                settings.fontFamily = '';
                saveData(true);
                applyBookshelfReadingSettings();
                renderBookshelfProfilePage();
            }
            closeModal('bs-font-family-modal');
        }

        function applyBookshelfReadingSettings() {
            const container = document.getElementById('bookshelf-app-page');
            const settings = appData.bookshelf.settings;
            
            let fontFaceStyle = '';
            if (settings.fontFamily) {
                const src = settings.fontFile ? `url(${settings.fontFile})` : `url(${settings.fontUrl})`;
                fontFaceStyle = `@font-face { font-family: '${settings.fontFamily}'; src: ${src}; }`;
            }
            const existingStyle = document.getElementById('bookshelf-font-style');
            if (existingStyle) existingStyle.remove();
            
            const styleEl = document.createElement('style');
            styleEl.id = 'bookshelf-font-style';
            styleEl.innerHTML = `
                ${fontFaceStyle}
                #bookshelf-app-page {
                    --bs-custom-font: ${settings.fontFamily || 'var(--bs-font-family)'};
                    --bs-font-weight: ${settings.fontWeight};
                    --bs-font-size: ${settings.fontSize}px;
                    --bs-text-shadow: ${settings.textShadow ? '0 0 5px rgba(0,0,0,0.5)' : 'none'};
                    --bs-text-highlight: ${settings.textHighlight ? 'linear-gradient(to top, rgba(255, 255, 0, 0.3) 50%, transparent 50%)' : 'none'};
                    --bs-text-underline: ${settings.textUnderline ? 'underline' : 'none'};
                    --bs-text-italic: ${settings.textItalic ? 'italic' : 'normal'};
                }
            `;
            document.head.appendChild(styleEl);
        }

        function showBookshelfInviteFriendModal() {
            const modalId = 'bs-invite-friend-modal';
            const friends = appData.bookshelf.friends;
            const friendIds = friends.map(f => f.id);
            const availableContacts = appData.contacts.filter(c => !friendIds.includes(c.id));

            const html = `
                <div class="modal-content">
                    <div class="modal-title">邀请好友</div>
                    <div class="list-view" style="max-height: 60vh; overflow-y: auto;">
                        ${availableContacts.length > 0 ? availableContacts.map(c => `
                            <div class="list-item" onclick="addBookshelfFriend(${c.id}); closeModal('${modalId}');">
                                <img src="${c.avatar}" class="avatar">
                                <div class="details"><span class="name">${c.name}</span></div>
                            </div>
                        `).join('') : '<p style="text-align:center; padding:20px;">没有更多好友可邀请</p>'}
                    </div>
                </div>
            `;
            showModal(modalId, html);
        }

        function addBookshelfFriend(contactId) {
            const contact = appData.contacts.find(c => c.id === contactId);
            if (contact) {
                appData.bookshelf.friends.push({
                    id: contact.id,
                    name: contact.name,
                    avatar: contact.avatar,
                    reading: null
                });
                saveData(true);
                renderBookshelfDiscoverPage();
            }
        }

        function renderBookshelfDiscoverPage() {
            const listEl = document.getElementById('bs-friends-reading-list');
            if (!listEl) return;
            const friends = appData.bookshelf.friends;
            if (friends.length === 0) {
                listEl.innerHTML = '<p style="color: var(--bs-text-tertiary);">还没有好友，快去邀请吧！</p>';
                return;
            }
            listEl.innerHTML = friends.map(f => `
                <div class="list-item">
                    <img src="${f.avatar}" class="avatar">
                    <div class="details">
                        <span class="name">${f.name}</span>
                        <p class="subtext">${f.reading ? `正在读《${f.reading}》` : '最近没在读书'}</p>
                    </div>
                </div>
            `).join('');
        }

        // ★★★ 优化：同人小说生成与展示逻辑 ★★★
        function renderBookshelfFanficPage() {
            const page = document.getElementById('bs-fanfic-content');
            if (!page) return;

            const tags = appData.bookshelf.fanfics.tags;
            const charOptions = appData.contacts.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            const personaOptions = appData.user.personas.map(p => `<option value="${p.id}">${p.name}</option>`).join('');

            page.innerHTML = `
                <div class="form-group">
                    <label>选择角色 (Char)</label>
                    <select id="fanfic-char-select" class="form-input">${charOptions}</select>
                </div>
                <div class="form-group">
                    <label>选择你的身份 (User)</label>
                    <select id="fanfic-user-select" class="form-input">${personaOptions}</select>
                </div>
                <div class="fanfic-header">
                    <h3 style="margin:0;">标签</h3>
                    <button class="icon-button" onclick="showEditFanficTagsModal()"><i class="fas fa-edit"></i></button>
                </div>
                <div class="fanfic-tags" id="fanfic-tags">
                    ${tags.map(tag => `<div class="fanfic-tag" data-tag="${tag}">${tag}</div>`).join('')}
                </div>
                <div id="fanfic-grid-container">
                    <div class="loader-container" style="display:none;"><div class="loader"></div></div>
                    <div class="fanfic-grid" id="fanfic-grid"></div>
                </div>
            `;

            document.querySelectorAll('.fanfic-tag').forEach(tagEl => {
                tagEl.addEventListener('click', () => {
                    document.querySelectorAll('.fanfic-tag').forEach(t => t.classList.remove('active'));
                    tagEl.classList.add('active');
                    generateFanfics();
                });
            });
        }

        function showEditFanficTagsModal() {
            const modalId = 'bs-edit-tags-modal';
            const tags = appData.bookshelf.fanfics.tags;
            const html = `
                <div class="modal-content">
                    <div class="modal-title">编辑标签</div>
                    <div class="form-group">
                        <textarea id="bs-tags-input" class="modal-input" rows="5" placeholder="每个标签用逗号或换行分隔">${tags.join(', ')}</textarea>
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" onclick="saveFanficTags()">保存</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);
        }

        function saveFanficTags() {
            const input = document.getElementById('bs-tags-input').value;
            const newTags = input.split(/[,，\n]/).map(t => t.trim()).filter(Boolean);
            appData.bookshelf.fanfics.tags = newTags;
            saveData(true);
            renderBookshelfFanficPage();
            closeModal('bs-edit-tags-modal');
        }

        async function generateFanfics(forceRefresh = false) {
            const charId = document.getElementById('fanfic-char-select').value;
            const userId = document.getElementById('fanfic-user-select').value;
            const activeTagEl = document.querySelector('.fanfic-tag.active');
            if (!charId || !userId || !activeTagEl) {
                showToast('请先选择角色、你的身份和标签', 'error');
                return;
            }
            
            const targetChar = appData.contacts.find(c => c.id == charId);
            const userPersona = appData.user.personas.find(p => p.id == userId);
            const tag = activeTagEl.dataset.tag;

            if (!targetChar || !userPersona) {
                showToast('选择的角色或身份无效', 'error');
                return;
            }

            const grid = document.getElementById('fanfic-grid');
            const loader = document.querySelector('#fanfic-grid-container .loader-container');
            
            loader.style.display = 'flex';
            grid.innerHTML = '';

            const cacheKey = `${charId}_${userId}_${tag}`;
            if (appData.bookshelf.fanfics.cache[cacheKey] && !forceRefresh) {
                renderFanficGrid(appData.bookshelf.fanfics.cache[cacheKey]);
                loader.style.display = 'none';
                return;
            }

            try {
                const prompt = `你是一个同人小说生成器。请为以下两位角色生成36篇关于“${tag}”主题的同人小说标题和简介。
                角色1 (Char): ${targetChar.name}, 性别: ${targetChar.gender}, 人设: ${targetChar.persona}
                角色2 (User): ${userPersona.name}, 性别: ${userPersona.gender}, 人设: ${userPersona.description}
                严格遵循以下格式，每篇用分号(;)分隔，标题和简介用逗号(,)分隔，确保生成的标题和简介符合双方人设和性别：
                标题1,简介1;标题2,简介2;...`;
                const result = (await getAiReply(charId, 'wechat', prompt))[0];
                const fanfics = result.split(';').map(item => {
                    const parts = item.split(',');
                    return parts.length >= 2 ? { title: parts[0].trim(), summary: parts.slice(1).join(',').trim() } : null;
                }).filter(Boolean);

                appData.bookshelf.fanfics.cache[cacheKey] = fanfics;
                saveData();
                renderFanficGrid(fanfics);
            } catch (e) {
                grid.innerHTML = `<p style="color:red;">生成失败: ${e.message}</p>`;
            } finally {
                loader.style.display = 'none';
            }
        }

        function renderFanficGrid(fanfics) {
            const grid = document.getElementById('fanfic-grid');
            grid.innerHTML = fanfics.map(fic => `
                <div class="fanfic-card" onclick="showToast('阅读功能开发中...')">
                    <div class="fanfic-cover">${fic.title}</div>
                    <div class="fanfic-info">
                        <p class="fanfic-summary">${fic.summary}</p>
                    </div>
                </div>
            `).join('');
        }

        function renderTimePerceptionSettingsPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div><span>设置</span></div>
                    <span class="header-title">时间感知</span>
                </div>
                <div class="content-area">
                    <div class="list-item">
                        <div class="details">
                            <span class="name">开启时间感知</span>
                            <p class="subtext">开启后，AI将能感知并回应现实时间与节日。</p>
                        </div>
                        <label class="switch"><input type="checkbox" id="time-perception-toggle" ${appData.settings.timePerception ? 'checked' : ''}><span class="slider"></span></label>
                    </div>
                </div>
            `;
            document.getElementById('time-perception-toggle').onchange = (e) => {
                appData.settings.timePerception = e.target.checked;
                saveData(true);
            };
        }

        function showWorldbookMountModal(contactId) {
            const contact = appData.contacts.find(c => c.id == contactId);
            if (!contact) return;
            const mountedIds = contact.chatSettings?.worldbookIds || [];
            const worldbooks = appData.worldbooks.library;

            const modalId = 'worldbook-mount-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">为 ${contact.name} 挂载世界书</div>
                    <div class="list-view" style="max-height: 60vh; overflow-y: auto;">
                        ${worldbooks.length > 0 ? worldbooks.map(book => `
                            <div class="list-item">
                                <div class="details"><span class="name">${book.name}</span></div>
                                <input type="checkbox" data-book-id="${book.id}" ${mountedIds.includes(book.id) ? 'checked' : ''}>
                            </div>
                        `).join('') : '<p style="text-align:center; padding:20px;">暂无世界书</p>'}
                    </div>
                    <button class="form-btn" style="margin-top: 15px;" onclick="saveWorldbookMounts(${contactId})">保存</button>
                </div>
            `;
            showModal(modalId, html);
        }

        function saveWorldbookMounts(contactId) {
            const contact = appData.contacts.find(c => c.id == contactId);
            if (!contact.chatSettings) contact.chatSettings = {};
            const selectedIds = Array.from(document.querySelectorAll('#worldbook-mount-modal input:checked')).map(cb => parseInt(cb.dataset.bookId));
            contact.chatSettings.worldbookIds = selectedIds;
            saveData(true);
            closeModal('worldbook-mount-modal');
        }

        function showFileContent(fileName, dataUrl, fileType) {
            const modalId = 'file-content-modal';
            let contentHtml = '';

            if (fileType.startsWith('image/')) {
                contentHtml = `<img src="${dataUrl}" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
            } else if (fileType.startsWith('video/')) {
                contentHtml = `<video src="${dataUrl}" controls style="width: 100%; height: auto;"></video>`;
            } else if (fileType.startsWith('audio/')) {
                contentHtml = `<audio src="${dataUrl}" controls style="width: 100%;"></audio>`;
            } else if (fileType.startsWith('text/')) {
                const base64Content = dataUrl.split(',')[1];
                const textContent = decodeURIComponent(escape(window.atob(base64Content)));
                contentHtml = `<textarea readonly style="flex: 1; width: 100%; border: 1px solid #ccc; padding: 10px; box-sizing: border-box; resize: none;">${textContent}</textarea>`;
            } else {
                contentHtml = `<p>不支持预览此文件类型: ${fileType}</p><a href="${dataUrl}" download="${fileName}">点击下载</a>`;
            }

            const html = `
                <div class="modal-content" style="width: 90%; max-width: 360px; height: 70vh; display: flex; flex-direction: column;">
                    <div class="modal-title">${fileName}</div>
                    <div style="flex: 1; display: flex; justify-content: center; align-items: center; overflow: auto;">
                        ${contentHtml}
                    </div>
                    <button class="modal-btn" style="margin-top: 15px;" onclick="closeModal('${modalId}')">关闭</button>
                </div>
            `;
            showModal(modalId, html);
        }
        
        // ★★★ 新增：证件办理APP ★★★
        function renderCertificateAppPage(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div></div>
                    <span class="header-title">证件办理</span>
                </div>
                <div class="content-area" id="certificate-content-area"></div>
                <div class="bottom-nav">
                    <div class="nav-item active" onclick="switchCertificateTab('id-card')"><i class="fas fa-id-card"></i><span>身份证</span></div>
                    <div class="nav-item" onclick="switchCertificateTab('marriage-cert')"><i class="fas fa-heart"></i><span>结婚证</span></div>
                    <div class="nav-item" onclick="switchCertificateTab('my-certs')"><i class="fas fa-user-circle"></i><span>我的</span></div>
                </div>
            `;
            switchCertificateTab('id-card');
        }

        function switchCertificateTab(tab) {
            const contentArea = document.getElementById('certificate-content-area');
            document.querySelectorAll('#certificate-app-page .nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`#certificate-app-page .nav-item[onclick="switchCertificateTab('${tab}')"]`).classList.add('active');

            if (tab === 'id-card') {
                renderIdCardTab(contentArea);
            } else if (tab === 'marriage-cert') {
                renderMarriageCertTab(contentArea);
            } else if (tab === 'my-certs') {
                renderMyCertsTab(contentArea);
            }
        }

        function renderIdCardTab(container) {
            const charOptions = appData.contacts.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            container.innerHTML = `
                <div class="form-page" style="padding: 20px;">
                    <h3>办理角色身份证</h3>
                    <div class="form-group">
                        <label>选择角色</label>
                        <select id="cert-char-select" class="form-input">${charOptions}</select>
                    </div>
                    <button class="form-btn" onclick="generateIdCard()">生成身份证</button>
                    <div id="id-card-display" class="certificate-display"></div>
                </div>
            `;
        }

        function renderMyCertsTab(container) {
            const personaOptions = appData.user.personas.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            container.innerHTML = `
                <div class="form-page" style="padding: 20px;">
                    <h3>办理我的身份证</h3>
                    <div class="form-group">
                        <label>选择自设</label>
                        <select id="cert-persona-select" class="form-input">${personaOptions}</select>
                    </div>
                    <button class="form-btn" onclick="generateIdCard('user')">生成我的身份证</button>
                    <div id="my-id-card-display" class="certificate-display"></div>
                </div>
            `;
        }

        function renderMarriageCertTab(container) {
            const charOptions = appData.contacts.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            const personaOptions = appData.user.personas.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            container.innerHTML = `
                <div class="form-page" style="padding: 20px;">
                    <h3>办理结婚证</h3>
                    <div class="form-group">
                        <label>选择你的身份 (User)</label>
                        <select id="marriage-user-select" class="form-input">${personaOptions}</select>
                    </div>
                    <div class="form-group">
                        <label>选择你的伴侣 (Char)</label>
                        <select id="marriage-char-select" class="form-input">${charOptions}</select>
                    </div>
                    <div class="form-group">
                        <label>结婚照</label>
                        <input type="file" id="marriage-photo-input" class="file-input" accept="image/*">
                        <button class="form-btn" style="background-color:#aaa;" onclick="document.getElementById('marriage-photo-input').click()">上传合影</button>
                    </div>
                    <div class="form-group">
                        <label>民政局印章文字</label>
                        <input type="text" id="marriage-stamp-input" class="form-input" value="${appData.certificates.marriageStamp}">
                    </div>
                    <button class="form-btn" onclick="generateMarriageCert()">生成结婚证</button>
                    <div id="marriage-cert-display" class="certificate-display"></div>
                </div>
            `;
        }

        async function generateIdCard(type = 'char') {
            const displayId = type === 'user' ? 'my-id-card-display' : 'id-card-display';
            const displayEl = document.getElementById(displayId);
            displayEl.innerHTML = `<div class="loader-container"><div class="loader"></div></div>`;

            let person, personaId;
            if (type === 'user') {
                personaId = document.getElementById('cert-persona-select').value;
                person = appData.user.personas.find(p => p.id == personaId);
            } else {
                const charId = document.getElementById('cert-char-select').value;
                person = appData.contacts.find(c => c.id == charId);
            }

            if (!person) {
                displayEl.innerHTML = '<p style="color:red;">请先选择一个有效的角色或自设。</p>';
                return;
            }

            try {
                const prompt = `请为以下角色生成一个逼真的中国居民身份证信息。严格遵循JSON格式，不要添加任何额外解释。
                角色信息: { "name": "${person.name}", "gender": "${person.gender}", "persona": "${person.persona || person.description}" }
                JSON格式: { "birth_date": "YYYY年M月D日", "ethnicity": "民族", "address": "详细住址", "id_number": "18位身份证号", "issuing_authority": "签发机关", "validity_period": "YYYY.MM.DD-YYYY.MM.DD" }`;
                
                const idDataStr = (await getAiReply(person.id, 'wechat', prompt))[0];
                const idData = JSON.parse(idDataStr);

                const newIdCard = {
                    id: Date.now(),
                    ownerId: person.id,
                    ownerType: type,
                    ...idData,
                    name: person.name,
                    gender: person.gender,
                    avatar: person.avatar
                };
                appData.certificates.idCards.push(newIdCard);
                saveData();

                displayEl.innerHTML = `
                    <div class="id-card" id="id-card-${newIdCard.id}">
                        <div class="id-bg-pattern"></div>
                        <div class="id-header"><div class="id-title">居民身份证</div><div class="id-logo">PRC ID</div></div>
                        <div class="id-content">
                            <div class="id-photo" style="background-image: url('${person.avatar}')"></div>
                            <div class="id-info">
                                <div class="info-item"><div class="info-label">姓名：</div><div class="info-value">${person.name}</div></div>
                                <div class="info-item"><div class="info-label">性别：</div><div class="info-value">${{male:'男', female:'女', other:'其他'}[person.gender]}</div></div>
                                <div class="info-item"><div class="info-label">民族：</div><div class="info-value">${idData.ethnicity}</div></div>
                                <div class="info-item"><div class="info-label">出生：</div><div class="info-value">${idData.birth_date}</div></div>
                                <div class="info-item"><div class="info-label">住址：</div><div class="info-value">${idData.address}</div></div>
                            </div>
                        </div>
                        <div class="id-footer">
                            <div class="id-number">${idData.id_number}</div>
                            <div>公民身份号码</div>
                        </div>
                    </div>
                `;
                document.getElementById(`id-card-${newIdCard.id}`).addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    // 保存图片逻辑
                });

            } catch (e) {
                displayEl.innerHTML = `<p style="color:red;">生成身份证失败: ${e.message}</p>`;
            }
        }

        function generateMarriageCert() {
            const displayEl = document.getElementById('marriage-cert-display');
            displayEl.innerHTML = `<div class="loader-container"><div class="loader"></div></div>`;

            const userId = document.getElementById('marriage-user-select').value;
            const charId = document.getElementById('marriage-char-select').value;
            const user = appData.user.personas.find(p => p.id == userId);
            const char = appData.contacts.find(c => c.id == charId);
            const stampText = document.getElementById('marriage-stamp-input').value;
            const photoInput = document.getElementById('marriage-photo-input');

            const userCard = appData.certificates.idCards.find(c => c.ownerId == userId && c.ownerType === 'user');
            const charCard = appData.certificates.idCards.find(c => c.ownerId == charId && c.ownerType === 'char');

            if (!user || !char) {
                displayEl.innerHTML = '<p style="color:red;">请选择有效的双方身份。</p>';
                return;
            }
            if (!userCard || !charCard) {
                displayEl.innerHTML = '<p style="color:red;">双方或其中一方未办理身份证，无法结婚。</p>';
                return;
            }
            
            const userAge = new Date().getFullYear() - new Date(userCard.birth_date.replace(/年|月/g, '-').replace('日', '')).getFullYear();
            const charAge = new Date().getFullYear() - new Date(charCard.birth_date.replace(/年|月/g, '-').replace('日', '')).getFullYear();

            if (userAge < 18 || charAge < 18) {
                displayEl.innerHTML = '<p style="color:red;">双方或其中一方未满18周岁，无法结婚。</p>';
                return;
            }

            const handlePhoto = (photoUrl) => {
                const certNumber = `结字第 No. ${new Date().getFullYear()}${String(new Date().getMonth()+1).padStart(2,'0')}${String(new Date().getDate()).padStart(2,'0')}${Math.floor(Math.random()*1000).toString().padStart(4,'0')}`;
                const registrationDate = new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });

                const newCert = {
                    id: Date.now(),
                    user: { id: user.id, name: user.name, gender: user.gender, birthDate: userCard.birth_date, idNumber: userCard.id_number },
                    char: { id: char.id, name: char.name, gender: char.gender, birthDate: charCard.birth_date, idNumber: charCard.id_number },
                    photo: photoUrl,
                    stamp: stampText,
                    certNumber: certNumber,
                    registrationDate: registrationDate
                };
                appData.certificates.marriageCerts.push(newCert);
                saveData();

                displayEl.innerHTML = `
                    <div class="marriage-certificate" style="transform: scale(0.8);">
                        <div class="heart-decoration">❤</div>
                        <div class="certificate-left">
                            <div class="certificate-header">
                                <div class="certificate-title">结婚证</div>
                                <div class="certificate-subtitle">MARRIAGE CERTIFICATE</div>
                                <div class="certificate-number">${certNumber}</div>
                            </div>
                            <div class="couple-photo" style="background-image: url('${photoUrl}')"></div>
                            <div class="marriage-info">
                                <div class="info-grid"><div class="info-label">${char.gender === 'male' ? '男方' : '女方'}：</div><div class="info-value">${char.name}</div></div>
                                <div class="info-grid"><div class="info-label">性别：</div><div class="info-value">${{male:'男', female:'女', other:'其他'}[char.gender]}</div></div>
                                <div class="info-grid"><div class="info-label">出生：</div><div class="info-value">${charCard.birth_date}</div></div>
                                <div class="info-grid"><div class="info-label">身份证号：</div><div class="info-value">${charCard.id_number}</div></div>
                                <div class="info-grid" style="margin-top: 20px;"><div class="info-label">${user.gender === 'female' ? '女方' : '男方'}：</div><div class="info-value">${user.name}</div></div>
                                <div class="info-grid"><div class="info-label">性别：</div><div class="info-value">${{male:'男', female:'女', other:'其他'}[user.gender]}</div></div>
                                <div class="info-grid"><div class="info-label">出生：</div><div class="info-value">${userCard.birth_date}</div></div>
                                <div class="info-grid"><div class="info-label">身份证号：</div><div class="info-value">${userCard.id_number}</div></div>
                            </div>
                        </div>
                        <div class="certificate-right">
                            <div class="marriage-vows">双方自愿申请结婚，经审查，符合《中华人民共和国民法典》关于结婚的规定，准予登记，特发此证。</div>
                            <div class="registration-date">登记日期：${registrationDate}</div>
                            <div class="official-stamp"><div class="stamp-content"><span class="stamp-text">婚姻登记专用章</span><span class="stamp-authority">${stampText}</span></div></div>
                        </div>
                    </div>
                `;
            };

            if (photoInput.files[0]) {
                handleImageUpload(photoInput.files[0], handlePhoto);
            } else {
                handlePhoto('');
            }
        }

        // ★★★ 优化：所有灵动岛逻辑 ★★★
        function initAllDynamicIslands() {
            initDynamicIsland();
            initIosDynamicIsland();
            initEvolDynamicIsland();
            initInsDynamicIsland();
        }

        function updateAllDynamicIslands() {
            updateDynamicIslandMusic();
            updateIosDynamicIslandMusic();
            updateEvolDynamicIslandMusic();
            updateInsDynamicIslandMusic();
        }
        
        function initDynamicIsland() {
            const island = document.getElementById('dynamic-island');
            if (!island) return;
            island.addEventListener('click', () => {
                if (island.classList.contains('music-mode')) {
                    togglePlayPause();
                }
            });
        }

        function updateDynamicIslandMusic() {
            if (appData.settings.beautify.statusBarDisplay !== 'island') return;
            const island = document.getElementById('dynamic-island');
            const content = document.getElementById('island-music-content');
            if (!island || !content) return;

            if (appData.music.isPlaying && appData.music.currentSongId) {
                const song = appData.music.library.find(s => s.id === appData.music.currentSongId);
                if (song) {
                    content.querySelector('.cover').style.backgroundImage = `url(${song.cover || 'https://img.js.design/assets/img/664e0d45692271d43c087968.jpg'})`;
                    content.querySelector('.info .title').textContent = song.title;
                    content.querySelector('.info .artist').textContent = song.artist;
                    const iconPath = appData.music.isPlaying ? "M6 19h4V5H6v14zm8-14v14h4V5h-4z" : "M8 5v14l11-7z";
                    document.getElementById('island-play-pause-icon').innerHTML = `<path d="${iconPath}"/>`;
                    island.classList.add('music-mode');
                    island.classList.toggle('playing', appData.music.isPlaying);
                }
            } else {
                island.classList.remove('music-mode', 'playing');
            }
        }

        function initIosDynamicIsland() {
            const island = document.getElementById('ios-dynamic-island');
            if (!island) return;
            const playPauseBtn = document.getElementById('ios-play-pause-btn');
            const prevBtn = document.getElementById('ios-prev-btn');
            const nextBtn = document.getElementById('ios-next-btn');
            
            playPauseBtn.addEventListener('click', (e) => { e.stopPropagation(); togglePlayPause(); });
            prevBtn.addEventListener('click', (e) => { e.stopPropagation(); playPreviousSong(); });
            nextBtn.addEventListener('click', (e) => { e.stopPropagation(); playNextSong(); });

            island.addEventListener('click', () => {
                if (appData.music.isPlaying) {
                    island.classList.toggle('island-expanded');
                    island.classList.toggle('expanded');
                }
            });
        }

        function updateIosDynamicIslandMusic() {
            if (appData.settings.beautify.statusBarDisplay !== 'island-v2') return;
            
            const island = document.getElementById('ios-dynamic-island');
            const musicControls = document.getElementById('ios-music-controls');
            const songTitleEl = document.getElementById('ios-song-title');
            const artistNameEl = document.getElementById('ios-artist-name');
            const playPauseIcon = document.getElementById('ios-play-pause-icon');
            const albumArtEl = document.getElementById('ios-album-art');

            if (appData.music.isPlaying && appData.music.currentSongId) {
                const song = appData.music.library.find(s => s.id === appData.music.currentSongId);
                if (song) {
                    musicControls.style.display = 'flex';
                    songTitleEl.textContent = song.title;
                    artistNameEl.textContent = song.artist;
                    albumArtEl.style.backgroundImage = `url(${song.cover || 'https://img.js.design/assets/img/664e0d45692271d43c087968.jpg'})`;
                    playPauseIcon.innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>'; // Pause icon
                    island.classList.add('playing', 'pulse');
                }
            } else {
                playPauseIcon.innerHTML = '<path d="M8 5v14l11-7z"/>'; // Play icon
                island.classList.remove('playing', 'pulse', 'expanded', 'island-expanded');
                setTimeout(() => {
                    if (!appData.music.isPlaying) {
                        musicControls.style.display = 'none';
                    }
                }, 300);
            }
        }

        function initEvolDynamicIsland() {
            const island = document.getElementById('evol-dynamic-island');
            if (!island) return;
            const playPauseBtn = document.getElementById('evol-play-pause-btn');
            const prevBtn = document.getElementById('evol-prev-btn');
            const nextBtn = document.getElementById('evol-next-btn');

            island.addEventListener('click', () => {
                if (appData.music.isPlaying) {
                    island.classList.toggle('expanded');
                }
            });
            playPauseBtn.addEventListener('click', (e) => { e.stopPropagation(); togglePlayPause(); });
            prevBtn.addEventListener('click', (e) => { e.stopPropagation(); playPreviousSong(); });
            nextBtn.addEventListener('click', (e) => { e.stopPropagation(); playNextSong(); });
        }

        function updateEvolDynamicIslandMusic() {
            if (appData.settings.beautify.statusBarDisplay !== 'evol-island') return;
            
            const island = document.getElementById('evol-dynamic-island');
            const songNameEl = document.getElementById('evol-song-name');
            const artistNameEl = document.getElementById('evol-artist-name');
            const playPauseIcon = document.querySelector('#evol-play-pause-btn i');
            const waveContainer = island.querySelector('.wave-container');

            if (appData.music.isPlaying && appData.music.currentSongId) {
                const song = appData.music.library.find(s => s.id === appData.music.currentSongId);
                if (song) {
                    songNameEl.textContent = song.title;
                    artistNameEl.textContent = song.artist;
                    playPauseIcon.className = 'fas fa-pause';
                    waveContainer.style.display = 'flex';
                }
            } else {
                playPauseIcon.className = 'fas fa-play';
                waveContainer.style.display = 'none';
                island.classList.remove('expanded');
            }
        }

        // ★★★ 新增：ins灵动岛逻辑 ★★★
        function initInsDynamicIsland() {
            const island = document.getElementById('ins-dynamic-island');
            if (!island) return;

            island.addEventListener('click', () => {
                if (appData.music.isPlaying) {
                    island.classList.toggle('expanded');
                }
            });
            document.getElementById('ins-play-btn').addEventListener('click', (e) => { e.stopPropagation(); togglePlayPause(); });
            document.getElementById('ins-prev-btn').addEventListener('click', (e) => { e.stopPropagation(); playPreviousSong(); });
            document.getElementById('ins-next-btn').addEventListener('click', (e) => { e.stopPropagation(); playNextSong(); });
        }

        function updateInsDynamicIslandMusic() {
            if (appData.settings.beautify.statusBarDisplay !== 'ins-island') return;

            const island = document.getElementById('ins-dynamic-island');
            const song = appData.music.library.find(s => s.id === appData.music.currentSongId);
            
            const songTitleEl = document.getElementById('ins-song-title');
            const artistNameEl = document.getElementById('ins-artist-name');
            const playIconEl = document.getElementById('ins-play-icon');
            const waveContainer = document.getElementById('ins-wave-container');
            const smallCover = document.getElementById('ins-album-cover-small');
            const smallText = document.getElementById('ins-now-playing-text');
            const currentTimeEl = document.getElementById('ins-current-time');
            const totalTimeEl = document.getElementById('ins-total-time');
            const progressEl = document.getElementById('ins-progress');

            if (appData.music.isPlaying && song) {
                island.classList.add('playing');
                playIconEl.className = 'fas fa-pause';
                waveContainer.classList.remove('paused');
                
                songTitleEl.textContent = song.title;
                artistNameEl.textContent = song.artist;
                smallText.textContent = song.title;
                smallCover.style.backgroundImage = `url(${song.cover || 'https://img.js.design/assets/img/664e0d45692271d43c087968.jpg'})`;
                
                const currentTime = audioPlayer.currentTime;
                const totalTime = audioPlayer.duration;
                currentTimeEl.textContent = formatTime(currentTime);
                totalTimeEl.textContent = formatTime(totalTime);
                progressEl.style.width = totalTime > 0 ? `${(currentTime / totalTime) * 100}%` : '0%';

            } else {
                island.classList.remove('playing', 'expanded');
                playIconEl.className = 'fas fa-play';
                waveContainer.classList.add('paused');
                smallText.textContent = 'Now Playing';
                smallCover.style.backgroundImage = '';
            }
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }


        // ★★★ 新增：心声功能 ★★★
        async function showHeartbeatModal(chatId) {
            const modalId = 'heartbeat-modal';
            const overlay = document.createElement('div');
            overlay.id = modalId;
            overlay.className = 'heartbeat-modal-overlay';
            overlay.innerHTML = `<div class="heartbeat-card"><div class="loader-container"><div class="loader"></div></div></div>`;
            document.body.appendChild(overlay);

            overlay.onclick = () => overlay.remove();

            try {
                const contact = appData.contacts.find(c => c.id == chatId);
                const chatHistory = contact.conversation.slice(-10).map(m => `${m.sender === appData.user.id ? appData.user.nickname : contact.name}: ${m.content.content}`).join('\n');
                const prompt = `你正在和'${appData.user.nickname}'聊天。请根据你的角色设定(${contact.persona})和最近的聊天记录，生成一句不超过100字的内心独白或真实想法。禁止任何括号、神态、动作或环境描写，只需纯粹的内心文字。\n\n聊天记录：\n${chatHistory}`;
                const heartbeatText = (await getAiReply(chatId, 'wechat', prompt))[0];
                
                const card = overlay.querySelector('.heartbeat-card');
                if (card) {
                    card.innerHTML = heartbeatText || '...';
                }
            } catch (e) {
                const card = overlay.querySelector('.heartbeat-card');
                if (card) {
                    card.innerHTML = `获取心声失败: ${e.message}`;
                }
            }
        }

        // ★★★ 优化：群头衔管理 ★★★
        function renderGroupTitleManagementPage(container, groupId) {
            if (!container) return;
            const group = appData.groups.find(g => g.id == groupId);
            if (!group) { goBack(); return; }

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div></div>
                    <span class="header-title">群头衔管理</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="showEditMemberTitleModal(${groupId})">
                        <div class="details"><span class="name">编辑群成员头衔</span></div>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showEditLevelTitleModal(${groupId})">
                        <div class="details"><span class="name">设置群成员等级头衔</span></div>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                </div>
            `;
        }

        function showEditMemberTitleModal(groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            const modalId = 'edit-member-title-modal';
            const allMembers = [appData.user, ...group.members];
            const membersHtml = allMembers.map(member => {
                const memberId = member.id === 'user' ? 'user' : member.id;
                const currentTitle = group.groupTitles?.[memberId]?.title || '无';
                const currentLevel = group.groupTitles?.[memberId]?.level || 0;
                return `
                    <div class="list-item">
                        <img src="${member.avatar}" class="avatar">
                        <div class="details">
                            <span class="name">${member.name || member.nickname}</span>
                            <p class="subtext">当前头衔: ${currentTitle}, 等级: ${currentLevel}</p>
                        </div>
                        <button class="form-btn" style="flex:0; padding: 5px 10px; margin:0;" onclick="editSingleMemberTitle(${groupId}, '${memberId}')">编辑</button>
                    </div>
                `;
            }).join('');

            const html = `
                <div class="modal-content" style="width: 90%; max-width: 360px;">
                    <div class="modal-title">编辑群成员头衔</div>
                    <div class="list-view" style="max-height: 60vh; overflow-y: auto;">${membersHtml}</div>
                    <button class="modal-btn" style="margin-top: 15px;" onclick="closeModal('${modalId}')">关闭</button>
                </div>
            `;
            showModal(modalId, html);
        }

        function editSingleMemberTitle(groupId, memberId) {
            const group = appData.groups.find(g => g.id == groupId);
            const member = memberId === 'user' ? appData.user : group.members.find(m => m.id == memberId);
            const currentTitle = group.groupTitles?.[memberId]?.title || '';
            const currentLevel = group.groupTitles?.[memberId]?.level || 0;

            const newTitle = prompt(`为 ${member.name || member.nickname} 设置新头衔 (6字以内):`, currentTitle);
            if (newTitle === null) return;
            const newLevelStr = prompt(`为 ${member.name || member.nickname} 设置等级 (0-100):`, currentLevel);
            if (newLevelStr === null) return;
            const newLevel = parseInt(newLevelStr);

            if (newTitle.length > 6) {
                showToast('头衔不能超过6个字', 'error');
                return;
            }
            if (isNaN(newLevel) || newLevel < 0 || newLevel > 100) {
                showToast('等级必须在0到100之间', 'error');
                return;
            }

            if (!group.groupTitles) group.groupTitles = {};
            group.groupTitles[memberId] = { title: newTitle, level: newLevel };
            saveData(true);
            closeModal('edit-member-title-modal');
            showEditMemberTitleModal(groupId);
        }

        function showEditLevelTitleModal(groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            const levels = group.levelTitles;
            const modalId = 'edit-level-title-modal';
            const html = `
                <div class="modal-content" style="width: 90%; max-width: 360px;">
                    <div class="modal-title">设置群成员等级头衔</div>
                    <div class="form-page" style="padding:0;">
                        <div class="form-group"><label>LV.0-10</label><input type="text" id="level-0-10" value="${levels['0-10']}"></div>
                        <div class="form-group"><label>LV.11-20</label><input type="text" id="level-11-20" value="${levels['11-20']}"></div>
                        <div class="form-group"><label>LV.21-30</label><input type="text" id="level-21-30" value="${levels['21-30']}"></div>
                        <div class="form-group"><label>LV.31-50</label><input type="text" id="level-31-50" value="${levels['31-50']}"></div>
                        <div class="form-group"><label>LV.51-80</label><input type="text" id="level-51-80" value="${levels['51-80']}"></div>
                        <div class="form-group"><label>LV.81-100</label><input type="text" id="level-81-100" value="${levels['81-100']}"></div>
                    </div>
                    <button class="form-btn" onclick="saveLevelTitles(${groupId})">保存</button>
                </div>
            `;
            showModal(modalId, html);
        }

        function saveLevelTitles(groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            group.levelTitles['0-10'] = document.getElementById('level-0-10').value;
            group.levelTitles['11-20'] = document.getElementById('level-11-20').value;
            group.levelTitles['21-30'] = document.getElementById('level-21-30').value;
            group.levelTitles['31-50'] = document.getElementById('level-31-50').value;
            group.levelTitles['51-80'] = document.getElementById('level-51-80').value;
            group.levelTitles['81-100'] = document.getElementById('level-81-100').value;
            saveData(true);
            closeModal('edit-level-title-modal');
        }
        
        function getMemberLevelRange(level) {
            if (level <= 10) return '0-10';
            if (level <= 20) return '11-20';
            if (level <= 30) return '21-30';
            if (level <= 50) return '31-50';
            if (level <= 80) return '51-80';
            return '81-100';
        }
        
        // ★★★ 优化：已读回执设置 ★★★
        function renderReadReceiptSettingsPage(container) {
            if (!container) return;
            const settings = appData.settings.beautify.readReceipt;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><div class="ui-icon back"></div></div>
                    <span class="header-title">已读回执</span>
                </div>
                <div class="content-area">
                    <div class="list-item">
                        <div class="details"><span class="name">开启已读回执总开关</span></div>
                        <label class="switch"><input type="checkbox" id="read-receipt-enabled" ${settings.enabled ? 'checked' : ''}><span class="slider"></span></label>
                    </div>
                    <div class="list-divider"></div>
                    <div class="list-item">
                        <div class="details"><span class="name">显示你的已读状态</span><p class="subtext">对方将看到你是否已读消息</p></div>
                        <label class="switch"><input type="checkbox" id="read-receipt-user-enabled" ${settings.userEnabled ? 'checked' : ''}><span class="slider"></span></label>
                    </div>
                    <div class="list-item">
                        <div class="details"><span class="name">显示对方的已读状态</span><p class="subtext">你将看到对方是否已读消息</p></div>
                        <label class="switch"><input type="checkbox" id="read-receipt-char-enabled" ${settings.charEnabled ? 'checked' : ''}><span class="slider"></span></label>
                    </div>
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="setReadReceiptPosition('outside')">
                        <div class="details"><span class="name">气泡外</span></div>
                        ${settings.position === 'outside' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setReadReceiptPosition('inside')">
                        <div class="details"><span class="name">气泡内</span></div>
                        ${settings.position === 'inside' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                </div>
            `;
            document.getElementById('read-receipt-enabled').onchange = (e) => {
                settings.enabled = e.target.checked;
                saveData(true);
            };
            document.getElementById('read-receipt-user-enabled').onchange = (e) => {
                settings.userEnabled = e.target.checked;
                saveData(true);
            };
            document.getElementById('read-receipt-char-enabled').onchange = (e) => {
                settings.charEnabled = e.target.checked;
                saveData(true);
            };
        }

        function setReadReceiptPosition(position) {
            appData.settings.beautify.readReceipt.position = position;
            saveData(true);
            renderReadReceiptSettingsPage(document.getElementById('read-receipt-settings-page'));
        }

    </script>
    <!-- FullCalendar JS for the new Calendar App -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
</body>
</html>
